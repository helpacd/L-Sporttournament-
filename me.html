<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Gaming Tournament</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Dark Theme Variables --- */
        :root {
            --primary-bg: #0F172A; /* Slate 900 */
            --secondary-bg: #1E293B; /* Slate 800 */
            --card-bg: #1E293B; /* Slate 800 */
            --sidebar-bg: #111827; /* Gray 900 */
            --text-primary: #E2E8F0; /* Slate 200 */
            --text-secondary: #94A3B8; /* Slate 400 */
            --text-muted-custom: #64748B; /* Slate 500 - Improved visibility for muted text */
            --accent-color: #FACC15; /* Yellow 500 */
            --accent-gradient: linear-gradient(to right, #FACC15, #FBBF24);
            --primary-button-bg: #3B82F6; /* Blue 500 */
            --border-color: #334155; /* Slate 700 */
            --success-color: #10B981; /* Emerald 500 */
            --danger-color: #EF4444; /* Red 500 */
            --warning-color: #F59E0B; /* Amber 500 */
            -info-color: #60A5FA; /* Blue 400 */
            --link-color: #9CA3AF; /* Gray 400 */
            --link-hover-color: #E5E7EB; /* Gray 200 */
            --placeholder-bg: rgba(100, 116, 139, 0.15); /* Slate 500 with opacity */
        }
        body { background-color: var(--primary-bg); color: var(--text-primary); font-family: 'Poppins', sans-serif; padding-top: 60px; }
        .app-header { position: fixed; top: 0; left: 0; width: 100%; height: 60px; background-color: var(--secondary-bg); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); z-index: 1030; border-bottom: 1px solid var(--border-color);}
        .header-left { display: flex; align-items: center; gap: 10px;}
        .menu-toggle-btn { background: none; border: none; color: var(--text-primary); font-size: 1.5rem; padding: 0 5px; margin-left: -5px;}
        .header-logo { width: 35px; height: 35px; border-radius: 50%; background-color: #fff; object-fit: cover; border: 1px solid var(--accent-color);}
        .header-title { font-size: 1rem; font-weight: 600; line-height: 1.2;}
        .header-right { display: flex; align-items: center; gap: 15px;}
        .admin-email-header { font-size: 0.8rem; color: var(--text-secondary); display: none; }
        @media (min-width: 576px) { .admin-email-header { display: inline; } }
        .offcanvas-start { background-color: var(--sidebar-bg); color: var(--link-color); width: 260px !important; border-right: 1px solid var(--border-color);}
        .offcanvas-header { border-bottom: 1px solid var(--border-color); padding: 1rem 1.2rem;}
        .offcanvas-title h5 { color: var(--text-primary); margin-bottom: 0; font-size: 1.1rem; }
        .btn-close-white { filter: invert(1) grayscale(100%) brightness(200%);}
        .offcanvas-body { padding: 0; display: flex; flex-direction: column; height: calc(100% - 56px); }
        .offcanvas-body .nav { flex-grow: 1; overflow-y: auto; }
        .offcanvas-body .nav-link { color: var(--link-color); padding: 0.8rem 1.2rem; border-left: 3px solid transparent; font-size: 0.95rem;}
        .offcanvas-body .nav-link.active, .offcanvas-body .nav-link:hover { color: var(--link-hover-color); background-color: rgba(255, 255, 255, 0.05); border-left-color: var(--accent-color);}
        .offcanvas-body .nav-link i { margin-right: 12px; width: 20px; text-align: center; font-size: 1.1rem;}
        .offcanvas-logout-btn { margin: 1rem; border-top: 1px solid var(--border-color); padding-top: 1rem;}
        .main-content { padding: 20px; }
        .section { display: none; animation: fadeIn 0.5s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .section-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 20px; }
        .login-container { max-width: 400px; margin: 10vh auto; background-color: var(--secondary-bg); padding: 2rem; border-radius: 8px; border: 1px solid var(--border-color); box-shadow: 0 4px 12px rgba(0,0,0,0.2);}
        #adminLoader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 9999; display: none; }
        .spinner-border { color: var(--accent-color); }
        .card { background-color: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-primary); margin-bottom: 1.5rem; }
        .card-title { color: var(--text-primary); }
        .table-responsive { overflow-x: auto; }
        .table { background-color: var(--card-bg); color: var(--text-primary); border-color: var(--border-color); margin-bottom: 0;}
        .table > :not(caption) > * > * { background-color: transparent !important; border-bottom-color: var(--border-color); }
        .table th { color: var(--text-secondary); font-weight: 500; white-space: nowrap; padding: 0.8rem 1rem;}
        .table td { vertical-align: middle; white-space: nowrap; padding: 0.7rem 1rem;}
        .table td .text-muted { color: var(--text-muted-custom) !important; }
        .table td small.text-muted { font-size: 0.85em; }
        .table-hover > tbody > tr:hover > * { background-color: rgba(255, 255, 255, 0.03) !important; color: var(--text-primary); }
        .action-buttons button, .action-buttons a { margin-right: 5px; margin-bottom: 5px; }
        .modal-content { background-color: var(--secondary-bg); color: var(--text-primary); border: 1px solid var(--border-color); }
        .modal-header { border-bottom-color: var(--border-color); }
        .modal-footer { border-top-color: var(--border-color); }
        .modal-body label { margin-bottom: 0.5rem; font-weight: 500; color: var(--text-secondary); }
        .form-control, .form-select { background-color: var(--primary-bg); color: var(--text-primary); border: 1px solid var(--border-color); }
        .form-control:focus, .form-select:focus { background-color: var(--primary-bg); color: var(--text-primary); border-color: var(--accent-color); box-shadow: 0 0 0 0.2rem rgba(250, 204, 21, 0.25); }
        .form-control::placeholder { color: var(--text-secondary); opacity: 0.7; }
        .form-control:disabled, .form-select:disabled { background-color: #2d3748; opacity: 0.7; }
        .form-control[type="file"] { background-color: var(--primary-bg); color: var(--text-secondary); border: 1px solid var(--border-color); }
        .form-control[type="color"] { min-height: 38px; padding: 0.2rem; }
        .imgbb-upload-status { display: none; margin-top: 5px; font-size: 0.85rem; color: var(--text-secondary);}
        .table img.preview-img { max-width: 60px; height: 40px; object-fit: cover; border-radius: 4px; cursor: pointer; border: 1px solid var(--border-color); }
        .text-bg-primary { background-color: #3B82F6 !important; }
        .text-bg-info { background-color: #0ea5e9 !important; }
        .text-bg-warning { background-color: #f59e0b !important; }
        .text-bg-success { background-color: #10b981 !important; }
        .text-bg-danger { background-color: #ef4444 !important; }
        .text-bg-secondary { background-color: #6b7280 !important; }
        .text-bg-dark { background-color: #374151 !important; }
        .nav-tabs .nav-link { color: var(--text-secondary); border-color: var(--border-color); border-bottom-color: transparent; margin-bottom: -1px;}
        .nav-tabs .nav-link.active { color: var(--accent-color); background-color: var(--card-bg); border-color: var(--border-color); border-bottom-color: var(--card-bg); font-weight: 600; }
        .nav-tabs { border-bottom-color: var(--border-color); }
        textarea.form-control { min-height: 120px; }
        .copy-btn { cursor: pointer; opacity: 0.6; transition: opacity 0.2s; }
        .copy-btn:hover { opacity: 1; }
        .status-badge { font-size: 0.8em; padding: 0.3em 0.6em; border-radius: 0.25rem; }
        .loading-placeholder td > div { background-color: var(--placeholder-bg); border-radius: 4px; min-height: 1.2em; animation: placeholder-glow 2s ease-in-out infinite; }
        @keyframes placeholder-glow { 0% { background-color: var(--placeholder-bg); } 50% { background-color: rgba(100, 116, 139, 0.2); } 100% { background-color: var(--placeholder-bg); } }
        .dash-card-icon { font-size: 1.8rem; opacity: 0.6; position: absolute; right: 15px; top: 50%; transform: translateY(-50%); }
        .card-body { position: relative; }
        .color-picker-group { display: flex; align-items: center; gap: 10px; }
        .color-picker-group label { flex-shrink: 0; width: 140px; }
        .color-picker-group .form-control[type="color"] { width: 50px; flex-shrink: 0; }
        .color-picker-group .form-control[type="text"] { flex-grow: 1; }
    </style>
</head>
<body>

    <div id="adminLoader">
        <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
    </div>

    <!-- Login / Setup Area -->
    <div id="auth-container">
        <div id="admin-setup-section" style="display: none;">
            <div class="container login-container"> <div class="card shadow"> <div class="card-body p-4"> <h2 class="card-title text-center mb-4">Admin Account Setup</h2> <p class="text-muted text-center small mb-3">Create the primary admin account.</p> <form id="adminSetupForm"> <div class="mb-3"> <label for="setupEmail" class="form-label">Admin Email</label> <input type="email" class="form-control" id="setupEmail" required> </div> <div class="mb-3"> <label for="setupPassword" class="form-label">Admin Password (min 6 chars)</label> <input type="password" class="form-control" id="setupPassword" required minlength="6"> </div> <div id="adminSetupStatus" class="mt-3"></div> <div class="d-grid"> <button type="submit" class="btn btn-success">Create Admin Account</button> </div> </form> </div> </div> </div>
        </div>
        <div id="admin-login-section" style="display: none;">
            <div class="container login-container"> <div class="card shadow"> <div class="card-body p-4"> <h2 class="card-title text-center mb-4">Admin Login</h2> <form id="adminLoginForm"> <div class="mb-3"> <label for="adminEmail" class="form-label">Email</label> <input type="email" class="form-control" id="adminEmail" required> </div> <div class="mb-3"> <label for="adminPassword" class="form-label">Password</label> <input type="password" class="form-control" id="adminPassword" required> </div> <div id="adminLoginStatus" class="mt-3"></div> <div class="d-grid"> <button type="submit" class="btn btn-primary">Login</button> </div> </form> </div> </div> </div>
        </div>
    </div>

    <!-- Main Admin Panel Area -->
    <div id="admin-main-area" style="display: none;">
        <header class="app-header">
            <div class="header-left">
                <button class="menu-toggle-btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#adminSidebar" aria-controls="adminSidebar">
                    <i class="bi bi-list"></i>
                </button>
                <img src="https://via.placeholder.com/35/1E293B/94A3B8?text=L" alt="Logo" class="header-logo" id="adminHeaderLogo" style="display:none;">
                <h1 class="header-title ms-1" id="adminPageTitle">Dashboard</h1>
            </div>
            <div class="header-right">
                <span class="admin-email-header" id="adminUserEmailShort"></span>
                <button class="btn btn-sm btn-outline-danger" id="adminLogoutBtnHeader"><i class="bi bi-box-arrow-right"></i> Logout</button>
            </div>
        </header>

        <div class="offcanvas offcanvas-start" tabindex="-1" id="adminSidebar" aria-labelledby="adminSidebarLabel">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="adminSidebarLabel">Admin Menu</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
                <ul class="nav flex-column">
                    <li class="nav-item"> <a class="nav-link active" href="#" data-section="dashboard-section"><i class="bi bi-speedometer2"></i> Dashboard</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="games-section"><i class="bi bi-controller"></i> Games</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="promotions-section"><i class="bi bi-images"></i> Promotions</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="update-section"><i class="bi bi-newspaper"></i> Updates</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="tournaments-section"><i class="bi bi-trophy"></i> Tournaments</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="users-section"><i class="bi bi-people"></i> Users</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="transactions-section"><i class="bi bi-receipt"></i> Transactions</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="withdrawals-section"><i class="bi bi-cash-coin"></i> Withdrawals <span class="badge bg-danger ms-1" id="pendingWithdrawalCountBadge" style="display: none;">0</span></a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="deposits-section"><i class="bi bi-wallet2"></i> Deposit <span class="badge bg-warning ms-1" id="pendingDepositCountBadge" style="display: none;">0</span></a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="notifications-section"><i class="bi bi-bell-fill"></i> Notifications</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="settings-section"><i class="bi bi-gear"></i> Settings</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="theme-section"><i class="bi bi-palette-fill"></i> Theme</a> </li>
                </ul>
                <div class="mt-auto p-3 border-top border-secondary">
                     <button class="btn btn-warning btn-sm w-100 mb-2" id="addDemoDataBtn"><i class="bi bi-database-add"></i> Add Demo Data</button>
                     <small class="text-muted d-block text-center">Adds sample data if DB is empty.</small>
                </div>
            </div>
        </div>

        <main class="main-content" id="adminMainContent">
            <!-- Dashboard Section -->
            <section id="dashboard-section" class="section active">
                <h2>Dashboard Overview</h2>
                <div class="row">
                    <!-- Row 1 -->
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-primary shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Total Users</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statTotalUsers">--</p>
                                <i class="bi bi-people-fill dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-info shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Active/Upcoming Tournaments</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statActiveTournaments">--</p>
                                <i class="bi bi-trophy-fill dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-warning shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Pending Withdrawals</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statPendingWithdrawals">--</p>
                                <i class="bi bi-hourglass-split dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                     <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-success shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Completed Withdrawals</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statCompletedWithdrawals">--</p>
                                <i class="bi bi-check-circle-fill dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                    <!-- Row 2 -->
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-dark shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Rejected Withdrawals</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statRejectedWithdrawals">--</p>
                                <i class="bi bi-x-octagon-fill dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                     <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-secondary shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Total Games</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statTotalGames">--</p>
                                <i class="bi bi-controller dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-secondary shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Total Promotions</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statTotalPromotions">--</p>
                                <i class="bi bi-images dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                     <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-secondary shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Finished Tournaments</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statFinishedTournaments">--</p>
                                <i class="bi bi-flag-fill dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="dashboardStatus"></div>
            </section>

            <!-- Games Section -->
            <section id="games-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <h2>Manage Games</h2>
                    <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#gameModal" id="addNewGameBtn"><i class="bi bi-plus-circle"></i> Add Game</button>
                </div>
                 <div id="gamesStatus" class="mb-3"></div>
                <div class="table-responsive card">
                    <table class="table table-dark table-hover mb-0">
                        <thead> <tr><th>Image</th><th>Name</th><th>Game ID</th><th>Actions</th></tr> </thead>
                        <tbody id="gamesTableBody">
                            <tr class="loading-placeholder"><td colspan="4"><div class="placeholder w-100 py-3"></div></td></tr>
                            <tr class="loading-placeholder"><td colspan="4"><div class="placeholder w-100 py-3"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Promotions Section -->
            <section id="promotions-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                     <h2>Manage Promotions</h2>
                     <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#promotionModal" id="addNewPromotionBtn"><i class="bi bi-plus-circle"></i> Add Promotion</button>
                </div>
                <div id="promotionsStatus" class="mb-3"></div>
                <div class="table-responsive card">
                    <table class="table table-dark table-hover mb-0">
                         <thead> <tr><th>Image</th><th>Link</th><th>Actions</th></tr> </thead>
                         <tbody id="promotionsTableBody">
                            <tr class="loading-placeholder"><td colspan="3"><div class="placeholder w-100 py-3"></div></td></tr>
                         </tbody>
                    </table>
                </div>
             </section>
             
            <!-- UPDATE SECTION -->
            <section id="update-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                     <h2>Manage Updates</h2>
                     <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#updateModal" id="addNewUpdateBtn"><i class="bi bi-plus-circle"></i> Add Update</button>
                </div>
                <div id="updatesStatus" class="mb-3"></div>
                <div class="table-responsive card">
                    <table class="table table-dark table-hover mb-0">
                         <thead> <tr><th>Image</th><th>Title</th><th>Actions</th></tr> </thead>
                         <tbody id="updatesTableBody">
                            <tr class="loading-placeholder"><td colspan="3"><div class="placeholder w-100 py-3"></div></td></tr>
                         </tbody>
                    </table>
                </div>
            </section>

            <!-- Tournaments Section -->
            <section id="tournaments-section" class="section">
                 <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                     <h2>Manage Tournaments</h2>
                     <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addTournamentModal" id="addNewTournamentBtn"><i class="bi bi-plus-circle"></i> Add Tournament</button>
                 </div>
                 <div id="tournamentsStatus" class="mb-3"></div>
                 <div class="table-responsive card">
                     <table class="table table-dark table-hover mb-0">
                         <thead> <tr><th>Name</th><th>Game</th><th>Fee</th><th>Prize</th><th>Start Time</th><th>Status</th><th>Players</th><th>Actions</th></tr> </thead>
                         <tbody id="tournamentsTableBody">
                            <tr class="loading-placeholder"><td colspan="8"><div class="placeholder w-100 py-3"></div></td></tr>
                            <tr class="loading-placeholder"><td colspan="8"><div class="placeholder w-100 py-3"></div></td></tr>
                         </tbody>
                    </table>
                 </div>
            </section>

            <!-- Users Section -->
            <section id="users-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <h2>Manage Users</h2>
                    <div class="d-flex gap-2">
                        <input type="search" class="form-control form-control-sm" id="userSearchInput" placeholder="Search by name or email...">
                        <button class="btn btn-success btn-sm flex-shrink-0" data-bs-toggle="modal" data-bs-target="#addUserModal">
                            <i class="bi bi-person-plus-fill"></i> Add User
                        </button>
                    </div>
                </div>
                 <div id="usersStatus" class="mb-3"></div>
                <div class="table-responsive card">
                    <table class="table table-dark table-hover mb-0">
                        <thead>
                            <tr><th>UID</th><th>Display Name</th><th>Email</th><th>Total Balance</th><th>Status</th><th>Actions</th></tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr class="loading-placeholder"><td colspan="6"><div class="placeholder w-100 py-3"></div></td></tr>
                            <tr class="loading-placeholder"><td colspan="6"><div class="placeholder w-100 py-3"></div></td></tr>
                            <tr class="loading-placeholder"><td colspan="6"><div class="placeholder w-100 py-3"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Transactions Section -->
            <section id="transactions-section" class="section card"> <div class="card-body"> <h2 class="card-title">User Transactions</h2> <p class="text-muted">Section under development.</p></div> </section>

            <!-- Withdrawals Section -->
            <section id="withdrawals-section" class="section">
                <h2>Manage Withdrawals</h2>
                 <div id="withdrawalsStatus" class="mb-3"></div>
                <div class="card">
                    <div class="card-header bg-secondary border-bottom border-dark"> <ul class="nav nav-tabs card-header-tabs" id="withdrawalTabs" role="tablist"> <li class="nav-item" role="presentation"><button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pendingWithdrawalsTab" type="button" role="tab">Pending</button></li> <li class="nav-item" role="presentation"><button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completedWithdrawalsTab" type="button" role="tab">Completed</button></li> <li class="nav-item" role="presentation"><button class="nav-link" id="rejected-tab" data-bs-toggle="tab" data-bs-target="#rejectedWithdrawalsTab" type="button" role="tab">Rejected</button></li> </ul> </div>
                    <div class="card-body tab-content p-0">
                        <div class="tab-pane fade show active" id="pendingWithdrawalsTab" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover mb-0">
                                    <thead><tr><th>Requested At</th><th>User</th><th>Amount</th><th>Method</th><th>Actions</th></tr></thead>
                                    <tbody id="pendingWithdrawalsTableBody"> <tr class="loading-placeholder"><td colspan="5"><div class="placeholder w-100 py-3"></div></td></tr> <tr class="loading-placeholder"><td colspan="5"><div class="placeholder w-100 py-3"></div></td></tr> </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="completedWithdrawalsTab" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover mb-0">
                                    <thead><tr><th>Requested At</th><th>Processed At</th><th>User</th><th>Amount</th><th>Method</th><th>Admin Note</th></tr></thead>
                                    <tbody id="completedWithdrawalsTableBody"> <tr class="loading-placeholder"><td colspan="6"><div class="placeholder w-100 py-3"></div></td></tr> </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="rejectedWithdrawalsTab" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover mb-0">
                                    <thead><tr><th>Requested At</th><th>Processed At</th><th>User</th><th>Amount</th><th>Method</th><th>Reason</th></tr></thead>
                                    <tbody id="rejectedWithdrawalsTableBody"> <tr class="loading-placeholder"><td colspan="6"><div class="placeholder w-100 py-3"></div></td></tr></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                 </div>
            </section>
            
            <!-- DEPOSIT SECTION    -->
            <section id="deposits-section" class="section">
                <h2>Manage Deposits (Recharge)</h2>
                <div id="depositsStatus" class="mb-3"></div>
                <div class="card">
                    <div class="card-header bg-secondary border-bottom border-dark">
                        <ul class="nav nav-tabs card-header-tabs" id="depositTabs" role="tablist">
                            <li class="nav-item" role="presentation"><button class="nav-link active" id="pending-deposit-tab" data-bs-toggle="tab" data-bs-target="#pendingDepositsTab" type="button" role="tab">Pending</button></li>
                            <li class="nav-item" role="presentation"><button class="nav-link" id="approved-deposit-tab" data-bs-toggle="tab" data-bs-target="#approvedDepositsTab" type="button" role="tab">Approved</button></li>
                            <li class="nav-item" role="presentation"><button class="nav-link" id="rejected-deposit-tab" data-bs-toggle="tab" data-bs-target="#rejectedDepositsTab" type="button" role="tab">Rejected</button></li>
                        </ul>
                    </div>
                    <div class="card-body tab-content p-0">
                        <!-- Pending Deposits -->
                        <div class="tab-pane fade show active" id="pendingDepositsTab" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover mb-0">
                                    <thead><tr><th>Requested At</th><th>User</th><th>Amount</th><th>Details</th><th>Actions</th></tr></thead>
                                    <tbody id="pendingDepositsTableBody">
                                        <tr class="loading-placeholder"><td colspan="5"><div class="placeholder w-100 py-3"></div></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- Approved Deposits -->
                        <div class="tab-pane fade" id="approvedDepositsTab" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover mb-0">
                                    <thead><tr><th>Requested At</th><th>Processed At</th><th>User</th><th>Amount</th><th>Details</th><th>Admin Note</th></tr></thead>
                                    <tbody id="approvedDepositsTableBody">
                                        <tr class="loading-placeholder"><td colspan="6"><div class="placeholder w-100 py-3"></div></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- Rejected Deposits -->
                        <div class="tab-pane fade" id="rejectedDepositsTab" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover mb-0">
                                    <thead><tr><th>Requested At</th><th>Processed At</th><th>User</th><th>Amount</th><th>Details</th><th>Reason</th></tr></thead>
                                    <tbody id="rejectedDepositsTableBody">
                                        <tr class="loading-placeholder"><td colspan="6"><div class="placeholder w-100 py-3"></div></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- NOTIFICATIONS SECTION -->
            <section id="notifications-section" class="section">
                <h2>Send Notifications</h2>
                <div id="notificationStatus" class="mb-3"></div>
                <div class="row">
                    <!-- Send to Single User -->
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header"><h5 class="mb-0"><i class="bi bi-person-fill me-2"></i> Send to Single User</h5></div>
                            <div class="card-body">
                                <form id="sendSingleNotificationForm">
                                    <div class="mb-3">
                                        <label for="singleNotificationUid" class="form-label">User ID (UID)</label>
                                        <input type="text" id="singleNotificationUid" class="form-control" placeholder="Enter user's Firebase UID" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="singleNotificationTitle" class="form-label">Title</label>
                                        <input type="text" id="singleNotificationTitle" class="form-control" placeholder="e.g., Recharge Approved" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="singleNotificationMessage" class="form-label">Message</label>
                                        <textarea id="singleNotificationMessage" class="form-control" rows="3" placeholder="e.g., Your recharge of ₹50 is complete." required></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Send Notification</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <!-- Broadcast to All Users -->
                    <div class="col-lg-6">
                        <div class="card border-danger">
                            <div class="card-header bg-danger text-white"><h5 class="mb-0"><i class="bi bi-broadcast me-2"></i> Broadcast to All Users</h5></div>
                            <div class="card-body">
                                <form id="sendBroadcastNotificationForm">
                                    <div class="mb-3">
                                        <label for="broadcastNotificationTitle" class="form-label">Title</label>
                                        <input type="text" id="broadcastNotificationTitle" class="form-control" placeholder="e.g., Maintenance Alert" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="broadcastNotificationMessage" class="form-label">Message</label>
                                        <textarea id="broadcastNotificationMessage" class="form-control" rows="3" placeholder="e.g., The app will be down for maintenance..." required></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-danger">Send to ALL Users</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settings-section" class="section card"> <div class="card-body"> <h2 class="card-title">App Settings</h2> <form id="appSettingsForm"> <div class="row"> <div class="col-md-6 mb-3"> <label for="settingLogoUrl" class="form-label">Logo URL</label> <input type="url" class="form-control" id="settingLogoUrl"> </div> <div class="col-md-6 mb-3"> <label for="settingAppName" class="form-label">App Name</label> <input type="text" class="form-control" id="settingAppName"> </div> <div class="col-md-6 mb-3"> <label for="settingMinWithdraw" class="form-label">Min Withdraw (₹)</label> <input type="number" class="form-control" id="settingMinWithdraw" min="0" step="any"> </div> <div class="col-md-6 mb-3"> <label for="settingReferralBonus" class="form-label">Referral Bonus (₹)</label> <input type="number" class="form-control" id="settingReferralBonus" min="0" step="any"> </div> <div class="col-12 mb-3"> <label for="settingSupportContact" class="form-label">Admin Support Contact</label> <input type="text" class="form-control" id="settingSupportContact"> </div> <div class="col-12 mb-3"> <label for="settingUpiDetails" class="form-label">UPI Details for Payment</label> <input type="text" class="form-control" id="settingUpiDetails"> </div> <div class="col-12 mb-3"> <label for="settingPolicyPrivacy" class="form-label">Privacy Policy</label> <textarea class="form-control" id="settingPolicyPrivacy" rows="5"></textarea> </div> <div class="col-12 mb-3"> <label for="settingPolicyTerms" class="form-label">Terms & Conditions</label> <textarea class="form-control" id="settingPolicyTerms" rows="5"></textarea> </div> <div class="col-12 mb-3"> <label for="settingPolicyRefund" class="form-label">Refund Policy</label> <textarea class="form-control" id="settingPolicyRefund" rows="5"></textarea> </div> <div class="col-12 mb-3"> <label for="settingPolicyFairPlay" class="form-label">Fair Play Policy</label> <textarea class="form-control" id="settingPolicyFairPlay" rows="5"></textarea> </div> </div> <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Save Settings</button> <div id="settingsStatus" class="mt-3"></div> </form> </div> </section>
            
            <!-- Theme Section -->
            <section id="theme-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="section-title mb-0">Theme Customization</h2>
                    <button class="btn btn-danger btn-sm" id="resetThemeBtn"><i class="bi bi-arrow-counterclockwise"></i> Reset to Default Theme</button>
                </div>
                <div id="themeStatus" class="mb-3"></div>
                <div class="row">
                    <div class="col-lg-4 mb-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">Predefined Themes</h5>
                                <p class="card-text text-secondary small">Select a theme to preview the colors in the form below, then click "Save Theme" to apply it.</p>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-secondary" id="previewDefaultThemeBtn">Default Dark</button>
                                    <button class="btn btn-outline-danger" id="previewCrimsonThemeBtn">Crimson Dark</button>
                                    <button class="btn btn-outline-info" id="previewOceanicThemeBtn">Oceanic Blue</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-8 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Custom Theme Colors</h5>
                                <form id="customThemeForm">
                                    <div class="row g-3">
                                        <div class="col-md-6"><div class="color-picker-group mb-2"><label for="theme-primary-bg" class="form-label">Primary BG</label><input type="color" class="form-control form-control-color" id="theme-primary-bg" data-var="--primary-bg"><input type="text" class="form-control form-control-sm" data-target="theme-primary-bg"></div></div>
                                        <div class="col-md-6"><div class="color-picker-group mb-2"><label for="theme-accent-color" class="form-label">Accent Color</label><input type="color" class="form-control form-control-color" id="theme-accent-color" data-var="--accent-color"><input type="text" class="form-control form-control-sm" data-target="theme-accent-color"></div></div>
                                        <div class="col-md-6"><div class="color-picker-group mb-2"><label for="theme-text-primary" class="form-label">Primary Text</label><input type="color" class="form-control form-control-color" id="theme-text-primary" data-var="--text-primary"><input type="text" class="form-control form-control-sm" data-target="theme-text-primary"></div></div>
                                        <div class="col-md-6"><div class="color-picker-group mb-2"><label for="theme-primary-button-bg" class="form-label">Primary Button</label><input type="color" class="form-control form-control-color" id="theme-primary-button-bg" data-var="--primary-button-bg"><input type="text" class="form-control form-control-sm" data-target="theme-primary-button-bg"></div></div>
                                        <div class="col-12"><hr class="my-2"></div>
                                        <div class="col-md-6"><div class="color-picker-group mb-2"><label for="theme-secondary-bg" class="form-label">Secondary BG</label><input type="color" class="form-control form-control-color" id="theme-secondary-bg" data-var="--secondary-bg"><input type="text" class="form-control form-control-sm" data-target="theme-secondary-bg"></div></div>
                                        <div class="col-md-6"><div class="color-picker-group mb-2"><label for="theme-card-bg" class="form-label">Card BG</label><input type="color" class="form-control form-control-color" id="theme-card-bg" data-var="--card-bg"><input type="text" class="form-control form-control-sm" data-target="theme-card-bg"></div></div>
                                        <div class="col-md-6"><div class="color-picker-group mb-2"><label for="theme-text-secondary" class="form-label">Secondary Text</label><input type="color" class="form-control form-control-color" id="theme-text-secondary" data-var="--text-secondary"><input type="text" class="form-control form-control-sm" data-target="theme-text-secondary"></div></div>
                                         <div class="col-md-6"><div class="color-picker-group mb-2"><label for="theme-border-color" class="form-label">Border Color</label><input type="color" class="form-control form-control-color" id="theme-border-color" data-var="--border-color"><input type="text" class="form-control form-control-sm" data-target="theme-border-color"></div></div>
                                    </div>
                                    <div class="d-flex justify-content-end mt-4">
                                         <button type="button" class="btn btn-primary" id="saveThemeBtn"><i class="bi bi-save"></i> Save Theme</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="gameModal" tabindex="-1"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="gameModalTitle">Add New Game</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <form id="gameForm"> <input type="hidden" id="gameEditId"> <div class="mb-3"> <label for="gameName" class="form-label">Game Name</label> <input type="text" class="form-control" id="gameName" required> </div> <div class="mb-3"> <label for="gameImageUrl" class="form-label">Image URL</label> <input type="url" class="form-control" id="gameImageUrl" required> <small class="text-muted">Direct image URL (e.g., from ImgBB).</small> </div> <div class="mb-3"> <label for="gameImageFile" class="form-label">Upload New Image (Optional - Overwrites URL)</label> <input class="form-control" type="file" id="gameImageFile" accept="image/*"> <div class="imgbb-upload-status mt-2"></div> </div> <div id="gameStatus" class="mt-2"></div></form> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> <button type="button" class="btn btn-primary" id="saveGameBtn">Save Game</button> </div> </div> </div> </div>
    <div class="modal fade" id="promotionModal" tabindex="-1"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="promotionModalTitle">Add New Promotion</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <form id="promotionForm"> <input type="hidden" id="promotionEditId"> <div class="mb-3"> <label for="promoImageUrl" class="form-label">Image URL</label> <input type="url" class="form-control" id="promoImageUrl" required> <small class="text-muted">Direct image URL (e.g., from ImgBB).</small> </div> <div class="mb-3"> <label for="promoImageFile" class="form-label">Upload New Image (Optional - Overwrites URL)</label> <input class="form-control" type="file" id="promoImageFile" accept="image/*"> <div class="imgbb-upload-status mt-2"></div> </div> <div class="mb-3"> <label for="promoLink" class="form-label">Link (Optional)</label> <input type="url" class="form-control" id="promoLink"> </div> <div id="promotionStatus" class="mt-2"></div></form> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> <button type="button" class="btn btn-primary" id="savePromotionBtn">Save Promotion</button> </div> </div> </div> </div>
    <!-- UPDATE MODAL -->
    <div class="modal fade" id="updateModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="updateModalTitle">Add New Update</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="updateForm">
                        <input type="hidden" id="updateEditId">
                        <div class="mb-3">
                            <label for="updateTitle" class="form-label">Title</label>
                            <input type="text" class="form-control" id="updateTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="updateImageUrl" class="form-label">Image URL</label>
                            <input type="url" class="form-control" id="updateImageUrl" required>
                            <small class="text-muted">Direct image URL (e.g., from ImgBB).</small>
                        </div>
                        <div id="updateStatus" class="mt-2"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveUpdateBtn">Post Update</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="addTournamentModal" tabindex="-1"> <div class="modal-dialog modal-lg"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="tournamentModalTitle">Add New Tournament</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <form id="tournamentForm"> <input type="hidden" id="tournamentEditId"> <div class="row"> <div class="col-md-6 mb-3"> <label for="tournamentGame" class="form-label">Game</label> <select class="form-select" id="tournamentGame" required></select> </div> <div class="col-md-6 mb-3"> <label for="tournamentName" class="form-label">Tournament Name</label> <input type="text" class="form-control" id="tournamentName" required> </div> <div class="col-md-6 mb-3"> <label for="tournamentStartTime" class="form-label">Start Date & Time</label> <input type="datetime-local" class="form-control" id="tournamentStartTime" required> </div> <div class="col-md-6 mb-3"> <label for="tournamentStatus" class="form-label">Status</label> <select class="form-select" id="tournamentStatus" required> <option value="upcoming">Upcoming</option> <option value="ongoing">Ongoing</option> <option value="completed">Completed</option> <option value="result">Result</option> <option value="cancelled">Cancelled</option> </select> </div> <div class="col-md-4 mb-3"> <label for="tournamentEntryFee" class="form-label">Entry Fee (₹)</label> <input type="number" class="form-control" id="tournamentEntryFee" min="0" value="0" required step="any"> </div> <div class="col-md-4 mb-3"> <label for="tournamentPrizePool" class="form-label">Total Prize Pool (₹)</label> <input type="number" class="form-control" id="tournamentPrizePool" min="0" value="0" step="any"> </div> <div class="col-md-4 mb-3"> <label for="tournamentPerKill" class="form-label">Per Kill Prize (₹)</label> <input type="number" class="form-control" id="tournamentPerKill" min="0" value="0" step="any"> </div> <div class="col-md-6 mb-3"> <label for="tournamentMaxPlayers" class="form-label">Max Players (0 for Unlimited)</label> <input type="number" class="form-control" id="tournamentMaxPlayers" min="0" value="0" required> </div> <div class="col-md-6 mb-3"> <label for="tournamentTags" class="form-label">Tags (comma-separated)</label> <input type="text" class="form-control" id="tournamentTags" placeholder="e.g., TPP, FPP"> </div> <div class="col-md-6 mb-3"> <label for="tournamentMode" class="form-label">Mode</label> <input type="text" class="form-control" id="tournamentMode" placeholder="e.g., Squad, Solo, Duo"> </div> <div class="col-md-6 mb-3"> <label for="tournamentMap" class="form-label">Map</label> <input type="text" class="form-control" id="tournamentMap" placeholder="e.g., Erangel, Livik, Miramar"> </div> <div class="col-12 mb-3"> <label for="tournamentDescription" class="form-label">Description / Rules</label> <textarea class="form-control" id="tournamentDescription" rows="4"></textarea> </div> <div class="col-md-6 mb-3"> <label for="tournamentRoomId" class="form-label">Room ID</label> <input type="text" class="form-control" id="tournamentRoomId"> </div> <div class="col-md-6 mb-3"> <label for="tournamentRoomPassword" class="form-label">Room Password</label> <input type="text" class="form-control" id="tournamentRoomPassword"> </div> <div class="form-check mb-3 ms-2"> <input class="form-check-input" type="checkbox" id="tournamentShowIdPass"> <label class="form-check-label" for="tournamentShowIdPass"> Show ID/Pass?</label> </div> </div> <div id="addTournamentStatus" class="mt-2"></div></form> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> <button type="button" class="btn btn-primary" id="saveTournamentBtn">Save Tournament</button> </div> </div> </div> </div>
    <div class="modal fade" id="userModal" tabindex="-1"> <div class="modal-dialog modal-lg"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="userModalTitle">User Details</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <div class="row"> <div class="col-md-6"> <h5>User Info</h5> <p><strong>UID:</strong> <small id="userDetailUid" class="text-muted user-uid-copy"></small> <i class="bi bi-clipboard copy-btn ms-1" data-target="#userDetailUid" title="Copy UID"></i></p> <p><strong>Email:</strong> <span id="userDetailEmail"></span></p> <p><strong>Name:</strong> <span id="userDetailName"></span></p> <p><strong>Created At:</strong> <span id="userDetailCreatedAt">N/A</span></p> <hr> <h5>Wallet</h5> <p>Total Balance: ₹<span id="userDetailBalance">0.00</span></p> <p>Winning Cash: ₹<span id="userDetailWinning">0.00</span></p> <p>Bonus Cash: ₹<span id="userDetailBonus">0.00</span></p> <hr> <h5>Referral Info</h5> <p><strong>Referral Code:</strong> <span id="userDetailReferralCode" class="text-info">N/A</span> <i class="bi bi-clipboard copy-btn ms-1" data-target="#userDetailReferralCode" title="Copy Code"></i></p> <p><strong>Referred By:</strong> <span id="userDetailReferredBy">N/A</span></p> <p><strong>Users Referred:</strong> <span id="userDetailReferredCount">N/A</span></p> </div> <div class="col-md-6"> <h5>Update Balance (Caution!)</h5> <form id="updateBalanceForm"> <input type="hidden" id="editUserUid"> <div class="row"> <div class="col-md-6 mb-3"> <label for="balanceUpdateAmount" class="form-label">Amount (+/-)</label> <input type="number" step="any" class="form-control" id="balanceUpdateAmount" placeholder="e.g., 50 or -20" required> </div> <div class="col-md-6 mb-3"> <label for="balanceUpdateType" class="form-label">Balance Type</label> <select id="balanceUpdateType" class="form-select" required> <option value="">--Select--</option> <option value="winningCash">Winning Cash</option> <option value="bonusCash">Bonus Cash</option> </select> </div> </div> <div class="mb-3"> <label for="balanceUpdateReason" class="form-label">Reason</label> <input type="text" class="form-control" id="balanceUpdateReason" placeholder="Manual Deposit, Correction etc." required> </div> <button type="submit" class="btn btn-warning">Update Balance</button> <div id="balanceUpdateStatus" class="mt-2"></div> </form> <hr> <h5>Status & Actions</h5> <p>Current Status: <span id="userDetailStatus" class="fw-bold"></span></p> <button class="btn btn-sm mb-2" id="userBlockBtn"></button> <button class="btn btn-sm btn-danger mb-2" id="userDeleteBtn"><i class="bi bi-trash"></i> Delete User (DB Only)</button> </div> </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> </div> </div> </div> </div>
    <div class="modal fade" id="withdrawalActionModal" tabindex="-1"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title">Withdrawal Action</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <p><strong>Request ID:</strong> <small id="withdrawalDetailId" class="text-muted withdrawal-id-copy"></small> <i class="bi bi-clipboard copy-btn ms-1" data-target="#withdrawalDetailId" title="Copy Request ID"></i></p> <p><strong>User:</strong> <span id="withdrawalDetailUser"></span> (<small id="withdrawalDetailUserUid" class="text-muted withdrawal-user-uid-copy"></small> <i class="bi bi-clipboard copy-btn ms-1" data-target="#withdrawalDetailUserUid" title="Copy User UID"></i>)</p> <p><strong>Amount:</strong> ₹<span id="withdrawalDetailAmount"></span></p> <p><strong>Method:</strong> <span id="withdrawalDetailMethod"></span></p> <hr> <div id="withdrawalRejectReasonDiv" style="display: none;" class="mb-3"> <label for="withdrawalRejectReason" class="form-label">Reason for Rejection</label> <textarea class="form-control" id="withdrawalRejectReason" rows="3" required></textarea> </div> <div id="withdrawalApproveNoteDiv" style="display: none;" class="mb-3"> <label for="withdrawalApproveNote" class="form-label">Admin Note / Txn ID (Optional)</label> <input type="text" class="form-control" id="withdrawalApproveNote" placeholder="e.g., Transaction ID"> </div> <div id="withdrawalActionStatus" class="mt-2"></div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button> <button type="button" class="btn btn-danger" id="rejectWithdrawalBtn">Reject</button> <button type="button" class="btn btn-success" id="approveWithdrawalBtn">Approve</button> </div> </div> </div> </div>
    <div class="modal fade" id="addUserModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Add New User</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="addUserForm"><div class="mb-3"><label for="newUserName" class="form-label">Display Name</label><input type="text" class="form-control" id="newUserName" required></div><div class="mb-3"><label for="newUserEmail" class="form-label">Email Address</label><input type="email" class="form-control" id="newUserEmail" required></div><div class="mb-3"><label for="newUserPassword" class="form-label">Password (min 6 chars)</label><input type="password" class="form-control" id="newUserPassword" required minlength="6"></div><div class="mb-3"><label for="newUserInitialBalance" class="form-label">Initial Balance (₹)</label><input type="number" step="any" class="form-control" id="newUserInitialBalance" value="0" min="0"><small class="text-muted">This will be added to Total Balance.</small></div><div id="addUserStatus" class="mt-2"></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button type="button" class="btn btn-primary" id="saveNewUserBtn">Create User</button></div></div></div></div>
    
    <!-- MODIFIED: Added columns for In-Game Name & ID -->
    <div class="modal fade" id="registeredPlayersModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="registeredPlayersModalTitle">Registered Players</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Tournament: <strong id="registeredPlayersTournamentName"></strong></p><div id="registeredPlayersStatus" class="mb-2"></div><div class="table-responsive"><table class="table table-dark table-sm table-hover"><thead><tr><th>User UID</th><th>Display Name</th><th>In-Game Name</th><th>In-Game ID</th><th>Joined At</th></tr></thead><tbody id="registeredPlayersTableBody"><tr><td colspan="5" class="text-center p-3"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div></td></tr></tbody></table></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div></div></div></div>

    <!-- DEPOSIT ACTION MODAL -->
    <div class="modal fade" id="depositActionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Deposit Action</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Request ID:</strong> <small id="depositDetailId" class="text-muted"></small></p>
                    <p><strong>User:</strong> <span id="depositDetailUser"></span></p>
                    <p><strong>Amount:</strong> <span id="depositDetailAmount" class="fw-bold text-success"></span></p>
                    <hr>
                    <p><strong>Method:</strong> <span id="depositDetailMethod"></span></p>
                    <p><strong>Game ID:</strong> <span id="depositDetailGameId"></span></p>
                    <p><strong>Transaction ID:</strong> <span id="depositDetailTxnId"></span></p>
                    <hr>
                    <div id="depositRejectReasonDiv" style="display: none;" class="mb-3">
                        <label for="depositRejectReason" class="form-label">Reason for Rejection</label>
                        <textarea class="form-control" id="depositRejectReason" rows="3" required></textarea>
                    </div>
                    <div id="depositApproveNoteDiv" style="display: none;" class="mb-3">
                        <label for="depositApproveNote" class="form-label">Admin Note (Optional)</label>
                        <input type="text" class="form-control" id="depositApproveNote" placeholder="e.g., Verified">
                    </div>
                    <div id="depositActionStatus" class="mt-2"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="rejectDepositBtn">Reject</button>
                    <button type="button" class="btn btn-success" id="approveDepositBtn">Approve</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, get, set, update, push, query, orderByChild, equalTo, onValue, off, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        // Firebase Config (Unchanged)
        const firebaseConfig = {
            apiKey: "AIzaSyBhE8HNbhHcL_DlGWDW4zu3AvE8VSeA8zE",
            authDomain: "l-tournament-10594.firebaseapp.com",
            databaseURL: "https://l-tournament-10594-default-rtdb.firebaseio.com",
            projectId: "l-tournament-10594",
            storageBucket: "l-tournament-10594.firebasestorage.app",
            messagingSenderId: "517389311136",
            appId: "1:517389311136:web:c05c333a3a15465fd37dc5"
        };

        // Firebase Initialization (Unchanged)
        let app, db, auth;
        try {
             if (firebaseConfig.apiKey.includes("YOUR_")) console.warn("Admin Panel: Using placeholder Firebase config.");
             app = initializeApp(firebaseConfig);
             db = getDatabase(app);
             auth = getAuth(app);
             console.log("Admin Panel: Firebase Initialized");
        } catch (error) {
             console.error("Admin Panel: Firebase initialization failed:", error);
             document.body.innerHTML = `<div class="alert alert-danger m-5"><strong>Critical Error:</strong> Could not connect. Check console & config.</div>`;
        }
        
        const getElement = (id) => document.getElementById(id);
        const querySel = (selector) => document.querySelector(selector);
        const querySelAll = (selector) => document.querySelectorAll(selector);
        
        const elements = {
             adminLoader: getElement('adminLoader'),
             authContainer: getElement('auth-container'),
             loginSection: getElement('admin-login-section'),
             setupSection: getElement('admin-setup-section'),
             mainArea: getElement('admin-main-area'),
             adminLoginForm: getElement('adminLoginForm'),
             adminEmailInput: getElement('adminEmail'),
             adminPasswordInput: getElement('adminPassword'),
             adminLoginStatus: getElement('adminLoginStatus'),
             adminSetupForm: getElement('adminSetupForm'),
             setupEmailInput: getElement('setupEmail'),
             setupPasswordInput: getElement('setupPassword'),
             setupStatus: getElement('adminSetupStatus'),
             adminUserEmailDisplay: getElement('adminUserEmailShort'),
             adminLogoutBtn: getElement('adminLogoutBtnHeader'),
             sidebar: getElement('adminSidebar'),
             sidebarLinks: querySelAll('#adminSidebar .nav-link'),
             sections: querySelAll('#adminMainContent .section'),
             adminPageTitle: getElement('adminPageTitle'),
             adminHeaderLogo: getElement('adminHeaderLogo'),
             dashboardSection: getElement('dashboard-section'),
             statTotalUsers: getElement('statTotalUsers'),
             statActiveTournaments: getElement('statActiveTournaments'),
             statPendingWithdrawals: getElement('statPendingWithdrawals'),
             statCompletedWithdrawals: getElement('statCompletedWithdrawals'),
             statRejectedWithdrawals: getElement('statRejectedWithdrawals'),
             statTotalGames: getElement('statTotalGames'),
             statTotalPromotions: getElement('statTotalPromotions'),
             statFinishedTournaments: getElement('statFinishedTournaments'),
             dashboardStatus: getElement('dashboardStatus'),
             pendingWithdrawalCountBadge: getElement('pendingWithdrawalCountBadge'),
             gamesTableBody: getElement('gamesTableBody'),
             gameModalEl: getElement('gameModal'),
             gameModalTitle: getElement('gameModalTitle'),
             gameForm: getElement('gameForm'),
             gameEditId: getElement('gameEditId'),
             gameNameInput: getElement('gameName'),
             gameImageFileInput: getElement('gameImageFile'),
             gameImageUrlInput: getElement('gameImageUrl'),
             saveGameBtn: getElement('saveGameBtn'),
             gameStatus: getElement('gameStatus'),
             gamesStatus: getElement('gamesStatus'),
             addNewGameBtn: getElement('addNewGameBtn'),
             promotionsTableBody: getElement('promotionsTableBody'),
             promotionModalEl: getElement('promotionModal'),
             promotionModalTitle: getElement('promotionModalTitle'),
             promotionForm: getElement('promotionForm'),
             promotionEditId: getElement('promotionEditId'),
             promoImageFileInput: getElement('promoImageFile'),
             promoImageUrlInput: getElement('promoImageUrl'),
             promoLinkInput: getElement('promoLink'),
             savePromotionBtn: getElement('savePromotionBtn'),
             promotionStatus: getElement('promotionStatus'),
             promotionsStatus: getElement('promotionsStatus'),
             addNewPromotionBtn: getElement('addNewPromotionBtn'),
             tournamentsTableBody: getElement('tournamentsTableBody'),
             addTournamentModalEl: getElement('addTournamentModal'),
             tournamentForm: getElement('tournamentForm'),
             tournamentModalTitle: getElement('tournamentModalTitle'),
             tournamentEditId: getElement('tournamentEditId'),
             tournamentGameSelect: getElement('tournamentGame'),
             tournamentNameInput: getElement('tournamentName'),
             tournamentStartTimeInput: getElement('tournamentStartTime'),
             tournamentStatusSelect: getElement('tournamentStatus'),
             tournamentEntryFeeInput: getElement('tournamentEntryFee'),
             tournamentPrizePoolInput: getElement('tournamentPrizePool'),
             tournamentPerKillInput: getElement('tournamentPerKill'),
             tournamentMaxPlayersInput: getElement('tournamentMaxPlayers'),
             tournamentTagsInput: getElement('tournamentTags'),
             tournamentModeInput: getElement('tournamentMode'),
             tournamentMapInput: getElement('tournamentMap'),
             tournamentDescriptionInput: getElement('tournamentDescription'),
             tournamentRoomIdInput: getElement('tournamentRoomId'),
             tournamentRoomPasswordInput: getElement('tournamentRoomPassword'),
             tournamentShowIdPassCheckbox: getElement('tournamentShowIdPass'),
             saveTournamentBtn: getElement('saveTournamentBtn'),
             addNewTournamentBtn: getElement('addNewTournamentBtn'),
             addTournamentStatus: getElement('addTournamentStatus'),
             tournamentsStatus: getElement('tournamentsStatus'),
             usersSection: getElement('users-section'),
             usersTableBody: getElement('usersTableBody'),
             userSearchInput: getElement('userSearchInput'),
             userModalEl: getElement('userModal'),
             userModalTitle: getElement('userModalTitle'),
             userDetailUid: getElement('userDetailUid'),
             userDetailEmail: getElement('userDetailEmail'),
             userDetailName: getElement('userDetailName'),
             userDetailCreatedAt: getElement('userDetailCreatedAt'),
             userDetailBalance: getElement('userDetailBalance'),
             userDetailWinning: getElement('userDetailWinning'),
             userDetailBonus: getElement('userDetailBonus'),
             userDetailReferralCode: getElement('userDetailReferralCode'),
             userDetailReferredBy: getElement('userDetailReferredBy'),
             userDetailReferredCount: getElement('userDetailReferredCount'),
             userDetailStatus: getElement('userDetailStatus'),
             updateBalanceForm: getElement('updateBalanceForm'),
             editUserUid: getElement('editUserUid'),
             balanceUpdateAmountInput: getElement('balanceUpdateAmount'),
             balanceUpdateTypeSelect: getElement('balanceUpdateType'),
             balanceUpdateReasonInput: getElement('balanceUpdateReason'),
             balanceUpdateStatus: getElement('balanceUpdateStatus'),
             userBlockBtn: getElement('userBlockBtn'),
             userDeleteBtn: getElement('userDeleteBtn'),
             addUserModalEl: getElement('addUserModal'),
             addUserForm: getElement('addUserForm'),
             newUserNameInput: getElement('newUserName'),
             newUserEmailInput: getElement('newUserEmail'),
             newUserPasswordInput: getElement('newUserPassword'),
             newUserInitialBalanceInput: getElement('newUserInitialBalance'),
             saveNewUserBtn: getElement('saveNewUserBtn'),
             addUserStatus: getElement('addUserStatus'),
             usersStatus: getElement('usersStatus'),
             pendingWithdrawalsTableBody: getElement('pendingWithdrawalsTableBody'),
             completedWithdrawalsTableBody: getElement('completedWithdrawalsTableBody'),
             rejectedWithdrawalsTableBody: getElement('rejectedWithdrawalsTableBody'),
             withdrawalActionModalEl: getElement('withdrawalActionModal'),
             withdrawalDetailId: getElement('withdrawalDetailId'),
             withdrawalDetailUser: getElement('withdrawalDetailUser'),
             withdrawalDetailUserUid: getElement('withdrawalDetailUserUid'),
             withdrawalDetailAmount: getElement('withdrawalDetailAmount'),
             withdrawalDetailMethod: getElement('withdrawalDetailMethod'),
             withdrawalRejectReasonDiv: getElement('withdrawalRejectReasonDiv'),
             withdrawalRejectReasonInput: getElement('withdrawalRejectReason'),
             withdrawalApproveNoteDiv: getElement('withdrawalApproveNoteDiv'),
             withdrawalApproveNoteInput: getElement('withdrawalApproveNote'),
             withdrawalActionStatus: getElement('withdrawalActionStatus'),
             rejectWithdrawalBtn: getElement('rejectWithdrawalBtn'),
             approveWithdrawalBtn: getElement('approveWithdrawalBtn'),
             withdrawalsStatus: getElement('withdrawalsStatus'),
             registeredPlayersModalEl: getElement('registeredPlayersModal'),
             registeredPlayersModalTitle: getElement('registeredPlayersModalTitle'),
             registeredPlayersTournamentName: getElement('registeredPlayersTournamentName'),
             registeredPlayersTableBody: getElement('registeredPlayersTableBody'),
             registeredPlayersStatus: getElement('registeredPlayersStatus'),
             settingsSection: getElement('settings-section'),
             appSettingsForm: getElement('appSettingsForm'),
             settingLogoUrlInput: getElement('settingLogoUrl'),
             settingAppNameInput: getElement('settingAppName'),
             settingMinWithdrawInput: getElement('settingMinWithdraw'),
             settingReferralBonusInput: getElement('settingReferralBonus'),
             settingSupportContactInput: getElement('settingSupportContact'),
             settingUpiDetailsInput: getElement('settingUpiDetails'),
             settingPolicyPrivacyInput: getElement('settingPolicyPrivacy'),
             settingPolicyTermsInput: getElement('settingPolicyTerms'),
             settingPolicyRefundInput: getElement('settingPolicyRefund'),
             settingPolicyFairPlayInput: getElement('settingPolicyFairPlay'),
             settingsStatus: getElement('settingsStatus'),
             themeSection: getElement('theme-section'),
             themeStatus: getElement('themeStatus'),
             customThemeForm: getElement('customThemeForm'),
             themeColorPickers: querySelAll('#customThemeForm input[type="color"]'),
             saveThemeBtn: getElement('saveThemeBtn'),
             resetThemeBtn: getElement('resetThemeBtn'),
             previewDefaultThemeBtn: getElement('previewDefaultThemeBtn'),
             previewCrimsonThemeBtn: getElement('previewCrimsonThemeBtn'),
             previewOceanicThemeBtn: getElement('previewOceanicThemeBtn'),
             addDemoDataBtn: getElement('addDemoDataBtn'),
             transactionsSection: getElement('transactions-section'),
             depositsStatus: getElement('depositsStatus'),
             pendingDepositCountBadge: getElement('pendingDepositCountBadge'),
             pendingDepositsTableBody: getElement('pendingDepositsTableBody'),
             approvedDepositsTableBody: getElement('approvedDepositsTableBody'),
             rejectedDepositsTableBody: getElement('rejectedDepositsTableBody'),
             depositActionModalEl: getElement('depositActionModal'),
             depositDetailId: getElement('depositDetailId'),
             depositDetailUser: getElement('depositDetailUser'),
             depositDetailAmount: getElement('depositDetailAmount'),
             depositDetailMethod: getElement('depositDetailMethod'),
             depositDetailGameId: getElement('depositDetailGameId'),
             depositDetailTxnId: getElement('depositDetailTxnId'),
             depositRejectReasonDiv: getElement('depositRejectReasonDiv'),
             depositRejectReasonInput: getElement('depositRejectReason'),
             depositApproveNoteDiv: getElement('depositApproveNoteDiv'),
             depositApproveNoteInput: getElement('depositApproveNote'),
             depositActionStatus: getElement('depositActionStatus'),
             rejectDepositBtn: getElement('rejectDepositBtn'),
             approveDepositBtn: getElement('approveDepositBtn'),
             notificationsSection: getElement('notifications-section'),
             notificationStatus: getElement('notificationStatus'),
             sendSingleNotificationForm: getElement('sendSingleNotificationForm'),
             singleNotificationUid: getElement('singleNotificationUid'),
             singleNotificationTitle: getElement('singleNotificationTitle'),
             singleNotificationMessage: getElement('singleNotificationMessage'),
             sendBroadcastNotificationForm: getElement('sendBroadcastNotificationForm'),
             broadcastNotificationTitle: getElement('broadcastNotificationTitle'),
             broadcastNotificationMessage: getElement('broadcastNotificationMessage'),
             updatesStatus: getElement('updatesStatus'),
             updatesTableBody: getElement('updatesTableBody'),
             addNewUpdateBtn: getElement('addNewUpdateBtn'),
             updateModalEl: getElement('updateModal'),
             updateModalTitle: getElement('updateModalTitle'),
             updateForm: getElement('updateForm'),
             updateEditId: getElement('updateEditId'),
             updateTitleInput: getElement('updateTitle'),
             updateImageUrlInput: getElement('updateImageUrl'),
             saveUpdateBtn: getElement('saveUpdateBtn'),
             updateStatus: getElement('updateStatus')
        };
        
        let componentInstances = {};
        const getComponentInstance = (element, componentType = 'Modal') => { if (!element) return null; const instanceKey = `${componentType}-${element.id}`; if (!componentInstances[instanceKey]) { try { if (componentType === 'Modal') componentInstances[instanceKey] = new bootstrap.Modal(element); else if (componentType === 'Offcanvas') componentInstances[instanceKey] = new bootstrap.Offcanvas(element); else if (componentType === 'Tab') componentInstances[instanceKey] = new bootstrap.Tab(element); else if (componentType === 'Alert') componentInstances[instanceKey] = new bootstrap.Alert(element); else if (componentType === 'Toast') componentInstances[instanceKey] = new bootstrap.Toast(element); else { console.warn("Unknown Bootstrap component type:", componentType); return null; } } catch (e) { console.error(`Error creating Bootstrap ${componentType} instance for #${element.id}:`, e); return null; } } return componentInstances[instanceKey]; }
        const getModalInstance = (element) => getComponentInstance(element, 'Modal');
        const getOffcanvasInstance = (element) => getComponentInstance(element, 'Offcanvas');
        let currentAdminUser = null;
        let currentWithdrawalAction = { id: null, type: null, userId: null };
        let currentDepositAction = { id: null, type: null, userId: null }; 
        let currentEditingItemId = null;
        let currentEditingTournamentId = null;
        let gameDataCache = {};
        let userDataCache = {};
        let fullUserDataCache = {};
        let dbListeners = {};
        let isAdminSetupComplete = false;
        let designatedAdminUid = null;
        let appSettings = {};
        const defaultTheme = {'--primary-bg':'#0F172A','--secondary-bg':'#1E293B','--card-bg':'#1E293B','--text-primary':'#E2E8F0','--text-secondary':'#94A3B8','--accent-color':'#FACC15','--primary-button-bg':'#3B82F6','--border-color':'#334155',};
        const crimsonTheme = {'--primary-bg':'#1a0005','--secondary-bg':'#2e0009','--card-bg':'#2e0009','--text-primary':'#fce7f3','--text-secondary':'#e9a8d9','--accent-color':'#f43f5e','--primary-button-bg':'#be185d','--border-color':'#500724',};
        const oceanicTheme = {'--primary-bg':'#0c1445','--secondary-bg':'#182157','--card-bg':'#182157','--text-primary':'#e0e7ff','--text-secondary':'#a5b4fc','--accent-color':'#38bdf8','--primary-button-bg':'#4338ca','--border-color':'#312e81',};
        
        function isDesignatedAdmin(user) { if (!user) return false; if (!designatedAdminUid) { console.warn("Designated Admin UID check failed: UID not loaded yet."); return false; } return user.uid === designatedAdminUid; }
        
        const showLoader = (show) => { if (elements.adminLoader) elements.adminLoader.style.display = show ? 'flex' : 'none'; };
        function showStatus(element, message, type = 'danger', autohide = 5000) { if (!element) { console.warn("showStatus called with null element for message:", message); return; } const alertId = `status-alert-${element.id || Math.random().toString(36).substring(2)}`; element.style.display = 'block'; element.innerHTML = `<div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">${sanitizeHTML(message)}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`; if (autohide && typeof autohide === 'number' && autohide > 0) { setTimeout(() => { const currentAlert = getElement(alertId); if (currentAlert) { try { const bsAlert = getComponentInstance(currentAlert, 'Alert'); if (bsAlert) bsAlert.close(); else currentAlert.remove(); } catch (e) { console.warn("Error closing alert:", e); currentAlert.remove(); } } }, autohide); } }
        function clearStatus(element) { if (!element) return; element.innerHTML = ''; }
        const formatDate = (timestamp) => { if (!timestamp) return 'N/A'; if (typeof timestamp === 'object' && timestamp.hasOwnProperty('.sv')) { return 'Pending...'; } const tsNumber = Number(timestamp); if (isNaN(tsNumber) || tsNumber <= 0) return 'Invalid Date'; try { const date = new Date(tsNumber); if (isNaN(date.getTime())) return 'Invalid Date'; return date.toLocaleString([], { dateStyle: 'short', timeStyle: 'short'}); } catch (e) { console.warn("Error formatting date:", timestamp, e); return 'Invalid Date'; } };
        const formatCurrency = (amount) => { const num = Number(amount); return isNaN(num) ? '₹--' : `₹${num.toFixed(2)}`; }
        function sanitizeHTML(str) { if (str == null) return ''; str = String(str); const temp = document.createElement('div'); temp.textContent = str; return temp.innerHTML; }
        function copyToClipboard(targetSelector) { const copyIcon = event?.target.closest('.copy-btn'); const context = copyIcon?.closest('.modal-body, tr'); const element = context?.querySelector(targetSelector); const textToCopy = element?.textContent?.trim(); if (!textToCopy) { console.warn("Copy target empty or not found:", targetSelector); return; } if (navigator.clipboard && window.isSecureContext) { navigator.clipboard.writeText(textToCopy).then(() => { const toastEl = document.createElement('div'); toastEl.className = 'toast position-fixed bottom-0 end-0 p-3 m-3 text-bg-success border-0'; toastEl.setAttribute('role', 'alert'); toastEl.setAttribute('aria-live', 'assertive'); toastEl.setAttribute('aria-atomic', 'true'); toastEl.innerHTML = '<div class="toast-body">Copied!</div>'; document.body.appendChild(toastEl); const toast = getComponentInstance(toastEl, 'Toast'); if(toast) toast.show(); toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove()); }).catch(err => { console.warn('Clipboard writeText failed: ', err); alert('Could not copy.'); }); } else { const textArea = document.createElement("textarea"); textArea.value = textToCopy; textArea.style.position = "fixed"; textArea.style.left = "-9999px"; textArea.style.top = "0"; document.body.appendChild(textArea); textArea.focus(); textArea.select(); try { document.execCommand('copy'); alert('Copied! (fallback)'); } catch (err) { console.warn('Fallback copy failed: ', err); alert('Copy failed.'); } document.body.removeChild(textArea); } }
        const tableLoadingPlaceholderHtml = (cols) => `<tr class="loading-placeholder"><td colspan="${cols}"><div class="placeholder w-100 py-3"></div></td></tr>`.repeat(3);

        function showAdminSection(sectionId) {
             elements.sections.forEach(sec => sec.classList.remove('active'));
             const targetSection = getElement(sectionId);
             if (targetSection) {
                 targetSection.classList.add('active');
                 const linkElement = querySel(`#adminSidebar .nav-link[data-section="${sectionId}"]`);
                 let title = 'Admin Panel';
                 if (linkElement) {
                     const linkText = linkElement.textContent.trim() || sectionId.replace('-section', '').replace('-', ' ');
                     title = linkText.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                     const badge = linkElement.querySelector('.badge');
                     if (badge) { title = title.replace(badge.textContent, '').trim(); }
                 }
                 if(elements.adminPageTitle) elements.adminPageTitle.textContent = title;
                 elements.sidebarLinks?.forEach(link => { link.classList.toggle('active', link.dataset.section === sectionId); });
                 loadDataForSection(sectionId);
                 const sidebar = getOffcanvasInstance(elements.sidebar);
                 if (sidebar?._isShown) sidebar.hide();
             } else {
                 console.error("Section element not found:", sectionId);
                 showAdminSection('dashboard-section');
             }
        }
        
        function loadDataForSection(sectionId) {
             if (!currentAdminUser || !isDesignatedAdmin(currentAdminUser)) {
                 console.warn("Attempted to load data without proper admin authorization.");
                 showStatus(elements.dashboardStatus, "Admin not authorized.", "danger", false);
                 return;
             }
             console.log(`Loading data for section: ${sectionId}`);
             clearStatus(elements.dashboardStatus); clearStatus(elements.gamesStatus); clearStatus(elements.promotionsStatus);
             clearStatus(elements.tournamentsStatus); clearStatus(elements.usersStatus); clearStatus(elements.withdrawalsStatus);
             clearStatus(elements.settingsStatus); clearStatus(elements.themeStatus);
             clearStatus(elements.depositsStatus); clearStatus(elements.notificationStatus); clearStatus(elements.updatesStatus);

             switch(sectionId) {
                 case 'dashboard-section': loadDashboardStats(); break;
                 case 'games-section': loadGames(); break;
                 case 'promotions-section': loadPromotions(); break;
                 case 'update-section': loadUpdates(); break;
                 case 'tournaments-section': loadTournaments(); break;
                 case 'users-section': loadUsers(); break;
                 case 'withdrawals-section':
                    loadWithdrawals('pending'); loadWithdrawals('completed'); loadWithdrawals('rejected');
                     const activeWithdrawalTab = querySel('#withdrawalTabs .nav-link.active') || getElement('pending-tab');
                     if (activeWithdrawalTab) getComponentInstance(activeWithdrawalTab, 'Tab')?.show();
                    break;
                 case 'deposits-section':
                    loadDeposits('pending'); loadDeposits('approved'); loadDeposits('rejected');
                    const activeDepositTab = querySel('#depositTabs .nav-link.active') || getElement('pending-deposit-tab');
                    if (activeDepositTab) getComponentInstance(activeDepositTab, 'Tab')?.show();
                    break;
                 case 'notifications-section': 
                    elements.sendSingleNotificationForm.reset();
                    elements.sendBroadcastNotificationForm.reset();
                    break; 
                 case 'settings-section': loadSettings(); break;
                 case 'theme-section': loadThemeSettings(); break;
                 case 'transactions-section':
                     if (elements.transactionsSection) elements.transactionsSection.innerHTML = '<div class="card-body"><h2 class="card-title">User Transactions</h2><p class="text-muted">Section under development.</p></div>';
                     break;
                 default: console.warn("Unknown section requested:", sectionId); showStatus(elements.dashboardStatus, `Unknown section requested: ${sectionId}`, "warning");
             }
         }

        async function loginAdmin(event) { event.preventDefault(); if (!auth) return; const email = elements.adminEmailInput.value; const password = elements.adminPasswordInput.value; clearStatus(elements.adminLoginStatus); showLoader(true); try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { console.error("Admin Login Error:", error); let message = `Login Failed: ${error.code}`; if (error.code === 'auth/network-request-failed') { message = "Login Failed: Network error."; } else if (['auth/invalid-credential', 'auth/wrong-password', 'auth/user-not-found', 'auth/invalid-email'].includes(error.code)) { message = "Login Failed: Invalid email or password."; } else if (error.code === 'auth/too-many-requests') { message = "Login Failed: Too many attempts."; } showStatus(elements.adminLoginStatus, message, 'danger', false); } finally { showLoader(false); } }
        async function logoutAdminUser() { if (!auth) return; showLoader(true); try { await signOut(auth); } catch (error) { console.error("Admin Logout Error:", error); alert("Logout failed: " + error.message); } }
        async function checkAdminSetup() { if (!db) return false; const adminConfigRef = ref(db, 'adminConfig'); try { console.log("Checking admin setup..."); const snapshot = await get(adminConfigRef); if (snapshot.exists()) { const d = snapshot.val(); isAdminSetupComplete = d.setupComplete === true; designatedAdminUid = d.adminUid || null; } else { isAdminSetupComplete = false; designatedAdminUid = null; } console.log("Admin setup check:", isAdminSetupComplete, "| UID:", designatedAdminUid); return isAdminSetupComplete; } catch (error) { console.error("Error checking admin setup:", error); const el = elements.loginSection?.style.display === 'block' ? elements.adminLoginStatus : elements.setupStatus; if (el) showStatus(el, `Config check error: ${error.message}. Check Rules.`, "danger", false); isAdminSetupComplete = false; designatedAdminUid = null; return false; } }
        async function setupAdmin(event) { event.preventDefault(); if (!auth || !db || isAdminSetupComplete) return; const email = elements.setupEmailInput.value.trim(); const password = elements.setupPasswordInput.value; clearStatus(elements.setupStatus); if (password.length < 6) { showStatus(elements.setupStatus, "Password min 6 chars.", "warning"); return; } showLoader(true); try { const cred = await createUserWithEmailAndPassword(auth, email, password); const uid = cred.user.uid; console.log("Admin user created in Auth:", uid); await set(ref(db, 'adminConfig'), { setupComplete: true, adminUid: uid }); console.log("Admin setup complete in DB."); isAdminSetupComplete = true; designatedAdminUid = uid; await signOut(auth); alert("Admin account created! Please login now."); await handleInitialLoad(); } catch (error) { console.error("Admin Setup Error:", error); let message = `Setup failed: ${error.message}`; if (error.code === 'auth/email-already-in-use') message = "Email already in use."; else if (error.code === 'auth/weak-password') message = "Password is too weak."; else if (error.code === 'auth/invalid-email') message = "Invalid email format."; else if (error.code === 'permission-denied') message = "Setup failed: Permission denied writing config. Check Firebase Rules for '/adminConfig'."; showStatus(elements.setupStatus, message, "danger", false); isAdminSetupComplete = false; designatedAdminUid = null; } finally { showLoader(false); } }
        async function handleInitialLoad() { if (!auth || !db) return; showLoader(true); await checkAdminSetup(); elements.setupSection.style.display = 'none'; elements.loginSection.style.display = 'none'; elements.mainArea.style.display = 'none'; elements.authContainer.style.display = 'block'; if (!isAdminSetupComplete) { elements.setupSection.style.display = 'block'; console.log("Showing Setup Form"); } else { elements.loginSection.style.display = 'block'; console.log("Showing Login Form"); } showLoader(false); }
        async function handleAdminAuthStateChange(user) { if (!auth || !db) return; console.log("Auth State Changed. User:", user ? user.uid : 'null'); showLoader(true); currentAdminUser = user; detachAllAdminListeners(); if (user) { if (!designatedAdminUid) await checkAdminSetup(); if (isDesignatedAdmin(user)) { console.log("Admin Authenticated & Authorized:", user.email); if (elements.adminUserEmailDisplay) elements.adminUserEmailDisplay.textContent = user.email; elements.authContainer.style.display = 'none'; elements.mainArea.style.display = 'block'; await loadSettings(); showAdminSection('dashboard-section'); setupRealtimeAdminListeners(); } else { console.warn("Unauthorized user login attempt:", user.email, "| UID:", user.uid, "| Expected:", designatedAdminUid); alert(`Access Denied. ${user.email} is not the designated admin.`); await logoutAdminUser(); return; } } else { console.log("Auth State: Logged Out"); currentAdminUser = null; designatedAdminUid = null; isAdminSetupComplete = false; elements.mainArea.style.display = 'none'; elements.authContainer.style.display = 'block'; gameDataCache = {}; userDataCache = {}; fullUserDataCache = {}; appSettings = {}; if(elements.adminHeaderLogo) { elements.adminHeaderLogo.src='https://via.placeholder.com/35/1E293B/94A3B8?text=L'; elements.adminHeaderLogo.style.display='none'; } if(elements.adminPageTitle) elements.adminPageTitle.textContent='Admin Panel'; document.title='Admin Panel'; if(elements.adminUserEmailDisplay) elements.adminUserEmailDisplay.textContent=''; Object.values(elements).filter(el => el.id?.startsWith('stat')).forEach(el => el.textContent = '--'); if(elements.pendingWithdrawalCountBadge) { elements.pendingWithdrawalCountBadge.textContent='0'; elements.pendingWithdrawalCountBadge.style.display='none';} if(elements.userSearchInput) elements.userSearchInput.value = ''; await handleInitialLoad(); } setTimeout(() => showLoader(false), 150); }
        
        async function loadDashboardStats() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; console.log("Loading dashboard stats..."); clearStatus(elements.dashboardStatus); Object.values(elements).filter(el => el.id?.startsWith('stat')).forEach(el => el.textContent = '...'); const usersRef = ref(db, 'users'); const gamesRef = ref(db, 'games'); const promotionsRef = ref(db, 'promotions'); const tournamentsRef = ref(db, 'tournaments'); const withdrawalsRef = ref(db, 'withdrawals'); const activeTournamentsQuery = query(tournamentsRef, orderByChild('status')); const pendingWithdrawalsQuery = query(withdrawalsRef, orderByChild('status'), equalTo('pending')); const completedWithdrawalsQuery = query(withdrawalsRef, orderByChild('status'), equalTo('completed')); const rejectedWithdrawalsQuery = query(withdrawalsRef, orderByChild('status'), equalTo('rejected')); const results = await Promise.allSettled([get(usersRef), get(gamesRef), get(promotionsRef), get(activeTournamentsQuery), get(pendingWithdrawalsQuery), get(completedWithdrawalsQuery), get(rejectedWithdrawalsQuery)]); let errorsFound = false; const setError = (element) => { element.textContent = 'Error'; errorsFound = true; }; if (results[0].status === 'fulfilled') elements.statTotalUsers.textContent = results[0].value.exists() ? results[0].value.size : 0; else { console.error("Err Users:", results[0].reason); setError(elements.statTotalUsers); showStatus(elements.dashboardStatus, `Err Users: ${results[0].reason?.message}`, "warning"); } if (results[1].status === 'fulfilled') elements.statTotalGames.textContent = results[1].value.exists() ? results[1].value.size : 0; else { console.error("Err Games:", results[1].reason); setError(elements.statTotalGames); } if (results[2].status === 'fulfilled') elements.statTotalPromotions.textContent = results[2].value.exists() ? results[2].value.size : 0; else { console.error("Err Promos:", results[2].reason); setError(elements.statTotalPromotions); } if (results[3].status === 'fulfilled') { let activeCount = 0; let finishedCount = 0; if (results[3].value.exists()) { results[3].value.forEach(child => { const status = child.val()?.status; if (status === 'ongoing' || status === 'upcoming') activeCount++; else if (status === 'completed' || status === 'result' || status === 'cancelled') finishedCount++; }); } elements.statActiveTournaments.textContent = activeCount; elements.statFinishedTournaments.textContent = finishedCount; } else { console.error("Err Tournaments:", results[3].reason); setError(elements.statActiveTournaments); setError(elements.statFinishedTournaments); if (results[3].reason?.message?.includes("index")) showStatus(elements.dashboardStatus, "WARNING: Tournament query fail. Add '.indexOn': 'status' to '/tournaments' rules.", "warning", false); else showStatus(elements.dashboardStatus, `Err Tournaments: ${results[3].reason?.message}`, "warning"); } if (results[4].status === 'fulfilled') { const count = results[4].value.exists() ? results[4].value.size : 0; elements.statPendingWithdrawals.textContent = count; elements.pendingWithdrawalCountBadge.textContent = count; elements.pendingWithdrawalCountBadge.style.display = count > 0 ? 'inline-block' : 'none'; } else { console.error("Err Pending Withdrawals:", results[4].reason); setError(elements.statPendingWithdrawals); elements.pendingWithdrawalCountBadge.textContent = 'Err'; elements.pendingWithdrawalCountBadge.style.display = 'inline-block'; if (results[4].reason?.message?.includes("index")) showStatus(elements.dashboardStatus, "CRITICAL: Pending withdrawal query fail. Add '.indexOn': 'status' to '/withdrawals' rules.", "danger", false); else showStatus(elements.dashboardStatus, `Err Pending Withdrawals: ${results[4].reason?.message}`, "warning"); } if (results[5].status === 'fulfilled') elements.statCompletedWithdrawals.textContent = results[5].value.exists() ? results[5].value.size : 0; else { console.error("Err Completed Withdrawals:", results[5].reason); setError(elements.statCompletedWithdrawals); if (results[5].reason?.message?.includes("index")) showStatus(elements.dashboardStatus, "WARNING: Completed withdrawal query fail. Add '.indexOn': 'status' to '/withdrawals' rules.", "warning", false); } if (results[6].status === 'fulfilled') elements.statRejectedWithdrawals.textContent = results[6].value.exists() ? results[6].value.size : 0; else { console.error("Err Rejected Withdrawals:", results[6].reason); setError(elements.statRejectedWithdrawals); if (results[6].reason?.message?.includes("index")) showStatus(elements.dashboardStatus, "WARNING: Rejected withdrawal query fail. Add '.indexOn': 'status' to '/withdrawals' rules.", "warning", false); } console.log("Dashboard stats loading complete.", errorsFound ? "Errors occurred." : "");}
        async function loadGames() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; const gamesRef = ref(db, 'games'); elements.gamesTableBody.innerHTML = tableLoadingPlaceholderHtml(4); gameDataCache = {}; clearStatus(elements.gamesStatus); try { const snapshot = await get(gamesRef); let tableHtml = ''; if (snapshot.exists()) { snapshot.forEach(childSnapshot => { const gameId = childSnapshot.key; const game = childSnapshot.val(); if (game && game.name) { gameDataCache[gameId] = game.name; tableHtml += `<tr><td><img src="${sanitizeHTML(game.imageUrl || 'https://via.placeholder.com/60x40/1E293B/94A3B8?text=N/A')}" alt="${sanitizeHTML(game.name)}" class="preview-img"></td><td>${sanitizeHTML(game.name)}</td><td><small class="text-muted">${sanitizeHTML(gameId)}</small> <i class="bi bi-clipboard copy-btn ms-1" data-target="td:nth-child(3) > small" title="Copy Game ID"></i></td><td class="action-buttons"><button class="btn btn-sm btn-info btn-edit-game" data-id="${sanitizeHTML(gameId)}" title="Edit Game"><i class="bi bi-pencil-square"></i></button><button class="btn btn-sm btn-danger btn-delete-game" data-id="${sanitizeHTML(gameId)}" title="Delete Game"><i class="bi bi-trash"></i></button></td></tr>`; } else { console.warn("Skipping invalid game data:", gameId, game); } }); } elements.gamesTableBody.innerHTML = tableHtml || `<tr><td colspan="4" class="text-center p-3 text-muted">No games found. Add one using the button above.</td></tr>`; if (elements.dashboardSection?.classList.contains('active')) { elements.statTotalGames.textContent = Object.keys(gameDataCache).length; } } catch (error) { console.error("Error loading games:", error); elements.gamesTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-3 text-danger">Error loading games: ${error.message}. Check console & Rules.</td></tr>`; showStatus(elements.gamesStatus, `Error loading games: ${error.message}. Check Rules.`, 'danger', false); if (elements.dashboardSection?.classList.contains('active')) elements.statTotalGames.textContent = 'Error'; } }
        async function loadPromotions() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; const promotionsRef = ref(db, 'promotions'); elements.promotionsTableBody.innerHTML = tableLoadingPlaceholderHtml(3); clearStatus(elements.promotionsStatus); let promoCount = 0; try { const snapshot = await get(promotionsRef); let tableHtml = ''; if (snapshot.exists()) { promoCount = snapshot.size; snapshot.forEach(childSnapshot => { const promoId = childSnapshot.key; const promo = childSnapshot.val(); if (promo && promo.imageUrl) { const displayLink = promo.link ? sanitizeHTML(promo.link) : ''; const shortLink = displayLink.length > 50 ? displayLink.substring(0, 50) + '...' : displayLink; tableHtml += `<tr><td><img src="${sanitizeHTML(promo.imageUrl)}" alt="Promotion" class="preview-img"></td><td>${promo.link ? `<a href="${displayLink}" target="_blank" class="text-info" title="${displayLink}">${shortLink}</a>` : '<span class="text-muted">No Link</span>'}</td><td class="action-buttons"><button class="btn btn-sm btn-info btn-edit-promo" data-id="${sanitizeHTML(promoId)}" title="Edit Promotion"><i class="bi bi-pencil-square"></i></button><button class="btn btn-sm btn-danger btn-delete-promo" data-id="${sanitizeHTML(promoId)}" title="Delete Promotion"><i class="bi bi-trash"></i></button></td></tr>`; } else { console.warn("Skipping invalid promotion data:", promoId, promo); } }); } elements.promotionsTableBody.innerHTML = tableHtml || `<tr><td colspan="3" class="text-center p-3 text-muted">No promotions found.</td></tr>`; if (elements.dashboardSection?.classList.contains('active')) { elements.statTotalPromotions.textContent = promoCount; } } catch (error) { console.error("Error loading promotions:", error); elements.promotionsTableBody.innerHTML = `<tr><td colspan="3" class="text-center p-3 text-danger">Error loading promotions: ${error.message}. Check console & Rules.</td></tr>`; showStatus(elements.promotionsStatus, `Error loading promotions: ${error.message}. Check Rules.`, 'danger', false); if (elements.dashboardSection?.classList.contains('active')) elements.statTotalPromotions.textContent = 'Error'; } }
        async function loadTournaments() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; const tournamentsRef = ref(db, 'tournaments'); if (Object.keys(gameDataCache).length === 0) await loadGames(); elements.tournamentsTableBody.innerHTML = tableLoadingPlaceholderHtml(8); clearStatus(elements.tournamentsStatus); try { const snapshot = await get(tournamentsRef); let activeCount = 0; let finishedCount = 0; let tableHtml = ''; if (snapshot.exists()) { snapshot.forEach(childSnapshot => { const tournamentId = childSnapshot.key; const t = childSnapshot.val(); if (t && t.name && t.gameId && t.status) { const gameName = gameDataCache[t.gameId] || `<small class="text-warning" title="ID: ${t.gameId}">Unknown</small>`; let statusClass = 'secondary'; if (t.status === 'ongoing') { statusClass = 'success'; activeCount++; } else if (t.status === 'upcoming') { statusClass = 'info'; activeCount++; } else if (t.status === 'result') { statusClass = 'primary'; finishedCount++; } else if (t.status === 'completed') { statusClass = 'secondary'; finishedCount++; } else if (t.status === 'cancelled') { statusClass = 'danger'; finishedCount++; } const statusBadge = `<span class="status-badge text-bg-${statusClass}">${t.status}</span>`; const registeredCount = t.registeredPlayers ? Object.keys(t.registeredPlayers).length : 0; const maxPlayers = t.maxPlayers > 0 ? `/${t.maxPlayers}` : ''; const playersDisplay = `${registeredCount}${maxPlayers}`; tableHtml += `<tr><td>${sanitizeHTML(t.name)}</td><td>${gameName}</td><td>${formatCurrency(t.entryFee)}</td><td>${formatCurrency(t.prizePool)}</td><td>${formatDate(t.startTime)}</td><td>${statusBadge}</td><td>${playersDisplay}</td><td class="action-buttons"><button class="btn btn-sm btn-info btn-edit-tournament" data-id="${sanitizeHTML(tournamentId)}" title="Edit"><i class="bi bi-pencil-square"></i></button><button class="btn btn-sm btn-secondary btn-view-registered" data-id="${sanitizeHTML(tournamentId)}" data-name="${sanitizeHTML(t.name)}" title="View Players"><i class="bi bi-people"></i></button><button class="btn btn-sm btn-danger btn-delete-tournament" data-id="${sanitizeHTML(tournamentId)}" title="Delete"><i class="bi bi-trash"></i></button></td></tr>`; } else { console.warn("Skipping invalid tournament data:", tournamentId, t); } }); } elements.tournamentsTableBody.innerHTML = tableHtml || `<tr><td colspan="8" class="text-center p-3 text-muted">No tournaments found.</td></tr>`; if (elements.dashboardSection?.classList.contains('active')) { elements.statActiveTournaments.textContent = activeCount; elements.statFinishedTournaments.textContent = finishedCount; } } catch (error) { console.error("Error loading tournaments:", error); elements.tournamentsTableBody.innerHTML = `<tr><td colspan="8" class="text-center p-3 text-danger">Error: ${error.message}. Check Rules.</td></tr>`; showStatus(elements.tournamentsStatus, `Error loading tournaments: ${error.message}. Check Rules.`, 'danger', false); if (elements.dashboardSection?.classList.contains('active')) { elements.statActiveTournaments.textContent = 'Error'; elements.statFinishedTournaments.textContent = 'Error'; } } }
        
        // MODIFIED: This function now calculates Total Balance correctly.
        function renderUsersTable(usersArray) {
            let tableHtml = '';
            if (usersArray?.length > 0) {
                usersArray.sort((a, b) => (a.displayName || '').localeCompare(b.displayName || '', undefined, { sensitivity: 'base' }));
                usersArray.forEach(user => {
                    if (user?.email && user.uid) {
                        const status = user.status || 'active';
                        const statusBadge = `<span class="status-badge text-bg-${status === 'active' ? 'success' : 'danger'}">${status}</span>`;
                        
                        // MODIFICATION: Calculate total balance from components instead of using the 'balance' field.
                        // EXPLANATION: This ensures the displayed value is always correct, as per your formula: Win cash + Bonus cash.
                        const totalBalance = (Number(user.winningCash) || 0) + (Number(user.bonusCash) || 0);

                        tableHtml += `<tr>
                            <td><small class="text-muted">${sanitizeHTML(user.uid)}</small> <i class="bi bi-clipboard copy-btn ms-1" data-target="td:first-child > small" title="Copy UID"></i></td>
                            <td>${sanitizeHTML(user.displayName || 'N/A')}</td>
                            <td>${sanitizeHTML(user.email)}</td>
                            <td>${formatCurrency(totalBalance)}</td>
                            <td>${statusBadge}</td>
                            <td class="action-buttons">
                                <button class="btn btn-sm btn-info btn-view-user" data-id="${sanitizeHTML(user.uid)}" title="View/Edit"><i class="bi bi-eye"></i></button>
                                <button class="btn btn-sm btn-danger btn-delete-user" data-id="${sanitizeHTML(user.uid)}" title="Delete (DB Only)"><i class="bi bi-trash"></i></button>
                            </td>
                        </tr>`;
                    }
                });
            }
            elements.usersTableBody.innerHTML = tableHtml || `<tr><td colspan="6" class="text-center p-3 text-muted">No users found matching criteria.</td></tr>`;
        }

        async function loadUsers() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; const usersRef = ref(db, 'users'); elements.usersTableBody.innerHTML = tableLoadingPlaceholderHtml(6); userDataCache = {}; fullUserDataCache = {}; clearStatus(elements.usersStatus); elements.userSearchInput.value = ''; const listenerKey = 'users'; if (dbListeners[listenerKey]) try { off(usersRef, 'value', dbListeners[listenerKey]); delete dbListeners[listenerKey]; console.log("Detached previous users listener."); } catch(e) { console.warn("Could not detach users listener", e); } dbListeners[listenerKey] = onValue(usersRef, (snapshot) => { console.log("Users data received via listener."); let userCount = 0; const usersArray = []; fullUserDataCache = {}; userDataCache = {}; if (snapshot.exists()) { snapshot.forEach(childSnapshot => { userCount++; const userId = childSnapshot.key; const user = childSnapshot.val(); if (user && user.email) { user.uid = userId; fullUserDataCache[userId] = user; userDataCache[userId] = { displayName: user.displayName || 'N/A', email: user.email, status: user.status || 'active', balance: user.balance || 0, winningCash: user.winningCash || 0 }; usersArray.push(user); } else { console.warn("Skipping invalid user data:", userId, user); } }); } renderUsersTable(usersArray); if (elements.dashboardSection?.classList.contains('active')) { elements.statTotalUsers.textContent = userCount; } console.log("Users table updated. Count:", userCount); }, (error) => { console.error("Error listening to users:", error); elements.usersTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-3 text-danger">Error: ${error.message}. Check Rules.</td></tr>`; showStatus(elements.usersStatus, `Error listening to users: ${error.message}. Check Rules.`, 'danger', false); fullUserDataCache = {}; userDataCache = {}; if (elements.dashboardSection?.classList.contains('active')) elements.statTotalUsers.textContent = 'Error'; try { if (dbListeners[listenerKey]) { off(usersRef, 'value', dbListeners[listenerKey]); delete dbListeners[listenerKey]; console.log("Detached failed users listener."); } } catch(e) { console.warn("Could not detach failed users listener.", e); } }); console.log("Attached new users listener."); }
        async function loadWithdrawals(status = 'pending') { if (!db || !isDesignatedAdmin(currentAdminUser)) return; const targetTableBody = getElement(`${status}WithdrawalsTableBody`); if (!targetTableBody) { console.error(`Table body not found: ${status}`); return; } const q = query(ref(db, 'withdrawals'), orderByChild('status'), equalTo(status)); targetTableBody.innerHTML = tableLoadingPlaceholderHtml(status === 'pending' ? 5 : 6); if (status === 'pending') clearStatus(elements.withdrawalsStatus); const listenerKey = `withdrawals-${status}`; if (dbListeners[listenerKey]) try { off(q, 'value', dbListeners[listenerKey]); delete dbListeners[listenerKey]; console.log(`Detached previous ${status} withdrawals listener.`); } catch (e) { console.warn(`Could not detach ${listenerKey}`, e); } dbListeners[listenerKey] = onValue(q, async (snapshot) => { console.log(`${status} withdrawals data received.`); let tableHtml = ''; let count = 0; targetTableBody.innerHTML = ''; if (snapshot.exists()) { count = snapshot.size; const userIds = new Set(); snapshot.forEach(child => { if (child.val()?.userId && !userDataCache[child.val().userId]) userIds.add(child.val().userId); }); if (userIds.size > 0) { console.log(`Fetching ${userIds.size} missing basic user details for ${status} withdrawals...`); const promises = Array.from(userIds).map(uid => get(ref(db, `users/${uid}`)).then(us => { if (us.exists()) { const u = us.val(); userDataCache[uid] = { displayName: u.displayName || 'N/A', email: u.email || uid, status: u.status || 'unknown' }; } else { userDataCache[uid] = { displayName: 'Unknown User', email: uid, status: 'deleted' }; } }).catch(err => { console.warn(`Failed fetch user ${uid}`, err); userDataCache[uid] = { displayName: 'Error Fetching', email: uid, status: 'error' }; })); await Promise.allSettled(promises); console.log("Missing user details fetch complete."); } const withdrawals = []; snapshot.forEach(child => withdrawals.push({ id: child.key, ...child.val() })); withdrawals.sort((a, b) => (b.requestTimestamp || 0) - (a.requestTimestamp || 0)); withdrawals.forEach(w => { if (w && w.userId && w.amount != null && w.requestTimestamp) { const user = userDataCache[w.userId] || { displayName: 'Loading...', email: w.userId, status: 'unknown' }; const userDisplay = `${sanitizeHTML(user.displayName)} (<small class="text-muted" title="${w.userId}">${sanitizeHTML(user.email)}</small>)`; let methodDisplay = sanitizeHTML(w.methodDetails?.methodName || w.method || 'N/A'); if (w.methodDetails?.accountInfo) { methodDisplay += `<small class="text-muted d-block" title="${sanitizeHTML(w.methodDetails.accountInfo)}">${sanitizeHTML(String(w.methodDetails.accountInfo)).substring(0, 40)}${String(w.methodDetails.accountInfo).length > 40 ? '...' : ''}</small>`; } const requestTime = formatDate(w.requestTimestamp); const processedTime = formatDate(w.processedAt); let rowHtml = `<tr><td>${requestTime}</td>`; if (status !== 'pending') rowHtml += `<td>${processedTime}</td>`; rowHtml += `<td>${userDisplay}</td><td>${formatCurrency(w.amount)}</td><td>${methodDisplay}</td>`; if (status === 'pending') { rowHtml += `<td class="action-buttons"><button class="btn btn-sm btn-success btn-approve-withdrawal" data-id="${sanitizeHTML(w.id)}" data-userid="${sanitizeHTML(w.userId)}" title="Approve"><i class="bi bi-check-circle"></i></button> <button class="btn btn-sm btn-danger btn-reject-withdrawal" data-id="${sanitizeHTML(w.id)}" data-userid="${sanitizeHTML(w.userId)}" title="Reject"><i class="bi bi-x-circle"></i></button></td>`; } else if (status === 'completed') { const note = sanitizeHTML(w.adminNote || ''); rowHtml += `<td><small title="${note}">${note.substring(0, 30)}${ note.length > 30 ? '...' : ''}</small></td>`; } else if (status === 'rejected') { const reason = sanitizeHTML(w.rejectReason || ''); rowHtml += `<td><small title="${reason}">${reason.substring(0, 30)}${ reason.length > 30 ? '...' : ''}</small></td>`; } rowHtml += `</tr>`; tableHtml += rowHtml; } else { console.warn(`Skipping invalid ${status} withdrawal:`, w.id, w); } }); } const emptyColspan = status === 'pending' ? 5 : 6; targetTableBody.innerHTML = tableHtml || `<tr><td colspan="${emptyColspan}" class="text-center p-3 text-muted">No ${status} withdrawals found.</td></tr>`; if (status === 'pending') { if (elements.pendingWithdrawalCountBadge) { elements.pendingWithdrawalCountBadge.textContent = count; elements.pendingWithdrawalCountBadge.style.display = count > 0 ? 'inline-block' : 'none'; } if (elements.dashboardSection?.classList.contains('active') && elements.statPendingWithdrawals) elements.statPendingWithdrawals.textContent = count; } else if (status === 'completed' && elements.dashboardSection?.classList.contains('active') && elements.statCompletedWithdrawals) { elements.statCompletedWithdrawals.textContent = count; } else if (status === 'rejected' && elements.dashboardSection?.classList.contains('active') && elements.statRejectedWithdrawals) { elements.statRejectedWithdrawals.textContent = count; } console.log(`${status} withdrawals table updated. Count:`, count); }, (error) => { console.error(`Error listening to ${status} withdrawals:`, error); const errorColspan = status === 'pending' ? 5 : 6; targetTableBody.innerHTML = `<tr><td colspan="${errorColspan}" class="text-center p-3 text-danger">Error loading: ${error.message}. Check Rules/Index.</td></tr>`; showStatus(elements.withdrawalsStatus, `Error loading ${status} withdrawals: ${error.message}. Check Rules/Index.`, 'danger', false); if (status === 'pending') { if (error?.message?.includes("index")) showStatus(elements.withdrawalsStatus, "CRITICAL: Pending query fail. Add '.indexOn': 'status' to '/withdrawals' rules.", "danger", false); if(elements.pendingWithdrawalCountBadge){ elements.pendingWithdrawalCountBadge.textContent = 'Err'; elements.pendingWithdrawalCountBadge.style.display = 'inline-block';} if (elements.dashboardSection?.classList.contains('active')) elements.statPendingWithdrawals.textContent = 'Error'; } else if (status === 'completed' && elements.dashboardSection?.classList.contains('active')) elements.statCompletedWithdrawals.textContent = 'Error'; else if (status === 'rejected' && elements.dashboardSection?.classList.contains('active')) elements.statRejectedWithdrawals.textContent = 'Error'; try { if (dbListeners[listenerKey]) { off(q, 'value', dbListeners[listenerKey]); delete dbListeners[listenerKey]; console.log(`Detached failed ${status} listener.`); } } catch(e) { console.warn(`Could not detach failed ${status} listener.`, e); } }); console.log(`Attached new listener for ${status} withdrawals.`); }
        async function loadSettings() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; console.log("Loading settings..."); elements.appSettingsForm?.querySelectorAll('input, textarea, button').forEach(el => el.disabled = true); clearStatus(elements.settingsStatus); try { const snapshot = await get(ref(db, 'settings')); if (snapshot.exists()) { appSettings = snapshot.val() || {}; elements.settingLogoUrlInput.value = appSettings.logoUrl || ''; elements.settingAppNameInput.value = appSettings.appName || ''; elements.settingMinWithdrawInput.value = appSettings.minWithdraw || 0; elements.settingReferralBonusInput.value = appSettings.referralBonus || 0; elements.settingSupportContactInput.value = appSettings.supportContact || ''; elements.settingUpiDetailsInput.value = appSettings.upiDetails || ''; elements.settingPolicyPrivacyInput.value = appSettings.policyPrivacy || ''; elements.settingPolicyTermsInput.value = appSettings.policyTerms || ''; elements.settingPolicyRefundInput.value = appSettings.policyRefund || ''; elements.settingPolicyFairPlayInput.value = appSettings.policyFairPlay || ''; if(elements.adminHeaderLogo) { const logoUrl = appSettings.logoUrl; elements.adminHeaderLogo.src = logoUrl || 'https://via.placeholder.com/35/1E293B/94A3B8?text=L'; elements.adminHeaderLogo.style.display = logoUrl ? 'inline-block' : 'none'; elements.adminHeaderLogo.alt = appSettings.appName ? `${appSettings.appName} Logo` : 'Logo'; } document.title = `${appSettings.appName || 'Gaming Tournament'} - Admin Panel`; console.log("Settings loaded and applied."); } else { console.log("No settings found."); showStatus(elements.settingsStatus, "No settings found. Please configure.", "info", false); elements.appSettingsForm.reset(); appSettings = {}; if(elements.adminHeaderLogo) elements.adminHeaderLogo.style.display = 'none'; document.title = 'Admin Panel'; } } catch (error) { console.error("Error loading settings:", error); showStatus(elements.settingsStatus, `Error loading settings: ${error.message}. Check Rules.`, "danger", false); appSettings = {}; if(elements.adminHeaderLogo) elements.adminHeaderLogo.style.display = 'none'; document.title = 'Admin Panel'; } finally { elements.appSettingsForm?.querySelectorAll('input, textarea, button').forEach(el => el.disabled = false); } }
        
        const IMGBB_API_KEY = '1579b196953465c653d3639ab091448c';
        async function uploadToImgBB(file, statusElement) { if (!file) throw new Error("File not selected."); if (!IMGBB_API_KEY || IMGBB_API_KEY === 'YOUR_IMGBB_API_KEY') { console.error("ImgBB API Key missing or is a placeholder!"); throw new Error("ImgBB API Key not set."); } const formData = new FormData(); formData.append('image', file); if (statusElement) { statusElement.textContent = 'Uploading...'; statusElement.style.color = 'var(--text-secondary)'; statusElement.style.display = 'block'; } try { const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData }); if (!response.ok) { let errorMsg = `ImgBB upload failed: HTTP ${response.status}`; try { const errorData = await response.json(); errorMsg += ` - ${errorData?.error?.message || response.statusText}`; } catch (e) {} throw new Error(errorMsg); } const data = await response.json(); if (data.success) { console.log('ImgBB upload successful. URL:', data.data.url); if (statusElement) statusElement.textContent = 'Upload complete!'; return data.data.url; } else { console.error('ImgBB upload failed:', data); throw new Error(`ImgBB upload failed: ${data.error?.message || 'Unknown error'}`); } } catch (error) { console.error('ImgBB Fetch error:', error); if (statusElement) { statusElement.textContent = `Upload Error: ${error.message}`; statusElement.style.color = 'var(--danger-color)'; } throw error; } }
        async function saveGame() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; const gameId = elements.gameEditId.value; const isEditing = !!gameId; const name = elements.gameNameInput.value.trim(); const imageUrlInput = elements.gameImageUrlInput.value.trim(); const imageFile = elements.gameImageFileInput.files[0]; const statusEl = elements.gameStatus; const imgbbStatusEl = elements.gameForm?.querySelector('.imgbb-upload-status'); clearStatus(statusEl); if (imgbbStatusEl) { imgbbStatusEl.textContent = ''; imgbbStatusEl.style.display = 'none'; } if (!name) { showStatus(statusEl, "Game Name is required.", "warning"); return; } if (!imageUrlInput && !imageFile && !isEditing) { showStatus(statusEl, "Image URL or File Upload required for new game.", "warning"); return; } if (!imageUrlInput && !imageFile && isEditing) { showStatus(statusEl, "Image URL cannot be empty when editing.", "warning"); return; } showLoader(true); elements.saveGameBtn.disabled = true; let finalImageUrl = imageUrlInput; try { if (imageFile) { finalImageUrl = await uploadToImgBB(imageFile, imgbbStatusEl); } if (!finalImageUrl) { throw new Error("Image URL is missing after potential upload."); } const gameData = { name: name, imageUrl: finalImageUrl }; if (isEditing) { gameData.updatedAt = serverTimestamp(); const gameRef = ref(db, `games/${gameId}`); await update(gameRef, gameData); console.log("Game updated successfully:", gameId); showStatus(elements.gamesStatus, "Game updated successfully!", "success", 3000); } else { gameData.createdAt = serverTimestamp(); const newGameRef = push(ref(db, 'games')); await set(newGameRef, gameData); console.log("Game added successfully, key:", newGameRef.key); showStatus(elements.gamesStatus, "Game added successfully!", "success", 3000); } elements.gameForm.reset(); elements.gameEditId.value = ''; if (imgbbStatusEl) { imgbbStatusEl.textContent = ''; imgbbStatusEl.style.display = 'none'; } getModalInstance(elements.gameModalEl)?.hide(); loadGames(); } catch (error) { console.error("Error saving game:", error); showStatus(statusEl, `Error saving game: ${error.message}. Check console & Rules.`, "danger", false); if (imgbbStatusEl && !imgbbStatusEl.textContent.includes('Error')) { imgbbStatusEl.style.display = 'none'; } } finally { showLoader(false); elements.saveGameBtn.disabled = false; } }
        async function savePromotion() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; const promoId = elements.promotionEditId.value; const isEditing = !!promoId; const promoLink = elements.promoLinkInput.value.trim(); const imageUrlInput = elements.promoImageUrlInput.value.trim(); const imageFile = elements.promoImageFileInput.files[0]; const statusEl = elements.promotionStatus; const imgbbStatusEl = elements.promotionForm?.querySelector('.imgbb-upload-status'); clearStatus(statusEl); if (imgbbStatusEl) { imgbbStatusEl.textContent = ''; imgbbStatusEl.style.display = 'none'; } if (!imageUrlInput && !imageFile && !isEditing) { showStatus(statusEl, "Image URL or File Upload required for new promotion.", "warning"); return; } if (!imageUrlInput && !imageFile && isEditing) { showStatus(statusEl, "Image URL cannot be empty when editing.", "warning"); return; } showLoader(true); elements.savePromotionBtn.disabled = true; let finalImageUrl = imageUrlInput; try { if (imageFile) { finalImageUrl = await uploadToImgBB(imageFile, imgbbStatusEl); } if (!finalImageUrl) { throw new Error("Image URL is missing after potential upload."); } const promoData = { imageUrl: finalImageUrl, link: promoLink || null }; if (isEditing) { promoData.updatedAt = serverTimestamp(); const promoRef = ref(db, `promotions/${promoId}`); await update(promoRef, promoData); console.log("Promotion updated successfully:", promoId); showStatus(elements.promotionsStatus, "Promotion updated successfully!", "success", 3000); } else { promoData.createdAt = serverTimestamp(); const newPromoRef = push(ref(db, 'promotions')); await set(newPromoRef, promoData); console.log("Promotion added successfully, key:", newPromoRef.key); showStatus(elements.promotionsStatus, "Promotion added successfully!", "success", 3000); } elements.promotionForm.reset(); elements.promotionEditId.value = ''; if (imgbbStatusEl) { imgbbStatusEl.textContent = ''; imgbbStatusEl.style.display = 'none'; } getModalInstance(elements.promotionModalEl)?.hide(); loadPromotions(); } catch (error) { console.error("Error saving promotion:", error); showStatus(statusEl, `Error saving promotion: ${error.message}. Check console & Rules.`, "danger", false); if (imgbbStatusEl && !imgbbStatusEl.textContent.includes('Error')) { imgbbStatusEl.style.display = 'none'; } } finally { showLoader(false); elements.savePromotionBtn.disabled = false; } }
        
        async function saveTournament(event) {
            event.preventDefault();
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            const statusEl = elements.addTournamentStatus;
            clearStatus(statusEl);
            
            const gameId = elements.tournamentGameSelect.value;
            const name = elements.tournamentNameInput.value.trim();
            const startTimeStr = elements.tournamentStartTimeInput.value;
            
            if (!gameId || !name || !startTimeStr) {
                showStatus(statusEl, "Game, Name, and Start Time are required.", "warning");
                return;
            }
        
            let startTimeTimestamp;
            try {
                startTimeTimestamp = new Date(startTimeStr).getTime();
                if (isNaN(startTimeTimestamp)) throw new Error('Invalid Date');
            } catch (e) {
                showStatus(statusEl, "Invalid Start Date & Time format.", "warning");
                return;
            }
        
            const entryFee = parseFloat(elements.tournamentEntryFeeInput.value) || 0;
            const prizePool = parseFloat(elements.tournamentPrizePoolInput.value) || 0;
            const perKillPrize = parseFloat(elements.tournamentPerKillInput.value) || 0;
            const maxPlayers = parseInt(elements.tournamentMaxPlayersInput.value) || 0;
        
            const tournamentData = {
                gameId: gameId,
                name: name,
                startTime: startTimeTimestamp,
                status: elements.tournamentStatusSelect.value,
                entryFee: entryFee,
                prizePool: prizePool,
                perKillPrize: perKillPrize,
                maxPlayers: maxPlayers,
                tags: elements.tournamentTagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag),
                mode: elements.tournamentModeInput.value.trim(),
                map: elements.tournamentMapInput.value.trim(),
                description: elements.tournamentDescriptionInput.value.trim(),
                roomId: elements.tournamentRoomIdInput.value.trim() || null,
                roomPassword: elements.tournamentRoomPasswordInput.value.trim() || null,
                showIdPass: elements.tournamentShowIdPassCheckbox.checked,
                updatedAt: serverTimestamp()
            };
        
            showLoader(true);
            elements.saveTournamentBtn.disabled = true;
        
            try {
                if (currentEditingTournamentId) {
                    const tRef = ref(db, `tournaments/${currentEditingTournamentId}`);
                    await update(tRef, tournamentData);
                    console.log("Tournament updated:", currentEditingTournamentId);
                    showStatus(elements.tournamentsStatus, "Tournament updated successfully!", "success", 3000);
                } else {
                    tournamentData.createdAt = serverTimestamp();
                    const newRef = push(ref(db, 'tournaments'));
                    await set(newRef, tournamentData);
                    console.log("Tournament added:", newRef.key);
                    showStatus(elements.tournamentsStatus, "Tournament added successfully!", "success", 3000);
                }
                elements.tournamentForm.reset();
                currentEditingTournamentId = null;
                getModalInstance(elements.addTournamentModalEl)?.hide();
                loadTournaments();
                loadDashboardStats();
            } catch (error) {
                console.error("Error saving tournament:", error);
                showStatus(statusEl, `Error: ${error.message}. Check Rules.`, "danger", false);
            } finally {
                showLoader(false);
                elements.saveTournamentBtn.disabled = false;
            }
        }

        async function deleteGame(gameId) { if (!db || !gameId || !isDesignatedAdmin(currentAdminUser)) return; if (!confirm(`DELETE Game ID: ${gameId}? Removes DB entry. Image on ImgBB NOT deleted. OK?`)) return; showLoader(true); const statusEl = elements.gamesStatus; clearStatus(statusEl); try { await remove(ref(db, `games/${gameId}`)); console.log("Game deleted from DB:", gameId); delete gameDataCache[gameId]; showStatus(statusEl, "Game data deleted.", "success", 3000); loadGames(); loadDashboardStats(); } catch (error) { console.error("Error deleting game:", error); showStatus(statusEl, `Error deleting game: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); } }
        async function deletePromotion(promoId) { if (!db || !promoId || !isDesignatedAdmin(currentAdminUser)) return; if (!confirm(`DELETE Promotion ID: ${promoId}? Removes DB entry. Image on ImgBB NOT deleted. OK?`)) return; showLoader(true); const statusEl = elements.promotionsStatus; clearStatus(statusEl); try { await remove(ref(db, `promotions/${promoId}`)); console.log("Promotion deleted from DB:", promoId); showStatus(statusEl, "Promotion data deleted.", "success", 3000); loadPromotions(); loadDashboardStats(); } catch (error) { console.error("Error deleting promotion:", error); showStatus(statusEl, `Error deleting promotion: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); } }
        async function deleteTournament(tournamentId) { if (!db || !tournamentId || !isDesignatedAdmin(currentAdminUser)) return; if (!confirm(`DELETE Tournament ID: ${tournamentId}? Cannot be undone.`)) return; showLoader(true); const statusEl = elements.tournamentsStatus; clearStatus(statusEl); try { await remove(ref(db, `tournaments/${tournamentId}`)); console.log("Tournament deleted:", tournamentId); showStatus(statusEl, "Tournament deleted.", "success", 3000); loadTournaments(); loadDashboardStats(); } catch (error) { console.error("Error deleting tournament:", error); showStatus(statusEl, `Error: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); } }
        async function saveNewUser() { if (!auth || !db || !isDesignatedAdmin(currentAdminUser)) return; const statusEl = elements.addUserStatus; clearStatus(statusEl); const name = elements.newUserNameInput.value.trim(); const email = elements.newUserEmailInput.value.trim(); const password = elements.newUserPasswordInput.value; const initialBalanceStr = elements.newUserInitialBalanceInput.value; if (!name || !email || !password) { showStatus(statusEl, "Name, Email, Password required.", "warning"); return; } if (password.length < 6) { showStatus(statusEl, "Password min 6 chars.", "warning"); return; } const initialBalance = parseFloat(initialBalanceStr) || 0; if (initialBalance < 0) { showStatus(statusEl, "Initial Balance cannot be negative.", "warning"); return; } if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showStatus(statusEl, "Invalid Email format.", "warning"); return; } showLoader(true); elements.saveNewUserBtn.disabled = true; try { const referralCode = Math.random().toString(36).substring(2, 10).toUpperCase(); const cred = await createUserWithEmailAndPassword(auth, email, password); const uid = cred.user.uid; console.log("User created in Auth:", uid, email); const userData = { uid: uid, email: email, displayName: name, balance: initialBalance, winningCash: 0, bonusCash: 0, status: 'active', createdAt: serverTimestamp(), referralCode: referralCode, isAdmin: false, referralEarnings: 0, totalEarnings: 0, totalMatches: 0, wonMatches: 0 }; await set(ref(db, `users/${uid}`), userData); console.log("User data created in DB:", uid); showStatus(statusEl, `User ${name} created!`, "success", 4000); elements.addUserForm.reset(); getModalInstance(elements.addUserModalEl)?.hide(); loadDashboardStats(); } catch (error) { console.error("Error creating user:", error); let msg = `Error: ${error.message}`; if (error.code === 'auth/email-already-in-use') msg = "Email already registered."; else if (error.code === 'auth/weak-password') msg = "Password too weak."; else if (error.code === 'auth/invalid-email') msg = "Invalid email format."; else if (error.code === 'permission-denied') msg = "Permission denied creating user/DB entry. Check Rules."; showStatus(statusEl, msg, "danger", false); } finally { showLoader(false); elements.saveNewUserBtn.disabled = false; } }
        async function updateUserBalance(event) { event.preventDefault(); if (!db || !isDesignatedAdmin(currentAdminUser)) return; const statusEl = elements.balanceUpdateStatus; clearStatus(statusEl); const userId = elements.editUserUid.value; const amountStr = elements.balanceUpdateAmountInput.value; const type = elements.balanceUpdateTypeSelect.value; const reason = elements.balanceUpdateReasonInput.value.trim(); if (!userId || !amountStr || !type || !reason) { showStatus(statusEl, "All fields required.", "warning"); return; } const amount = parseFloat(amountStr); if (isNaN(amount) || amount === 0) { showStatus(statusEl, "Invalid or zero amount.", "warning"); return; } showLoader(true); const userRefPath = `users/${userId}`; const updates = {}; try { const userSnapshot = await get(ref(db, userRefPath)); if (!userSnapshot.exists()) throw new Error(`User ${userId} not found.`); const user = userSnapshot.val(); const currentBalance = Number(user.balance || 0); const currentWinning = Number(user.winningCash || 0); const currentBonus = Number(user.bonusCash || 0); let newBalance = currentBalance; let newWinning = currentWinning; let newBonus = currentBonus; let logType = ''; switch (type) { case 'balance': newBalance += amount; updates[`${userRefPath}/balance`] = newBalance; logType = amount > 0 ? 'admin_deposit' : 'admin_deduction'; break; case 'winningCash': newWinning += amount; newBalance += amount; if (newWinning < 0) throw new Error("Winning cash cannot be negative."); updates[`${userRefPath}/winningCash`] = newWinning; updates[`${userRefPath}/balance`] = newBalance; logType = amount > 0 ? 'admin_winning_add' : 'admin_winning_deduct'; break; case 'bonusCash': newBonus += amount; newBalance += amount; if (newBonus < 0) throw new Error("Bonus cash cannot be negative."); updates[`${userRefPath}/bonusCash`] = newBonus; updates[`${userRefPath}/balance`] = newBalance; logType = amount > 0 ? 'admin_bonus_add' : 'admin_bonus_deduct'; break; default: throw new Error("Invalid balance type."); } if (newBalance < 0 && !confirm(`Warning: Negative total balance (${formatCurrency(newBalance)}). Proceed?`)) { showLoader(false); showStatus(statusEl, "Update cancelled.", "info"); return; } const txKey = push(ref(db, `transactions/${userId}`)).key; const txData = { type: logType, amount: amount, timestamp: serverTimestamp(), description: `Admin Update: ${reason}`, status: 'completed', balanceAfter: newBalance, adminUid: currentAdminUser.uid }; updates[`transactions/${userId}/${txKey}`] = txData; await update(ref(db), updates); console.log(`Balance updated for ${userId}. New Bal: ${newBalance}, Win: ${newWinning}, Bonus: ${newBonus}`); elements.userDetailWinning.textContent = newWinning.toFixed(2); elements.userDetailBonus.textContent = newBonus.toFixed(2); const updatedTotalBalance = newWinning + newBonus; elements.userDetailBalance.textContent = updatedTotalBalance.toFixed(2); if (fullUserDataCache[userId]) { fullUserDataCache[userId].balance = newBalance; fullUserDataCache[userId].winningCash = newWinning; fullUserDataCache[userId].bonusCash = newBonus; } if (userDataCache[userId]) { userDataCache[userId].balance = newBalance; userDataCache[userId].winningCash = newWinning; } showStatus(statusEl, "Balance updated!", "success", 3000); elements.updateBalanceForm.reset(); } catch (error) { console.error("Error updating balance:", error); showStatus(statusEl, `Error: ${error.message}`, "danger", false); } finally { showLoader(false); } }
        async function toggleUserBlock(event) { const button = event.target.closest('button'); if (!button || !db || !isDesignatedAdmin(currentAdminUser)) return; const userId = button.dataset.id; const currentAction = button.dataset.action; if (!userId || !currentAction) return; const newStatus = currentAction === 'block' ? 'blocked' : 'active'; if (!confirm(`Confirm ${currentAction} user ${userId}?`)) return; showLoader(true); button.disabled = true; const modalVisible = getModalInstance(elements.userModalEl)?._isShown; const statusEl = modalVisible && elements.editUserUid.value === userId ? elements.balanceUpdateStatus : elements.usersStatus; clearStatus(statusEl); try { await set(ref(db, `users/${userId}/status`), newStatus); console.log(`User ${userId} status set to ${newStatus}`); if (fullUserDataCache[userId]) fullUserDataCache[userId].status = newStatus; if (userDataCache[userId]) userDataCache[userId].status = newStatus; showStatus(statusEl, `User ${newStatus} successfully!`, "success", 3000); if (modalVisible && elements.editUserUid.value === userId) { elements.userDetailStatus.textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1); elements.userDetailStatus.className = `fw-bold text-${newStatus === 'active' ? 'success' : 'danger'}`; button.textContent = newStatus === 'active' ? 'Block User' : 'Unblock User'; button.className = `btn btn-sm ${newStatus === 'active' ? 'btn-danger' : 'btn-success'}`; button.dataset.action = newStatus === 'active' ? 'block' : 'unblock'; } filterUsers(); } catch (error) { console.error(`Error ${currentAction}ing user:`, error); showStatus(statusEl, `Error ${currentAction}ing user: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); button.disabled = false; } }
        async function deleteUser(userId) { if (!db || !userId || !isDesignatedAdmin(currentAdminUser)) return; const userName = fullUserDataCache[userId]?.displayName || fullUserDataCache[userId]?.email || userId; if (!confirm(`DELETE USER: ${userName} (UID: ${userId})?\n\nWARNING:\n- Removes user data from Realtime Database ONLY.\n- DOES NOT delete from Firebase Auth.\n- Associated data (transactions, etc.) may be orphaned.\n\nCannot be undone. Proceed?`)) return; showLoader(true); const statusEl = elements.usersStatus; clearStatus(statusEl); const modal = getModalInstance(elements.userModalEl); if (modal?._isShown) modal.hide(); try { await remove(ref(db, `users/${userId}`)); console.log("User deleted from DB:", userId); delete fullUserDataCache[userId]; delete userDataCache[userId]; showStatus(statusEl, `User ${userName} deleted from Database.`, "success", 5000); filterUsers(); loadDashboardStats(); } catch (error) { console.error("Error deleting user from DB:", error); showStatus(statusEl, `Error deleting user data: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); } }
        async function openWithdrawalActionModal(withdrawalId, type) { if (!db || !withdrawalId || !type || !isDesignatedAdmin(currentAdminUser)) return; console.log(`Opening withdrawal modal: ${withdrawalId}, Action: ${type}`); showLoader(true); currentWithdrawalAction = { id: withdrawalId, type: type, userId: null }; elements.withdrawalRejectReasonInput.value = ''; elements.withdrawalApproveNoteInput.value = ''; elements.withdrawalRejectReasonDiv.style.display = 'none'; elements.withdrawalApproveNoteDiv.style.display = 'none'; elements.withdrawalRejectReasonInput.required = false; elements.withdrawalApproveNoteInput.required = false; clearStatus(elements.withdrawalActionStatus); elements.approveWithdrawalBtn.style.display = 'inline-block'; elements.rejectWithdrawalBtn.style.display = 'inline-block'; elements.approveWithdrawalBtn.disabled = false; elements.rejectWithdrawalBtn.disabled = false; const withdrawalRef = ref(db, `withdrawals/${withdrawalId}`); try { const snapshot = await get(withdrawalRef); if (!snapshot.exists()) throw new Error(`Withdrawal ${withdrawalId} not found.`); const w = snapshot.val(); currentWithdrawalAction.userId = w.userId; if (w.status !== 'pending') { alert(`Request already processed (Status: ${w.status}).`); showLoader(false); return; } let userDisplay = `UID: ${w.userId}`; const userId = w.userId; if (userId && userDataCache[userId]) { const u = userDataCache[userId]; userDisplay = `${sanitizeHTML(u.displayName)} (<small class="text-muted" title="${userId}">${sanitizeHTML(u.email)}</small>)`; } else if (userId) { try { const userSnap = await get(ref(db, `users/${userId}`)); if (userSnap.exists()) { const u = userSnap.val(); userDataCache[userId] = { displayName: u.displayName || 'N/A', email: u.email || userId, status: u.status || 'unknown' }; userDisplay = `${sanitizeHTML(u.displayName)} (<small class="text-muted" title="${userId}">${sanitizeHTML(u.email)}</small>)`; } else { userDataCache[userId] = { displayName: 'Unknown User', email: userId, status: 'deleted' }; userDisplay = `Unknown User (<small class="text-muted" title="${userId}">${userId}</small>)`; } } catch (err) { console.warn(`Could not fetch user ${userId}`, err); userDataCache[userId] = { displayName: 'Error Fetching', email: userId, status: 'error' }; userDisplay = `Error Fetching (<small class="text-muted" title="${userId}">${userId}</small>)`; } } let methodDisplay = sanitizeHTML(w.methodDetails?.methodName || w.method || 'N/A'); if (w.methodDetails?.accountInfo) methodDisplay += ` - ${sanitizeHTML(w.methodDetails.accountInfo)}`; elements.withdrawalDetailId.textContent = withdrawalId; elements.withdrawalDetailUser.innerHTML = userDisplay; elements.withdrawalDetailUserUid.textContent = userId || 'N/A'; elements.withdrawalDetailAmount.textContent = (w.amount || 0).toFixed(2); elements.withdrawalDetailMethod.textContent = methodDisplay; if (type === 'reject') { elements.withdrawalRejectReasonDiv.style.display = 'block'; elements.withdrawalRejectReasonInput.required = true; elements.approveWithdrawalBtn.style.display = 'none'; } else { elements.withdrawalApproveNoteDiv.style.display = 'block'; elements.rejectWithdrawalBtn.style.display = 'none'; } getModalInstance(elements.withdrawalActionModalEl)?.show(); } catch (error) { console.error("Error opening withdrawal modal:", error); alert(`Error fetching details: ${error.message}`); showStatus(elements.withdrawalsStatus, `Error fetching details: ${error.message}`, 'danger', false); } finally { showLoader(false); } }
        async function processWithdrawalAction() { if (!db || !currentWithdrawalAction.id || !currentWithdrawalAction.type || !currentWithdrawalAction.userId || !isDesignatedAdmin(currentAdminUser)) { console.error("Withdrawal details missing or unauthorized."); showStatus(elements.withdrawalActionStatus, "Internal error/unauthorized.", "danger", false); return; } const statusEl = elements.withdrawalActionStatus; clearStatus(statusEl); const withdrawalId = currentWithdrawalAction.id; const actionType = currentWithdrawalAction.type; const userId = currentWithdrawalAction.userId; const updates = {}; const withdrawalRefPath = `withdrawals/${withdrawalId}`; let reason = ''; let adminNote = ''; let logType = ''; let logStatus = 'failed'; let refundRequired = false; showLoader(true); elements.approveWithdrawalBtn.disabled = true; elements.rejectWithdrawalBtn.disabled = true; try { const wSnapshot = await get(ref(db, withdrawalRefPath)); if (!wSnapshot.exists()) throw new Error("Withdrawal request not found."); const wData = wSnapshot.val(); const amount = Number(wData.amount || 0); if (wData.status !== 'pending') throw new Error(`Request already processed (Status: ${wData.status}).`); if (amount <= 0) throw new Error("Invalid amount."); if (actionType === 'reject') { reason = elements.withdrawalRejectReasonInput.value.trim(); if (!reason) { elements.rejectWithdrawalBtn.disabled = false; throw new Error("Rejection reason required."); } updates[`${withdrawalRefPath}/status`] = 'rejected'; updates[`${withdrawalRefPath}/rejectReason`] = reason; updates[`${withdrawalRefPath}/processedAt`] = serverTimestamp(); updates[`${withdrawalRefPath}/processedBy`] = currentAdminUser.uid; refundRequired = true; logType = 'withdrawal_rejected'; logStatus = 'completed'; } else { adminNote = elements.withdrawalApproveNoteInput.value.trim(); updates[`${withdrawalRefPath}/status`] = 'completed'; updates[`${withdrawalRefPath}/adminNote`] = adminNote || 'Approved'; updates[`${withdrawalRefPath}/processedAt`] = serverTimestamp(); updates[`${withdrawalRefPath}/processedBy`] = currentAdminUser.uid; refundRequired = false; logType = 'withdrawal_approved'; logStatus = 'completed'; } if (refundRequired) { const uSnapshot = await get(ref(db, `users/${userId}`)); if (!uSnapshot.exists()) throw new Error(`User ${userId} not found for refund.`); const user = uSnapshot.val(); const currentWinning = Number(user.winningCash || 0); const currentBalance = Number(user.balance || 0); const newWinning = currentWinning + amount; const newBalance = currentBalance + amount; updates[`users/${userId}/winningCash`] = newWinning; updates[`users/${userId}/balance`] = newBalance; const refundTxKey = push(ref(db, `transactions/${userId}`)).key; updates[`transactions/${userId}/${refundTxKey}`] = { type: 'withdrawal_refund', amount: amount, timestamp: serverTimestamp(), description: `Refund rejected withdrawal: ${withdrawalId}. Reason: ${reason}`, status: 'completed', balanceAfter: newBalance, adminUid: currentAdminUser.uid }; console.log(`Prepared refund for ${userId}. New Bal: ${newBalance}`); if (fullUserDataCache[userId]) { fullUserDataCache[userId].balance = newBalance; fullUserDataCache[userId].winningCash = newWinning; } if (userDataCache[userId]) { userDataCache[userId].balance = newBalance; userDataCache[userId].winningCash = newWinning; } } const mainTxKey = push(ref(db, `transactions/${userId}`)).key; updates[`transactions/${userId}/${mainTxKey}`] = { type: logType, amount: 0, timestamp: serverTimestamp(), description: `Withdrawal ${actionType} by admin. ID: ${withdrawalId}. ${actionType === 'reject' ? `Reason: ${reason}` : `Note: ${adminNote}`}`, status: logStatus, withdrawalId: withdrawalId, adminUid: currentAdminUser.uid }; await update(ref(db), updates); console.log(`Withdrawal ${withdrawalId} ${actionType} processed.`); showStatus(elements.withdrawalsStatus, `Withdrawal ${actionType} successfully!`, "success", 4000); getModalInstance(elements.withdrawalActionModalEl)?.hide(); loadDashboardStats(); } catch (error) { console.error("Error processing withdrawal:", error); showStatus(statusEl, `Error: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); if (getModalInstance(elements.withdrawalActionModalEl)?._isShown) { elements.approveWithdrawalBtn.disabled = false; elements.rejectWithdrawalBtn.disabled = false; } } }
        async function saveSettings(event) { event.preventDefault(); if (!db || !isDesignatedAdmin(currentAdminUser)) return; const statusEl = elements.settingsStatus; clearStatus(statusEl); const minW = parseFloat(elements.settingMinWithdrawInput.value) || 0; const refB = parseFloat(elements.settingReferralBonusInput.value) || 0; if (minW < 0 || refB < 0) { showStatus(statusEl, "Numeric values cannot be negative.", "warning"); return; } const settingsData = { logoUrl: elements.settingLogoUrlInput.value.trim(), appName: elements.settingAppNameInput.value.trim(), minWithdraw: minW, referralBonus: refB, supportContact: elements.settingSupportContactInput.value.trim(), upiDetails: elements.settingUpiDetailsInput.value.trim(), policyPrivacy: elements.settingPolicyPrivacyInput.value.trim(), policyTerms: elements.settingPolicyTermsInput.value.trim(), policyRefund: elements.settingPolicyRefundInput.value.trim(), policyFairPlay: elements.settingPolicyFairPlayInput.value.trim(), lastUpdated: serverTimestamp() }; showLoader(true); elements.appSettingsForm?.querySelectorAll('input, textarea, button').forEach(el => el.disabled = true); try { await set(ref(db, 'settings'), settingsData); appSettings = settingsData; console.log("Settings saved:", appSettings); showStatus(statusEl, "Settings saved!", "success", 3000); if(elements.adminHeaderLogo) { const logoUrl = appSettings.logoUrl; elements.adminHeaderLogo.src = logoUrl || 'https://via.placeholder.com/35/1E293B/94A3B8?text=L'; elements.adminHeaderLogo.style.display = logoUrl ? 'inline-block' : 'none'; elements.adminHeaderLogo.alt = appSettings.appName ? `${appSettings.appName} Logo` : 'Logo'; } document.title = `${appSettings.appName || 'Gaming Tournament'} - Admin Panel`; } catch (error) { console.error("Error saving settings:", error); showStatus(statusEl, `Error: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); elements.appSettingsForm?.querySelectorAll('input, textarea, button').forEach(el => el.disabled = false); } }
        async function loadThemeSettings() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; console.log("Loading theme settings..."); const statusEl = elements.themeStatus; clearStatus(statusEl); try { const settingsSnap = await get(ref(db, 'settings')); const currentTheme = settingsSnap.exists() ? settingsSnap.val().theme : null; if (currentTheme) { console.log("Found custom theme in DB:", currentTheme); populateThemePickers(currentTheme); } else { console.log("No custom theme in DB, loading default."); populateThemePickers(defaultTheme); showStatus(statusEl, "Currently using the default theme. Customize and save to change it.", "info", 10000); } } catch (error) { console.error("Error loading theme settings:", error); showStatus(statusEl, `Error loading theme: ${error.message}`, "danger", false); populateThemePickers(defaultTheme); } }
        function populateThemePickers(theme) { elements.themeColorPickers.forEach(picker => { const cssVar = picker.dataset.var; const colorValue = theme[cssVar] || '#000000'; picker.value = colorValue; const textInput = picker.parentElement.querySelector(`input[type="text"][data-target="${picker.id}"]`); if (textInput) { textInput.value = colorValue; } }); }
        async function saveTheme() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; const statusEl = elements.themeStatus; clearStatus(statusEl); const themeData = {}; elements.themeColorPickers.forEach(picker => { const cssVar = picker.dataset.var; if (cssVar && /^#[0-9A-F]{6}$/i.test(picker.value)) { themeData[cssVar] = picker.value; } else { console.warn(`Skipping invalid color for ${cssVar}: ${picker.value}`); } }); if(themeData['--accent-color']) { themeData['--accent-gradient'] = `linear-gradient(to right, ${themeData['--accent-color']}, #FBBF24)`; } if (Object.keys(themeData).length < elements.themeColorPickers.length) { showStatus(statusEl, "One or more colors are invalid. Please check the values.", "warning"); return; } showLoader(true); elements.saveThemeBtn.disabled = true; try { await update(ref(db, 'settings'), { theme: themeData }); console.log("Theme saved successfully:", themeData); showStatus(statusEl, "Theme saved successfully! Changes will appear for users in real-time.", "success", 5000); } catch (error) { console.error("Error saving theme:", error); showStatus(statusEl, `Error saving theme: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); elements.saveThemeBtn.disabled = false; } }
        async function resetTheme() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; if (!confirm("Are you sure you want to reset to the default theme? This will remove your custom theme settings.")) { return; } const statusEl = elements.themeStatus; clearStatus(statusEl); showLoader(true); elements.resetThemeBtn.disabled = true; try { await remove(ref(db, 'settings/theme')); console.log("Theme reset successfully."); showStatus(statusEl, "Theme has been reset to default.", "success", 5000); populateThemePickers(defaultTheme); } catch (error) { console.error("Error resetting theme:", error); showStatus(statusEl, `Error resetting theme: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); elements.resetThemeBtn.disabled = false; } }
        async function addDemoData() { if (!db || !isDesignatedAdmin(currentAdminUser) || !confirm("Add sample demo data? Only adds if sections are empty.")) return; showLoader(true); elements.addDemoDataBtn.disabled = true; const sectionEl = querySel('#adminMainContent .section.active'); const statusEl = sectionEl?.querySelector('div[id$="Status"]') || elements.dashboardStatus; clearStatus(statusEl); let added = []; const now = Date.now(); try { const gamesRef = ref(db, 'games'); const gamesSnap = await get(gamesRef); let demoGameId = null; if (!gamesSnap.exists() || gamesSnap.size === 0) { const newRef = push(gamesRef); demoGameId = newRef.key; await set(newRef, { name: "Demo Game (BGMI)", imageUrl: "https://i.ibb.co/4Z5hPVzp/20250418-150058.jpg", createdAt: serverTimestamp() }); added.push("Game"); gameDataCache[demoGameId] = "Demo Game (BGMI)"; } else { const games = gamesSnap.val(); demoGameId = Object.keys(games)[0]; gameDataCache = Object.entries(games).reduce((acc, [id, data]) => { acc[id] = data.name; return acc; }, {}); } const promoRef = ref(db, 'promotions'); const promoSnap = await get(promoRef); if (!promoSnap.exists() || promoSnap.size === 0) { await set(push(promoRef), { imageUrl: "https://i.ibb.co/RGmQ420n/20250418-150709.jpg", link: "#", createdAt: serverTimestamp() }); added.push("Promotion"); } if (demoGameId) { const tRef = ref(db, 'tournaments'); const tSnap = await get(tRef); if (!tSnap.exists() || tSnap.size === 0) { await set(push(tRef), { gameId: demoGameId, name: "Weekend Demo Clash", startTime: now + 86400000, status: "upcoming", entryFee: 10, prizePool: 100, perKillPrize: 2, maxPlayers: 50, tags: ["Demo", "Squad"], description: "Sample tournament details.", roomId: null, roomPassword: null, showIdPass: false, createdAt: serverTimestamp(), updatedAt: serverTimestamp() }); added.push("Tournament"); } } const usersRef = ref(db, 'users'); const usersSnap = await get(usersRef); let demoUserNeeded = true; if(usersSnap.exists()){ usersSnap.forEach(uSnap => { if(uSnap.key !== designatedAdminUid) demoUserNeeded = false; }); } if(demoUserNeeded && auth) { try { const demoEmail = `demo${Date.now().toString().slice(-5)}@example.com`, demoPass = "password", cred = await createUserWithEmailAndPassword(auth, demoEmail, demoPass), uid = cred.user.uid, code = Math.random().toString(36).substring(2, 10).toUpperCase(); await set(ref(db, `users/${uid}`), { uid: uid, email: demoEmail, displayName: "Demo User", balance: 50, winningCash: 10, bonusCash: 5, status: 'active', createdAt: serverTimestamp(), referralCode: code, isAdmin: false, referralEarnings: 0, totalEarnings: 0, totalMatches: 0, wonMatches: 0 }); added.push("User (Demo)"); console.log("Created demo user:", demoEmail); } catch (userErr) { console.error("Failed demo user creation:", userErr); } } const settingsRef = ref(db, 'settings'); const settingsSnap = await get(settingsRef); if (!settingsSnap.exists()) { const demoSettings = { appName: "Demo Gaming App", logoUrl: "https://i.ibb.co/BvH3m14/Chat-GPT-Image-Apr-18-2025-05-54-04-PM.png", minWithdraw: 50, referralBonus: 5, supportContact: "support@demo.com", upiDetails: "demo@upi", policyPrivacy: "Demo Privacy Policy.", policyTerms: "Demo Terms.", policyRefund: "Demo Refund Policy.", policyFairPlay: "Demo Fair Play Policy.", lastUpdated: serverTimestamp() }; await set(settingsRef, demoSettings); added.push("Settings"); appSettings = demoSettings; } if (added.length > 0) { showStatus(statusEl, `Demo data added for: ${added.join(', ')}. Refreshing...`, "success", 5000); if (added.includes("Game")) await loadGames(); if (added.includes("Promotion")) await loadPromotions(); if (added.includes("Tournament")) await loadTournaments(); if (added.includes("Settings")) await loadSettings(); if (added.includes("User (Demo)")) await loadUsers(); loadDashboardStats(); } else { showStatus(statusEl, "No demo data added (already exists?).", "info", 5000); } } catch (error) { console.error("Error adding demo data:", error); showStatus(statusEl, `Error adding demo data: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); elements.addDemoDataBtn.disabled = false; } }
        
        async function loadUpdates() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            const updatesRef = ref(db, 'updates');
            elements.updatesTableBody.innerHTML = tableLoadingPlaceholderHtml(3);
            clearStatus(elements.updatesStatus);
            try {
                const snapshot = await get(updatesRef);
                let tableHtml = '';
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const updateId = childSnapshot.key;
                        const update = childSnapshot.val();
                        if (update && update.imageUrl && update.title) {
                            tableHtml += `<tr>
                                <td><img src="${sanitizeHTML(update.imageUrl)}" alt="Update Image" class="preview-img"></td>
                                <td>${sanitizeHTML(update.title)}</td>
                                <td class="action-buttons">
                                    <button class="btn btn-sm btn-info btn-edit-update" data-id="${sanitizeHTML(updateId)}" title="Edit Update"><i class="bi bi-pencil-square"></i></button>
                                    <button class="btn btn-sm btn-danger btn-delete-update" data-id="${sanitizeHTML(updateId)}" title="Delete Update"><i class="bi bi-trash"></i></button>
                                </td>
                            </tr>`;
                        }
                    });
                }
                elements.updatesTableBody.innerHTML = tableHtml || `<tr><td colspan="3" class="text-center p-3 text-muted">No updates found.</td></tr>`;
            } catch (error) {
                console.error("Error loading updates:", error);
                elements.updatesTableBody.innerHTML = `<tr><td colspan="3" class="text-center p-3 text-danger">Error loading updates: ${error.message}.</td></tr>`;
                showStatus(elements.updatesStatus, `Error loading updates: ${error.message}.`, 'danger', false);
            }
        }

        async function saveUpdate() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            const updateId = elements.updateEditId.value;
            const isEditing = !!updateId;
            const title = elements.updateTitleInput.value.trim();
            const imageUrl = elements.updateImageUrlInput.value.trim();
            const statusEl = elements.updateStatus;
            clearStatus(statusEl);

            if (!title || !imageUrl) {
                showStatus(statusEl, "Title and Image URL are required.", "warning");
                return;
            }

            showLoader(true);
            elements.saveUpdateBtn.disabled = true;
            
            try {
                const updateData = { title, imageUrl };
                if (isEditing) {
                    updateData.updatedAt = serverTimestamp();
                    await update(ref(db, `updates/${updateId}`), updateData);
                    showStatus(elements.updatesStatus, "Update saved successfully!", "success");
                } else {
                    updateData.createdAt = serverTimestamp();
                    await push(ref(db, 'updates'), updateData);
                    showStatus(elements.updatesStatus, "Update posted successfully!", "success");
                }
                getModalInstance(elements.updateModalEl)?.hide();
                loadUpdates();
            } catch (error) {
                console.error("Error saving update:", error);
                showStatus(statusEl, `Error: ${error.message}.`, "danger", false);
            } finally {
                showLoader(false);
                elements.saveUpdateBtn.disabled = false;
            }
        }
        
        async function openEditUpdateModal(updateId) {
            if (!db || !updateId || !isDesignatedAdmin(currentAdminUser)) return;
            showLoader(true);
            elements.updateForm.reset();
            clearStatus(elements.updateStatus);
            try {
                const snapshot = await get(ref(db, `updates/${updateId}`));
                if (!snapshot.exists()) throw new Error(`Update ${updateId} not found.`);
                const update = snapshot.val();
                elements.updateModalTitle.textContent = "Edit Update";
                elements.updateEditId.value = updateId;
                elements.updateTitleInput.value = update.title || '';
                elements.updateImageUrlInput.value = update.imageUrl || '';
                getModalInstance(elements.updateModalEl)?.show();
            } catch (error) {
                console.error("Error opening edit update modal:", error);
                showStatus(elements.updatesStatus, `Error loading update for edit: ${error.message}`, "danger");
            } finally {
                showLoader(false);
            }
        }
        
        async function deleteUpdate(updateId) {
            if (!db || !updateId || !isDesignatedAdmin(currentAdminUser)) return;
            if (!confirm(`Are you sure you want to delete this update?`)) return;
            showLoader(true);
            try {
                await remove(ref(db, `updates/${updateId}`));
                showStatus(elements.updatesStatus, "Update deleted successfully.", "success");
                loadUpdates();
            } catch (error) {
                console.error("Error deleting update:", error);
                showStatus(elements.updatesStatus, `Error: ${error.message}`, "danger");
            } finally {
                showLoader(false);
            }
        }

        async function loadDeposits(status = 'pending') {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            const targetTableBody = getElement(`${status}DepositsTableBody`);
            if (!targetTableBody) { console.error(`Table body not found for deposits: ${status}`); return; }
            
            const q = query(ref(db, 'rechargeRequests'), orderByChild('status'), equalTo(status));
            targetTableBody.innerHTML = tableLoadingPlaceholderHtml(status === 'pending' ? 5 : 6);
            if (status === 'pending') clearStatus(elements.depositsStatus);

            const listenerKey = `deposits-${status}`;
            if (dbListeners[listenerKey]) try { off(q, 'value', dbListeners[listenerKey]); } catch (e) { console.warn(`Could not detach ${listenerKey}`, e); }

            dbListeners[listenerKey] = onValue(q, async (snapshot) => {
                console.log(`${status} deposit data received.`);
                let tableHtml = '';
                let count = 0;

                if (snapshot.exists()) {
                    count = snapshot.size;
                    const userIds = new Set();
                    snapshot.forEach(child => { if (child.val()?.userId && !userDataCache[child.val().userId]) userIds.add(child.val().userId); });
                    if (userIds.size > 0) await Promise.allSettled(Array.from(userIds).map(uid => get(ref(db, `users/${uid}`)).then(us => { if (us.exists()) { const u = us.val(); userDataCache[uid] = { displayName: u.displayName || 'N/A', email: u.email || uid }; } })));

                    const deposits = [];
                    snapshot.forEach(child => deposits.push({ id: child.key, ...child.val() }));
                    deposits.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                    deposits.forEach(d => {
                        const user = userDataCache[d.userId] || { displayName: 'Unknown', email: d.userId };
                        const userDisplay = `${sanitizeHTML(user.displayName)} (<small class="text-muted">${sanitizeHTML(user.email)}</small>)`;
                        const detailsHtml = `
                            <small class="d-block">Method: <strong>${sanitizeHTML(d.method)}</strong></small>
                            <small class="d-block" title="${sanitizeHTML(d.transactionId)}">Txn ID: ${sanitizeHTML(String(d.transactionId).substring(0, 15))}...</small>
                            <small class="d-block">Phone Number: ${sanitizeHTML(d.playerGameId)}</small>`;
                        
                        const requestTime = formatDate(d.timestamp);
                        const processedTime = formatDate(d.processedAt);

                        let rowHtml = `<tr><td>${requestTime}</td>`;
                        if (status !== 'pending') rowHtml += `<td>${processedTime}</td>`;
                        rowHtml += `<td>${userDisplay}</td><td>${formatCurrency(d.amount)}</td><td>${detailsHtml}</td>`;

                        if (status === 'pending') {
                            rowHtml += `<td class="action-buttons"><button class="btn btn-sm btn-success btn-approve-deposit" data-id="${d.id}"><i class="bi bi-check-circle"></i></button> <button class="btn btn-sm btn-danger btn-reject-deposit" data-id="${d.id}"><i class="bi bi-x-circle"></i></button></td>`;
                        } else if (status === 'approved') {
                            rowHtml += `<td><small>${sanitizeHTML(d.adminNote || 'N/A')}</small></td>`;
                        } else if (status === 'rejected') {
                            rowHtml += `<td><small>${sanitizeHTML(d.rejectReason || 'N/A')}</small></td>`;
                        }
                        rowHtml += `</tr>`;
                        tableHtml += rowHtml;
                    });
                }
                const emptyColspan = status === 'pending' ? 5 : 6;
                targetTableBody.innerHTML = tableHtml || `<tr><td colspan="${emptyColspan}" class="text-center p-3 text-muted">No ${status} deposits found.</td></tr>`;
                
                if (status === 'pending') {
                    elements.pendingDepositCountBadge.textContent = count;
                    elements.pendingDepositCountBadge.style.display = count > 0 ? 'inline-block' : 'none';
                }
            }, (error) => {
                console.error(`Error loading ${status} deposits:`, error);
                targetTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-3 text-danger">Error: ${error.message}. Check Rules/Index.</td></tr>`;
                if (error?.message?.includes("index")) showStatus(elements.depositsStatus, "CRITICAL: Deposit query fail. Add '.indexOn': 'status' to '/rechargeRequests' rules.", "danger", false);
            });
        }

        async function openDepositActionModal(requestId, type) {
            if (!db || !requestId || !type || !isDesignatedAdmin(currentAdminUser)) return;
            showLoader(true);
            currentDepositAction = { id: requestId, type: type, userId: null };
            
            elements.depositRejectReasonInput.value = '';
            elements.depositApproveNoteInput.value = '';
            elements.depositRejectReasonDiv.style.display = 'none';
            elements.depositApproveNoteDiv.style.display = 'none';
            elements.approveDepositBtn.style.display = 'inline-block';
            elements.rejectDepositBtn.style.display = 'inline-block';
            clearStatus(elements.depositActionStatus);

            try {
                const snapshot = await get(ref(db, `rechargeRequests/${requestId}`));
                if (!snapshot.exists()) throw new Error("Deposit request not found.");
                const d = snapshot.val();
                currentDepositAction.userId = d.userId;

                if (d.status !== 'pending') {
                    alert(`Request already processed (Status: ${d.status}).`);
                    return;
                }
                
                const user = userDataCache[d.userId] || { displayName: 'Loading...', email: d.userId };
                elements.depositDetailId.textContent = requestId;
                elements.depositDetailUser.textContent = `${user.displayName} (${user.email})`;
                elements.depositDetailAmount.textContent = formatCurrency(d.amount);
                elements.depositDetailMethod.textContent = d.method || 'N/A';
                elements.depositDetailGameId.textContent = d.playerGameId || 'N/A';
                elements.depositDetailTxnId.textContent = d.transactionId || 'N/A';

                if (type === 'reject') {
                    elements.depositRejectReasonDiv.style.display = 'block';
                    elements.approveDepositBtn.style.display = 'none';
                } else {
                    elements.depositApproveNoteDiv.style.display = 'block';
                    elements.rejectDepositBtn.style.display = 'none';
                }
                getModalInstance(elements.depositActionModalEl)?.show();
            } catch (error) {
                console.error("Error opening deposit modal:", error);
                showStatus(elements.depositsStatus, `Error: ${error.message}`, 'danger');
            } finally {
                showLoader(false);
            }
        }

        async function processDepositAction() {
            const { id, type, userId } = currentDepositAction;
            if (!id || !type || !userId || !isDesignatedAdmin(currentAdminUser)) return;

            const statusEl = elements.depositActionStatus;
            clearStatus(statusEl);
            showLoader(true);
            elements.approveDepositBtn.disabled = true;
            elements.rejectDepositBtn.disabled = true;
            
            const updates = {};
            const depositRefPath = `rechargeRequests/${id}`;

            try {
                const depositSnap = await get(ref(db, depositRefPath));
                if (!depositSnap.exists() || depositSnap.val().status !== 'pending') throw new Error("Request not found or already processed.");
                const depositData = depositSnap.val();
                const amount = Number(depositData.amount);

                if (type === 'approve') {
                    const userSnap = await get(ref(db, `users/${userId}`));
                    if (!userSnap.exists()) throw new Error("User to credit not found.");
                    
                    const newBalance = (userSnap.val().balance || 0) + amount;
                    updates[`users/${userId}/balance`] = newBalance;
                    
                    const txKey = push(ref(db, `transactions/${userId}`)).key;
                    updates[`transactions/${userId}/${txKey}`] = {
                        type: 'deposit_approved',
                        amount: amount,
                        description: `Deposit via ${depositData.method}`,
                        timestamp: serverTimestamp(),
                        balanceAfter: newBalance,
                        adminUid: currentAdminUser.uid
                    };
                    
                    updates[`${depositRefPath}/status`] = 'approved';
                    updates[`${depositRefPath}/processedAt`] = serverTimestamp();
                    updates[`${depositRefPath}/adminNote`] = elements.depositApproveNoteInput.value.trim() || 'Approved';
                    
                    await update(ref(db), updates);
                    await sendNotification(userId, "Deposit Approved", `Your deposit request for ${formatCurrency(amount)} has been approved.`);
                    showStatus(elements.depositsStatus, "Deposit approved and balance updated.", "success");

                } else { // Reject
                    const reason = elements.depositRejectReasonInput.value.trim();
                    if (!reason) throw new Error("Rejection reason is required.");
                    
                    updates[`${depositRefPath}/status`] = 'rejected';
                    updates[`${depositRefPath}/processedAt`] = serverTimestamp();
                    updates[`${depositRefPath}/rejectReason`] = reason;

                    await update(ref(db), updates);
                    await sendNotification(userId, "Deposit Rejected", `Your deposit request was rejected. Reason: ${reason}`);
                    showStatus(elements.depositsStatus, "Deposit request rejected.", "success");
                }

                getModalInstance(elements.depositActionModalEl)?.hide();
                loadDashboardStats();

            } catch (error) {
                console.error("Error processing deposit:", error);
                showStatus(statusEl, `Error: ${error.message}`, "danger", false);
            } finally {
                showLoader(false);
                elements.approveDepositBtn.disabled = false;
                elements.rejectDepositBtn.disabled = false;
            }
        }

        async function sendNotification(userId, title, message) {
            if (!userId || !title || !message) {
                throw new Error("User ID, title, and message are required to send a notification.");
            }
            const notification = {
                title: title,
                message: message,
                isRead: false,
                timestamp: serverTimestamp()
            };
            await push(ref(db, `notifications/${userId}`), notification);
            console.log(`Notification sent to ${userId}`);
        }

        async function sendBroadcastNotification(event) {
            event.preventDefault();
            const title = elements.broadcastNotificationTitle.value.trim();
            const message = elements.broadcastNotificationMessage.value.trim();
            if (!title || !message) {
                showStatus(elements.notificationStatus, "Title and Message are required.", "warning");
                return;
            }

            if (!confirm(`Are you sure you want to send this notification to ALL users? This action cannot be undone.`)) {
                return;
            }

            showLoader(true);
            try {
                const usersSnap = await get(ref(db, 'users'));
                if (!usersSnap.exists()) throw new Error("No users found to broadcast to.");
                
                const updates = {};
                const notification = { title, message, isRead: false, timestamp: serverTimestamp() };
                let userCount = 0;
                
                usersSnap.forEach(userSnapshot => {
                    const userId = userSnapshot.key;
                    const newNotifKey = push(ref(db, `notifications/${userId}`)).key;
                    updates[`notifications/${userId}/${newNotifKey}`] = notification;
                    userCount++;
                });

                await update(ref(db), updates);
                showStatus(elements.notificationStatus, `Broadcast sent successfully to ${userCount} users.`, "success");
                elements.sendBroadcastNotificationForm.reset();

            } catch (error) {
                console.error("Error sending broadcast:", error);
                showStatus(elements.notificationStatus, `Error: ${error.message}`, "danger");
            } finally {
                showLoader(false);
            }
        }

        function setupRealtimeAdminListeners() {
            if (!db || !currentAdminUser || !isDesignatedAdmin(currentAdminUser)) return;
            console.log("Setting up realtime count listeners...");
            detachAllAdminListeners();

            const pendingWithdrawalQuery = query(ref(db, 'withdrawals'), orderByChild('status'), equalTo('pending'));
            dbListeners['pendingWithdrawalsCount'] = onValue(pendingWithdrawalQuery, (snapshot) => {
                 const count = snapshot.exists() ? snapshot.size : 0;
                 if (elements.pendingWithdrawalCountBadge) { elements.pendingWithdrawalCountBadge.textContent = count; elements.pendingWithdrawalCountBadge.style.display = count > 0 ? 'inline-block' : 'none'; }
                 if (elements.statPendingWithdrawals && elements.dashboardSection.classList.contains('active')) elements.statPendingWithdrawals.textContent = count;
            }, error => console.error("Listener error (pending withdrawals):", error));
            
            const pendingDepositQuery = query(ref(db, 'rechargeRequests'), orderByChild('status'), equalTo('pending'));
            dbListeners['pendingDepositsCount'] = onValue(pendingDepositQuery, (snapshot) => {
                const count = snapshot.exists() ? snapshot.size : 0;
                console.log("Realtime pending deposit count:", count);
                if (elements.pendingDepositCountBadge) {
                    elements.pendingDepositCountBadge.textContent = count;
                    elements.pendingDepositCountBadge.style.display = count > 0 ? 'inline-block' : 'none';
                }
            }, error => {
                console.error("Listener error (pending deposits):", error);
                if (elements.pendingDepositCountBadge) { elements.pendingDepositCountBadge.textContent = 'Err'; elements.pendingDepositCountBadge.style.display = 'inline-block';}
                if (error?.message?.includes("index")) showStatus(elements.dashboardStatus, `Deposit count error. Add index '.indexOn': 'status' to '/rechargeRequests'.`, "danger", false);
            });
        }
        
        function detachAllAdminListeners() {
             if (!db || Object.keys(dbListeners).length === 0) return;
             Object.keys(dbListeners).forEach(key => {
                 try {
                      if (key === 'pendingWithdrawalsCount') off(query(ref(db, 'withdrawals'), orderByChild('status'), equalTo('pending')), 'value', dbListeners[key]);
                      else if (key === 'pendingDepositsCount') off(query(ref(db, 'rechargeRequests'), orderByChild('status'), equalTo('pending')), 'value', dbListeners[key]);
                      else if (key === 'users') off(ref(db, 'users'), 'value', dbListeners[key]);
                      else if (key.startsWith('withdrawals-')) off(query(ref(db, 'withdrawals'), orderByChild('status'), equalTo(key.split('-')[1])), 'value', dbListeners[key]);
                      else if (key.startsWith('deposits-')) off(query(ref(db, 'rechargeRequests'), orderByChild('status'), equalTo(key.split('-')[1])), 'value', dbListeners[key]);
                      else console.warn("Unknown listener key, cannot detach automatically:", key);
                 } catch (e) { console.warn(`Could not detach listener ${key}`, e); }
             });
             dbListeners = {};
             console.log("Finished detaching listeners.");
        }
        
        async function openEditGameModal(gameId) { if (!db || !gameId || !isDesignatedAdmin(currentAdminUser)) return; showLoader(true); elements.gameForm.reset(); clearStatus(elements.gameStatus); const imgbbStatusEl = elements.gameForm.querySelector('.imgbb-upload-status'); if (imgbbStatusEl) { imgbbStatusEl.textContent = ''; imgbbStatusEl.style.display = 'none'; } try { const snapshot = await get(ref(db, `games/${gameId}`)); if (!snapshot.exists()) throw new Error(`Game ${gameId} not found.`); const game = snapshot.val(); elements.gameModalTitle.textContent = "Edit Game"; elements.gameEditId.value = gameId; elements.gameNameInput.value = game.name || ''; elements.gameImageUrlInput.value = game.imageUrl || ''; elements.gameImageFileInput.value = ''; getModalInstance(elements.gameModalEl)?.show(); } catch (error) { console.error("Error opening edit game modal:", error); showStatus(elements.gamesStatus, `Error loading game for edit: ${error.message}`, "danger", false); } finally { showLoader(false); } }
        async function openEditPromotionModal(promoId) { if (!db || !promoId || !isDesignatedAdmin(currentAdminUser)) return; showLoader(true); elements.promotionForm.reset(); clearStatus(elements.promotionStatus); const imgbbStatusEl = elements.promotionForm.querySelector('.imgbb-upload-status'); if (imgbbStatusEl) { imgbbStatusEl.textContent = ''; imgbbStatusEl.style.display = 'none'; } try { const snapshot = await get(ref(db, `promotions/${promoId}`)); if (!snapshot.exists()) throw new Error(`Promotion ${promoId} not found.`); const promo = snapshot.val(); elements.promotionModalTitle.textContent = "Edit Promotion"; elements.promotionEditId.value = promoId; elements.promoImageUrlInput.value = promo.imageUrl || ''; elements.promoLinkInput.value = promo.link || ''; elements.promoImageFileInput.value = ''; getModalInstance(elements.promotionModalEl)?.show(); } catch (error) { console.error("Error opening edit promotion modal:", error); showStatus(elements.promotionsStatus, `Error loading promotion for edit: ${error.message}`, "danger", false); } finally { showLoader(false); } }
        async function populateGameSelect(selectedValue = null) { if (!elements.tournamentGameSelect) return; const select = elements.tournamentGameSelect; select.innerHTML = '<option value="">Loading...</option>'; select.disabled = true; try { if (Object.keys(gameDataCache).length === 0) await loadGames(); if (Object.keys(gameDataCache).length > 0) { select.innerHTML = '<option value="">-- Select Game --</option>'; const sorted = Object.entries(gameDataCache).sort(([, a], [, b]) => a.localeCompare(b)); sorted.forEach(([id, name]) => { const opt = document.createElement('option'); opt.value = id; opt.textContent = sanitizeHTML(name); select.appendChild(opt); }); if (selectedValue) select.value = selectedValue; } else { select.innerHTML = '<option value="">No Games Available</option>'; } } catch (error) { console.error("Error populating game select:", error); select.innerHTML = '<option value="">Error Loading</option>'; } finally { select.disabled = false; } }
        
        async function openEditTournamentModal(tournamentId) {
            if (!db || !tournamentId || !isDesignatedAdmin(currentAdminUser)) return;
            showLoader(true);
            clearStatus(elements.addTournamentStatus);
            elements.tournamentForm.reset();
            currentEditingTournamentId = tournamentId;
        
            try {
                const snapshot = await get(ref(db, `tournaments/${tournamentId}`));
                if (!snapshot.exists()) throw new Error(`Tournament ${tournamentId} not found.`);
                const t = snapshot.val();
        
                await populateGameSelect(t.gameId);
                elements.tournamentModalTitle.textContent = "Edit Tournament";
                elements.tournamentEditId.value = tournamentId;
                elements.tournamentNameInput.value = t.name || '';
                
                if (t.startTime) {
                    try {
                        const d = new Date(t.startTime);
                        if (!isNaN(d)) {
                            const offset = d.getTimezoneOffset() * 60000;
                            elements.tournamentStartTimeInput.value = new Date(d - offset).toISOString().slice(0, 16);
                        }
                    } catch (e) { console.warn("Err fmt date", e); }
                }
                
                elements.tournamentStatusSelect.value = t.status || 'upcoming';
                elements.tournamentEntryFeeInput.value = t.entryFee ?? 0;
                elements.tournamentPrizePoolInput.value = t.prizePool ?? 0;
                elements.tournamentPerKillInput.value = t.perKillPrize ?? 0;
                elements.tournamentMaxPlayersInput.value = t.maxPlayers ?? 0;
                elements.tournamentTagsInput.value = (t.tags || []).join(', ');
                elements.tournamentModeInput.value = t.mode || '';
                elements.tournamentMapInput.value = t.map || '';
                elements.tournamentDescriptionInput.value = t.description || '';
                
                elements.tournamentRoomIdInput.value = t.roomId || '';
                elements.tournamentRoomPasswordInput.value = t.roomPassword || '';
                elements.tournamentShowIdPassCheckbox.checked = t.showIdPass || false;
        
                getModalInstance(elements.addTournamentModalEl)?.show();
            } catch (error) {
                console.error("Error opening edit tournament modal:", error);
                showStatus(elements.tournamentsStatus, `Error loading tournament: ${error.message}`, "danger", false);
                currentEditingTournamentId = null;
            } finally {
                showLoader(false);
            }
        }
        
        // MODIFIED: This function now calculates and displays Total Balance correctly.
        async function openUserModal(userId) {
            if (!db || !userId || !isDesignatedAdmin(currentAdminUser)) return;
            showLoader(true);
            clearStatus(elements.balanceUpdateStatus);
            elements.updateBalanceForm.reset();
            elements.userDetailReferredBy.textContent = "N/A";
            elements.userDetailReferredCount.textContent = "N/A";
            try {
                let user;
                if (fullUserDataCache[userId] && fullUserDataCache[userId].status !== 'error' && fullUserDataCache[userId].status !== 'deleted') {
                    user = fullUserDataCache[userId];
                } else {
                    const snapshot = await get(ref(db, `users/${userId}`));
                    if (!snapshot.exists()) throw new Error(`User ${userId} not found.`);
                    user = snapshot.val();
                    user.uid = userId;
                    fullUserDataCache[userId] = user;
                }
                elements.userModalTitle.textContent = `User: ${sanitizeHTML(user.displayName || 'N/A')}`;
                elements.userDetailUid.textContent = userId;
                elements.userDetailEmail.textContent = sanitizeHTML(user.email || 'N/A');
                elements.userDetailName.textContent = sanitizeHTML(user.displayName || 'N/A');
                elements.userDetailCreatedAt.textContent = formatDate(user.createdAt);

                // MODIFICATION: Calculate total balance from components.
                // EXPLANATION: This ensures the modal always shows the correct sum of winning and bonus cash.
                const totalBalance = (Number(user.winningCash) || 0) + (Number(user.bonusCash) || 0);
                elements.userDetailBalance.textContent = formatCurrency(totalBalance).substring(1); // remove ₹ symbol for consistency with other fields

                elements.userDetailWinning.textContent = (Number(user.winningCash) || 0).toFixed(2);
                elements.userDetailBonus.textContent = (Number(user.bonusCash) || 0).toFixed(2);

                elements.editUserUid.value = userId;
                elements.userDetailReferralCode.textContent = user.referralCode || 'N/A';
                const status = user.status || 'active';
                elements.userDetailStatus.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                elements.userDetailStatus.className = `fw-bold text-${status === 'active' ? 'success' : 'danger'}`;
                elements.userBlockBtn.textContent = status === 'active' ? 'Block User' : 'Unblock User';
                elements.userBlockBtn.className = `btn btn-sm ${status === 'active' ? 'btn-danger' : 'btn-success'}`;
                elements.userBlockBtn.dataset.id = userId;
                elements.userBlockBtn.dataset.action = status === 'active' ? 'block' : 'unblock';
                elements.userDeleteBtn.dataset.id = userId;
                getModalInstance(elements.userModalEl)?.show();
            } catch (error) {
                console.error("Error opening user modal:", error);
                showStatus(elements.usersStatus, `Error loading user: ${error.message}`, "danger", false);
            } finally {
                showLoader(false);
            }
        }
        
        async function openRegisteredPlayersModal(tournamentId, tournamentName) {
            if (!db || !tournamentId || !isDesignatedAdmin(currentAdminUser)) return;
            elements.registeredPlayersModalTitle.textContent = "Registered Players";
            elements.registeredPlayersTournamentName.textContent = tournamentName || "N/A";
            elements.registeredPlayersTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-3"><div class="spinner-border spinner-border-sm"></div></td></tr>`;
            clearStatus(elements.registeredPlayersStatus);
            getModalInstance(elements.registeredPlayersModalEl)?.show();
            
            try {
                const playersRef = ref(db, `tournaments/${tournamentId}/registeredPlayers`);
                const snapshot = await get(playersRef);
                
                if (!snapshot.exists()) {
                    elements.registeredPlayersTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-3 text-muted">No players registered.</td></tr>`;
                    return;
                }
                
                const registeredData = snapshot.val();
                const userIds = Object.keys(registeredData);
                let tableHtml = '';
                
                const promises = userIds.map(async (uid) => {
                    let user = fullUserDataCache[uid];
                    if (!user) {
                        const uSnap = await get(ref(db, `users/${uid}`));
                        user = uSnap.exists() ? { uid, ...uSnap.val() } : { uid, displayName: 'User Not Found', email: 'N/A' };
                        fullUserDataCache[uid] = user;
                    }
                    return { user, playerData: registeredData[uid] };
                });
                
                const results = await Promise.all(promises);
                
                results.forEach(({ user, playerData }) => {
                    tableHtml += `<tr>
                        <td><small class="text-muted">${sanitizeHTML(user.uid)}</small></td>
                        <td>${sanitizeHTML(user.displayName)}</td>
                        <td>${sanitizeHTML(playerData.inGameName || 'N/A')}</td>
                        <td>${sanitizeHTML(playerData.inGameId || 'N/A')}</td>
                        <td>${formatDate(playerData.joinedAt)}</td>
                    </tr>`;
                });

                elements.registeredPlayersTableBody.innerHTML = tableHtml || `<tr><td colspan="5" class="text-center p-3 text-muted">Could not load player details.</td></tr>`;
                elements.registeredPlayersModalTitle.textContent = `Registered Players (${results.length})`;

            } catch (error) {
                console.error("Error loading registered players:", error);
                elements.registeredPlayersTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-3 text-danger">Error: ${error.message}.</td></tr>`;
                showStatus(elements.registeredPlayersStatus, `Error: ${error.message}`, 'danger');
            }
        }
        
        function initializeAdminEventListeners() {
            console.log("Initializing Admin Event Listeners...");
            if (!auth || !db) { console.error("Cannot init listeners: Firebase not ready."); return; }
            elements.adminSetupForm?.addEventListener('submit', setupAdmin);
            elements.adminLoginForm?.addEventListener('submit', loginAdmin);
            elements.adminLogoutBtn?.addEventListener('click', logoutAdminUser);
            elements.sidebarLinks?.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); const sectionId = link.dataset.section; if (sectionId && !link.classList.contains('active')) { showAdminSection(sectionId); } else { getOffcanvasInstance(elements.sidebar)?.hide(); } }); });
            elements.saveGameBtn?.addEventListener('click', saveGame);
            elements.savePromotionBtn?.addEventListener('click', savePromotion);
            elements.saveTournamentBtn?.addEventListener('click', saveTournament);
            elements.saveNewUserBtn?.addEventListener('click', saveNewUser);
            elements.appSettingsForm?.addEventListener('submit', saveSettings);
            elements.updateBalanceForm?.addEventListener('submit', updateUserBalance);
            elements.addNewGameBtn?.addEventListener('click', () => { elements.gameForm?.reset(); elements.gameEditId.value = ''; elements.gameModalTitle.textContent = "Add New Game"; clearStatus(elements.gameStatus); const imgbbEl = elements.gameForm?.querySelector('.imgbb-upload-status'); if(imgbbEl){ imgbbEl.textContent=''; imgbbEl.style.display='none';} });
            elements.addNewPromotionBtn?.addEventListener('click', () => { elements.promotionForm?.reset(); elements.promotionEditId.value = ''; elements.promotionModalTitle.textContent = "Add New Promotion"; clearStatus(elements.promotionStatus); const imgbbEl = elements.promotionForm?.querySelector('.imgbb-upload-status'); if(imgbbEl){ imgbbEl.textContent=''; imgbbEl.style.display='none';} });
            elements.addNewTournamentBtn?.addEventListener('click', () => { currentEditingTournamentId = null; elements.tournamentForm?.reset(); if(elements.tournamentModalTitle) elements.tournamentModalTitle.textContent = "Add New Tournament"; clearStatus(elements.addTournamentStatus); populateGameSelect(); });
            elements.userBlockBtn?.addEventListener('click', toggleUserBlock);
            elements.userDeleteBtn?.addEventListener('click', (e) => { const userId = e.target.closest('button')?.dataset.id; if (userId) deleteUser(userId); });
            elements.approveWithdrawalBtn?.addEventListener('click', processWithdrawalAction);
            elements.rejectWithdrawalBtn?.addEventListener('click', processWithdrawalAction);
            elements.addDemoDataBtn?.addEventListener('click', addDemoData);
            elements.userSearchInput?.addEventListener('input', filterUsers);
            elements.saveThemeBtn?.addEventListener('click', saveTheme);
            elements.resetThemeBtn?.addEventListener('click', resetTheme);
            elements.previewDefaultThemeBtn?.addEventListener('click', () => populateThemePickers(defaultTheme));
            elements.previewCrimsonThemeBtn?.addEventListener('click', () => populateThemePickers(crimsonTheme));
            elements.previewOceanicThemeBtn?.addEventListener('click', () => populateThemePickers(oceanicTheme));
            elements.customThemeForm?.addEventListener('input', (e) => { if (e.target.matches('input[type="color"]')) { const textInput = e.target.parentElement.querySelector(`input[type="text"][data-target="${e.target.id}"]`); if(textInput) textInput.value = e.target.value; } else if (e.target.matches('input[type="text"]')) { const colorInput = getElement(e.target.dataset.target); if(colorInput && /^#[0-9A-F]{6}$/i.test(e.target.value)) { colorInput.value = e.target.value; } } });

            elements.saveUpdateBtn?.addEventListener('click', saveUpdate);
            elements.addNewUpdateBtn?.addEventListener('click', () => {
                elements.updateForm?.reset();
                elements.updateEditId.value = '';
                elements.updateModalTitle.textContent = "Add New Update";
                clearStatus(elements.updateStatus);
            });
            elements.approveDepositBtn?.addEventListener('click', processDepositAction);
            elements.rejectDepositBtn?.addEventListener('click', processDepositAction);
            elements.sendSingleNotificationForm?.addEventListener('submit', (e) => {
                e.preventDefault();
                const uid = elements.singleNotificationUid.value;
                const title = elements.singleNotificationTitle.value;
                const message = elements.singleNotificationMessage.value;
                sendNotification(uid, title, message)
                    .then(() => {
                        showStatus(elements.notificationStatus, `Notification sent to ${uid}`, "success");
                        elements.sendSingleNotificationForm.reset();
                    })
                    .catch(err => showStatus(elements.notificationStatus, `Error: ${err.message}`, "danger"));
            });
            elements.sendBroadcastNotificationForm?.addEventListener('submit', sendBroadcastNotification);
            
            document.body.addEventListener('click', (event) => {
                 const target = event.target; const actionButton = target.closest('button[data-id]'); const copyIcon = target.closest('.copy-btn[data-target]');
                 if (actionButton) {
                     const targetId = actionButton.dataset.id; if (!targetId) return;
                     if (actionButton.classList.contains('btn-delete-game')) deleteGame(targetId);
                     else if (actionButton.classList.contains('btn-edit-game')) openEditGameModal(targetId);
                     else if (actionButton.classList.contains('btn-delete-promo')) deletePromotion(targetId);
                     else if (actionButton.classList.contains('btn-edit-promo')) openEditPromotionModal(targetId);
                     else if (actionButton.classList.contains('btn-delete-update')) deleteUpdate(targetId);
                     else if (actionButton.classList.contains('btn-edit-update')) openEditUpdateModal(targetId);
                     else if (actionButton.classList.contains('btn-delete-tournament')) deleteTournament(targetId);
                     else if (actionButton.classList.contains('btn-edit-tournament')) openEditTournamentModal(targetId);
                     else if (actionButton.classList.contains('btn-view-user')) openUserModal(targetId);
                     else if (actionButton.classList.contains('btn-approve-withdrawal')) openWithdrawalActionModal(targetId, 'approve');
                     else if (actionButton.classList.contains('btn-reject-withdrawal')) openWithdrawalActionModal(targetId, 'reject');
                     else if (actionButton.classList.contains('btn-approve-deposit')) openDepositActionModal(targetId, 'approve');
                     else if (actionButton.classList.contains('btn-reject-deposit')) openDepositActionModal(targetId, 'reject');
                     else if (actionButton.classList.contains('btn-delete-user')) deleteUser(targetId);
                     else if (actionButton.classList.contains('btn-view-registered')) openRegisteredPlayersModal(targetId, actionButton.dataset.name);
                     return;
                 }
                 if (copyIcon) { copyToClipboard(copyIcon.dataset.target); return; }
            });
            
            const resetModal = (modalEl, formEl, statusEl, idField = null, titleEl = null, defaultTitle = 'Add New Item', imgbbSel = '.imgbb-upload-status') => { modalEl?.addEventListener('hidden.bs.modal', () => { formEl?.reset(); if(statusEl) clearStatus(statusEl); const imgbbStat = formEl?.querySelector(imgbbSel); if(imgbbStat) { imgbbStat.textContent=''; imgbbStat.style.display='none'; } if (idField) idField.value = ''; if (titleEl) titleEl.textContent = defaultTitle; if (modalEl === elements.addTournamentModalEl) currentEditingTournamentId = null; if (modalEl === elements.userModalEl) elements.editUserUid.value = ''; if (modalEl === elements.withdrawalActionModalEl) currentWithdrawalAction = { id: null, type: null, userId: null }; if (modalEl === elements.depositActionModalEl) currentDepositAction = { id: null, type: null, userId: null }; currentEditingItemId = null; }); };
            resetModal(elements.gameModalEl, elements.gameForm, elements.gameStatus, elements.gameEditId, elements.gameModalTitle, 'Add New Game');
            resetModal(elements.promotionModalEl, elements.promotionForm, elements.promotionStatus, elements.promotionEditId, elements.promotionModalTitle, 'Add New Promotion');
            resetModal(elements.updateModalEl, elements.updateForm, elements.updateStatus, elements.updateEditId, elements.updateModalTitle, 'Add New Update');
            resetModal(elements.addTournamentModalEl, elements.tournamentForm, elements.addTournamentStatus, elements.tournamentEditId, elements.tournamentModalTitle, 'Add New Tournament', null);
            resetModal(elements.addUserModalEl, elements.addUserForm, elements.addUserStatus, null, null, '', null);
            resetModal(elements.userModalEl, elements.updateBalanceForm, elements.balanceUpdateStatus, elements.editUserUid, null, '', null);
            resetModal(elements.withdrawalActionModalEl, null, elements.withdrawalActionStatus, null, null, '', null);
            resetModal(elements.depositActionModalEl, null, elements.depositActionStatus, null, null, '', null);
            resetModal(elements.registeredPlayersModalEl, null, elements.registeredPlayersStatus, null, null, '', null);
             console.log("Admin Event Listeners Initialized.");
        }

        function filterUsers() { const searchTerm = elements.userSearchInput.value.toLowerCase().trim(); const filteredUsers = Object.values(fullUserDataCache).filter(user => user.displayName?.toLowerCase().includes(searchTerm) || user.email?.toLowerCase().includes(searchTerm)); renderUsersTable(filteredUsers); }

        document.addEventListener('DOMContentLoaded', () => {
            console.log("Admin Panel DOM Loaded.");
            if (!app || !auth || !db) return;
            initializeAdminEventListeners();
            onAuthStateChanged(auth, handleAdminAuthStateChange);
        });

    </script>

</body>
</html>            <div class="header-game-title" id="headerGameTitleEl">Game Title</div>
        </div>
        <div class="header-right">
            <button class="notification-icon" id="notificationBtnEl"> <i class="bi bi-bell-fill"></i> <span class="notification-badge" style="display: none;"></span> </button>
            <button class="wallet-chip" id="headerWalletChipEl" style="display: none;"> <i class="bi bi-wallet-fill"></i> ৳<span id="headerChipBalanceEl">0</span> </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="main-content">
        <div id="globalLoaderEl"> <div class="loader"></div> </div>

        <!-- Login Section -->
        <section id="login-section" class="section">
             <div class="container" style="max-width: 450px;">
                <div class="text-center mb-4 login-logo-container">
                    <img src="https://via.placeholder.com/80/FFFFFF/0F172A?text=G" alt="Logo" class="login-logo" id="loginLogoEl">
                    <h1 class="login-brand-title">L TOURNAMENT</h1>
                </div>

                <div class="card shadow-sm custom-card">
                    <div class="card-body p-4">
                        <!-- Login Form -->
                        <form id="emailLoginForm">
                            <h2 class="card-title text-center mb-4">Login</h2>
                            <div class="mb-3"> <label for="loginEmailInputEl" class="form-label">Email</label> <input type="email" class="form-control" id="loginEmailInputEl" placeholder="name@example.com" required> </div>
                            <div class="mb-3"> <label for="loginPasswordInputEl" class="form-label">Password</label> <input type="password" class="form-control" id="loginPasswordInputEl" placeholder="Password" required> </div>
                            <div id="loginStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                            <div class="d-grid gap-2 mb-3"> <button type="button" class="btn btn-custom btn-custom-primary" id="loginEmailBtnEl">Login</button> <button type="button" class="btn-custom-link btn-sm p-0 text-center d-block" id="showSignupToggleBtnEl">Need an account? Sign Up</button> <a href="#" id="forgotPasswordLinkEl" class="text-center small mt-2 d-block" style="color: var(--text-secondary);">Forgot Password?</a> </div>
                        </form>

                        <!-- Signup Form (Initially Hidden) -->
                        <form id="emailSignupForm" style="display: none;">
                            <h2 class="card-title text-center mb-4">Sign Up</h2>
                            <div class="mb-3"> <label for="signupEmailInputEl" class="form-label">Email</label> <input type="email" class="form-control" id="signupEmailInputEl" placeholder="name@example.com" required> </div>
                            <div class="mb-3"> <label for="signupPasswordInputEl" class="form-label">Password (min 6 chars)</label> <input type="password" class="form-control" id="signupPasswordInputEl" placeholder="Password" required minlength="6"> </div>
                            <div class="mb-3"> <label for="signupConfirmPasswordInputEl" class="form-label">Confirm Password</label> <input type="password" class="form-control" id="signupConfirmPasswordInputEl" placeholder="Confirm Password" required> </div>
                            <div class="mb-3"> <label for="signupReferralCodeInputEl" class="form-label">Referral Code (Optional)</label> <input type="text" class="form-control" id="signupReferralCodeInputEl" placeholder="Enter referral code"> </div>
                            <div id="signupStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                            <div class="d-grid gap-2 mb-3"> <button type="button" class="btn btn-custom btn-custom-accent" id="signupEmailBtnEl">Sign Up</button> <button type="button" class="btn-custom-link btn-sm p-0 text-center d-block" id="showLoginToggleBtnEl">Already have account? Login</button> </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <!-- Home Section -->
        <section id="home-section" class="section">
            <!-- 1. Promotion Slider -->
            <div class="swiper-container" id="promotionSliderEl">
                <div class="swiper-wrapper placeholder-glow"> <div class="swiper-slide"><span class="placeholder" style="display: block; width: 100%; height: 100%; border-radius: 10px;"></span></div> </div>
                 <div class="swiper-pagination"></div>
            </div>

            <!-- 2. NEW: Home Page Tournament Filter Tabs -->
            <div class="home-tabs-container">
                <div class="home-tab-box" data-target="upcoming">
                    <i class="bi bi-calendar-event-fill"></i>
                    <span>Upcoming</span>
                </div>
                <div class="home-tab-box" data-target="ongoing">
                    <i class="bi bi-play-circle-fill"></i>
                    <span>Ongoing</span>
                </div>
                <div class="home-tab-box" data-target="completed">
                    <i class="bi bi-trophy-fill"></i>
                    <span>Results</span>
                </div>
            </div>

            <!-- 3. NEW: User Profiles Horizontal Scroll -->
            <h6 class="text-secondary small ms-1 mb-2">Active Players</h6>
            <div class="user-ticker-container">
                <div class="user-ticker-wrapper" id="homeUserTickerEl">
                    <!-- Ticker items will be injected here by JS -->
                </div>
            </div>

            <h2 class="section-title">Esport Games</h2>
            <div class="row g-3 mb-4 placeholder-glow" id="gamesListEl">
                <div class="col-6"> <div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px; border-top-left-radius: 8px; border-top-right-radius: 8px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div> </div> <div class="col-6"> <div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px; border-top-left-radius: 8px; border-top-right-radius: 8px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div> </div>
            </div>
            <h2 class="section-title">My Contests</h2>
            <div id="myContestsListEl" class="placeholder-glow">
                <div class="tournament-card placeholder-glow mb-3"> <span class="placeholder col-6" style="height: 18px;"></span> <span class="placeholder col-12 mt-2" style="height: 24px;"></span> <span class="placeholder col-10 mt-2" style="height: 16px;"></span> <div class="d-flex justify-content-between mt-3"> <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span> <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span> </div> </div>
                <p id="noContestsMessageEl" class="text-secondary text-center" style="display: none;">You haven't joined any contests yet.</p>
            </div>
        </section>

        <!-- Tournaments Section -->
        <section id="tournaments-section" class="section">
            <div class="tournament-tabs"> <button class="tab-item active" data-status="upcoming"><i class="bi bi-calendar-event-fill"></i> Upcoming</button> <button class="tab-item" data-status="ongoing"><i class="bi bi-play-circle-fill"></i> Ongoing</button> <button class="tab-item" data-status="completed"><i class="bi bi-trophy-fill"></i> Results</button> </div>
            <div id="tournamentsListContainerEl" class="mt-3 placeholder-glow"> <div class="tournament-card placeholder-glow mb-3"> <span class="placeholder col-6" style="height: 18px;"></span> <span class="placeholder col-12 mt-2" style="height: 24px;"></span> <span class="placeholder col-10 mt-2" style="height: 16px;"></span> <div class="d-flex justify-content-between mt-3"> <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span> <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span> </div> </div> </div>
            <p id="noTournamentsMessageEl" class="text-secondary text-center mt-4" style="display: none;">No tournaments found.</p>
        </section>

        <!-- Leaderboard Section -->
        <section id="leaderboard-section" class="section">
            <h2 class="section-title">Leaderboard</h2>
            <p class="text-secondary small mb-3">Top players by total wallet balance.</p>
            <div id="leaderboardListEl" class="placeholder-glow">
                 <div class="leaderboard-item"><span class="leaderboard-rank placeholder col-1"></span> <span class="leaderboard-avatar placeholder" style="width: 45px; height: 45px; border-radius: 50%;"></span><span class="leaderboard-name placeholder col-6"></span> <span class="leaderboard-winnings placeholder col-3"></span></div>
                 <div class="leaderboard-item"><span class="leaderboard-rank placeholder col-1"></span> <span class="leaderboard-avatar placeholder" style="width: 45px; height: 45px; border-radius: 50%;"></span><span class="leaderboard-name placeholder col-6"></span> <span class="leaderboard-winnings placeholder col-3"></span></div>
                 <div class="leaderboard-item"><span class="leaderboard-rank placeholder col-1"></span> <span class="leaderboard-avatar placeholder" style="width: 45px; height: 45px; border-radius: 50%;"></span><span class="leaderboard-name placeholder col-6"></span> <span class="leaderboard-winnings placeholder col-3"></span></div>
            </div>
            <p id="noLeaderboardMessageEl" class="text-secondary text-center mt-4" style="display: none;">Leaderboard data is not available yet.</p>
        </section>

        <!-- Update Section -->
        <section id="update-section" class="section">
            <h2 class="section-title">Updates & Notices</h2>
            <div id="updateFeedEl">
                <div class="update-post-card placeholder-glow">
                    <div class="placeholder" style="width: 100%; height: 200px;"></div>
                    <div class="update-post-content">
                        <h4 class="update-post-title placeholder col-8"></h4>
                        <p class="update-post-body placeholder col-12"></p>
                        <p class="update-post-body placeholder col-10"></p>
                    </div>
                </div>
            </div>
             <p id="noUpdatesMessageEl" class="text-secondary text-center mt-4" style="display: none;">No updates available yet.</p>
        </section>

        <!-- Wallet Section -->
        <section id="wallet-section" class="section">
            <div class="wallet-card custom-card">
                <h2 class="section-title mb-4">Wallet</h2>
                <div class="balance-item placeholder-glow"> <span class="balance-item-label">Total Balance</span> <span class="balance-item-value" id="walletTotalBalanceEl"><span class="placeholder col-3"></span></span> <div class="balance-item-action"> <button class="btn-custom-link" id="allTransactionsBtnEl">History <i class="bi bi-chevron-right"></i></button> </div> </div>
                <div class="balance-item placeholder-glow"> <span class="balance-item-label">Winning Cash</span> <span class="balance-item-value" id="walletWinningCashEl"><span class="placeholder col-3"></span></span> <div class="balance-item-action"> </div> </div>
                <div class="balance-item placeholder-glow"> <span class="balance-item-label">Bonus Cash</span> <span class="balance-item-value" id="walletBonusCashEl"><span class="placeholder col-3"></span></span> <div class="balance-item-action" style="min-width: 100px;"></div> </div>
                <div class="d-grid gap-2 mt-4">
                    <button class="btn btn-custom btn-custom-primary" id="withdrawBtnEl"> <i class="bi bi-cash-coin me-2"></i>Withdraw Money</button>
                    <button class="btn btn-custom btn-custom-secondary" id="addAmountWalletBtnEl"> <i class="bi bi-plus-circle-fill me-2"></i>Add Money </button>
                </div>
            </div>
            <h3 class="section-title mt-4">Recent Transactions</h3>
            <div id="recentTransactionsListEl" class="placeholder-glow"> <div class="custom-card p-2 mb-2 placeholder-glow"> <div class="d-flex justify-content-between"> <span class="placeholder col-5" style="height: 16px;"></span> <span class="placeholder col-3" style="height: 16px;"></span> </div> <div class="small text-secondary mt-1"><span class="placeholder col-6" style="height: 14px;"></span></div> </div> <p class="text-secondary text-center mt-3" id="noTransactionsMessageEl" style="display: none;">Loading transactions...</p> </div>
        </section>

        <!-- Profile Section -->
        <section id="profile-section" class="section">
            <div class="profile-header-card placeholder-glow">
                <img src="https://via.placeholder.com/70" alt="Avatar" class="profile-avatar" id="profileAvatarEl">
                
                <div id="profileNameDisplayContainer" class="d-flex align-items-center justify-content-center gap-2 mt-2">
                    <h3 class="profile-name mb-0" id="profileNameEl"><span class="placeholder col-6"></span></h3>
                    <button class="btn btn-sm btn-link p-0" id="editProfileNameBtnEl" style="font-size: 1.1rem; line-height: 1; color: var(--text-secondary);"><i class="bi bi-pencil-square"></i></button>
                </div>
                <div id="editProfileNameContainerEl" class="input-group mt-2 w-75 mx-auto" style="display: none;">
                    <input type="text" class="form-control form-control-sm" id="profileNameInputEl" placeholder="Enter new name">
                    <button class="btn btn-sm btn-custom-accent" id="saveProfileNameBtnEl">Save</button>
                </div>
                
                <p class="profile-email mt-1" id="profileEmailEl"><span class="placeholder col-8"></span></p>
                <div id="profileNameStatusMessageEl" class="alert small py-1" style="display: none;"></div>
                
                <div class="profile-stats w-100">
                    <div class="stat-item"><strong id="profileTotalMatchesEl"><span class="placeholder col-4"></span></strong><span>Matches Played</span></div>
                    <div class="stat-item"><strong id="profileWonMatchesEl"><span class="placeholder col-4"></span></strong><span>Matches Won</span></div>
                    <div class="stat-item"><strong id="profileTotalEarningsEl"><span class="placeholder col-4"></span></strong><span>Total Winnings</span></div>
                </div>
            </div>
            <div class="profile-links">
                <div class="list-group custom-card">
                    <label class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item"> <span><i class="bi bi-bell-fill"></i> Notifications</span> <div class="form-check form-switch"> <input class="form-check-input" type="checkbox" role="switch" id="notificationSwitchEl" checked> </div> </label>
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" id="liveSupportBtnEl"> <span><i class="bi bi-headset"></i> Live Support</span> <i class="bi bi-chevron-right"></i> </a>
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" id="contactSupportBtnEl"> <span><i class="bi bi-envelope-fill"></i> Contact Support</span> <i class="bi bi-box-arrow-up-right"></i> </a>
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="refer"> <span><i class="bi bi-person-plus-fill"></i> Refer & Earn</span> <i class="bi bi-chevron-right"></i> </a>
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="privacy"> <span><i class="bi bi-shield-lock-fill"></i> Privacy Policy</span><i class="bi bi-chevron-right"></i> </a>
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="terms"> <span><i class="bi bi-file-text-fill"></i> Terms and Conditions</span><i class="bi bi-chevron-right"></i> </a>
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="refund"> <span><i class="bi bi-arrow-repeat"></i> Refund and Cancellation</span><i class="bi bi-chevron-right"></i> </a>
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="fairPlay"> <span><i class="bi bi-patch-check-fill"></i> Fair Play Policy</span><i class="bi bi-chevron-right"></i> </a>
                    <button class="list-group-item list-group-item-action text-danger d-flex justify-content-between align-items-center interactive-list-item" id="logoutProfileBtnEl"> <span><i class="bi bi-box-arrow-right"></i> Logout</span><span></span> </button>
                </div>
            </div>
        </section>

    </main>

    <!-- NEW MODAL: Join Tournament Confirmation -->
    <div class="modal fade" id="joinConfirmModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Join</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="joinConfirmTextEl">আপনি কি টুর্নামেন্টে জয়েন হবেন, যদি এই টুর্নামেন্টে জয়েন হতে চান তাহলে আপনার গেম আইডি, এবং আপনার আপনার নাম দিয়ে কনফার্ম বাটনে ক্লিক করুন</p>
                    <div class="mb-3">
                        <label for="joinGameIdInputEl" class="form-label">Enter Your Game Id</label>
                        <input type="text" class="form-control" id="joinGameIdInputEl" placeholder="e.g., YourGameID123" required>
                    </div>
                    <div class="mb-3">
                        <label for="joinFullNameInputEl" class="form-label">Enter Your Full Name</label>
                        <input type="text" class="form-control" id="joinFullNameInputEl" placeholder="e.g., John Doe" required>
                    </div>
                     <div id="joinStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-custom btn-custom-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-custom btn-custom-accent" id="confirmJoinBtnEl">Confirm</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Other Modals -->
    <div class="modal fade" id="policyModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-scrollable modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="policyModalTitleEl">Details</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body" id="policyModalBodyEl" style="min-height: 300px;"></div></div></div></div>
    <div class="modal fade" id="rechargeModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="rechargeModalTitleEl">Recharge</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><div id="rechargeStep1"><div class="text-center mb-3"><small class="text-secondary">Total Balance</small><h3 class="mb-3" id="rechargeModalBalanceEl">৳0.00</h3></div><div class="mb-3"><label for="rechargeAmountInputEl" class="form-label">Amount</label><input type="number" class="form-control text-center fs-4" id="rechargeAmountInputEl" placeholder="10 - 1000"><small class="text-secondary d-block text-center mt-1">Minimum: ৳10, Maximum: ৳10000</small></div><div class="d-flex justify-content-center flex-wrap gap-2 my-4" id="presetAmountsContainerEl"><button class="btn btn-custom btn-custom-secondary preset-amount-btn" data-amount="20">৳20</button><button class="btn btn-custom btn-custom-secondary preset-amount-btn" data-amount="50">৳50</button><button class="btn btn-custom btn-custom-secondary preset-amount-btn" data-amount="100">৳100</button><button class="btn btn-custom btn-custom-secondary preset-amount-btn" data-amount="200">৳200</button><button class="btn btn-custom btn-custom-secondary preset-amount-btn" data-amount="500">৳500</button><button class="btn btn-custom btn-custom-secondary preset-amount-btn" data-amount="1000">৳1000</button></div><div class="d-grid"><button class="btn btn-custom btn-custom-primary" id="rechargeNextBtnEl">Recharge</button></div></div><div id="rechargeStep2" style="display: none;"><div class="text-center mb-4"><small class="text-secondary">Recharge Amount</small><h2 class="text-accent" id="rechargeConfirmAmountEl">৳50.00</h2></div><h6 class="section-title mb-3">Select Payment Method</h6><div class="list-group payment-method-list"><label class="list-group-item list-group-item-action d-flex align-items-center gap-3"><input class="form-check-input" type="radio" name="paymentMethod" value="bKash" id="paymentMethodBkash"><img src="https://iili.io/KJaab3P.png" alt="bKash" style="height: 30px;"><span class="fw-bold">bKash</span></label><label class="list-group-item list-group-item-action d-flex align-items-center gap-3"><input class="form-check-input" type="radio" name="paymentMethod" value="Nagad" id="paymentMethodNagad"><img src="https://iili.io/KJacOHF.jpg" alt="Nagad" style="height: 30px;"><span class="fw-bold">Nagad</span></label></div><div class="d-grid mt-4"><button class="btn btn-custom btn-custom-primary" id="rechargeProcessBtnEl">Process to Pay</button></div></div><div id="rechargeStep3" style="display: none;"><div class="text-center mb-3"><small class="text-secondary">Recharge Amount</small><h2 id="rechargeFinalAmountEl">৳50.00</h2><p class="mb-0">Payment Mode: <strong id="rechargeFinalMethodEl">bKash</strong></p></div><div class="text-center my-3"><img id="rechargeQrCodeEl" src="https://iili.io/KJajPup.jpg" alt="QR Code" class="img-fluid rounded" style="max-width: 180px; border: 2px solid var(--border-color); display: none;"><p class="mt-2 mb-0">BIKASH/NAGAT available</p><p>ROKET: <strong class="text-warning" id="rechargePaymentNumberEl">[Number from settings]</strong></p><p>[01305888199]</p></div><p class="small text-warning text-center">After paying, please fill the details below to complete the recharge.TransactionId must be provided </p><div class="mb-3"><label for="rechargeTxnIdInputEl" class="form-label">Type Payment Transaction ID</label><input type="text" class="form-control" id="rechargeTxnIdInputEl" placeholder="Enter Transaction ID here..."></div><div class="mb-3"><label for="rechargeGameIdInputEl" class="form-label">Enter In Your Phone Number</label><input type="text" class="form-control" id="rechargeGameIdInputEl" placeholder="Enter your in-Current phone-number"></div><div id="rechargeStatusMessageEl" class="alert" style="display: none;"></div><div class="d-grid gap-2"><button class="btn btn-custom btn-custom-accent" id="rechargeSubmitBtnEl">Submit</button><button type="button" class="btn btn-custom btn-custom-secondary" id="rechargeBackBtnEl">Back</button></div></div></div></div></div></div>
    
    <!-- Withdraw Modal -->
    <div class="modal fade" id="withdrawModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-cash-coin me-2"></i> Withdraw Funds</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-secondary">Withdrawable balance: <strong class="text-light" id="withdrawModalBalanceEl">৳0.00</strong></p>
                    
                    <div class="mb-3">
                        <label class="form-label">Withdrawal Method</label>
                        <div class="list-group payment-method-list">
                            <label class="list-group-item list-group-item-action d-flex align-items-center gap-3">
                                <input class="form-check-input" type="radio" name="withdrawPaymentMethod" value="bKash" id="withdrawMethodBkash" checked>
                                <img src="https://iili.io/KJaab3P.png" alt="bKash" style="height: 30px;">
                                <span class="fw-bold">bKash</span>
                            </label>
                            <label class="list-group-item list-group-item-action d-flex align-items-center gap-3">
                                <input class="form-check-input" type="radio" name="withdrawPaymentMethod" value="Nagad" id="withdrawMethodNagad">
                                <img src="https://iili.io/KJacOHF.jpg" alt="Nagad" style="height: 30px;">
                                <span class="fw-bold">Nagad</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="withdrawAccountInputEl" class="form-label">Account Number</label>
                        <input type="tel" class="form-control" id="withdrawAccountInputEl" placeholder="Enter your account phone number">
                    </div>

                    <div class="mb-3">
                        <label for="withdrawAmountInputEl" class="form-label">Amount (Min ৳<span id="minWithdrawAmountEl">50</span>)</label>
                        <input type="number" class="form-control" id="withdrawAmountInputEl" placeholder="Enter amount">
                    </div>
                    
                    <div id="withdrawStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-custom btn-custom-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-custom btn-custom-primary" id="submitWithdrawRequestBtnEl">Submit Request</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="matchDetailsModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="matchDetailsModalTitleEl">Match Details</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body" id="matchDetailsModalBodyEl"></div></div></div></div>
    <div class="modal fade" id="idPasswordModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Room ID & Password</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><p class="small text-secondary">ID/Pass shown shortly before match start.</p><div class="my-3 p-3" style="background: var(--primary-bg); border-radius: 8px;"><p class="mb-1">Room ID:</p><h4 id="roomIdDisplayEl" class="text-accent referral-code placeholder-glow d-inline-block"><span class="placeholder col-6"></span></h4><button class="btn btn-sm btn-outline-warning ms-2 copy-btn" data-target="#roomIdDisplayEl" title="Copy Room ID"><i class="bi bi-clipboard"></i></button></div><div class="my-3 p-3" style="background: var(--primary-bg); border-radius: 8px;"><p class="mb-1">Password:</p><h4 id="roomPasswordDisplayEl" class="text-accent referral-code placeholder-glow d-inline-block"><span class="placeholder col-6"></span></h4><button class="btn btn-sm btn-outline-warning ms-2 copy-btn" data-target="#roomPasswordDisplayEl" title="Copy Password"><i class="bi bi-clipboard"></i></button></div><p class="small text-warning"><i class="bi bi-exclamation-triangle"></i> Don't share ID/Password.</p></div></div></div></div>
    <div class="modal fade" id="notificationsModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="bi bi-bell-fill me-2"></i> Notifications</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body p-0"><div class="list-group list-group-flush" id="notificationsListEl"><p class="text-secondary text-center p-4" id="noNotificationsMessageEl">No notifications yet.</p></div></div></div></div></div>

    <!-- Comments Modal -->
    <div class="modal fade" id="commentsModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Comments</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="comment-list" id="commentsListEl">
                        <p class="text-center text-secondary">No comments yet.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="message-input-group w-100">
                        <input type="text" class="form-control" id="commentInputEl" placeholder="Add a comment...">
                        <button class="btn btn-custom btn-custom-accent" id="sendCommentBtnEl"><i class="bi bi-send-fill"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Live Support Modal -->
    <div class="modal fade" id="liveSupportModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-headset"></i> Live Support</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="chat-messages" id="liveSupportMessagesEl">
                        <!-- Messages will be injected here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="message-input-group w-100">
                        <input type="text" class="form-control" id="liveSupportInputEl" placeholder="Type your message...">
                        <button class="btn btn-custom btn-custom-primary" id="sendLiveSupportBtnEl"><i class="bi bi-send-fill"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-item active" data-section="home-section"><i class="bi bi-house-door-fill"></i><span>Home</span></button>
        <button class="nav-item" data-section="leaderboard-section"><i class="bi bi-trophy-fill"></i><span>Leaderboard</span></button>
        <button class="nav-item" data-section="update-section"><i class="bi bi-newspaper"></i><span>Update</span></button>
        <button class="nav-item" data-section="wallet-section"><i class="bi bi-wallet-fill"></i><span>Wallet</span></button>
        <button class="nav-item" data-section="profile-section"><i class="bi bi-person-fill"></i><span>Profile</span></button>
    </nav>

    <!-- JS Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

    <!-- Firebase SDK & App Logic -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, get, set, update, push, query, orderByChild, equalTo, onValue, runTransaction, off, limitToLast, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        // ===============================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBhE8HNbhHcL_DlGWDW4zu3AvE8VSeA8zE",
            authDomain: "l-tournament-10594.firebaseapp.com",
            databaseURL: "https://l-tournament-10594-default-rtdb.firebaseio.com",
            projectId: "l-tournament-10594",
            storageBucket: "l-tournament-10594.firebasestorage.app",
            messagingSenderId: "517389311136",
            appId: "1:517389311136:web:c05c333a3a15465fd37dc5"
        };
        // ===============================================================

        // Initialize Firebase
        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            auth = getAuth(app);
            console.log("Firebase Initialized");
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.body.innerHTML = `<div class="alert alert-danger m-5">Critical Error: Could not connect. Check Firebase config.</div>`;
        }

        // --- DOM Elements Cache ---
         const getElement = (id) => document.getElementById(id);
         const querySel = (selector) => document.querySelector(selector);
         const querySelAll = (selector) => document.querySelectorAll(selector);
         const elements = {
             sections: querySelAll('.section'), bottomNavItems: querySelAll('.bottom-nav .nav-item'), globalLoader: getElement('globalLoaderEl'),
             headerBackBtn: getElement('headerBackBtnEl'), headerTitleContainer: getElement('headerTitleContainerEl'), headerGameTitle: getElement('headerGameTitleEl'), headerWalletChip: getElement('headerWalletChipEl'), headerChipBalance: getElement('headerChipBalanceEl'), headerUserGreeting: getElement('headerUserGreetingEl'), appLogo: getElement('appLogoEl'), notificationBtn: getElement('notificationBtnEl'), notificationBadge: querySel('.notification-badge'),
             loginSection: getElement('login-section'), loginLogo: getElement('loginLogoEl'),
             emailLoginForm: getElement('emailLoginForm'), loginEmailInput: getElement('loginEmailInputEl'), loginPasswordInput: getElement('loginPasswordInputEl'), loginEmailBtn: getElement('loginEmailBtnEl'), showSignupToggleBtn: getElement('showSignupToggleBtnEl'), loginStatusMessage: getElement('loginStatusMessageEl'), forgotPasswordLink: getElement('forgotPasswordLinkEl'),
             emailSignupForm: getElement('emailSignupForm'), signupEmailInput: getElement('signupEmailInputEl'), signupPasswordInput: getElement('signupPasswordInputEl'), signupConfirmPasswordInput: getElement('signupConfirmPasswordInputEl'), signupReferralCodeInput: getElement('signupReferralCodeInputEl'), signupEmailBtn: getElement('signupEmailBtnEl'), showLoginToggleBtn: getElement('showLoginToggleBtnEl'), signupStatusMessage: getElement('signupStatusMessageEl'),
             homeSection: getElement('home-section'), promotionSlider: getElement('promotionSliderEl'), gamesList: getElement('gamesListEl'), myContestsList: getElement('myContestsListEl'), noContestsMessage: getElement('noContestsMessageEl'),
             // NEW: Home Page Elements
             homeTabs: querySelAll('.home-tab-box'),
             homeUserTicker: getElement('homeUserTickerEl'),
             
             tournamentsSection: getElement('tournaments-section'), tournamentsListContainer: getElement('tournamentsListContainerEl'), noTournamentsMessage: getElement('noTournamentsMessageEl'), tournamentTabs: querySelAll('.tournament-tabs .tab-item'),
             walletSection: getElement('wallet-section'), walletTotalBalance: getElement('walletTotalBalanceEl'), walletWinningCash: getElement('walletWinningCashEl'), walletBonusCash: getElement('walletBonusCashEl'), allTransactionsBtn: getElement('allTransactionsBtnEl'), withdrawBtn: getElement('withdrawBtnEl'), addAmountWalletBtn: getElement('addAmountWalletBtnEl'), recentTransactionsList: getElement('recentTransactionsListEl'), noTransactionsMessage: getElement('noTransactionsMessageEl'),
             profileSection: getElement('profile-section'), profileAvatar: getElement('profileAvatarEl'), profileName: getElement('profileNameEl'), profileEmail: getElement('profileEmailEl'), profileTotalMatches: getElement('profileTotalMatchesEl'), profileWonMatches: getElement('profileWonMatchesEl'), profileTotalEarnings: getElement('profileTotalEarningsEl'), logoutProfileBtn: getElement('logoutProfileBtnEl'), policyLinks: querySelAll('.profile-links a[data-policy], .profile-links button[data-policy]'), notificationSwitch: getElement('notificationSwitchEl'),
             
             editProfileNameBtnEl: getElement('editProfileNameBtnEl'),
             saveProfileNameBtnEl: getElement('saveProfileNameBtnEl'),
             profileNameInputEl: getElement('profileNameInputEl'),
             editProfileNameContainerEl: getElement('editProfileNameContainerEl'),
             profileNameDisplayContainer: getElement('profileNameDisplayContainer'),
             profileNameStatusMessageEl: getElement('profileNameStatusMessageEl'),

             leaderboardSection: getElement('leaderboard-section'),
             leaderboardList: getElement('leaderboardListEl'),
             noLeaderboardMessage: getElement('noLeaderboardMessageEl'),

             updateSection: getElement('update-section'),
             updateFeed: getElement('updateFeedEl'),
             noUpdatesMessage: getElement('noUpdatesMessageEl'),

             liveSupportBtn: getElement('liveSupportBtnEl'),
             contactSupportBtnEl: getElement('contactSupportBtnEl'),

             policyModalInstance: getElement('policyModalEl') ? new bootstrap.Modal(getElement('policyModalEl')) : null, policyModalTitle: getElement('policyModalTitleEl'), policyModalBody: getElement('policyModalBodyEl'),
             notificationsModalInstance: getElement('notificationsModalEl') ? new bootstrap.Modal(getElement('notificationsModalEl')) : null, notificationsList: getElement('notificationsListEl'), noNotificationsMessage: getElement('noNotificationsMessageEl'),
             rechargeModalInstance: getElement('rechargeModalEl') ? new bootstrap.Modal(getElement('rechargeModalEl')) : null, rechargeModalTitle: getElement('rechargeModalTitleEl'), rechargeStep1: getElement('rechargeStep1'), rechargeStep2: getElement('rechargeStep2'), rechargeStep3: getElement('rechargeStep3'), rechargeModalBalance: getElement('rechargeModalBalanceEl'), rechargeAmountInput: getElement('rechargeAmountInputEl'), presetAmountsContainer: getElement('presetAmountsContainerEl'), rechargeNextBtn: getElement('rechargeNextBtnEl'), rechargeConfirmAmount: getElement('rechargeConfirmAmountEl'), rechargeProcessBtn: getElement('rechargeProcessBtnEl'), rechargeFinalAmount: getElement('rechargeFinalAmountEl'), rechargeFinalMethod: getElement('rechargeFinalMethodEl'), rechargeQrCode: getElement('rechargeQrCodeEl'), rechargePaymentNumber: getElement('rechargePaymentNumberEl'), rechargeTxnIdInput: getElement('rechargeTxnIdInputEl'), rechargeGameIdInput: getElement('rechargeGameIdInputEl'), rechargeStatusMessage: getElement('rechargeStatusMessageEl'), rechargeSubmitBtn: getElement('rechargeSubmitBtnEl'), rechargeBackBtn: getElement('rechargeBackBtnEl'),
             withdrawModalInstance: getElement('withdrawModalEl') ? new bootstrap.Modal(getElement('withdrawModalEl')) : null, withdrawModalBalance: getElement('withdrawModalBalanceEl'), withdrawAmountInput: getElement('withdrawAmountInputEl'), withdrawAccountInput: getElement('withdrawAccountInputEl'), minWithdrawAmount: getElement('minWithdrawAmountEl'), withdrawStatusMessage: getElement('withdrawStatusMessageEl'), submitWithdrawRequestBtn: getElement('submitWithdrawRequestBtnEl'),
             matchDetailsModalInstance: getElement('matchDetailsModalEl') ? new bootstrap.Modal(getElement('matchDetailsModalEl')) : null, matchDetailsModalTitle: getElement('matchDetailsModalTitleEl'), matchDetailsModalBody: getElement('matchDetailsModalBodyEl'),
             idPasswordModalInstance: getElement('idPasswordModalEl') ? new bootstrap.Modal(getElement('idPasswordModalEl')) : null, roomIdDisplay: getElement('roomIdDisplayEl'), roomPasswordDisplay: getElement('roomPasswordDisplayEl'),
             joinConfirmModalInstance: getElement('joinConfirmModalEl') ? new bootstrap.Modal(getElement('joinConfirmModalEl')) : null,
             joinConfirmTextEl: getElement('joinConfirmTextEl'),
             joinGameIdInputEl: getElement('joinGameIdInputEl'),
             joinFullNameInputEl: getElement('joinFullNameInputEl'),
             joinStatusMessageEl: getElement('joinStatusMessageEl'),
             confirmJoinBtnEl: getElement('confirmJoinBtnEl'),

             commentsModalInstance: getElement('commentsModalEl') ? new bootstrap.Modal(getElement('commentsModalEl')) : null,
             commentsList: getElement('commentsListEl'),
             commentInput: getElement('commentInputEl'),
             sendCommentBtn: getElement('sendCommentBtnEl'),

             liveSupportModalInstance: getElement('liveSupportModalEl') ? new bootstrap.Modal(getElement('liveSupportModalEl')) : null,
             liveSupportMessages: getElement('liveSupportMessagesEl'),
             liveSupportInput: getElement('liveSupportInputEl'),
             sendLiveSupportBtn: getElement('sendLiveSupportBtnEl'),

             securityWarning: getElement('securityWarning')
         };

        // --- App State ---
        let currentUser = null; let userProfile = {}; let currentSectionId = 'login-section'; let dbListeners = {};
        let swiperInstance; let currentTournamentGameId = null; let appSettings = {};
        let validReferrerUid = null; 
        let rechargeState = { amount: 0, method: '' };

        // --- Utility & Theme Functions ---
        const defaultTheme={'--primary-bg':'#0F172A','--secondary-bg':'#1E293B','--card-bg':'#1E293B','--text-primary':'#E2E8F0','--text-secondary':'#94A3B8','--accent-color':'#FACC15','--accent-gradient':'linear-gradient(to right, #FACC15, #FBBF24)','--primary-button-bg':'#3B82F6','--border-color':'#334155','--bottom-nav-bg':'#1E293B','--success-color':'#10B981','--danger-color':'#EF4444','--warning-color':'#F59E0B','--info-color':'#3B82F6'};function applyTheme(e){const t=document.documentElement;if(e&&"object"==typeof e){console.log("Applying custom theme:",e);for(const o in defaultTheme)e[o]?t.style.setProperty(o,e[o]):t.style.removeProperty(o)}else{console.log("Resetting to default theme.");for(const o in defaultTheme)t.style.removeProperty(o)}}
        const showLoader=(e)=>{if(elements.globalLoader)elements.globalLoader.style.display=e?"flex":"none"};function showStatusMessage(e,t,o="danger",s=!0){e&&(e.innerHTML=t,e.className=`alert alert-${o} mt-3`,e.style.display="block",e.setAttribute("role","alert"),s&&setTimeout(()=>{e.innerHTML===t&&(e.style.display="none")},5e3))}function clearStatusMessage(e){e&&(e.style.display="none",e.innerHTML="",e.removeAttribute("role"))}function copyToClipboard(e){if(!e)return void alert("Copy target not defined.");const t=querySel(e);if(!t)return void alert("Element to copy from not found.");const o=t.textContent;o&&"N/A"!==o&&!o.includes("placeholder")?navigator.clipboard.writeText(o).then(()=>{alert("Copied!")}).catch(e=>{console.error("Failed to copy:",e),alert("Failed to copy.")}):alert("Nothing to copy.")}function shareReferral(e){navigator.share?e&&"N/A"!==e?navigator.share({title:"Join Me on Gaming Tournament!",text:`Join using my referral code: ${e} & get rewards! App: ${window.location.origin}`,url:window.location.origin}).catch(e=>console.log("Error sharing",e)):alert("Referral code not available."):alert("Web Share not supported. Copy the code manually.")}function generateReferralCode(e=8){let t="",o="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";for(let s=0;s<e;s++)t+=o.charAt(Math.floor(Math.random()*o.length));return t}function getTimeRemaining(e){if(!e)return"TBA";const t=Date.now(),o=e-t;if(o<=0)return"Starting Soon";const s=Math.floor(o/864e5),n=Math.floor(o%864e5/36e5),a=Math.floor(o%36e5/6e4);let r="";return s>0&&(r+=`${s}d `),(n>0||s>0)&&(r+=`${n}h `),r+=`${a}m`,r.trim()||"Now"}const removePlaceholders=e=>{if(e){e.classList.remove("placeholder-glow"),e.querySelectorAll(".placeholder").forEach(e=>e.remove())}};

        // --- UI Functions ---
         function showSection(sectionId) {
             if (!auth || !sectionId || !elements.sections) { console.error("Cannot show section", sectionId); return; }
             const targetSection = getElement(sectionId); if (!targetSection) { console.error(`Section element "${sectionId}" not found.`); showSection(currentUser ? 'home-section' : 'login-section'); return; }
             const protectedSections = ['home-section', 'wallet-section', 'profile-section', 'tournaments-section', 'leaderboard-section', 'update-section'];
             const isLoggedIn = !!currentUser;
             if (protectedSections.includes(sectionId) && !isLoggedIn) { showSection('login-section'); return; }
             if (sectionId === 'login-section' && isLoggedIn) { showSection('home-section'); return; }
             elements.sections.forEach(sec => sec.classList.remove('active')); targetSection.classList.add('active'); currentSectionId = sectionId;
             updateHeaderForSection(sectionId);
             elements.bottomNavItems.forEach(item => item.classList.toggle('active', item.dataset.section === sectionId));
             console.log(`Loading data for section: ${sectionId}`);
             switch (sectionId) {
                 case 'home-section': loadHomePageData(); break;
                 case 'wallet-section': loadWalletData(); break;
                 case 'profile-section': loadProfileData(); break;
                 case 'leaderboard-section': loadLeaderboardData(); break; 
                 case 'update-section': loadUpdateFeedData(); break; 
                 case 'tournaments-section': if(currentTournamentGameId) { const activeTab = querySel('.tournament-tabs .tab-item.active')?.dataset.status || 'upcoming'; filterTournaments(currentTournamentGameId, activeTab); } else { elements.tournamentsListContainer.innerHTML = '<p class="text-secondary text-center mt-4">Select a game from Home page first.</p>'; } break;
             }
             if (sectionId === 'login-section') { toggleLoginForm(true); } 
             window.scrollTo(0, 0);
         }
         function updateHeaderForSection(sectionId) { const showBackButton = (sectionId === 'tournaments-section'); const defaultTitleVisible = !showBackButton; const gameTitleVisible = showBackButton; if (elements.headerBackBtn) elements.headerBackBtn.style.display = showBackButton ? 'inline-block' : 'none'; if (elements.headerTitleContainer) elements.headerTitleContainer.style.display = defaultTitleVisible ? 'flex' : 'none'; if (elements.headerGameTitle) elements.headerGameTitle.style.display = gameTitleVisible ? 'block' : 'none'; if (gameTitleVisible && currentTournamentGameId && elements.headerGameTitle) { const gameName = appSettings?.games?.[currentTournamentGameId]?.name || `Game`; elements.headerGameTitle.textContent = gameName; } else if (defaultTitleVisible && elements.headerUserGreeting) { const nameToShow = userProfile?.displayName?.split(' ')[0] || (currentUser ? currentUser.email?.split('@')[0] : 'Guest') || 'Guest'; elements.headerUserGreeting.textContent = nameToShow; } }
         function updateGlobalUI(isLoggedIn) { if (elements.headerWalletChip) { elements.headerWalletChip.style.display = isLoggedIn ? 'flex' : 'none'; if (isLoggedIn) elements.headerWalletChip.onclick = () => showSection('wallet-section'); else elements.headerWalletChip.onclick = null; } if (!isLoggedIn && elements.headerUserGreeting) elements.headerUserGreeting.textContent = 'Guest'; if (!isLoggedIn && elements.headerChipBalance) elements.headerChipBalance.textContent = '0'; elements.bottomNavItems.forEach(item => { const section = item.dataset.section; item.style.display = 'flex'; }); }
         
        function populateUserInfo(user, profile) {
            if (!user || !profile) return;
            const displayName = profile.displayName || user.displayName || user.email?.split('@')[0] || 'User';
            const photoURL = profile.photoURL || user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=0F172A&color=E2E8F0&bold=true&size=70`;
            const winningCash = (profile.winningCash || 0);
            const bonusCash = (profile.bonusCash || 0);
            const totalBalance = winningCash + bonusCash; 
            const totalEarnings = (profile.totalEarnings || 0);
            const totalMatches = profile.totalMatches || 0;
            const wonMatches = profile.wonMatches || 0;
            const formatCurrency = (amount) => `৳${amount.toFixed(2)}`;
            if (elements.headerUserGreeting) elements.headerUserGreeting.textContent = displayName.split(' ')[0];
            if (elements.headerChipBalance) elements.headerChipBalance.textContent = Math.floor(totalBalance);
            if (elements.walletTotalBalance) {
                elements.walletTotalBalance.textContent = formatCurrency(totalBalance);
                removePlaceholders(elements.walletTotalBalance.closest('.placeholder-glow'));
            }
            if (elements.walletWinningCash) {
                elements.walletWinningCash.textContent = formatCurrency(winningCash);
                removePlaceholders(elements.walletWinningCash.closest('.placeholder-glow'));
            }
            if (elements.walletBonusCash) {
                elements.walletBonusCash.textContent = formatCurrency(bonusCash);
                removePlaceholders(elements.walletBonusCash.closest('.placeholder-glow'));
            }
            if (elements.withdrawModalBalance) elements.withdrawModalBalance.textContent = formatCurrency(totalBalance); 
            if (elements.profileAvatar) elements.profileAvatar.src = photoURL;
            if (elements.profileName) {
                elements.profileName.textContent = displayName;
                removePlaceholders(elements.profileName.closest('.placeholder-glow'));
            }
            if (elements.profileEmail) {
                elements.profileEmail.textContent = user.email || 'N/A';
                removePlaceholders(elements.profileEmail.closest('.placeholder-glow'));
            }
            if (elements.profileTotalMatches) {
                elements.profileTotalMatches.textContent = totalMatches;
                removePlaceholders(elements.profileTotalMatches.closest('.placeholder-glow'));
            }
            if (elements.profileWonMatches) {
                elements.profileWonMatches.textContent = wonMatches;
                removePlaceholders(elements.profileWonMatches.closest('.placeholder-glow'));
            }
            if (elements.profileTotalEarnings) {
                elements.profileTotalEarnings.textContent = formatCurrency(totalEarnings);
                removePlaceholders(elements.profileTotalEarnings.closest('.placeholder-glow'));
            }
        }
        function toggleLoginForm(showLogin) { if (!elements.emailLoginForm || !elements.emailSignupForm) return; clearStatusMessage(elements.loginStatusMessage); clearStatusMessage(elements.signupStatusMessage); elements.emailLoginForm.style.display = showLogin ? 'block' : 'none'; elements.emailSignupForm.style.display = showLogin ? 'none' : 'block'; elements.emailLoginForm.reset(); elements.emailSignupForm.reset(); }
        
        // --- Firebase Auth & DB Functions ---
        async function signUpWithEmail(){if(auth){const e=elements.signupEmailInput.value.trim(),t=elements.signupPasswordInput.value,o=elements.signupConfirmPasswordInput.value,s=elements.signupReferralCodeInput.value.trim();if(!e||!t||!o)return void showStatusMessage(elements.signupStatusMessage,"Fill required fields.","warning");if(t!==o)return void showStatusMessage(elements.signupStatusMessage,"Passwords don't match.","warning");if(t.length<6)return void showStatusMessage(elements.signupStatusMessage,"Password min 6 chars.","warning");showLoader(!0),clearStatusMessage(elements.signupStatusMessage),validReferrerUid=null;try{if(s){console.log("Validating referral code:",s);const n=ref(db,"users"),a=query(n,orderByChild("referralCode"),equalTo(s)),r=await get(a);if(r.exists()){const l=r.val(),c=Object.keys(l)[0],i=l[c];c&&i.email?validReferrerUid=c:console.warn("Referral code found, but referrer data invalid:",l)}else console.log("Referral code not found:",s)}await createUserWithEmailAndPassword(auth,e,t)}catch(u){console.error("Signup Error:",u);let d="Signup failed.";switch(u.code){case"auth/email-already-in-use":d="Email already registered.";break;case"auth/weak-password":d="Password too weak.";break;case"auth/invalid-email":d="Invalid email.";break;case"auth/network-request-failed":d="Network error.";break;default:d=`Error: ${u.message}`}showStatusMessage(elements.signupStatusMessage,d,"danger")}finally{showLoader(!1)}}}async function loginWithEmail(){if(auth){const e=elements.loginEmailInput.value.trim(),t=elements.loginPasswordInput.value;if(!e||!t)return void showStatusMessage(elements.loginStatusMessage,"Enter email & password.","warning");showLoader(!0),clearStatusMessage(elements.loginStatusMessage);try{await signInWithEmailAndPassword(auth,e,t)}catch(o){console.error("Login Error:",o);let s="Login failed.";switch(o.code){case"auth/user-not-found":case"auth/wrong-password":case"auth/invalid-credential":s="Invalid email or password.";break;case"auth/invalid-email":s="Invalid email format.";break;case"auth/too-many-requests":s="Too many attempts. Reset pass or wait.";break;case"auth/network-request-failed":s="Network error.";break;case"auth/user-disabled":s="Account disabled.";break;default:s=`Error: ${o.message}`}showStatusMessage(elements.loginStatusMessage,s,"danger")}finally{showLoader(!1)}}}async function resetPassword(){if(auth){const e=elements.loginEmailInput.value.trim();if(!e)return void showStatusMessage(elements.loginStatusMessage,"Enter email for password reset.","warning");showLoader(!0),clearStatusMessage(elements.loginStatusMessage);try{await sendPasswordResetEmail(auth,e),showStatusMessage(elements.loginStatusMessage,"Password reset email sent! Check inbox/spam.","success",!1)}catch(t){console.error("Reset Pass Error:",t);let o="Failed to send email.";switch(t.code){case"auth/user-not-found":case"auth/invalid-email":o="Email not found.";break;case"auth/network-request-failed":o="Network error.";break;default:o=`Error: ${t.message}`}showStatusMessage(elements.loginStatusMessage,o,"danger")}finally{showLoader(!1)}}}async function logoutUser(){if(auth)try{showLoader(!0),await signOut(auth)}catch(e){console.error("Sign Out Error:",e),alert(`Logout failed: ${e.message}`),showLoader(!1)}}
        async function handleAuthStateChange(e){if(!auth||!db)return console.error("Firebase not ready in auth change"),void showLoader(!1);showLoader(!0),detachAllDbListeners(),currentUser=e;const t=validReferrerUid;if(validReferrerUid=null,e){console.log("Auth State: Logged In",e.uid);const o=ref(db,"users/"+e.uid);try{const s=await get(o);if(s.exists()){userProfile=s.val();const n={};e.displayName&&(!userProfile.displayName||userProfile.displayName!==e.displayName)&&(n.displayName=e.displayName),e.email&&!userProfile.email&&(n.email=e.email),Object.keys(n).length>0&&(await update(o,n),userProfile={...userProfile,...n})}else{console.log("New user, creating profile...");const a={uid:e.uid,displayName:e.displayName||e.email?.split("@")[0]||"User",email:e.email||null,photoURL:e.photoURL||null,winningCash:0,bonusCash:appSettings.newUserBonus||0,totalMatches:0,wonMatches:0,totalEarnings:0,referralEarnings:0,createdAt:Date.now(),referralCode:generateReferralCode(),joinedTournaments:{},isAdmin:!1,...t&&{referredBy:t}};if(await set(o,a),userProfile=a,a.bonusCash>0&&await recordTransaction(e.uid,"signup_bonus",a.bonusCash,"Welcome Bonus"),t&&appSettings.referralBonus>0){console.log(`Awarding referral bonus of ${appSettings.referralBonus} to referrer: ${t}`);const r=ref(db,`users/${t}`);try{const l=await runTransaction(r,e=>{if(e)return e.bonusCash=(e.bonusCash||0)+appSettings.referralBonus,e.referralEarnings=(e.referralEarnings||0)+appSettings.referralBonus,e.totalEarnings=(e.totalEarnings||0)+appSettings.referralBonus,e;});l.committed?(await recordTransaction(t,"referral_bonus",appSettings.referralBonus,`Referral Bonus from ${a.displayName||a.email}`),console.log("Referrer bonus awarded successfully.")):console.error("Referrer bonus transaction aborted.")}catch(c){console.error("Error awarding referrer bonus:",c)}}}populateUserInfo(e,userProfile),setupRealtimeListeners(e.uid),loadNotifications(e.uid),updateGlobalUI(!0);const i="login-section"===currentSectionId||!getElement(currentSectionId)?"home-section":currentSectionId;showSection(i)}catch(u){console.error("Profile handling error:",u),alert("Error loading profile. Logging out. "+u.message);try{await logoutUser()}catch(d){}}}else console.log("Auth State: Logged Out"),currentUser=null,userProfile={},updateGlobalUI(!1),showSection("login-section");showLoader(!1)}
        
        function loadAppSettings(){console.log("Attaching listener for App Settings...");const e=ref(db,"settings");dbListeners.settings&&(off(e,"value",dbListeners.settings.func),delete dbListeners.settings);const t=onValue(e,e=>{if(e.exists()){appSettings=e.val()||{},console.log("App Settings Updated (Real-time):",appSettings),applyTheme(appSettings.theme||null); if (appSettings.logoUrl) { elements.appLogo.src = appSettings.logoUrl; elements.loginLogo.src = appSettings.logoUrl; } appSettings.minWithdraw&&elements.minWithdrawAmount&&(elements.minWithdrawAmount.textContent=appSettings.minWithdraw);const t=document.querySelector(".phonepe-number");t&&(t.textContent=appSettings.upiDetails||"[!!! YOUR UPI ID/NUMBER HERE !!!]");const o=document.querySelector(".modal-body p strong#modalUserEmailEl")?.closest("p");o&&appSettings.supportContact?o.innerHTML=o.innerHTML.replace(/\[!!! ADMIN CONTACT INFO HERE !!!\]/g,appSettings.supportContact):o&&(o.innerHTML=o.innerHTML.replace(appSettings.supportContact||"some_previous_value","[!!! ADMIN CONTACT INFO HERE !!!]"))}else{console.warn("App Settings not found in database! Using defaults."),appSettings={},applyTheme(null);const e=document.querySelector(".phonepe-number");e&&(e.textContent="[!!! YOUR UPI ID/NUMBER HERE !!!]");const t=document.querySelector(".modal-body p strong#modalUserEmailEl")?.closest("p");t&&(t.innerHTML=t.innerHTML.replace(/.*/,'<strong><i class="bi bi-exclamation-triangle-fill text-warning"></i> IMPORTANT:</strong> After payment, contact admin via [!!! ADMIN CONTACT INFO HERE !!!] with registered Email (<strong id="modalUserEmailEl">...</strong>) & payment screenshot. Amount added manually after verification.'))}},e=>{console.error("Settings listener failed",e),appSettings={},applyTheme(null)});dbListeners.settings={path:"settings",func:t}}
        function loadHomePageData(){console.log("Loading Home Page Data..."),currentUser?(loadPromotions(),loadHomeUserTicker(),loadGames(),loadMyContests()):(elements.promotionSlider?.querySelector(".swiper-wrapper")&&(elements.promotionSlider.querySelector(".swiper-wrapper").innerHTML=""),elements.homeUserTicker&&(elements.homeUserTicker.innerHTML=""),elements.gamesList&&(elements.gamesList.innerHTML=""),elements.myContestsList&&(elements.myContestsList.innerHTML='<p class="text-secondary text-center">Login to view contests.</p>'))}async function loadPromotions(){console.log("Loading Promotions...");if(!elements.promotionSlider)return;const e=elements.promotionSlider.querySelector(".swiper-wrapper");if(!e)return;e.classList.add("placeholder-glow"),e.innerHTML='<div class="swiper-slide"><span class="placeholder" style="height: 100%; border-radius: 10px; display: block; width: 100%;"></span></div>';const t=ref(db,"promotions");try{const o=await get(t),s=o.val()||{},n=Object.values(s).filter(e=>e.imageUrl);if(console.log(`Found ${n.length} active promotions.`),removePlaceholders(elements.promotionSlider),e.innerHTML="",n.length>0){elements.promotionSlider.style.display="block",n.forEach(t=>{const o=document.createElement("div");o.className="swiper-slide",o.innerHTML=t.link?`<a href="${t.link}" target="_blank"><img src="${t.imageUrl}" alt="Promo"></a>`:`<img src="${t.imageUrl}" alt="Promo">`,e.appendChild(o)}),swiperInstance&&swiperInstance.destroy(!0,!0),swiperInstance=new Swiper(elements.promotionSlider,{loop:n.length>1,autoplay:{delay:3500,disableOnInteraction:!1},pagination:{el:".swiper-pagination",clickable:!0},slidesPerView:1})}else elements.promotionSlider.style.display="none"}catch(a){console.error("Promo load failed:",a),removePlaceholders(elements.promotionSlider),e.innerHTML='<p class="text-danger text-center small p-3">Could not load promotions.</p>',elements.promotionSlider.style.display="block"}}
        
        // --- NEW: Load User Ticker for Home Page ---
        async function loadHomeUserTicker() {
            if(!elements.homeUserTicker) return;
            console.log("Loading Home User Ticker...");
            try {
                const usersRef = query(ref(db, "users"), limitToLast(20));
                const snapshot = await get(usersRef);
                elements.homeUserTicker.innerHTML = "";
                
                if (snapshot.exists()) {
                    const users = [];
                    snapshot.forEach(child => {
                        const u = child.val();
                        if(u.displayName) users.push(u);
                    });
                    
                    // Shuffle or just reverse to show latest
                    users.reverse();
                    
                    users.forEach(user => {
                        const displayName = user.displayName;
                        const photoURL = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=0F172A&color=FACC15&bold=true`;
                        
                        const tickerItem = document.createElement("div");
                        tickerItem.className = "ticker-item";
                        tickerItem.innerHTML = `
                            <img src="${photoURL}" alt="${displayName}" class="ticker-avatar">
                            <span class="ticker-name">${displayName.split(' ')[0]}</span>
                        `;
                        elements.homeUserTicker.appendChild(tickerItem);
                    });
                } else {
                    elements.homeUserTicker.innerHTML = "<small class='text-secondary ps-2'>No active players.</small>";
                }
            } catch (error) {
                console.error("Failed to load ticker:", error);
                elements.homeUserTicker.innerHTML = "<small class='text-danger ps-2'>Error loading players.</small>";
            }
        }

        async function loadGames(){console.log("Loading Games...");if(!elements.gamesList)return;elements.gamesList.classList.add("placeholder-glow"),elements.gamesList.innerHTML='<div class="col-6"><div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div></div> <div class="col-6"><div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div></div>';const e=ref(db,"games");try{const t=await get(e),o=t.val()||{},s=Object.entries(o).filter(([,e])=>e.imageUrl&&e.name).sort(([,e],[,t])=>(e.order||0)-(t.order||0));if(console.log(`Found ${s.length} active games.`),removePlaceholders(elements.gamesList),elements.gamesList.innerHTML="",s.length>0){appSettings.games||(appSettings.games={}),s.forEach(([e,t])=>{appSettings.games[e]={name:t.name,imageUrl:t.imageUrl};const o=document.createElement("div");o.className="col-6",o.innerHTML=`<div class="game-card custom-card" data-game-id="${e}" data-game-name="${t.name}"><img src="${t.imageUrl}" alt="${t.name}"><span>${t.name}</span></div>`,o.querySelector(".game-card").addEventListener("click",()=>{currentTournamentGameId=e,loadTournamentsForGame(e,t.name)}),elements.gamesList.appendChild(o)})}else elements.gamesList.innerHTML='<p class="text-secondary text-center col-12">No games available.</p>'}catch(n){console.error("Games load failed:",n),removePlaceholders(elements.gamesList),elements.gamesList.innerHTML='<p class="text-danger text-center col-12">Could not load games.</p>'}}function loadTournamentsForGame(e,t){console.log(`Loading tournaments for game: ${t} (ID: ${e})`),elements.tournamentsSection&&(currentTournamentGameId=e,elements.tournamentTabs.forEach(e=>e.classList.remove("active")),querySel('.tournament-tabs .tab-item[data-status="upcoming"]')?.classList.add("active"),showSection("tournaments-section"),filterTournaments(e,"upcoming"))}async function filterTournaments(e,t){console.log(`Filtering tournaments for game ${e} with status ${t}`);if(!elements.tournamentsListContainer)return;elements.tournamentsListContainer.innerHTML="",elements.tournamentsListContainer.classList.add("placeholder-glow"),elements.tournamentsListContainer.innerHTML='<div class="tournament-card placeholder-glow mb-3"><span class="placeholder col-6"></span><span class="placeholder col-12 mt-2"></span><span class="placeholder col-10 mt-2"></span><div class="d-flex justify-content-between mt-3"><span class="placeholder col-4 h-30"></span><span class="placeholder col-4 h-30"></span></div></div>',elements.noTournamentsMessage.style.display="none";try{const o=query(ref(db,"tournaments"),orderByChild("gameId"),equalTo(e)),s=await get(o),n=s.val()||{},a=Object.entries(n).filter(([,e])=>e.status===t).sort(([,e],[,t])=>(e.startTime||0)-(t.startTime||0));if(console.log(`Found ${a.length} tournaments matching criteria.`),removePlaceholders(elements.tournamentsListContainer),elements.tournamentsListContainer.innerHTML="",a.length>0)a.forEach(([e,t])=>{const o=createTournamentCardElement(e,t);elements.tournamentsListContainer.appendChild(o)});else elements.noTournamentsMessage.style.display="block",elements.noTournamentsMessage.textContent=`No ${t} tournaments found.`}catch(r){console.error(`Tournaments filter failed (${t}):`,r),removePlaceholders(elements.tournamentsListContainer),elements.tournamentsListContainer.innerHTML='<p class="text-danger tc mt-4">Could not load tournaments.</p>',elements.noTournamentsMessage.style.display="none"}}
        function createTournamentCardElement(e,t){const o=document.createElement("div");o.className="tournament-card",o.dataset.tournamentId=e;const s=t.entryFee||0,n=t.perKillPrize||0,a=t.prizePool||0,r=t.startTime?new Date(t.startTime):null,l=r?r.toLocaleString([],"short"=={dateStyle:"short",timeStyle:"short"}):"TBA",c=t.registeredPlayers||{},i=Object.keys(c).length,u=t.maxPlayers||0,d=u>0?Math.max(0,u-i):1/0,m=u>0&&d<=0,p=currentUser&&userProfile?.joinedTournaments?.[e],f=!p&&!m&&"upcoming"===t.status;let h=t.status?.toUpperCase()||"N/A";"upcoming"===t.status&&r?h=getTimeRemaining(t.startTime):"ongoing"===t.status?h="LIVE":"completed"!==t.status&&"result"!==t.status||(h="ENDED");let g="Unlimited Spots",w=0;u>0&&(g=`<span class="${d<=5?"text-danger":"text-accent"}">${d}</span> Spots Left (${i}/${u})`,w=Math.min(100,i/u*100));let y="",b="";if(p)y='<button class="btn btn-custom btn-sm btn-joined" disabled><i class="bi bi-check-circle-fill"></i> Joined</button>',("ongoing"===t.status||"upcoming"===t.status&&t.showIdPass&&r&&Date.now()>r.getTime()-9e5)&&(b=`<button class="btn btn-custom btn-idpass w-100 mt-2 btn-sm" data-tournament-id="${e}"><i class="bi bi-key-fill"></i> View ID & Pass</button>`);else if(f)y=`<button class="btn btn-custom btn-sm btn-custom-accent btn-join" data-tournament-id="${e}" data-fee="${s}">৳${s} Join <i class="bi bi-arrow-right-short"></i></button>`;else{let v="upcoming"!==t.status?t.status?.toUpperCase():m?"Full":"Closed";y=`<button class="btn btn-custom btn-sm btn-disabled" disabled>${v||"N/A"}</button>`}const contentHtml=`<div class="tournament-card-header"><div class="tournament-card-tags">${t.mode?`<span>${t.mode}</span>`:""}${t.map?`<span>${t.map}</span>`:""}${t.tags?Array.isArray(t.tags)?t.tags.map(e=>`<span>${e}</span>`).join(""):Object.values(t.tags).map(e=>`<span>${e}</span>`).join(""):""}</div><div class="tournament-card-timer">${h}</div></div><h3 class="tournament-card-title">${t.icon?`<i class="${t.icon}"></i>`:'<i class="bi bi-joystick text-accent"></i>'} ${t.name||"Tournament"}</h3><p class="small text-secondary mb-2"><i class="bi bi-calendar-event"></i> ${l}</p><div class="tournament-card-info"><div class="info-item"><span>Prize Pool</span><strong><i class="bi bi-trophy-fill text-accent prize-icon"></i> ৳${a}</strong></div><div class="info-item"><span>Per Kill</span><strong>৳${n}</strong></div><div class="info-item"><span>Entry Fee</span><strong class="${s>0?"text-info":""}">${s>0?`৳${s}`:"Free"}</strong></div></div><div class="tournament-card-spots">${g}${u>0?`<div class="progress mt-1" style="height: 6px;"><div class="progress-bar bg-warning" role="progressbar" style="width: ${w}%"></div></div>`:""}</div><div class="tournament-card-actions"><button class="btn btn-custom btn-custom-secondary btn-sm btn-details" data-tournament-id="${e}">Details</button>${y}</div>${b}`;let bannerImageUrl=t.imageUrl;if(!bannerImageUrl&&t.gameId&&appSettings.games?.[t.gameId]?.imageUrl){bannerImageUrl=appSettings.games[t.gameId].imageUrl}if(bannerImageUrl){o.style.padding="0";o.innerHTML=`<img src="${bannerImageUrl}" alt="${t.name||"Tournament Banner"}" style="width: 100%; height: 160px; object-fit: cover; display: block;"><div class="tournament-card-content" style="padding: 15px;">${contentHtml}</div>`}else{o.innerHTML=contentHtml}o.querySelector(".btn-join")?.addEventListener("click",handleJoinTournamentClick),o.querySelector(".btn-details")?.addEventListener("click",handleMatchDetailsClick),o.querySelector(".btn-idpass")?.addEventListener("click",handleIdPasswordClick);return o}
        async function loadMyContests(){console.log("Loading My Contests...");if(!currentUser||!elements.myContestsList)return elements.myContestsList&&removePlaceholders(elements.myContestsList),elements.myContestsList&&(elements.myContestsList.innerHTML=""),void(elements.noContestsMessage&&(elements.noContestsMessage.style.display="block"));const e=Object.keys(userProfile.joinedTournaments||{});if(elements.myContestsList.classList.add("placeholder-glow"),elements.myContestsList.innerHTML='<div class="tournament-card placeholder-glow mb-3"><span class="placeholder col-6"></span><span class="placeholder col-12 mt-2"></span><span class="placeholder col-10 mt-2"></span><div class="d-flex justify-content-between mt-3"><span class="placeholder col-4 h-30"></span><span class="placeholder col-4 h-30"></span></div></div>',elements.noContestsMessage&&(elements.noContestsMessage.style.display="none"),0===e.length)return removePlaceholders(elements.myContestsList),elements.myContestsList.innerHTML="",elements.noContestsMessage&&(elements.noContestsMessage.style.display="block"),void console.log("No joined contests found for user.");console.log(`Found ${e.length} joined contest IDs.`);try{const t=e.map(e=>get(ref(db,`tournaments/${e}`))),o=await Promise.all(t);removePlaceholders(elements.myContestsList),elements.myContestsList.innerHTML="";const s=[];o.forEach((t,o)=>{if(t.exists()){const n=t.val();("upcoming"===n.status||"ongoing"===n.status)&&s.push({startTime:n.startTime||0,card:createTournamentCardElement(e[o],n)})}else console.warn(`Joined tournament ${e[o]} not found in tournaments node.`)}),s.sort((e,t)=>e.startTime-t.startTime),s.length>0?s.forEach(e=>elements.myContestsList.appendChild(e.card)):elements.noContestsMessage&&(elements.noContestsMessage.style.display="block",elements.noContestsMessage.textContent="No upcoming/ongoing joined contests.")}catch(n){console.error("My contests load failed:",n),removePlaceholders(elements.myContestsList),elements.myContestsList.innerHTML='<p class="text-danger tc">Could not load contests.</p>'}}function loadWalletData(){console.log("Loading Wallet Data..."),currentUser&&loadRecentTransactions()}function loadProfileData(){console.log("Loading Profile Data..."),currentUser&&userProfile?.displayName&&(removePlaceholders(elements.profileName?.closest(".placeholder-glow")),removePlaceholders(elements.profileEmail?.closest(".placeholder-glow")),removePlaceholders(elements.profileTotalMatches?.closest(".placeholder-glow")),removePlaceholders(elements.profileWonMatches?.closest(".placeholder-glow")),removePlaceholders(elements.profileTotalEarnings?.closest(".placeholder-glow")))}async function recordTransaction(e,t,o,s,n={}){if(!e)return;const a=ref(db,`transactions/${e}`),r={type:t,amount:o,description:s,timestamp:Date.now(),...n};try{await push(a,r),console.log(`Transaction recorded: ${t}, Amount: ${o}`)}catch(l){console.error("Transaction record failed:",l)}}async function loadRecentTransactions(){console.log("Loading Recent Transactions...");if(!currentUser||!elements.recentTransactionsList)return;elements.recentTransactionsList.innerHTML="",elements.recentTransactionsList.classList.add("placeholder-glow");for(let e=0;e<3;e++)elements.recentTransactionsList.innerHTML+='<div class="custom-card p-2 mb-2 placeholder-glow"><div class="d-flex justify-content-between"><span class="placeholder col-5 h-16"></span><span class="placeholder col-3 h-16"></span></div><div class="small text-secondary mt-1"><span class="placeholder col-6 h-14"></span></div></div>';elements.noTransactionsMessage&&(elements.noTransactionsMessage.style.display="block",elements.noTransactionsMessage.textContent="Loading transactions...");try{const e=query(ref(db,`transactions/${currentUser.uid}`),limitToLast(5)),t=await get(e),o=t.val()||{},s=Object.values(o).sort((e,t)=>(t.timestamp||0)-(e.timestamp||0));if(console.log(`Found ${s.length} recent transactions.`),removePlaceholders(elements.recentTransactionsList),elements.recentTransactionsList.innerHTML="",s.length>0){elements.noTransactionsMessage&&(elements.noTransactionsMessage.style.display="none"),s.forEach(e=>{const t=document.createElement("div");t.className="custom-card p-2 mb-2 d-flex justify-content-between align-items-center";const o=e.amount>0,s=`${o?"+":""}৳${Math.abs(e.amount||0).toFixed(2)}`,n=e.timestamp?new Date(e.timestamp).toLocaleString([],"short"=={dateStyle:"short",timeStyle:"short"}):"N/A";t.innerHTML=`<div><div class="small fw-bold">${e.description||e.type||"Txn"}</div><div class="small text-secondary">${n}</div></div><div class="fw-bold ${o?"text-success":"text-danger"}">${s}</div>`,elements.recentTransactionsList.appendChild(t)})}else elements.noTransactionsMessage&&(elements.noTransactionsMessage.style.display="block",elements.noTransactionsMessage.textContent="No recent transactions.")}catch(n){console.error("Transactions load failed:",n),removePlaceholders(elements.recentTransactionsList),elements.recentTransactionsList.innerHTML='<p class="text-danger tc">Could not load transactions.</p>',elements.noTransactionsMessage&&(elements.noTransactionsMessage.style.display="none")}}
        
        function handleJoinTournamentClick(e) { if (!currentUser) { alert("Login to join."); return showSection("login-section"); } const targetButton = e.currentTarget; const tournamentId = targetButton.dataset.tournamentId; const fee = parseFloat(targetButton.dataset.fee || 0); if (!tournamentId || !elements.joinConfirmModalInstance) return; const confirmBtn = elements.confirmJoinBtnEl; confirmBtn.dataset.tournamentId = tournamentId; confirmBtn.dataset.fee = fee; elements.joinConfirmTextEl.innerHTML = `Are you sure you want to join for <strong>৳${fee.toFixed(2)}</strong>? <br> Please confirm your in-game details below.`; elements.joinGameIdInputEl.value = userProfile.inGameId || ""; elements.joinFullNameInputEl.value = userProfile.displayName || ""; clearStatusMessage(elements.joinStatusMessageEl); confirmBtn.disabled = false; confirmBtn.innerHTML = "Confirm Join"; elements.joinConfirmModalInstance.show(); }
        async function processTournamentJoin() { if (!currentUser) return; const confirmBtn = elements.confirmJoinBtnEl; const tournamentId = confirmBtn.dataset.tournamentId; const fee = parseFloat(confirmBtn.dataset.fee || 0); const loaderHtml = '<div class="loader" style="width:16px;height:16px;"></div>'; const gameId = elements.joinGameIdInputEl.value.trim(); const fullName = elements.joinFullNameInputEl.value.trim(); if (!gameId || !fullName) { showStatusMessage(elements.joinStatusMessageEl, "Please enter your Game ID and Full Name.", "warning"); return; } confirmBtn.disabled = true; confirmBtn.innerHTML = `${loaderHtml} Joining...`; clearStatusMessage(elements.joinStatusMessageEl); const userRef = ref(db, `users/${currentUser.uid}`); const tournamentRef = ref(db, `tournaments/${tournamentId}`); let tournamentData = null; let balanceTx = null; try { balanceTx = await runTransaction(userRef, (profile) => { if (!profile) throw new Error("User profile missing."); if (profile.joinedTournaments?.[tournamentId]) return; const currentBonus = profile.bonusCash || 0; const currentWinnings = profile.winningCash || 0; if ((currentBonus + currentWinnings) < fee) throw new Error("Insufficient total balance."); let remainingFee = fee; const bonusToUse = Math.min(currentBonus, remainingFee); profile.bonusCash -= bonusToUse; remainingFee -= bonusToUse; if (remainingFee > 0) { profile.winningCash -= remainingFee; } if (!profile.joinedTournaments) profile.joinedTournaments = {}; profile.joinedTournaments[tournamentId] = true; profile.totalMatches = (profile.totalMatches || 0) + 1; return profile; }); if (!balanceTx.committed && userProfile?.joinedTournaments?.[tournamentId]) { throw new Error("Already joined this tournament."); } if (!balanceTx.committed) { throw new Error("Join transaction failed. Not enough balance or data mismatch."); } console.log("Balance and stats transaction successful."); const tourneySnapshot = await get(tournamentRef); if (!tourneySnapshot.exists()) throw new Error("Tournament not found after transaction."); tournamentData = tourneySnapshot.val(); if (tournamentData.status !== 'upcoming') throw new Error("Tournament is no longer available to join."); const playerCount = tournamentData.registeredPlayers ? Object.keys(tournamentData.registeredPlayers).length : 0; if (tournamentData.maxPlayers > 0 && playerCount >= tournamentData.maxPlayers) throw new Error("Tournament is full."); const updates = {}; updates[`tournaments/${tournamentId}/registeredPlayers/${currentUser.uid}`] = { joinedAt: serverTimestamp(), inGameId: gameId, inGameName: fullName, userEmail: currentUser.email }; if (!userProfile.inGameId || userProfile.inGameId !== gameId) { updates[`users/${currentUser.uid}/inGameId`] = gameId; } await update(ref(db), updates); console.log("Successfully updated tournament registered players."); await recordTransaction(currentUser.uid, 'tournament_join', -fee, `Joined: ${tournamentData.name || "Tournament"}`, { tournamentId: tournamentId }); showStatusMessage(elements.joinStatusMessageEl, "Successfully Joined!", "success", false); setTimeout(() => { elements.joinConfirmModalInstance.hide(); }, 1500); const tournamentCard = document.querySelector(`.tournament-card[data-tournament-id="${tournamentId}"]`); if (tournamentCard) { const latestTourneyData = (await get(tournamentRef)).val(); if(latestTourneyData) tournamentCard.parentNode.replaceChild(createTournamentCardElement(tournamentId, latestTourneyData), tournamentCard); } else if(currentSectionId === 'tournaments-section' && currentTournamentGameId) { const activeTab = querySel('.tournament-tabs .tab-item.active')?.dataset.status || 'upcoming'; filterTournaments(currentTournamentGameId, activeTab); } if (currentSectionId === 'home-section') loadMyContests(); if (currentSectionId === 'wallet-section') loadRecentTransactions(); } catch (error) { console.error("Join failed:", error); showStatusMessage(elements.joinStatusMessageEl, `Error: ${error.message}`, "danger"); if (balanceTx?.committed) { console.error("CRITICAL: Balance deducted but failed to update tournament! Attempting refund."); try { const refundTx = await runTransaction(userRef, (profile) => { if (profile) { profile.winningCash = (profile.winningCash || 0) + fee; if (profile.joinedTournaments?.[tournamentId]) { delete profile.joinedTournaments[tournamentId]; } profile.totalMatches = Math.max(0, (profile.totalMatches || 0) - 1); } return profile; }); if(refundTx.committed) { await recordTransaction(currentUser.uid, 'join_failed_refund', fee, `Refund Failed Join: ${tournamentData?.name || "Tournament"}`); showStatusMessage(elements.joinStatusMessageEl, `Error: ${error.message}. Your balance has been refunded.`, "danger", false); } else { console.error("CRITICAL: FAILED TO REFUND BALANCE!"); showStatusMessage(elements.joinStatusMessageEl, `Error: ${error.message}. CRITICAL: Failed to refund your balance! Contact support.`, "danger", false); } } catch (refundError) { console.error("CRITICAL: FAILED TO REFUND BALANCE!", refundError); showStatusMessage(elements.joinStatusMessageEl, `Error: ${error.message}. CRITICAL: Failed to refund your balance! Contact support.`, "danger", false); } } } finally { confirmBtn.disabled = false; confirmBtn.innerHTML = 'Confirm Join'; } }
        
        function handleWithdrawClick() { 
            if (currentUser && elements.withdrawModalInstance) { 
                const winningCash = userProfile.winningCash || 0;
                const bonusCash = userProfile.bonusCash || 0;
                const totalBalance = winningCash + bonusCash; 
                const minWithdraw = appSettings?.minWithdraw || 50; 
                elements.minWithdrawAmount.textContent = minWithdraw; 
                elements.withdrawModalBalance.textContent = `৳${totalBalance.toFixed(2)}`; 
                elements.withdrawAmountInput.value = ""; 
                elements.withdrawAmountInput.min = minWithdraw; 
                elements.withdrawAccountInput.value = userProfile.withdrawNumber || ""; 
                const lastMethod = userProfile.lastWithdrawMethod || 'bKash'; 
                const radioToCheck = document.getElementById(`withdrawMethod${lastMethod}`); 
                if(radioToCheck) radioToCheck.checked = true; 
                clearStatusMessage(elements.withdrawStatusMessage); 
                elements.withdrawModalInstance.show(); 
            } 
        }

        async function submitWithdrawRequestHandler() { 
            if (!currentUser || !elements.withdrawModalInstance) return; 
            const selectedMethodEl = document.querySelector('input[name="withdrawPaymentMethod"]:checked'); 
            const amount = parseFloat(elements.withdrawAmountInput.value); 
            const accountNumber = elements.withdrawAccountInput.value.trim(); 
            const winningCash = userProfile.winningCash || 0;
            const bonusCash = userProfile.bonusCash || 0;
            const totalBalance = winningCash + bonusCash; 
            const minWithdraw = appSettings?.minWithdraw || 50; 
            
            clearStatusMessage(elements.withdrawStatusMessage); 
            if (!selectedMethodEl) return showStatusMessage(elements.withdrawStatusMessage, "Please select a payment method.", "warning"); 
            if (!accountNumber) return showStatusMessage(elements.withdrawStatusMessage, "Please enter your account number.", "warning"); 
            if (isNaN(amount) || amount <= 0) return showStatusMessage(elements.withdrawStatusMessage, "Please enter a valid amount.", "warning"); 
            if (amount < minWithdraw) return showStatusMessage(elements.withdrawStatusMessage, `Minimum withdrawal amount is ৳${minWithdraw}.`, "warning"); 
            if (amount > totalBalance) return showStatusMessage(elements.withdrawStatusMessage, "Insufficient total balance.", "warning"); 
            
            const methodName = selectedMethodEl.value; 
            const loaderHtml = '<div class="loader" style="width:16px;height:16px;"></div>'; 
            elements.submitWithdrawRequestBtn.disabled = true; 
            elements.submitWithdrawRequestBtn.innerHTML = `${loaderHtml} Sending...`; 
            
            let balanceDeducted = false; 
            try { 
                const userRef = ref(db, `users/${currentUser.uid}`); 
                const balanceTx = await runTransaction(userRef, (profile) => { 
                    if (profile) {
                        const currentWinnings = profile.winningCash || 0;
                        const currentBonus = profile.bonusCash || 0;
                        if ((currentWinnings + currentBonus) < amount) {
                             throw new Error("Insufficient total balance (Tx).");
                        }
                        let remainingAmount = amount;
                        const winningsToUse = Math.min(currentWinnings, remainingAmount);
                        profile.winningCash -= winningsToUse;
                        remainingAmount -= winningsToUse;
                        
                        if (remainingAmount > 0) {
                            profile.bonusCash -= remainingAmount;
                        }
                        return profile; 
                    } 
                    throw new Error("Profile missing (Tx)."); 
                }); 
                if (!balanceTx.committed) throw new Error("Failed to update balance. Please try again."); 
                balanceDeducted = true; 
                console.log("Balance deducted successfully."); 
                
                const profileUpdates = { withdrawNumber: accountNumber, lastWithdrawMethod: methodName }; 
                await update(userRef, profileUpdates); 
                const withdrawalsRef = ref(db, "withdrawals"); 
                const requestData = { userId: currentUser.uid, userName: userProfile.displayName || currentUser.email, amount: amount, methodDetails: { methodName: methodName, accountInfo: accountNumber }, status: "pending", requestTimestamp: serverTimestamp(), userEmail: currentUser.email || "N/A" }; 
                const newRequest = await push(withdrawalsRef, requestData); 
                console.log("Withdrawal request created:", newRequest.key); 
                await recordTransaction(currentUser.uid, 'withdraw_request', -amount, `Withdrawal to ${methodName}: ${accountNumber}`, { withdrawalId: newRequest.key }); 
                showStatusMessage(elements.withdrawStatusMessage, "Request submitted successfully!", "success", false); 
                setTimeout(() => { elements.withdrawModalInstance.hide(); }, 2500); 
                if (currentSectionId === 'wallet-section') loadRecentTransactions(); 
            } catch (error) { 
                console.error("Withdraw error:", error); 
                showStatusMessage(elements.withdrawStatusMessage, `Error: ${error.message}`, "danger"); 
                if (balanceDeducted) { 
                    console.warn("Attempting to refund balance due to withdrawal request failure..."); 
                    const userRef = ref(db, `users/${currentUser.uid}`); 
                    try { 
                        await runTransaction(userRef, (profile) => { if (profile) { profile.winningCash = (profile.winningCash || 0) + amount; } return profile; }); 
                        await recordTransaction(currentUser.uid, 'withdraw_failed_refund', amount, "Refund for Failed Withdrawal"); 
                        console.log("Refund successful."); 
                        showStatusMessage(elements.withdrawStatusMessage, `Error: ${error.message}. Your amount has been refunded.`, "danger"); 
                    } catch (refundError) { 
                        console.error("CRITICAL: FAILED TO REFUND BALANCE!", refundError); 
                        showStatusMessage(elements.withdrawStatusMessage, `Error: ${error.message}. CRITICAL: Failed to refund amount! Contact support immediately.`, "danger", false); 
                    } 
                } 
            } finally { 
                elements.submitWithdrawRequestBtn.disabled = false; 
                elements.submitWithdrawRequestBtn.innerHTML = "Submit Request"; 
            } 
        }

        async function handleMatchDetailsClick(e) { console.log("Match Details Clicked"); if (!elements.matchDetailsModalInstance) return; const tournamentId = e.currentTarget.dataset.tournamentId; if (!tournamentId) return; elements.matchDetailsModalTitle.textContent = "Loading..."; elements.matchDetailsModalBody.innerHTML = '<div class="d-flex justify-content-center p-5"><div class="loader"></div></div>'; elements.matchDetailsModalInstance.show(); try { const tournamentRef = ref(db, `tournaments/${tournamentId}`); const snapshot = await get(tournamentRef); if (snapshot.exists()) { const tournamentData = snapshot.val(); const gameName = appSettings.games?.[tournamentData.gameId]?.name || tournamentData.gameId || "N/A"; const startTime = tournamentData.startTime ? new Date(tournamentData.startTime).toLocaleString([], { dateStyle: 'medium', timeStyle: 'short' }) : "TBA"; const mode = tournamentData.mode || "N/A"; const map = tournamentData.map || "N/A"; let prizeDistributionHtml = ''; if (tournamentData.prizeDistribution) { let prizeText = ''; if (typeof tournamentData.prizeDistribution === 'object') { prizeText = Object.entries(tournamentData.prizeDistribution).map(([rank, prize]) => `Rank ${rank}: ৳${prize}`).join('\n'); } else { prizeText = String(tournamentData.prizeDistribution).replace(/\\n/g, '\n'); } prizeDistributionHtml = `<h5>Prize Distribution:</h5><pre>${prizeText}</pre>`; } const rules = (tournamentData.description || "Standard rules apply.").replace(/\n/g, '<br>'); elements.matchDetailsModalTitle.textContent = tournamentData.name || "Match Details"; elements.matchDetailsModalBody.innerHTML = ` <p><strong>Game:</strong> ${gameName}</p> <p><strong>Mode:</strong> ${mode}</p> <p><strong>Map:</strong> ${map}</p> <p><strong>Starts:</strong> ${startTime}</p> <hr> <p><strong>Entry:</strong> ${tournamentData.entryFee > 0 ? `৳${tournamentData.entryFee}` : "Free"}</p> <p><strong>Prize:</strong> ৳${tournamentData.prizePool || 0}</p> <p><strong>Per Kill:</strong> ৳${tournamentData.perKillPrize || 0}</p> <p><strong>Max Players:</strong> ${tournamentData.maxPlayers > 0 ? tournamentData.maxPlayers : "Unlimited"}</p> <hr> <h5>Rules:</h5> <div style="white-space: pre-wrap; line-height: 1.6;">${rules}</div> ${prizeDistributionHtml} `; } else { elements.matchDetailsModalBody.innerHTML = '<p class="text-danger">Details not found.</p>'; } } catch (error) { console.error("Details load failed:", error); elements.matchDetailsModalBody.innerHTML = '<p class="text-danger">Error loading details.</p>'; } }
        async function handleIdPasswordClick(e){if(!elements.idPasswordModalInstance)return;const t=e.currentTarget.dataset.tournamentId;if(!t)return;if(console.log("--- Checking ID/Pass ---"),console.log("Tournament ID (tId):",t),console.log("Current User UID:",currentUser?.uid),!currentUser||!userProfile?.joinedTournaments?.[t])return console.warn("Client-side check failed: User not logged in or tId not found in userProfile.joinedTournaments"),void alert("Join the tournament first or refresh the page.");elements.roomIdDisplay.innerHTML='<span class="placeholder col-6"></span>',elements.roomPasswordDisplay.innerHTML='<span class="placeholder col-6"></span>',elements.idPasswordModalInstance.show();try{const o=ref(db,`tournaments/${t}`);console.log("Fetching from path:",`tournaments/${t}`);const s=await get(o);if(console.log("Snapshot exists?",s.exists(),"Snapshot value:",s.val()),removePlaceholders(elements.roomIdDisplay.closest(".placeholder-glow")),removePlaceholders(elements.roomPasswordDisplay.closest(".placeholder-glow")),s.exists()){const n=s.val();n.showIdPass?(elements.roomIdDisplay.textContent=n.roomId||"Not updated yet",elements.roomPasswordDisplay.textContent=n.roomPassword||"Not updated yet"):(elements.roomIdDisplay.textContent="Hidden by Admin",elements.roomPasswordDisplay.textContent="Hidden by Admin")}else elements.roomIdDisplay.textContent="Not Found",elements.roomPasswordDisplay.textContent="Not Found"}catch(a){console.error("ID/Pass fetch error:",a),removePlaceholders(elements.roomIdDisplay.closest(".placeholder-glow")),removePlaceholders(elements.roomPasswordDisplay.closest(".placeholder-glow")),elements.roomIdDisplay.textContent="Error",elements.roomPasswordDisplay.textContent="Error",alert("Error loading ID/Password. Check permissions or network.")}}async function handlePolicyClick(e){console.log("Policy link clicked");if(!elements.policyModalInstance)return void console.error("Policy modal instance not found");e.preventDefault();const t=e.currentTarget,o=t.dataset.policy;if(console.log("Policy type requested:",o),!o)return;let s="",n='<div class="d-flex justify-content-center p-5"><div class="loader"></div></div>';switch(elements.policyModalBody.innerHTML=n,o){case"privacy":s="Privacy Policy",n=appSettings.policyPrivacy||"Content not available.";break;case"terms":s="Terms and Conditions",n=appSettings.policyTerms||"Content not available.";break;case"refund":s="Refund and Cancellation",n=appSettings.policyRefund||"Content not available.";break;case"fairPlay":s="Fair Play Policy",n=appSettings.policyFairPlay||"Content not available.";break;case"refer":if(s="Refer & Earn",!currentUser)return void alert("Login to view referral.");const a=userProfile.referralCode||"N/A",r=appSettings?.referralBonus||0,l=appSettings?.referralDescription||`Get ৳${r} when your friend joins using your code.`;n=`<div class="text-center"><h4>Refer Friends!</h4><p class="text-secondary">Share code & earn!</p><div class="my-4 p-3" style="background: var(--primary-bg); border-radius: 8px;"><p class="small text-secondary mb-1">Your Code:</p><h3 class="text-accent referral-code" id="referralCodeDisplay">${a}</h3><div class="mt-3"><button class="btn btn-sm btn-custom btn-custom-secondary me-2 copy-btn" data-target="#referralCodeDisplay"><i class="bi bi-clipboard"></i> Copy</button><button class="btn btn-sm btn-custom btn-custom-secondary" id="shareReferralBtn"><i class="bi bi-share-fill"></i> Share</button></div></div><p class="mt-3 small text-secondary">${l}</p></div>`;break;default:s="Info",console.warn("Unknown policy:",o),n="<p>Content unavailable.</p>"}elements.policyModalTitle.textContent=s,"string"==typeof n&&"refer"!==o?elements.policyModalBody.innerHTML=n.replace(/\n/g,"<br>"):elements.policyModalBody.innerHTML=n,console.log("Showing policy modal for:",o),elements.policyModalInstance.show()}function setupRealtimeListeners(e){if(e&&db&&currentUser){detachAllDbListeners(),console.log("Setting up realtime listener for User Profile:",e);const t=ref(db,`users/${e}`),o=onValue(t,s=>{currentUser&&currentUser.uid===e?s.exists()?(console.log("Realtime: User Profile Update Received"),userProfile=s.val(),populateUserInfo(currentUser,userProfile),"home-section"===currentSectionId&&loadMyContests(),"wallet-section"===currentSectionId&&loadRecentTransactions()):(console.warn("User data deleted (realtime) for:",e),alert("Account data missing or deleted. Logging out."),logoutUser()):(console.log("Realtime listener fired for a different user or logged-out state. Detaching."),off(t,"value",o))},e=>{console.error("Listener error (user profile):",e)});dbListeners.userProfile={path:`users/${e}`,func:o}}}function detachAllDbListeners(){console.log("Detaching listeners:",Object.keys(dbListeners));let e=0;for(const t in dbListeners)try{const{path:o,func:s}=dbListeners[t];o&&s?(off(ref(db,o),"value",s),e++):console.warn(`Listener object invalid for key: ${t}`)}catch(n){console.error(`Detach error ${t}:`,n)}dbListeners={},console.log(`Detached ${e} listeners.`)}async function checkSecurityRules(){console.log("Checking security rules..."),currentUser?elements.securityWarning&&(elements.securityWarning.style.display="none"):console.log("Security rule check skipped for anonymous user (rely on console).")}
        function showRechargeStep(e){elements.rechargeStep1.style.display="none",elements.rechargeStep2.style.display="none",elements.rechargeStep3.style.display="none",clearStatusMessage(elements.rechargeStatusMessage),1===e?(elements.rechargeModalTitle.textContent="Recharge",elements.rechargeStep1.style.display="block"):2===e?(elements.rechargeModalTitle.textContent="Select Payment Method",elements.rechargeStep2.style.display="block"):3===e&&(elements.rechargeModalTitle.textContent="Complete Recharge",elements.rechargeStep3.style.display="block")}function handleAddAmountClick(){if(!currentUser)return alert("Please login to add amount."),void showSection("login-section");rechargeState={amount:0,method:""},elements.rechargeAmountInput.value="",elements.rechargeTxnIdInput.value="",elements.rechargeGameIdInput.value="";const e=document.querySelectorAll('input[name="paymentMethod"]');e.forEach(e=>{e.checked=!1});const totalBalance = (userProfile.winningCash || 0) + (userProfile.bonusCash || 0); elements.rechargeModalBalance.textContent=`৳${totalBalance.toFixed(2)}`,showRechargeStep(1),elements.rechargeModalInstance.show()}async function submitRechargeRequest(){const e=elements.rechargeTxnIdInput.value.trim(),t=elements.rechargeGameIdInput.value.trim();if(!e||!t)return void showStatusMessage(elements.rechargeStatusMessage,"Please fill all fields.","warning");const loaderHtml='<div class="loader" style="width:16px;height:16px;"></div>';elements.rechargeSubmitBtn.disabled=!0,elements.rechargeSubmitBtn.innerHTML=`${loaderHtml} Submitting...`;const o={userId:currentUser.uid,userName:userProfile.displayName||currentUser.email,amount:rechargeState.amount,method:rechargeState.method,transactionId:e,playerGameId:t,status:"pending",timestamp:serverTimestamp()};try{const s=ref(db,"rechargeRequests");await push(s,o),showStatusMessage(elements.rechargeStatusMessage,"Request submitted! It will be reviewed by admin shortly.","success",!1),setTimeout(()=>{elements.rechargeModalInstance.hide()},3e3)}catch(n){console.error("Failed to submit recharge request:",n),showStatusMessage(elements.rechargeStatusMessage,"Failed to submit request. Please try again.","danger")}finally{elements.rechargeSubmitBtn.disabled=!1,elements.rechargeSubmitBtn.innerHTML="Submit"}}
        function loadNotifications(userId){if(!userId)return;const notificationsRef=ref(db,`notifications/${userId}`);dbListeners.notifications&&(off(ref(db,dbListeners.notifications.path),"value",dbListeners.notifications.func),delete dbListeners.notifications),console.log(`Setting up realtime listener for Notifications: notifications/${userId}`);const listenerFunc=onValue(notificationsRef,snapshot=>{if(!elements.notificationsList||!elements.notificationBadge)return;if(elements.notificationsList.innerHTML="",snapshot.exists()){const allNotifications=snapshot.val(),notificationEntries=Object.entries(allNotifications).sort(([,e],[,t])=>(t.timestamp||0)-(e.timestamp||0));let unreadCount=0;notificationEntries.forEach(([key,notification])=>{notification.isRead||unreadCount++;const notificationEl=document.createElement("a");notificationEl.href=notification.link||"#",notificationEl.className="list-group-item list-group-item-action",notificationEl.style.borderBottom=`1px solid var(--border-color)`,notificationEl.addEventListener("click",e=>{notification.link&&"#"!==notification.link||e.preventDefault(),elements.notificationsModalInstance.hide()});const timestamp=notification.timestamp?new Date(notification.timestamp).toLocaleString([],"short"=={dateStyle:"short",timeStyle:"short"}):"";notificationEl.innerHTML=`
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <h6 class="mb-1">${notification.isRead?"":'<i class="bi bi-circle-fill text-accent me-2" style="font-size: 0.5rem;"></i>'} ${notification.title||"Notification"}</h6>
                                <small class="text-secondary">${timestamp}</small>
                            </div>
                            <p class="mb-1 small text-secondary">${notification.message||""}</p>
                        `,elements.notificationsList.appendChild(notificationEl)}),unreadCount>0?(elements.notificationBadge.textContent=unreadCount>9?"9+":unreadCount,elements.notificationBadge.style.display="flex"):(elements.notificationBadge.style.display="none",elements.noNotificationsMessage.style.display="none")}else elements.notificationBadge.style.display="none",elements.notificationsList.innerHTML='<p class="text-secondary text-center p-4" id="noNotificationsMessageEl">No notifications yet.</p>'},error=>{console.error("Notification listener failed:",error)});dbListeners.notifications={path:`notifications/${userId}`,func:listenerFunc}}async function markNotificationsAsRead(){if(!currentUser)return;console.log("Marking notifications as read...");const e=ref(db,`notifications/${currentUser.uid}`),t=await get(e);if(t.exists()){const o={};t.forEach(e=>{e.val().isRead||(o[`${e.key}/isRead`]=!0)}),Object.keys(o).length>0&&(await update(e,o),console.log("Updated unread notifications."))}}
        async function loadLeaderboardData() {
            if (!currentUser) return;
            console.log("Loading Leaderboard Data...");
            elements.leaderboardList.classList.add("placeholder-glow");
            elements.leaderboardList.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                elements.leaderboardList.innerHTML += `<div class="leaderboard-item"><span class="leaderboard-rank placeholder col-1"></span> <span class="leaderboard-avatar placeholder" style="width: 45px; height: 45px; border-radius: 50%;"></span><span class="leaderboard-name placeholder col-6"></span> <span class="leaderboard-winnings placeholder col-3"></span></div>`;
            }
            elements.noLeaderboardMessage.style.display = 'none';

            try {
                const usersRef = ref(db, 'users');
                const snapshot = await get(usersRef);

                removePlaceholders(elements.leaderboardList);
                elements.leaderboardList.innerHTML = '';

                if (snapshot.exists()) {
                    const users = [];
                    snapshot.forEach(childSnapshot => {
                        const user = childSnapshot.val();
                        const totalBalance = (user.winningCash || 0) + (user.bonusCash || 0);
                        if (totalBalance > 0 && user.displayName) {
                           users.push({...user, totalBalance});
                        }
                    });
                    
                    users.sort((a, b) => b.totalBalance - a.totalBalance); 
                    const topUsers = users.slice(0, 50);

                    if (topUsers.length > 0) {
                        elements.noLeaderboardMessage.style.display = 'none';
                        topUsers.forEach((user, index) => {
                            const rank = index + 1;
                            const displayName = user.displayName;
                            const photoURL = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=1E293B&color=E2E8F0`;
                            const itemEl = document.createElement('div');
                            itemEl.className = 'leaderboard-item';
                            itemEl.innerHTML = `
                                <span class="leaderboard-rank">${rank}</span>
                                <img src="${photoURL}" alt="${displayName}" class="leaderboard-avatar">
                                <span class="leaderboard-name">${displayName}</span>
                                <span class="leaderboard-winnings">৳${user.totalBalance.toFixed(2)}</span>
                            `;
                            elements.leaderboardList.appendChild(itemEl);
                        });
                    } else {
                         elements.noLeaderboardMessage.style.display = 'block';
                    }

                } else {
                    elements.noLeaderboardMessage.style.display = 'block';
                }
            } catch (error) {
                console.error("Failed to load leaderboard:", error);
                removePlaceholders(elements.leaderboardList);
                elements.leaderboardList.innerHTML = `<p class="text-danger text-center">Could not load leaderboard.</p>`;
            }
        }
        async function loadUpdateFeedData() { if (!currentUser) return; console.log("Loading Update Feed..."); elements.updateFeed.classList.add("placeholder-glow"); elements.updateFeed.innerHTML = `<div class="update-post-card placeholder-glow"><div class="placeholder" style="width: 100%; height: 200px;"></div><div class="update-post-content"><h4 class="update-post-title placeholder col-8"></h4><p class="update-post-body placeholder col-12"></p></div></div>`; elements.noUpdatesMessage.style.display = 'none'; const updatesRef = ref(db, 'updates'); const updatesQuery = query(updatesRef, orderByChild('timestamp')); try { const snapshot = await get(updatesQuery); removePlaceholders(elements.updateFeed); elements.updateFeed.innerHTML = ''; if (snapshot.exists()) { const posts = []; snapshot.forEach(child => { posts.push({ id: child.key, ...child.val() }); }); posts.reverse(); posts.forEach(post => { const postEl = createUpdatePostElement(post); elements.updateFeed.appendChild(postEl); }); elements.noUpdatesMessage.style.display = 'none'; } else { elements.noUpdatesMessage.style.display = 'block'; } } catch (error) { console.error("Failed to load update feed:", error); elements.updateFeed.innerHTML = `<p class="text-danger text-center">Could not load updates.</p>`; } }
        function createUpdatePostElement(post) { const postCard = document.createElement('div'); postCard.className = 'update-post-card'; postCard.dataset.postId = post.id; const loves = post.loves || {}; const comments = post.comments || {}; const loveCount = Object.keys(loves).length; const commentCount = Object.keys(comments).length; const userHasLoved = currentUser && loves[currentUser.uid]; let imageHtml = ''; if (post.imageUrl) { imageHtml = `<img src="${post.imageUrl}" alt="Update Image" class="update-post-image">`; } postCard.innerHTML = ` ${imageHtml} <div class="update-post-content"> <h4 class="update-post-title">${post.title || ''}</h4> <p class="update-post-body">${post.body || ''}</p> </div> <div class="update-post-actions"> <button class="action-btn btn-love ${userHasLoved ? 'loved' : ''}"> <i class="bi ${userHasLoved ? 'bi-heart-fill' : 'bi-heart'}"></i> <span class="love-count">${loveCount}</span> </button> <button class="action-btn btn-comment"> <i class="bi bi-chat-square-text"></i> <span class="comment-count">${commentCount}</span> </button> </div> `; postCard.querySelector('.btn-love').addEventListener('click', () => toggleLove(post.id)); postCard.querySelector('.btn-comment').addEventListener('click', () => openCommentsModal(post.id)); return postCard; }
        async function openCommentsModal(postId) { if (!currentUser || !elements.commentsModalInstance) return; elements.sendCommentBtn.dataset.postId = postId; elements.commentsList.innerHTML = '<div class="d-flex justify-content-center p-3"><div class="loader"></div></div>'; elements.commentsModalInstance.show(); const commentsRef = ref(db, `updates/${postId}/comments`); try { const snapshot = await get(query(commentsRef, orderByChild('timestamp'))); elements.commentsList.innerHTML = ''; if (snapshot.exists()) { snapshot.forEach(commentSnap => { const commentData = commentSnap.val(); const commentEl = document.createElement('div'); commentEl.className = 'comment-item'; const timestamp = commentData.timestamp ? new Date(commentData.timestamp).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }) : ''; commentEl.innerHTML = ` <div class="comment-meta"> <strong>${commentData.name || 'User'}</strong> <small>${timestamp}</small> </div> <p class="comment-body">${commentData.text}</p> `; elements.commentsList.appendChild(commentEl); }); elements.commentsList.scrollTop = elements.commentsList.scrollHeight; } else { elements.commentsList.innerHTML = '<p class="text-center text-secondary">No comments yet. Be the first!</p>'; } } catch (error) { console.error("Error loading comments:", error); elements.commentsList.innerHTML = '<p class="text-center text-danger">Could not load comments.</p>'; } }
        async function sendComment() { if (!currentUser) return; const postId = elements.sendCommentBtn.dataset.postId; const text = elements.commentInput.value.trim(); if (!text || !postId) return; const commentData = { text: text, uid: currentUser.uid, name: userProfile.displayName || currentUser.email.split('@')[0], timestamp: serverTimestamp() }; const commentsRef = ref(db, `updates/${postId}/comments`); try { await push(commentsRef, commentData); elements.commentInput.value = ''; openCommentsModal(postId); const postCard = document.querySelector(`.update-post-card[data-post-id="${postId}"] .comment-count`); if(postCard) postCard.textContent = parseInt(postCard.textContent, 10) + 1; } catch (error) { console.error("Failed to send comment:", error); alert("Could not post comment. Please try again."); } }
        async function toggleLove(postId) { if (!currentUser) return; const postLovesRef = ref(db, `updates/${postId}/loves/${currentUser.uid}`); const postCard = document.querySelector(`.update-post-card[data-post-id="${postId}"]`); if (!postCard) return; const loveButton = postCard.querySelector('.btn-love'); const loveIcon = loveButton.querySelector('i'); const loveCountSpan = loveButton.querySelector('.love-count'); let currentCount = parseInt(loveCountSpan.textContent, 10); try { const snapshot = await get(postLovesRef); if (snapshot.exists()) { await set(postLovesRef, null); loveButton.classList.remove('loved'); loveIcon.className = 'bi bi-heart'; loveCountSpan.textContent = Math.max(0, currentCount - 1); } else { await set(postLovesRef, true); loveButton.classList.add('loved'); loveIcon.className = 'bi bi-heart-fill'; loveCountSpan.textContent = currentCount + 1; } } catch (error) { console.error("Failed to toggle love:", error); alert("Could not update reaction. Please try again."); } }

        function openLiveSupportChat() { if (!currentUser || !elements.liveSupportModalInstance) return; elements.liveSupportModalInstance.show(); elements.liveSupportMessages.innerHTML = '<div class="d-flex justify-content-center p-3"><div class="loader"></div></div>'; const chatPath = `liveSupportChats/${currentUser.uid}/messages`; const messagesRef = ref(db, chatPath); if (dbListeners.liveChat) { off(ref(db, dbListeners.liveChat.path), 'value', dbListeners.liveChat.func); } const listenerFunc = onValue(messagesRef, (snapshot) => { elements.liveSupportMessages.innerHTML = ''; if (snapshot.exists()) { snapshot.forEach(childSnapshot => { const message = childSnapshot.val(); renderChatMessage(message); }); } else { elements.liveSupportMessages.innerHTML = '<p class="text-center text-secondary small p-3">Welcome to live support! Type your question below to start a conversation.</p>'; } elements.liveSupportMessages.scrollTop = elements.liveSupportMessages.scrollHeight; }); dbListeners.liveChat = { path: chatPath, func: listenerFunc }; }
        function renderChatMessage(message) { if(!elements.liveSupportMessages) return; const msgDiv = document.createElement('div'); const bubbleDiv = document.createElement('div'); const metaDiv = document.createElement('div'); const sender = message.sender || 'user'; msgDiv.className = `chat-message ${sender}`; bubbleDiv.className = 'chat-bubble'; metaDiv.className = 'chat-bubble-meta'; bubbleDiv.textContent = message.text || ''; const timestamp = message.timestamp ? new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit'}) : ''; metaDiv.textContent = sender === 'admin' ? `Admin • ${timestamp}` : `You • ${timestamp}`; bubbleDiv.appendChild(metaDiv); msgDiv.appendChild(bubbleDiv); elements.liveSupportMessages.appendChild(msgDiv); }
        async function sendLiveSupportMessage() { if (!currentUser) return; const text = elements.liveSupportInput.value.trim(); if (!text) return; const messageData = { text: text, sender: 'user', timestamp: serverTimestamp() }; elements.liveSupportInput.value = ''; elements.sendLiveSupportBtn.disabled = true; const messagesRef = ref(db, `liveSupportChats/${currentUser.uid}/messages`); try { await push(messagesRef, messageData); } catch (error) { console.error("Failed to send live support message:", error); alert("Message could not be sent. Please try again."); elements.liveSupportInput.value = text; } finally { elements.sendLiveSupportBtn.disabled = false; } }
        function toggleProfileNameEdit(isEditing) { clearStatusMessage(elements.profileNameStatusMessageEl); if(isEditing) { elements.profileNameDisplayContainer.style.display = 'none'; elements.editProfileNameContainerEl.style.display = 'flex'; elements.profileNameInputEl.value = userProfile.displayName || ''; elements.profileNameInputEl.focus(); } else { elements.profileNameDisplayContainer.style.display = 'flex'; elements.editProfileNameContainerEl.style.display = 'none'; } }
        async function saveProfileName() { if(!currentUser) return; const newName = elements.profileNameInputEl.value.trim(); if(!newName || newName.length < 3) { showStatusMessage(elements.profileNameStatusMessageEl, 'Name must be at least 3 characters.', 'warning'); return; } if(newName === userProfile.displayName) { toggleProfileNameEdit(false); return; } elements.saveProfileNameBtnEl.disabled = true; elements.saveProfileNameBtnEl.innerHTML = '<div class="loader" style="width:16px;height:16px;"></div>'; try { const userRef = ref(db, `users/${currentUser.uid}`); await update(userRef, { displayName: newName }); showStatusMessage(elements.profileNameStatusMessageEl, 'Name updated successfully!', 'success'); setTimeout(() => { toggleProfileNameEdit(false); }, 1500); } catch (error) { console.error("Failed to update name:", error); showStatusMessage(elements.profileNameStatusMessageEl, 'Failed to update name.', 'danger'); } finally { elements.saveProfileNameBtnEl.disabled = false; elements.saveProfileNameBtnEl.textContent = 'Save'; } }
        
        // --- MODIFIED: Fixed Contact Support Handler ---
        function handleContactSupportClick(e) { 
            e.preventDefault();
            // Check multiple potential keys for the link
            const supportUrl = appSettings.supportUrl || appSettings.supportContact || appSettings.contactLink || appSettings.telegramUrl || appSettings.whatsappUrl;
            
            if (supportUrl && (supportUrl.startsWith('http') || supportUrl.startsWith('https'))) { 
                window.open(supportUrl, '_blank', 'noopener,noreferrer'); 
            } else { 
                console.log("Debug Support Info:", appSettings);
                alert("Support contact information is not available at the moment.\n(Admin needs to set a valid URL in Settings)"); 
            } 
        }

        // --- Event Listeners Initialization ---
        function initializeEventListeners() {
            if (!elements) return; console.log("Initializing listeners...");
            elements.bottomNavItems?.forEach(item => item.addEventListener('click', (e) => { e.preventDefault(); showSection(item.dataset.section); }));
            
            // NEW: Home Tab Listeners
            elements.homeTabs?.forEach(tab => tab.addEventListener('click', (e) => {
                const targetStatus = e.currentTarget.dataset.target;
                if(targetStatus) {
                    showSection('tournaments-section');
                    // Find the corresponding tab in Tournaments section and trigger click
                    const tournamentTab = querySel(`.tournament-tabs .tab-item[data-status="${targetStatus}"]`);
                    if(tournamentTab) tournamentTab.click();
                    
                    if(!currentTournamentGameId) {
                        elements.tournamentsListContainer.innerHTML = `
                            <div class="alert alert-info text-center mt-3">
                                <i class="bi bi-info-circle-fill"></i> Please select a game from the <strong>Home Page</strong> first to see ${targetStatus} tournaments.
                            </div>
                            <div class="d-grid mt-2">
                                <button class="btn btn-sm btn-custom btn-custom-secondary" onclick="document.getElementById('headerBackBtnEl').click()">Go to Games List</button>
                            </div>
                        `;
                    }
                }
            }));

            elements.headerBackBtn?.addEventListener('click', () => showSection('home-section'));
            elements.tournamentTabs?.forEach(tab => tab.addEventListener('click', (e) => { const s = e.currentTarget.dataset.status; if (currentTournamentGameId && s) { elements.tournamentTabs.forEach(t => t.classList.remove('active')); e.currentTarget.classList.add('active'); filterTournaments(currentTournamentGameId, s); } }));
            elements.loginEmailBtn?.addEventListener('click', loginWithEmail);
            elements.signupEmailBtn?.addEventListener('click', signUpWithEmail);
            elements.showSignupToggleBtn?.addEventListener('click', () => toggleLoginForm(false));
            elements.showLoginToggleBtn?.addEventListener('click', () => toggleLoginForm(true));
            elements.forgotPasswordLink?.addEventListener('click', (e) => { e.preventDefault(); resetPassword(); });
            elements.logoutProfileBtn?.addEventListener('click', logoutUser);
            elements.policyLinks?.forEach(link => link.addEventListener('click', handlePolicyClick));
            elements.notificationSwitch?.addEventListener('change', (e) => console.log("Notification toggle:", e.target.checked));
            elements.withdrawBtn?.addEventListener('click', handleWithdrawClick);
            elements.addAmountWalletBtn?.addEventListener('click', handleAddAmountClick);
            elements.submitWithdrawRequestBtn?.addEventListener('click', submitWithdrawRequestHandler);
            elements.notificationBtn?.addEventListener('click', () => { if (elements.notificationsModalInstance) { elements.notificationsModalInstance.show(); setTimeout(markNotificationsAsRead, 1500); } });
            elements.allTransactionsBtn?.addEventListener('click', () => alert('Transaction history page coming soon!'));
            elements.presetAmountsContainer.addEventListener('click', (e) => { if (e.target.classList.contains('preset-amount-btn')) { elements.rechargeAmountInput.value = e.target.dataset.amount; } });
            elements.rechargeNextBtn.addEventListener('click', () => { const e=parseFloat(elements.rechargeAmountInput.value);if(isNaN(e)||e<10||e>1e4)return void alert("Please enter a valid amount between ৳10 and ৳10000.");rechargeState.amount=e,elements.rechargeConfirmAmount.textContent=`৳${e.toFixed(2)}`,showRechargeStep(2)});
            elements.rechargeProcessBtn.addEventListener('click', () => { const e=querySel('input[name="paymentMethod"]:checked');if(!e)return void alert("Please select a payment method.");rechargeState.method=e.value,elements.rechargeFinalAmount.textContent=`৳${rechargeState.amount.toFixed(2)}`,elements.rechargeFinalMethod.textContent=rechargeState.method;const t=appSettings.paymentDetails?.[rechargeState.method.toLowerCase()]||{};elements.rechargePaymentNumber.textContent=t.number||"Not Available",t.qrCodeUrl?(elements.rechargeQrCode.src=t.qrCodeUrl,elements.rechargeQrCode.style.display="inline-block"):(elements.rechargeQrCode.style.display="none"),showRechargeStep(3)});
            elements.rechargeBackBtn.addEventListener('click', () => showRechargeStep(2));
            elements.rechargeSubmitBtn.addEventListener('click', submitRechargeRequest);
            elements.confirmJoinBtnEl?.addEventListener('click', processTournamentJoin);

            elements.sendCommentBtn?.addEventListener('click', sendComment);
            elements.liveSupportBtn?.addEventListener('click', openLiveSupportChat);
            elements.sendLiveSupportBtn?.addEventListener('click', sendLiveSupportMessage);
            elements.editProfileNameBtnEl?.addEventListener('click', () => toggleProfileNameEdit(true));
            elements.saveProfileNameBtnEl?.addEventListener('click', saveProfileName);
            elements.contactSupportBtnEl?.addEventListener('click', handleContactSupportClick);

            document.body.addEventListener('click', (event) => { if (event.target.matches('.copy-btn') || event.target.closest('.copy-btn')) { const btn = event.target.closest('.copy-btn'); if (btn.dataset.target) copyToClipboard(btn.dataset.target); } if (event.target.matches('#shareReferralBtn') || event.target.closest('#shareReferralBtn')) { const cel = getElement('referralCodeDisplay'); if (cel) shareReferral(cel.textContent); } });
            console.log("Listeners initialized.");
        }

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Loaded. Init App...");
            if (typeof initializeApp !== 'function' || !auth || !db) {
                console.error("Firebase SDK failed/not ready."); return;
            }
            showLoader(true);
            initializeEventListeners();
            updateGlobalUI(false); 
            loadAppSettings();
            onAuthStateChanged(auth, handleAuthStateChange);
        });

    </script>

</body>
</html>    <div id="auth-container">
        <div id="admin-setup-section" style="display: none;">
            <div class="container login-container"> <div class="card shadow"> <div class="card-body p-4"> <h2 class="card-title text-center mb-4">Admin Account Setup</h2> <p class="text-muted text-center small mb-3">Create the primary admin account.</p> <form id="adminSetupForm"> <div class="mb-3"> <label for="setupEmail" class="form-label">Admin Email</label> <input type="email" class="form-control" id="setupEmail" required> </div> <div class="mb-3"> <label for="setupPassword" class="form-label">Admin Password (min 6 chars)</label> <input type="password" class="form-control" id="setupPassword" required minlength="6"> </div> <div id="adminSetupStatus" class="mt-3"></div> <div class="d-grid"> <button type="submit" class="btn btn-success">Create Admin Account</button> </div> </form> </div> </div> </div>
        </div>
        <div id="admin-login-section" style="display: none;">
            <div class="container login-container"> <div class="card shadow"> <div class="card-body p-4"> <h2 class="card-title text-center mb-4">Admin Login</h2> <form id="adminLoginForm"> <div class="mb-3"> <label for="adminEmail" class="form-label">Email</label> <input type="email" class="form-control" id="adminEmail" required> </div> <div class="mb-3"> <label for="adminPassword" class="form-label">Password</label> <input type="password" class="form-control" id="adminPassword" required> </div> <div id="adminLoginStatus" class="mt-3"></div> <div class="d-grid"> <button type="submit" class="btn btn-primary">Login</button> </div> </form> </div> </div> </div>
        </div>
    </div>

    <!-- Main Admin Panel Area -->
    <div id="admin-main-area" style="display: none;">
        <header class="app-header">
            <div class="header-left">
                <button class="menu-toggle-btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#adminSidebar" aria-controls="adminSidebar">
                    <i class="bi bi-list"></i>
                </button>
                <img src="https://via.placeholder.com/35/1E293B/94A3B8?text=L" alt="Logo" class="header-logo" id="adminHeaderLogo" style="display:none;">
                <h1 class="header-title ms-1" id="adminPageTitle">Dashboard</h1>
            </div>
            <div class="header-right">
                <span class="admin-email-header" id="adminUserEmailShort"></span>
                <button class="btn btn-sm btn-outline-danger" id="adminLogoutBtnHeader"><i class="bi bi-box-arrow-right"></i> Logout</button>
            </div>
        </header>

        <div class="offcanvas offcanvas-start" tabindex="-1" id="adminSidebar" aria-labelledby="adminSidebarLabel">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="adminSidebarLabel">Admin Menu</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
                <ul class="nav flex-column">
                    <li class="nav-item"> <a class="nav-link active" href="#" data-section="dashboard-section"><i class="bi bi-speedometer2"></i> Dashboard</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="games-section"><i class="bi bi-controller"></i> Games</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="promotions-section"><i class="bi bi-images"></i> Promotions</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="update-section"><i class="bi bi-newspaper"></i> Updates</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="tournaments-section"><i class="bi bi-trophy"></i> Tournaments</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="users-section"><i class="bi bi-people"></i> Users</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="transactions-section"><i class="bi bi-receipt"></i> Transactions</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="withdrawals-section"><i class="bi bi-cash-coin"></i> Withdrawals <span class="badge bg-danger ms-1" id="pendingWithdrawalCountBadge" style="display: none;">0</span></a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="deposits-section"><i class="bi bi-wallet2"></i> Deposit <span class="badge bg-warning ms-1" id="pendingDepositCountBadge" style="display: none;">0</span></a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="notifications-section"><i class="bi bi-bell-fill"></i> Notifications</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="settings-section"><i class="bi bi-gear"></i> Settings</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="theme-section"><i class="bi bi-palette-fill"></i> Theme</a> </li>
                </ul>
                <div class="mt-auto p-3 border-top border-secondary">
                     <button class="btn btn-warning btn-sm w-100 mb-2" id="addDemoDataBtn"><i class="bi bi-database-add"></i> Add Demo Data</button>
                     <small class="text-muted d-block text-center">Adds sample data if DB is empty.</small>
                </div>
            </div>
        </div>

        <main class="main-content" id="adminMainContent">
            <!-- Dashboard Section -->
            <section id="dashboard-section" class="section active">
                <h2>Dashboard Overview</h2>
                <div class="row">
                    <!-- Row 1 -->
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-primary shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Total Users</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statTotalUsers">--</p>
                                <i class="bi bi-people-fill dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-info shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Active/Upcoming Tournaments</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statActiveTournaments">--</p>
                                <i class="bi bi-trophy-fill dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-warning shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Pending Withdrawals</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statPendingWithdrawals">--</p>
                                <i class="bi bi-hourglass-split dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                     <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-success shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Completed Withdrawals</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statCompletedWithdrawals">--</p>
                                <i class="bi bi-check-circle-fill dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                    <!-- Row 2 -->
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-dark shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Rejected Withdrawals</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statRejectedWithdrawals">--</p>
                                <i class="bi bi-x-octagon-fill dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                     <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-secondary shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Total Games</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statTotalGames">--</p>
                                <i class="bi bi-controller dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-secondary shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Total Promotions</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statTotalPromotions">--</p>
                                <i class="bi bi-images dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                     <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-secondary shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Finished Tournaments</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statFinishedTournaments">--</p>
                                <i class="bi bi-flag-fill dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="dashboardStatus"></div>
            </section>

            <!-- Games Section -->
            <section id="games-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <h2>Manage Games</h2>
                    <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#gameModal" id="addNewGameBtn"><i class="bi bi-plus-circle"></i> Add Game</button>
                </div>
                 <div id="gamesStatus" class="mb-3"></div>
                <div class="table-responsive card">
                    <table class="table table-dark table-hover mb-0">
                        <thead> <tr><th>Image</th><th>Name</th><th>Game ID</th><th>Actions</th></tr> </thead>
                        <tbody id="gamesTableBody">
                            <tr class="loading-placeholder"><td colspan="4"><div class="placeholder w-100 py-3"></div></td></tr>
                            <tr class="loading-placeholder"><td colspan="4"><div class="placeholder w-100 py-3"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Promotions Section -->
            <section id="promotions-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                     <h2>Manage Promotions</h2>
                     <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#promotionModal" id="addNewPromotionBtn"><i class="bi bi-plus-circle"></i> Add Promotion</button>
                </div>
                <div id="promotionsStatus" class="mb-3"></div>
                <div class="table-responsive card">
                    <table class="table table-dark table-hover mb-0">
                         <thead> <tr><th>Image</th><th>Link</th><th>Actions</th></tr> </thead>
                         <tbody id="promotionsTableBody">
                            <tr class="loading-placeholder"><td colspan="3"><div class="placeholder w-100 py-3"></div></td></tr>
                         </tbody>
                    </table>
                </div>
             </section>
             
            <!-- UPDATE SECTION -->
            <section id="update-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                     <h2>Manage Updates</h2>
                     <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#updateModal" id="addNewUpdateBtn"><i class="bi bi-plus-circle"></i> Add Update</button>
                </div>
                <div id="updatesStatus" class="mb-3"></div>
                <div class="table-responsive card">
                    <table class="table table-dark table-hover mb-0">
                         <thead> <tr><th>Image</th><th>Title</th><th>Actions</th></tr> </thead>
                         <tbody id="updatesTableBody">
                            <tr class="loading-placeholder"><td colspan="3"><div class="placeholder w-100 py-3"></div></td></tr>
                         </tbody>
                    </table>
                </div>
            </section>

            <!-- Tournaments Section -->
            <section id="tournaments-section" class="section">
                 <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                     <h2>Manage Tournaments</h2>
                     <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addTournamentModal" id="addNewTournamentBtn"><i class="bi bi-plus-circle"></i> Add Tournament</button>
                 </div>
                 <div id="tournamentsStatus" class="mb-3"></div>
                 <div class="table-responsive card">
                     <table class="table table-dark table-hover mb-0">
                         <thead> <tr><th>Name</th><th>Game</th><th>Fee</th><th>Prize</th><th>Start Time</th><th>Status</th><th>Players</th><th>Actions</th></tr> </thead>
                         <tbody id="tournamentsTableBody">
                            <tr class="loading-placeholder"><td colspan="8"><div class="placeholder w-100 py-3"></div></td></tr>
                            <tr class="loading-placeholder"><td colspan="8"><div class="placeholder w-100 py-3"></div></td></tr>
                         </tbody>
                    </table>
                 </div>
            </section>

            <!-- Users Section -->
            <section id="users-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <h2>Manage Users</h2>
                    <div class="d-flex gap-2">
                        <input type="search" class="form-control form-control-sm" id="userSearchInput" placeholder="Search by name or email...">
                        <button class="btn btn-success btn-sm flex-shrink-0" data-bs-toggle="modal" data-bs-target="#addUserModal">
                            <i class="bi bi-person-plus-fill"></i> Add User
                        </button>
                    </div>
                </div>
                 <div id="usersStatus" class="mb-3"></div>
                <div class="table-responsive card">
                    <table class="table table-dark table-hover mb-0">
                        <thead>
                            <tr><th>UID</th><th>Display Name</th><th>Email</th><th>Total Balance</th><th>Status</th><th>Actions</th></tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr class="loading-placeholder"><td colspan="6"><div class="placeholder w-100 py-3"></div></td></tr>
                            <tr class="loading-placeholder"><td colspan="6"><div class="placeholder w-100 py-3"></div></td></tr>
                            <tr class="loading-placeholder"><td colspan="6"><div class="placeholder w-100 py-3"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Transactions Section -->
            <section id="transactions-section" class="section card"> <div class="card-body"> <h2 class="card-title">User Transactions</h2> <p class="text-muted">Section under development.</p></div> </section>

            <!-- Withdrawals Section -->
            <section id="withdrawals-section" class="section">
                <h2>Manage Withdrawals</h2>
                 <div id="withdrawalsStatus" class="mb-3"></div>
                <div class="card">
                    <div class="card-header bg-secondary border-bottom border-dark"> <ul class="nav nav-tabs card-header-tabs" id="withdrawalTabs" role="tablist"> <li class="nav-item" role="presentation"><button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pendingWithdrawalsTab" type="button" role="tab">Pending</button></li> <li class="nav-item" role="presentation"><button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completedWithdrawalsTab" type="button" role="tab">Completed</button></li> <li class="nav-item" role="presentation"><button class="nav-link" id="rejected-tab" data-bs-toggle="tab" data-bs-target="#rejectedWithdrawalsTab" type="button" role="tab">Rejected</button></li> </ul> </div>
                    <div class="card-body tab-content p-0">
                        <div class="tab-pane fade show active" id="pendingWithdrawalsTab" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover mb-0">
                                    <thead><tr><th>Requested At</th><th>User</th><th>Amount</th><th>Method</th><th>Actions</th></tr></thead>
                                    <tbody id="pendingWithdrawalsTableBody"> <tr class="loading-placeholder"><td colspan="5"><div class="placeholder w-100 py-3"></div></td></tr> <tr class="loading-placeholder"><td colspan="5"><div class="placeholder w-100 py-3"></div></td></tr> </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="completedWithdrawalsTab" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover mb-0">
                                    <thead><tr><th>Requested At</th><th>Processed At</th><th>User</th><th>Amount</th><th>Method</th><th>Admin Note</th></tr></thead>
                                    <tbody id="completedWithdrawalsTableBody"> <tr class="loading-placeholder"><td colspan="6"><div class="placeholder w-100 py-3"></div></td></tr> </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="rejectedWithdrawalsTab" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover mb-0">
                                    <thead><tr><th>Requested At</th><th>Processed At</th><th>User</th><th>Amount</th><th>Method</th><th>Reason</th></tr></thead>
                                    <tbody id="rejectedWithdrawalsTableBody"> <tr class="loading-placeholder"><td colspan="6"><div class="placeholder w-100 py-3"></div></td></tr></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                 </div>
            </section>
            
            <!-- DEPOSIT SECTION    -->
            <section id="deposits-section" class="section">
                <h2>Manage Deposits (Recharge)</h2>
                <div id="depositsStatus" class="mb-3"></div>
                <div class="card">
                    <div class="card-header bg-secondary border-bottom border-dark">
                        <ul class="nav nav-tabs card-header-tabs" id="depositTabs" role="tablist">
                            <li class="nav-item" role="presentation"><button class="nav-link active" id="pending-deposit-tab" data-bs-toggle="tab" data-bs-target="#pendingDepositsTab" type="button" role="tab">Pending</button></li>
                            <li class="nav-item" role="presentation"><button class="nav-link" id="approved-deposit-tab" data-bs-toggle="tab" data-bs-target="#approvedDepositsTab" type="button" role="tab">Approved</button></li>
                            <li class="nav-item" role="presentation"><button class="nav-link" id="rejected-deposit-tab" data-bs-toggle="tab" data-bs-target="#rejectedDepositsTab" type="button" role="tab">Rejected</button></li>
                        </ul>
                    </div>
                    <div class="card-body tab-content p-0">
                        <!-- Pending Deposits -->
                        <div class="tab-pane fade show active" id="pendingDepositsTab" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover mb-0">
                                    <thead><tr><th>Requested At</th><th>User</th><th>Amount</th><th>Details</th><th>Actions</th></tr></thead>
                                    <tbody id="pendingDepositsTableBody">
                                        <tr class="loading-placeholder"><td colspan="5"><div class="placeholder w-100 py-3"></div></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- Approved Deposits -->
                        <div class="tab-pane fade" id="approvedDepositsTab" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover mb-0">
                                    <thead><tr><th>Requested At</th><th>Processed At</th><th>User</th><th>Amount</th><th>Details</th><th>Admin Note</th></tr></thead>
                                    <tbody id="approvedDepositsTableBody">
                                        <tr class="loading-placeholder"><td colspan="6"><div class="placeholder w-100 py-3"></div></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- Rejected Deposits -->
                        <div class="tab-pane fade" id="rejectedDepositsTab" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover mb-0">
                                    <thead><tr><th>Requested At</th><th>Processed At</th><th>User</th><th>Amount</th><th>Details</th><th>Reason</th></tr></thead>
                                    <tbody id="rejectedDepositsTableBody">
                                        <tr class="loading-placeholder"><td colspan="6"><div class="placeholder w-100 py-3"></div></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- NOTIFICATIONS SECTION -->
            <section id="notifications-section" class="section">
                <h2>Send Notifications</h2>
                <div id="notificationStatus" class="mb-3"></div>
                <div class="row">
                    <!-- Send to Single User -->
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header"><h5 class="mb-0"><i class="bi bi-person-fill me-2"></i> Send to Single User</h5></div>
                            <div class="card-body">
                                <form id="sendSingleNotificationForm">
                                    <div class="mb-3">
                                        <label for="singleNotificationUid" class="form-label">User ID (UID)</label>
                                        <input type="text" id="singleNotificationUid" class="form-control" placeholder="Enter user's Firebase UID" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="singleNotificationTitle" class="form-label">Title</label>
                                        <input type="text" id="singleNotificationTitle" class="form-control" placeholder="e.g., Recharge Approved" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="singleNotificationMessage" class="form-label">Message</label>
                                        <textarea id="singleNotificationMessage" class="form-control" rows="3" placeholder="e.g., Your recharge of ₹50 is complete." required></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Send Notification</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <!-- Broadcast to All Users -->
                    <div class="col-lg-6">
                        <div class="card border-danger">
                            <div class="card-header bg-danger text-white"><h5 class="mb-0"><i class="bi bi-broadcast me-2"></i> Broadcast to All Users</h5></div>
                            <div class="card-body">
                                <form id="sendBroadcastNotificationForm">
                                    <div class="mb-3">
                                        <label for="broadcastNotificationTitle" class="form-label">Title</label>
                                        <input type="text" id="broadcastNotificationTitle" class="form-control" placeholder="e.g., Maintenance Alert" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="broadcastNotificationMessage" class="form-label">Message</label>
                                        <textarea id="broadcastNotificationMessage" class="form-control" rows="3" placeholder="e.g., The app will be down for maintenance..." required></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-danger">Send to ALL Users</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settings-section" class="section card"> <div class="card-body"> <h2 class="card-title">App Settings</h2> <form id="appSettingsForm"> <div class="row"> <div class="col-md-6 mb-3"> <label for="settingLogoUrl" class="form-label">Logo URL</label> <input type="url" class="form-control" id="settingLogoUrl"> </div> <div class="col-md-6 mb-3"> <label for="settingAppName" class="form-label">App Name</label> <input type="text" class="form-control" id="settingAppName"> </div> <div class="col-md-6 mb-3"> <label for="settingMinWithdraw" class="form-label">Min Withdraw (₹)</label> <input type="number" class="form-control" id="settingMinWithdraw" min="0" step="any"> </div> <div class="col-md-6 mb-3"> <label for="settingReferralBonus" class="form-label">Referral Bonus (₹)</label> <input type="number" class="form-control" id="settingReferralBonus" min="0" step="any"> </div> <div class="col-12 mb-3"> <label for="settingSupportContact" class="form-label">Admin Support Contact</label> <input type="text" class="form-control" id="settingSupportContact"> </div> <div class="col-12 mb-3"> <label for="settingUpiDetails" class="form-label">UPI Details for Payment</label> <input type="text" class="form-control" id="settingUpiDetails"> </div> <div class="col-12 mb-3"> <label for="settingPolicyPrivacy" class="form-label">Privacy Policy</label> <textarea class="form-control" id="settingPolicyPrivacy" rows="5"></textarea> </div> <div class="col-12 mb-3"> <label for="settingPolicyTerms" class="form-label">Terms & Conditions</label> <textarea class="form-control" id="settingPolicyTerms" rows="5"></textarea> </div> <div class="col-12 mb-3"> <label for="settingPolicyRefund" class="form-label">Refund Policy</label> <textarea class="form-control" id="settingPolicyRefund" rows="5"></textarea> </div> <div class="col-12 mb-3"> <label for="settingPolicyFairPlay" class="form-label">Fair Play Policy</label> <textarea class="form-control" id="settingPolicyFairPlay" rows="5"></textarea> </div> </div> <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Save Settings</button> <div id="settingsStatus" class="mt-3"></div> </form> </div> </section>
            
            <!-- Theme Section -->
            <section id="theme-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="section-title mb-0">Theme Customization</h2>
                    <button class="btn btn-danger btn-sm" id="resetThemeBtn"><i class="bi bi-arrow-counterclockwise"></i> Reset to Default Theme</button>
                </div>
                <div id="themeStatus" class="mb-3"></div>
                <div class="row">
                    <div class="col-lg-4 mb-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">Predefined Themes</h5>
                                <p class="card-text text-secondary small">Select a theme to preview the colors in the form below, then click "Save Theme" to apply it.</p>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-secondary" id="previewDefaultThemeBtn">Default Dark</button>
                                    <button class="btn btn-outline-danger" id="previewCrimsonThemeBtn">Crimson Dark</button>
                                    <button class="btn btn-outline-info" id="previewOceanicThemeBtn">Oceanic Blue</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-8 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Custom Theme Colors</h5>
                                <form id="customThemeForm">
                                    <div class="row g-3">
                                        <div class="col-md-6"><div class="color-picker-group mb-2"><label for="theme-primary-bg" class="form-label">Primary BG</label><input type="color" class="form-control form-control-color" id="theme-primary-bg" data-var="--primary-bg"><input type="text" class="form-control form-control-sm" data-target="theme-primary-bg"></div></div>
                                        <div class="col-md-6"><div class="color-picker-group mb-2"><label for="theme-accent-color" class="form-label">Accent Color</label><input type="color" class="form-control form-control-color" id="theme-accent-color" data-var="--accent-color"><input type="text" class="form-control form-control-sm" data-target="theme-accent-color"></div></div>
                                        <div class="col-md-6"><div class="color-picker-group mb-2"><label for="theme-text-primary" class="form-label">Primary Text</label><input type="color" class="form-control form-control-color" id="theme-text-primary" data-var="--text-primary"><input type="text" class="form-control form-control-sm" data-target="theme-text-primary"></div></div>
                                        <div class="col-md-6"><div class="color-picker-group mb-2"><label for="theme-primary-button-bg" class="form-label">Primary Button</label><input type="color" class="form-control form-control-color" id="theme-primary-button-bg" data-var="--primary-button-bg"><input type="text" class="form-control form-control-sm" data-target="theme-primary-button-bg"></div></div>
                                        <div class="col-12"><hr class="my-2"></div>
                                        <div class="col-md-6"><div class="color-picker-group mb-2"><label for="theme-secondary-bg" class="form-label">Secondary BG</label><input type="color" class="form-control form-control-color" id="theme-secondary-bg" data-var="--secondary-bg"><input type="text" class="form-control form-control-sm" data-target="theme-secondary-bg"></div></div>
                                        <div class="col-md-6"><div class="color-picker-group mb-2"><label for="theme-card-bg" class="form-label">Card BG</label><input type="color" class="form-control form-control-color" id="theme-card-bg" data-var="--card-bg"><input type="text" class="form-control form-control-sm" data-target="theme-card-bg"></div></div>
                                        <div class="col-md-6"><div class="color-picker-group mb-2"><label for="theme-text-secondary" class="form-label">Secondary Text</label><input type="color" class="form-control form-control-color" id="theme-text-secondary" data-var="--text-secondary"><input type="text" class="form-control form-control-sm" data-target="theme-text-secondary"></div></div>
                                         <div class="col-md-6"><div class="color-picker-group mb-2"><label for="theme-border-color" class="form-label">Border Color</label><input type="color" class="form-control form-control-color" id="theme-border-color" data-var="--border-color"><input type="text" class="form-control form-control-sm" data-target="theme-border-color"></div></div>
                                    </div>
                                    <div class="d-flex justify-content-end mt-4">
                                         <button type="button" class="btn btn-primary" id="saveThemeBtn"><i class="bi bi-save"></i> Save Theme</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="gameModal" tabindex="-1"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="gameModalTitle">Add New Game</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <form id="gameForm"> <input type="hidden" id="gameEditId"> <div class="mb-3"> <label for="gameName" class="form-label">Game Name</label> <input type="text" class="form-control" id="gameName" required> </div> <div class="mb-3"> <label for="gameImageUrl" class="form-label">Image URL</label> <input type="url" class="form-control" id="gameImageUrl" required> <small class="text-muted">Direct image URL (e.g., from ImgBB).</small> </div> <div class="mb-3"> <label for="gameImageFile" class="form-label">Upload New Image (Optional - Overwrites URL)</label> <input class="form-control" type="file" id="gameImageFile" accept="image/*"> <div class="imgbb-upload-status mt-2"></div> </div> <div id="gameStatus" class="mt-2"></div></form> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> <button type="button" class="btn btn-primary" id="saveGameBtn">Save Game</button> </div> </div> </div> </div>
    <div class="modal fade" id="promotionModal" tabindex="-1"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="promotionModalTitle">Add New Promotion</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <form id="promotionForm"> <input type="hidden" id="promotionEditId"> <div class="mb-3"> <label for="promoImageUrl" class="form-label">Image URL</label> <input type="url" class="form-control" id="promoImageUrl" required> <small class="text-muted">Direct image URL (e.g., from ImgBB).</small> </div> <div class="mb-3"> <label for="promoImageFile" class="form-label">Upload New Image (Optional - Overwrites URL)</label> <input class="form-control" type="file" id="promoImageFile" accept="image/*"> <div class="imgbb-upload-status mt-2"></div> </div> <div class="mb-3"> <label for="promoLink" class="form-label">Link (Optional)</label> <input type="url" class="form-control" id="promoLink"> </div> <div id="promotionStatus" class="mt-2"></div></form> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> <button type="button" class="btn btn-primary" id="savePromotionBtn">Save Promotion</button> </div> </div> </div> </div>
    <!-- UPDATE MODAL -->
    <div class="modal fade" id="updateModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="updateModalTitle">Add New Update</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="updateForm">
                        <input type="hidden" id="updateEditId">
                        <div class="mb-3">
                            <label for="updateTitle" class="form-label">Title</label>
                            <input type="text" class="form-control" id="updateTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="updateImageUrl" class="form-label">Image URL</label>
                            <input type="url" class="form-control" id="updateImageUrl" required>
                            <small class="text-muted">Direct image URL (e.g., from ImgBB).</small>
                        </div>
                        <div id="updateStatus" class="mt-2"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveUpdateBtn">Post Update</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="addTournamentModal" tabindex="-1"> <div class="modal-dialog modal-lg"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="tournamentModalTitle">Add New Tournament</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <form id="tournamentForm"> <input type="hidden" id="tournamentEditId"> <div class="row"> <div class="col-md-6 mb-3"> <label for="tournamentGame" class="form-label">Game</label> <select class="form-select" id="tournamentGame" required></select> </div> <div class="col-md-6 mb-3"> <label for="tournamentName" class="form-label">Tournament Name</label> <input type="text" class="form-control" id="tournamentName" required> </div> <div class="col-md-6 mb-3"> <label for="tournamentStartTime" class="form-label">Start Date & Time</label> <input type="datetime-local" class="form-control" id="tournamentStartTime" required> </div> <div class="col-md-6 mb-3"> <label for="tournamentStatus" class="form-label">Status</label> <select class="form-select" id="tournamentStatus" required> <option value="upcoming">Upcoming</option> <option value="ongoing">Ongoing</option> <option value="completed">Completed</option> <option value="result">Result</option> <option value="cancelled">Cancelled</option> </select> </div> <div class="col-md-4 mb-3"> <label for="tournamentEntryFee" class="form-label">Entry Fee (₹)</label> <input type="number" class="form-control" id="tournamentEntryFee" min="0" value="0" required step="any"> </div> <div class="col-md-4 mb-3"> <label for="tournamentPrizePool" class="form-label">Total Prize Pool (₹)</label> <input type="number" class="form-control" id="tournamentPrizePool" min="0" value="0" step="any"> </div> <div class="col-md-4 mb-3"> <label for="tournamentPerKill" class="form-label">Per Kill Prize (₹)</label> <input type="number" class="form-control" id="tournamentPerKill" min="0" value="0" step="any"> </div> <div class="col-md-6 mb-3"> <label for="tournamentMaxPlayers" class="form-label">Max Players (0 for Unlimited)</label> <input type="number" class="form-control" id="tournamentMaxPlayers" min="0" value="0" required> </div> <div class="col-md-6 mb-3"> <label for="tournamentTags" class="form-label">Tags (comma-separated)</label> <input type="text" class="form-control" id="tournamentTags" placeholder="e.g., TPP, FPP"> </div> <div class="col-md-6 mb-3"> <label for="tournamentMode" class="form-label">Mode</label> <input type="text" class="form-control" id="tournamentMode" placeholder="e.g., Squad, Solo, Duo"> </div> <div class="col-md-6 mb-3"> <label for="tournamentMap" class="form-label">Map</label> <input type="text" class="form-control" id="tournamentMap" placeholder="e.g., Erangel, Livik, Miramar"> </div> <div class="col-12 mb-3"> <label for="tournamentDescription" class="form-label">Description / Rules</label> <textarea class="form-control" id="tournamentDescription" rows="4"></textarea> </div> <div class="col-md-6 mb-3"> <label for="tournamentRoomId" class="form-label">Room ID</label> <input type="text" class="form-control" id="tournamentRoomId"> </div> <div class="col-md-6 mb-3"> <label for="tournamentRoomPassword" class="form-label">Room Password</label> <input type="text" class="form-control" id="tournamentRoomPassword"> </div> <div class="form-check mb-3 ms-2"> <input class="form-check-input" type="checkbox" id="tournamentShowIdPass"> <label class="form-check-label" for="tournamentShowIdPass"> Show ID/Pass?</label> </div> </div> <div id="addTournamentStatus" class="mt-2"></div></form> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> <button type="button" class="btn btn-primary" id="saveTournamentBtn">Save Tournament</button> </div> </div> </div> </div>
    <div class="modal fade" id="userModal" tabindex="-1"> <div class="modal-dialog modal-lg"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="userModalTitle">User Details</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <div class="row"> <div class="col-md-6"> <h5>User Info</h5> <p><strong>UID:</strong> <small id="userDetailUid" class="text-muted user-uid-copy"></small> <i class="bi bi-clipboard copy-btn ms-1" data-target="#userDetailUid" title="Copy UID"></i></p> <p><strong>Email:</strong> <span id="userDetailEmail"></span></p> <p><strong>Name:</strong> <span id="userDetailName"></span></p> <p><strong>Created At:</strong> <span id="userDetailCreatedAt">N/A</span></p> <hr> <h5>Wallet</h5> <p>Total Balance: ₹<span id="userDetailBalance">0.00</span></p> <p>Winning Cash: ₹<span id="userDetailWinning">0.00</span></p> <p>Bonus Cash: ₹<span id="userDetailBonus">0.00</span></p> <hr> <h5>Referral Info</h5> <p><strong>Referral Code:</strong> <span id="userDetailReferralCode" class="text-info">N/A</span> <i class="bi bi-clipboard copy-btn ms-1" data-target="#userDetailReferralCode" title="Copy Code"></i></p> <p><strong>Referred By:</strong> <span id="userDetailReferredBy">N/A</span></p> <p><strong>Users Referred:</strong> <span id="userDetailReferredCount">N/A</span></p> </div> <div class="col-md-6"> <h5>Update Balance (Caution!)</h5> <form id="updateBalanceForm"> <input type="hidden" id="editUserUid"> <div class="row"> <div class="col-md-6 mb-3"> <label for="balanceUpdateAmount" class="form-label">Amount (+/-)</label> <input type="number" step="any" class="form-control" id="balanceUpdateAmount" placeholder="e.g., 50 or -20" required> </div> <div class="col-md-6 mb-3"> <label for="balanceUpdateType" class="form-label">Balance Type</label> <select id="balanceUpdateType" class="form-select" required> <option value="">--Select--</option> <option value="winningCash">Winning Cash</option> <option value="bonusCash">Bonus Cash</option> </select> </div> </div> <div class="mb-3"> <label for="balanceUpdateReason" class="form-label">Reason</label> <input type="text" class="form-control" id="balanceUpdateReason" placeholder="Manual Deposit, Correction etc." required> </div> <button type="submit" class="btn btn-warning">Update Balance</button> <div id="balanceUpdateStatus" class="mt-2"></div> </form> <hr> <h5>Status & Actions</h5> <p>Current Status: <span id="userDetailStatus" class="fw-bold"></span></p> <button class="btn btn-sm mb-2" id="userBlockBtn"></button> <button class="btn btn-sm btn-danger mb-2" id="userDeleteBtn"><i class="bi bi-trash"></i> Delete User (DB Only)</button> </div> </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> </div> </div> </div> </div>
    <div class="modal fade" id="withdrawalActionModal" tabindex="-1"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title">Withdrawal Action</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <p><strong>Request ID:</strong> <small id="withdrawalDetailId" class="text-muted withdrawal-id-copy"></small> <i class="bi bi-clipboard copy-btn ms-1" data-target="#withdrawalDetailId" title="Copy Request ID"></i></p> <p><strong>User:</strong> <span id="withdrawalDetailUser"></span> (<small id="withdrawalDetailUserUid" class="text-muted withdrawal-user-uid-copy"></small> <i class="bi bi-clipboard copy-btn ms-1" data-target="#withdrawalDetailUserUid" title="Copy User UID"></i>)</p> <p><strong>Amount:</strong> ₹<span id="withdrawalDetailAmount"></span></p> <p><strong>Method:</strong> <span id="withdrawalDetailMethod"></span></p> <hr> <div id="withdrawalRejectReasonDiv" style="display: none;" class="mb-3"> <label for="withdrawalRejectReason" class="form-label">Reason for Rejection</label> <textarea class="form-control" id="withdrawalRejectReason" rows="3" required></textarea> </div> <div id="withdrawalApproveNoteDiv" style="display: none;" class="mb-3"> <label for="withdrawalApproveNote" class="form-label">Admin Note / Txn ID (Optional)</label> <input type="text" class="form-control" id="withdrawalApproveNote" placeholder="e.g., Transaction ID"> </div> <div id="withdrawalActionStatus" class="mt-2"></div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button> <button type="button" class="btn btn-danger" id="rejectWithdrawalBtn">Reject</button> <button type="button" class="btn btn-success" id="approveWithdrawalBtn">Approve</button> </div> </div> </div> </div>
    <div class="modal fade" id="addUserModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Add New User</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="addUserForm"><div class="mb-3"><label for="newUserName" class="form-label">Display Name</label><input type="text" class="form-control" id="newUserName" required></div><div class="mb-3"><label for="newUserEmail" class="form-label">Email Address</label><input type="email" class="form-control" id="newUserEmail" required></div><div class="mb-3"><label for="newUserPassword" class="form-label">Password (min 6 chars)</label><input type="password" class="form-control" id="newUserPassword" required minlength="6"></div><div class="mb-3"><label for="newUserInitialBalance" class="form-label">Initial Balance (₹)</label><input type="number" step="any" class="form-control" id="newUserInitialBalance" value="0" min="0"><small class="text-muted">This will be added to Total Balance.</small></div><div id="addUserStatus" class="mt-2"></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button type="button" class="btn btn-primary" id="saveNewUserBtn">Create User</button></div></div></div></div>
    
    <!-- MODIFIED: Added columns for In-Game Name & ID -->
    <div class="modal fade" id="registeredPlayersModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="registeredPlayersModalTitle">Registered Players</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Tournament: <strong id="registeredPlayersTournamentName"></strong></p><div id="registeredPlayersStatus" class="mb-2"></div><div class="table-responsive"><table class="table table-dark table-sm table-hover"><thead><tr><th>User UID</th><th>Display Name</th><th>In-Game Name</th><th>In-Game ID</th><th>Joined At</th></tr></thead><tbody id="registeredPlayersTableBody"><tr><td colspan="5" class="text-center p-3"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div></td></tr></tbody></table></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div></div></div></div>

    <!-- DEPOSIT ACTION MODAL -->
    <div class="modal fade" id="depositActionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Deposit Action</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Request ID:</strong> <small id="depositDetailId" class="text-muted"></small></p>
                    <p><strong>User:</strong> <span id="depositDetailUser"></span></p>
                    <p><strong>Amount:</strong> <span id="depositDetailAmount" class="fw-bold text-success"></span></p>
                    <hr>
                    <p><strong>Method:</strong> <span id="depositDetailMethod"></span></p>
                    <p><strong>Game ID:</strong> <span id="depositDetailGameId"></span></p>
                    <p><strong>Transaction ID:</strong> <span id="depositDetailTxnId"></span></p>
                    <hr>
                    <div id="depositRejectReasonDiv" style="display: none;" class="mb-3">
                        <label for="depositRejectReason" class="form-label">Reason for Rejection</label>
                        <textarea class="form-control" id="depositRejectReason" rows="3" required></textarea>
                    </div>
                    <div id="depositApproveNoteDiv" style="display: none;" class="mb-3">
                        <label for="depositApproveNote" class="form-label">Admin Note (Optional)</label>
                        <input type="text" class="form-control" id="depositApproveNote" placeholder="e.g., Verified">
                    </div>
                    <div id="depositActionStatus" class="mt-2"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="rejectDepositBtn">Reject</button>
                    <button type="button" class="btn btn-success" id="approveDepositBtn">Approve</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, get, set, update, push, query, orderByChild, equalTo, onValue, off, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        // Firebase Config (Unchanged)
        const firebaseConfig = {
            apiKey: "AIzaSyBhE8HNbhHcL_DlGWDW4zu3AvE8VSeA8zE",
            authDomain: "l-tournament-10594.firebaseapp.com",
            databaseURL: "https://l-tournament-10594-default-rtdb.firebaseio.com",
            projectId: "l-tournament-10594",
            storageBucket: "l-tournament-10594.firebasestorage.app",
            messagingSenderId: "517389311136",
            appId: "1:517389311136:web:c05c333a3a15465fd37dc5"
        };

        // Firebase Initialization (Unchanged)
        let app, db, auth;
        try {
             if (firebaseConfig.apiKey.includes("YOUR_")) console.warn("Admin Panel: Using placeholder Firebase config.");
             app = initializeApp(firebaseConfig);
             db = getDatabase(app);
             auth = getAuth(app);
             console.log("Admin Panel: Firebase Initialized");
        } catch (error) {
             console.error("Admin Panel: Firebase initialization failed:", error);
             document.body.innerHTML = `<div class="alert alert-danger m-5"><strong>Critical Error:</strong> Could not connect. Check console & config.</div>`;
        }
        
        const getElement = (id) => document.getElementById(id);
        const querySel = (selector) => document.querySelector(selector);
        const querySelAll = (selector) => document.querySelectorAll(selector);
        
        const elements = {
             adminLoader: getElement('adminLoader'),
             authContainer: getElement('auth-container'),
             loginSection: getElement('admin-login-section'),
             setupSection: getElement('admin-setup-section'),
             mainArea: getElement('admin-main-area'),
             adminLoginForm: getElement('adminLoginForm'),
             adminEmailInput: getElement('adminEmail'),
             adminPasswordInput: getElement('adminPassword'),
             adminLoginStatus: getElement('adminLoginStatus'),
             adminSetupForm: getElement('adminSetupForm'),
             setupEmailInput: getElement('setupEmail'),
             setupPasswordInput: getElement('setupPassword'),
             setupStatus: getElement('adminSetupStatus'),
             adminUserEmailDisplay: getElement('adminUserEmailShort'),
             adminLogoutBtn: getElement('adminLogoutBtnHeader'),
             sidebar: getElement('adminSidebar'),
             sidebarLinks: querySelAll('#adminSidebar .nav-link'),
             sections: querySelAll('#adminMainContent .section'),
             adminPageTitle: getElement('adminPageTitle'),
             adminHeaderLogo: getElement('adminHeaderLogo'),
             dashboardSection: getElement('dashboard-section'),
             statTotalUsers: getElement('statTotalUsers'),
             statActiveTournaments: getElement('statActiveTournaments'),
             statPendingWithdrawals: getElement('statPendingWithdrawals'),
             statCompletedWithdrawals: getElement('statCompletedWithdrawals'),
             statRejectedWithdrawals: getElement('statRejectedWithdrawals'),
             statTotalGames: getElement('statTotalGames'),
             statTotalPromotions: getElement('statTotalPromotions'),
             statFinishedTournaments: getElement('statFinishedTournaments'),
             dashboardStatus: getElement('dashboardStatus'),
             pendingWithdrawalCountBadge: getElement('pendingWithdrawalCountBadge'),
             gamesTableBody: getElement('gamesTableBody'),
             gameModalEl: getElement('gameModal'),
             gameModalTitle: getElement('gameModalTitle'),
             gameForm: getElement('gameForm'),
             gameEditId: getElement('gameEditId'),
             gameNameInput: getElement('gameName'),
             gameImageFileInput: getElement('gameImageFile'),
             gameImageUrlInput: getElement('gameImageUrl'),
             saveGameBtn: getElement('saveGameBtn'),
             gameStatus: getElement('gameStatus'),
             gamesStatus: getElement('gamesStatus'),
             addNewGameBtn: getElement('addNewGameBtn'),
             promotionsTableBody: getElement('promotionsTableBody'),
             promotionModalEl: getElement('promotionModal'),
             promotionModalTitle: getElement('promotionModalTitle'),
             promotionForm: getElement('promotionForm'),
             promotionEditId: getElement('promotionEditId'),
             promoImageFileInput: getElement('promoImageFile'),
             promoImageUrlInput: getElement('promoImageUrl'),
             promoLinkInput: getElement('promoLink'),
             savePromotionBtn: getElement('savePromotionBtn'),
             promotionStatus: getElement('promotionStatus'),
             promotionsStatus: getElement('promotionsStatus'),
             addNewPromotionBtn: getElement('addNewPromotionBtn'),
             tournamentsTableBody: getElement('tournamentsTableBody'),
             addTournamentModalEl: getElement('addTournamentModal'),
             tournamentForm: getElement('tournamentForm'),
             tournamentModalTitle: getElement('tournamentModalTitle'),
             tournamentEditId: getElement('tournamentEditId'),
             tournamentGameSelect: getElement('tournamentGame'),
             tournamentNameInput: getElement('tournamentName'),
             tournamentStartTimeInput: getElement('tournamentStartTime'),
             tournamentStatusSelect: getElement('tournamentStatus'),
             tournamentEntryFeeInput: getElement('tournamentEntryFee'),
             tournamentPrizePoolInput: getElement('tournamentPrizePool'),
             tournamentPerKillInput: getElement('tournamentPerKill'),
             tournamentMaxPlayersInput: getElement('tournamentMaxPlayers'),
             tournamentTagsInput: getElement('tournamentTags'),
             tournamentModeInput: getElement('tournamentMode'),
             tournamentMapInput: getElement('tournamentMap'),
             tournamentDescriptionInput: getElement('tournamentDescription'),
             tournamentRoomIdInput: getElement('tournamentRoomId'),
             tournamentRoomPasswordInput: getElement('tournamentRoomPassword'),
             tournamentShowIdPassCheckbox: getElement('tournamentShowIdPass'),
             saveTournamentBtn: getElement('saveTournamentBtn'),
             addNewTournamentBtn: getElement('addNewTournamentBtn'),
             addTournamentStatus: getElement('addTournamentStatus'),
             tournamentsStatus: getElement('tournamentsStatus'),
             usersSection: getElement('users-section'),
             usersTableBody: getElement('usersTableBody'),
             userSearchInput: getElement('userSearchInput'),
             userModalEl: getElement('userModal'),
             userModalTitle: getElement('userModalTitle'),
             userDetailUid: getElement('userDetailUid'),
             userDetailEmail: getElement('userDetailEmail'),
             userDetailName: getElement('userDetailName'),
             userDetailCreatedAt: getElement('userDetailCreatedAt'),
             userDetailBalance: getElement('userDetailBalance'),
             userDetailWinning: getElement('userDetailWinning'),
             userDetailBonus: getElement('userDetailBonus'),
             userDetailReferralCode: getElement('userDetailReferralCode'),
             userDetailReferredBy: getElement('userDetailReferredBy'),
             userDetailReferredCount: getElement('userDetailReferredCount'),
             userDetailStatus: getElement('userDetailStatus'),
             updateBalanceForm: getElement('updateBalanceForm'),
             editUserUid: getElement('editUserUid'),
             balanceUpdateAmountInput: getElement('balanceUpdateAmount'),
             balanceUpdateTypeSelect: getElement('balanceUpdateType'),
             balanceUpdateReasonInput: getElement('balanceUpdateReason'),
             balanceUpdateStatus: getElement('balanceUpdateStatus'),
             userBlockBtn: getElement('userBlockBtn'),
             userDeleteBtn: getElement('userDeleteBtn'),
             addUserModalEl: getElement('addUserModal'),
             addUserForm: getElement('addUserForm'),
             newUserNameInput: getElement('newUserName'),
             newUserEmailInput: getElement('newUserEmail'),
             newUserPasswordInput: getElement('newUserPassword'),
             newUserInitialBalanceInput: getElement('newUserInitialBalance'),
             saveNewUserBtn: getElement('saveNewUserBtn'),
             addUserStatus: getElement('addUserStatus'),
             usersStatus: getElement('usersStatus'),
             pendingWithdrawalsTableBody: getElement('pendingWithdrawalsTableBody'),
             completedWithdrawalsTableBody: getElement('completedWithdrawalsTableBody'),
             rejectedWithdrawalsTableBody: getElement('rejectedWithdrawalsTableBody'),
             withdrawalActionModalEl: getElement('withdrawalActionModal'),
             withdrawalDetailId: getElement('withdrawalDetailId'),
             withdrawalDetailUser: getElement('withdrawalDetailUser'),
             withdrawalDetailUserUid: getElement('withdrawalDetailUserUid'),
             withdrawalDetailAmount: getElement('withdrawalDetailAmount'),
             withdrawalDetailMethod: getElement('withdrawalDetailMethod'),
             withdrawalRejectReasonDiv: getElement('withdrawalRejectReasonDiv'),
             withdrawalRejectReasonInput: getElement('withdrawalRejectReason'),
             withdrawalApproveNoteDiv: getElement('withdrawalApproveNoteDiv'),
             withdrawalApproveNoteInput: getElement('withdrawalApproveNote'),
             withdrawalActionStatus: getElement('withdrawalActionStatus'),
             rejectWithdrawalBtn: getElement('rejectWithdrawalBtn'),
             approveWithdrawalBtn: getElement('approveWithdrawalBtn'),
             withdrawalsStatus: getElement('withdrawalsStatus'),
             registeredPlayersModalEl: getElement('registeredPlayersModal'),
             registeredPlayersModalTitle: getElement('registeredPlayersModalTitle'),
             registeredPlayersTournamentName: getElement('registeredPlayersTournamentName'),
             registeredPlayersTableBody: getElement('registeredPlayersTableBody'),
             registeredPlayersStatus: getElement('registeredPlayersStatus'),
             settingsSection: getElement('settings-section'),
             appSettingsForm: getElement('appSettingsForm'),
             settingLogoUrlInput: getElement('settingLogoUrl'),
             settingAppNameInput: getElement('settingAppName'),
             settingMinWithdrawInput: getElement('settingMinWithdraw'),
             settingReferralBonusInput: getElement('settingReferralBonus'),
             settingSupportContactInput: getElement('settingSupportContact'),
             settingUpiDetailsInput: getElement('settingUpiDetails'),
             settingPolicyPrivacyInput: getElement('settingPolicyPrivacy'),
             settingPolicyTermsInput: getElement('settingPolicyTerms'),
             settingPolicyRefundInput: getElement('settingPolicyRefund'),
             settingPolicyFairPlayInput: getElement('settingPolicyFairPlay'),
             settingsStatus: getElement('settingsStatus'),
             themeSection: getElement('theme-section'),
             themeStatus: getElement('themeStatus'),
             customThemeForm: getElement('customThemeForm'),
             themeColorPickers: querySelAll('#customThemeForm input[type="color"]'),
             saveThemeBtn: getElement('saveThemeBtn'),
             resetThemeBtn: getElement('resetThemeBtn'),
             previewDefaultThemeBtn: getElement('previewDefaultThemeBtn'),
             previewCrimsonThemeBtn: getElement('previewCrimsonThemeBtn'),
             previewOceanicThemeBtn: getElement('previewOceanicThemeBtn'),
             addDemoDataBtn: getElement('addDemoDataBtn'),
             transactionsSection: getElement('transactions-section'),
             depositsStatus: getElement('depositsStatus'),
             pendingDepositCountBadge: getElement('pendingDepositCountBadge'),
             pendingDepositsTableBody: getElement('pendingDepositsTableBody'),
             approvedDepositsTableBody: getElement('approvedDepositsTableBody'),
             rejectedDepositsTableBody: getElement('rejectedDepositsTableBody'),
             depositActionModalEl: getElement('depositActionModal'),
             depositDetailId: getElement('depositDetailId'),
             depositDetailUser: getElement('depositDetailUser'),
             depositDetailAmount: getElement('depositDetailAmount'),
             depositDetailMethod: getElement('depositDetailMethod'),
             depositDetailGameId: getElement('depositDetailGameId'),
             depositDetailTxnId: getElement('depositDetailTxnId'),
             depositRejectReasonDiv: getElement('depositRejectReasonDiv'),
             depositRejectReasonInput: getElement('depositRejectReason'),
             depositApproveNoteDiv: getElement('depositApproveNoteDiv'),
             depositApproveNoteInput: getElement('depositApproveNote'),
             depositActionStatus: getElement('depositActionStatus'),
             rejectDepositBtn: getElement('rejectDepositBtn'),
             approveDepositBtn: getElement('approveDepositBtn'),
             notificationsSection: getElement('notifications-section'),
             notificationStatus: getElement('notificationStatus'),
             sendSingleNotificationForm: getElement('sendSingleNotificationForm'),
             singleNotificationUid: getElement('singleNotificationUid'),
             singleNotificationTitle: getElement('singleNotificationTitle'),
             singleNotificationMessage: getElement('singleNotificationMessage'),
             sendBroadcastNotificationForm: getElement('sendBroadcastNotificationForm'),
             broadcastNotificationTitle: getElement('broadcastNotificationTitle'),
             broadcastNotificationMessage: getElement('broadcastNotificationMessage'),
             updatesStatus: getElement('updatesStatus'),
             updatesTableBody: getElement('updatesTableBody'),
             addNewUpdateBtn: getElement('addNewUpdateBtn'),
             updateModalEl: getElement('updateModal'),
             updateModalTitle: getElement('updateModalTitle'),
             updateForm: getElement('updateForm'),
             updateEditId: getElement('updateEditId'),
             updateTitleInput: getElement('updateTitle'),
             updateImageUrlInput: getElement('updateImageUrl'),
             saveUpdateBtn: getElement('saveUpdateBtn'),
             updateStatus: getElement('updateStatus')
        };
        
        let componentInstances = {};
        const getComponentInstance = (element, componentType = 'Modal') => { if (!element) return null; const instanceKey = `${componentType}-${element.id}`; if (!componentInstances[instanceKey]) { try { if (componentType === 'Modal') componentInstances[instanceKey] = new bootstrap.Modal(element); else if (componentType === 'Offcanvas') componentInstances[instanceKey] = new bootstrap.Offcanvas(element); else if (componentType === 'Tab') componentInstances[instanceKey] = new bootstrap.Tab(element); else if (componentType === 'Alert') componentInstances[instanceKey] = new bootstrap.Alert(element); else if (componentType === 'Toast') componentInstances[instanceKey] = new bootstrap.Toast(element); else { console.warn("Unknown Bootstrap component type:", componentType); return null; } } catch (e) { console.error(`Error creating Bootstrap ${componentType} instance for #${element.id}:`, e); return null; } } return componentInstances[instanceKey]; }
        const getModalInstance = (element) => getComponentInstance(element, 'Modal');
        const getOffcanvasInstance = (element) => getComponentInstance(element, 'Offcanvas');
        let currentAdminUser = null;
        let currentWithdrawalAction = { id: null, type: null, userId: null };
        let currentDepositAction = { id: null, type: null, userId: null }; 
        let currentEditingItemId = null;
        let currentEditingTournamentId = null;
        let gameDataCache = {};
        let userDataCache = {};
        let fullUserDataCache = {};
        let dbListeners = {};
        let isAdminSetupComplete = false;
        let designatedAdminUid = null;
        let appSettings = {};
        const defaultTheme = {'--primary-bg':'#0F172A','--secondary-bg':'#1E293B','--card-bg':'#1E293B','--text-primary':'#E2E8F0','--text-secondary':'#94A3B8','--accent-color':'#FACC15','--primary-button-bg':'#3B82F6','--border-color':'#334155',};
        const crimsonTheme = {'--primary-bg':'#1a0005','--secondary-bg':'#2e0009','--card-bg':'#2e0009','--text-primary':'#fce7f3','--text-secondary':'#e9a8d9','--accent-color':'#f43f5e','--primary-button-bg':'#be185d','--border-color':'#500724',};
        const oceanicTheme = {'--primary-bg':'#0c1445','--secondary-bg':'#182157','--card-bg':'#182157','--text-primary':'#e0e7ff','--text-secondary':'#a5b4fc','--accent-color':'#38bdf8','--primary-button-bg':'#4338ca','--border-color':'#312e81',};
        
        function isDesignatedAdmin(user) { if (!user) return false; if (!designatedAdminUid) { console.warn("Designated Admin UID check failed: UID not loaded yet."); return false; } return user.uid === designatedAdminUid; }
        
        const showLoader = (show) => { if (elements.adminLoader) elements.adminLoader.style.display = show ? 'flex' : 'none'; };
        function showStatus(element, message, type = 'danger', autohide = 5000) { if (!element) { console.warn("showStatus called with null element for message:", message); return; } const alertId = `status-alert-${element.id || Math.random().toString(36).substring(2)}`; element.style.display = 'block'; element.innerHTML = `<div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">${sanitizeHTML(message)}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`; if (autohide && typeof autohide === 'number' && autohide > 0) { setTimeout(() => { const currentAlert = getElement(alertId); if (currentAlert) { try { const bsAlert = getComponentInstance(currentAlert, 'Alert'); if (bsAlert) bsAlert.close(); else currentAlert.remove(); } catch (e) { console.warn("Error closing alert:", e); currentAlert.remove(); } } }, autohide); } }
        function clearStatus(element) { if (!element) return; element.innerHTML = ''; }
        const formatDate = (timestamp) => { if (!timestamp) return 'N/A'; if (typeof timestamp === 'object' && timestamp.hasOwnProperty('.sv')) { return 'Pending...'; } const tsNumber = Number(timestamp); if (isNaN(tsNumber) || tsNumber <= 0) return 'Invalid Date'; try { const date = new Date(tsNumber); if (isNaN(date.getTime())) return 'Invalid Date'; return date.toLocaleString([], { dateStyle: 'short', timeStyle: 'short'}); } catch (e) { console.warn("Error formatting date:", timestamp, e); return 'Invalid Date'; } };
        const formatCurrency = (amount) => { const num = Number(amount); return isNaN(num) ? '₹--' : `₹${num.toFixed(2)}`; }
        function sanitizeHTML(str) { if (str == null) return ''; str = String(str); const temp = document.createElement('div'); temp.textContent = str; return temp.innerHTML; }
        function copyToClipboard(targetSelector) { const copyIcon = event?.target.closest('.copy-btn'); const context = copyIcon?.closest('.modal-body, tr'); const element = context?.querySelector(targetSelector); const textToCopy = element?.textContent?.trim(); if (!textToCopy) { console.warn("Copy target empty or not found:", targetSelector); return; } if (navigator.clipboard && window.isSecureContext) { navigator.clipboard.writeText(textToCopy).then(() => { const toastEl = document.createElement('div'); toastEl.className = 'toast position-fixed bottom-0 end-0 p-3 m-3 text-bg-success border-0'; toastEl.setAttribute('role', 'alert'); toastEl.setAttribute('aria-live', 'assertive'); toastEl.setAttribute('aria-atomic', 'true'); toastEl.innerHTML = '<div class="toast-body">Copied!</div>'; document.body.appendChild(toastEl); const toast = getComponentInstance(toastEl, 'Toast'); if(toast) toast.show(); toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove()); }).catch(err => { console.warn('Clipboard writeText failed: ', err); alert('Could not copy.'); }); } else { const textArea = document.createElement("textarea"); textArea.value = textToCopy; textArea.style.position = "fixed"; textArea.style.left = "-9999px"; textArea.style.top = "0"; document.body.appendChild(textArea); textArea.focus(); textArea.select(); try { document.execCommand('copy'); alert('Copied! (fallback)'); } catch (err) { console.warn('Fallback copy failed: ', err); alert('Copy failed.'); } document.body.removeChild(textArea); } }
        const tableLoadingPlaceholderHtml = (cols) => `<tr class="loading-placeholder"><td colspan="${cols}"><div class="placeholder w-100 py-3"></div></td></tr>`.repeat(3);

        function showAdminSection(sectionId) {
             elements.sections.forEach(sec => sec.classList.remove('active'));
             const targetSection = getElement(sectionId);
             if (targetSection) {
                 targetSection.classList.add('active');
                 const linkElement = querySel(`#adminSidebar .nav-link[data-section="${sectionId}"]`);
                 let title = 'Admin Panel';
                 if (linkElement) {
                     const linkText = linkElement.textContent.trim() || sectionId.replace('-section', '').replace('-', ' ');
                     title = linkText.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                     const badge = linkElement.querySelector('.badge');
                     if (badge) { title = title.replace(badge.textContent, '').trim(); }
                 }
                 if(elements.adminPageTitle) elements.adminPageTitle.textContent = title;
                 elements.sidebarLinks?.forEach(link => { link.classList.toggle('active', link.dataset.section === sectionId); });
                 loadDataForSection(sectionId);
                 const sidebar = getOffcanvasInstance(elements.sidebar);
                 if (sidebar?._isShown) sidebar.hide();
             } else {
                 console.error("Section element not found:", sectionId);
                 showAdminSection('dashboard-section');
             }
        }
        
        function loadDataForSection(sectionId) {
             if (!currentAdminUser || !isDesignatedAdmin(currentAdminUser)) {
                 console.warn("Attempted to load data without proper admin authorization.");
                 showStatus(elements.dashboardStatus, "Admin not authorized.", "danger", false);
                 return;
             }
             console.log(`Loading data for section: ${sectionId}`);
             clearStatus(elements.dashboardStatus); clearStatus(elements.gamesStatus); clearStatus(elements.promotionsStatus);
             clearStatus(elements.tournamentsStatus); clearStatus(elements.usersStatus); clearStatus(elements.withdrawalsStatus);
             clearStatus(elements.settingsStatus); clearStatus(elements.themeStatus);
             clearStatus(elements.depositsStatus); clearStatus(elements.notificationStatus); clearStatus(elements.updatesStatus);

             switch(sectionId) {
                 case 'dashboard-section': loadDashboardStats(); break;
                 case 'games-section': loadGames(); break;
                 case 'promotions-section': loadPromotions(); break;
                 case 'update-section': loadUpdates(); break;
                 case 'tournaments-section': loadTournaments(); break;
                 case 'users-section': loadUsers(); break;
                 case 'withdrawals-section':
                    loadWithdrawals('pending'); loadWithdrawals('completed'); loadWithdrawals('rejected');
                     const activeWithdrawalTab = querySel('#withdrawalTabs .nav-link.active') || getElement('pending-tab');
                     if (activeWithdrawalTab) getComponentInstance(activeWithdrawalTab, 'Tab')?.show();
                    break;
                 case 'deposits-section':
                    loadDeposits('pending'); loadDeposits('approved'); loadDeposits('rejected');
                    const activeDepositTab = querySel('#depositTabs .nav-link.active') || getElement('pending-deposit-tab');
                    if (activeDepositTab) getComponentInstance(activeDepositTab, 'Tab')?.show();
                    break;
                 case 'notifications-section': 
                    elements.sendSingleNotificationForm.reset();
                    elements.sendBroadcastNotificationForm.reset();
                    break; 
                 case 'settings-section': loadSettings(); break;
                 case 'theme-section': loadThemeSettings(); break;
                 case 'transactions-section':
                     if (elements.transactionsSection) elements.transactionsSection.innerHTML = '<div class="card-body"><h2 class="card-title">User Transactions</h2><p class="text-muted">Section under development.</p></div>';
                     break;
                 default: console.warn("Unknown section requested:", sectionId); showStatus(elements.dashboardStatus, `Unknown section requested: ${sectionId}`, "warning");
             }
         }

        async function loginAdmin(event) { event.preventDefault(); if (!auth) return; const email = elements.adminEmailInput.value; const password = elements.adminPasswordInput.value; clearStatus(elements.adminLoginStatus); showLoader(true); try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { console.error("Admin Login Error:", error); let message = `Login Failed: ${error.code}`; if (error.code === 'auth/network-request-failed') { message = "Login Failed: Network error."; } else if (['auth/invalid-credential', 'auth/wrong-password', 'auth/user-not-found', 'auth/invalid-email'].includes(error.code)) { message = "Login Failed: Invalid email or password."; } else if (error.code === 'auth/too-many-requests') { message = "Login Failed: Too many attempts."; } showStatus(elements.adminLoginStatus, message, 'danger', false); } finally { showLoader(false); } }
        async function logoutAdminUser() { if (!auth) return; showLoader(true); try { await signOut(auth); } catch (error) { console.error("Admin Logout Error:", error); alert("Logout failed: " + error.message); } }
        async function checkAdminSetup() { if (!db) return false; const adminConfigRef = ref(db, 'adminConfig'); try { console.log("Checking admin setup..."); const snapshot = await get(adminConfigRef); if (snapshot.exists()) { const d = snapshot.val(); isAdminSetupComplete = d.setupComplete === true; designatedAdminUid = d.adminUid || null; } else { isAdminSetupComplete = false; designatedAdminUid = null; } console.log("Admin setup check:", isAdminSetupComplete, "| UID:", designatedAdminUid); return isAdminSetupComplete; } catch (error) { console.error("Error checking admin setup:", error); const el = elements.loginSection?.style.display === 'block' ? elements.adminLoginStatus : elements.setupStatus; if (el) showStatus(el, `Config check error: ${error.message}. Check Rules.`, "danger", false); isAdminSetupComplete = false; designatedAdminUid = null; return false; } }
        async function setupAdmin(event) { event.preventDefault(); if (!auth || !db || isAdminSetupComplete) return; const email = elements.setupEmailInput.value.trim(); const password = elements.setupPasswordInput.value; clearStatus(elements.setupStatus); if (password.length < 6) { showStatus(elements.setupStatus, "Password min 6 chars.", "warning"); return; } showLoader(true); try { const cred = await createUserWithEmailAndPassword(auth, email, password); const uid = cred.user.uid; console.log("Admin user created in Auth:", uid); await set(ref(db, 'adminConfig'), { setupComplete: true, adminUid: uid }); console.log("Admin setup complete in DB."); isAdminSetupComplete = true; designatedAdminUid = uid; await signOut(auth); alert("Admin account created! Please login now."); await handleInitialLoad(); } catch (error) { console.error("Admin Setup Error:", error); let message = `Setup failed: ${error.message}`; if (error.code === 'auth/email-already-in-use') message = "Email already in use."; else if (error.code === 'auth/weak-password') message = "Password is too weak."; else if (error.code === 'auth/invalid-email') message = "Invalid email format."; else if (error.code === 'permission-denied') message = "Setup failed: Permission denied writing config. Check Firebase Rules for '/adminConfig'."; showStatus(elements.setupStatus, message, "danger", false); isAdminSetupComplete = false; designatedAdminUid = null; } finally { showLoader(false); } }
        async function handleInitialLoad() { if (!auth || !db) return; showLoader(true); await checkAdminSetup(); elements.setupSection.style.display = 'none'; elements.loginSection.style.display = 'none'; elements.mainArea.style.display = 'none'; elements.authContainer.style.display = 'block'; if (!isAdminSetupComplete) { elements.setupSection.style.display = 'block'; console.log("Showing Setup Form"); } else { elements.loginSection.style.display = 'block'; console.log("Showing Login Form"); } showLoader(false); }
        async function handleAdminAuthStateChange(user) { if (!auth || !db) return; console.log("Auth State Changed. User:", user ? user.uid : 'null'); showLoader(true); currentAdminUser = user; detachAllAdminListeners(); if (user) { if (!designatedAdminUid) await checkAdminSetup(); if (isDesignatedAdmin(user)) { console.log("Admin Authenticated & Authorized:", user.email); if (elements.adminUserEmailDisplay) elements.adminUserEmailDisplay.textContent = user.email; elements.authContainer.style.display = 'none'; elements.mainArea.style.display = 'block'; await loadSettings(); showAdminSection('dashboard-section'); setupRealtimeAdminListeners(); } else { console.warn("Unauthorized user login attempt:", user.email, "| UID:", user.uid, "| Expected:", designatedAdminUid); alert(`Access Denied. ${user.email} is not the designated admin.`); await logoutAdminUser(); return; } } else { console.log("Auth State: Logged Out"); currentAdminUser = null; designatedAdminUid = null; isAdminSetupComplete = false; elements.mainArea.style.display = 'none'; elements.authContainer.style.display = 'block'; gameDataCache = {}; userDataCache = {}; fullUserDataCache = {}; appSettings = {}; if(elements.adminHeaderLogo) { elements.adminHeaderLogo.src='https://via.placeholder.com/35/1E293B/94A3B8?text=L'; elements.adminHeaderLogo.style.display='none'; } if(elements.adminPageTitle) elements.adminPageTitle.textContent='Admin Panel'; document.title='Admin Panel'; if(elements.adminUserEmailDisplay) elements.adminUserEmailDisplay.textContent=''; Object.values(elements).filter(el => el.id?.startsWith('stat')).forEach(el => el.textContent = '--'); if(elements.pendingWithdrawalCountBadge) { elements.pendingWithdrawalCountBadge.textContent='0'; elements.pendingWithdrawalCountBadge.style.display='none';} if(elements.userSearchInput) elements.userSearchInput.value = ''; await handleInitialLoad(); } setTimeout(() => showLoader(false), 150); }
        
        async function loadDashboardStats() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; console.log("Loading dashboard stats..."); clearStatus(elements.dashboardStatus); Object.values(elements).filter(el => el.id?.startsWith('stat')).forEach(el => el.textContent = '...'); const usersRef = ref(db, 'users'); const gamesRef = ref(db, 'games'); const promotionsRef = ref(db, 'promotions'); const tournamentsRef = ref(db, 'tournaments'); const withdrawalsRef = ref(db, 'withdrawals'); const activeTournamentsQuery = query(tournamentsRef, orderByChild('status')); const pendingWithdrawalsQuery = query(withdrawalsRef, orderByChild('status'), equalTo('pending')); const completedWithdrawalsQuery = query(withdrawalsRef, orderByChild('status'), equalTo('completed')); const rejectedWithdrawalsQuery = query(withdrawalsRef, orderByChild('status'), equalTo('rejected')); const results = await Promise.allSettled([get(usersRef), get(gamesRef), get(promotionsRef), get(activeTournamentsQuery), get(pendingWithdrawalsQuery), get(completedWithdrawalsQuery), get(rejectedWithdrawalsQuery)]); let errorsFound = false; const setError = (element) => { element.textContent = 'Error'; errorsFound = true; }; if (results[0].status === 'fulfilled') elements.statTotalUsers.textContent = results[0].value.exists() ? results[0].value.size : 0; else { console.error("Err Users:", results[0].reason); setError(elements.statTotalUsers); showStatus(elements.dashboardStatus, `Err Users: ${results[0].reason?.message}`, "warning"); } if (results[1].status === 'fulfilled') elements.statTotalGames.textContent = results[1].value.exists() ? results[1].value.size : 0; else { console.error("Err Games:", results[1].reason); setError(elements.statTotalGames); } if (results[2].status === 'fulfilled') elements.statTotalPromotions.textContent = results[2].value.exists() ? results[2].value.size : 0; else { console.error("Err Promos:", results[2].reason); setError(elements.statTotalPromotions); } if (results[3].status === 'fulfilled') { let activeCount = 0; let finishedCount = 0; if (results[3].value.exists()) { results[3].value.forEach(child => { const status = child.val()?.status; if (status === 'ongoing' || status === 'upcoming') activeCount++; else if (status === 'completed' || status === 'result' || status === 'cancelled') finishedCount++; }); } elements.statActiveTournaments.textContent = activeCount; elements.statFinishedTournaments.textContent = finishedCount; } else { console.error("Err Tournaments:", results[3].reason); setError(elements.statActiveTournaments); setError(elements.statFinishedTournaments); if (results[3].reason?.message?.includes("index")) showStatus(elements.dashboardStatus, "WARNING: Tournament query fail. Add '.indexOn': 'status' to '/tournaments' rules.", "warning", false); else showStatus(elements.dashboardStatus, `Err Tournaments: ${results[3].reason?.message}`, "warning"); } if (results[4].status === 'fulfilled') { const count = results[4].value.exists() ? results[4].value.size : 0; elements.statPendingWithdrawals.textContent = count; elements.pendingWithdrawalCountBadge.textContent = count; elements.pendingWithdrawalCountBadge.style.display = count > 0 ? 'inline-block' : 'none'; } else { console.error("Err Pending Withdrawals:", results[4].reason); setError(elements.statPendingWithdrawals); elements.pendingWithdrawalCountBadge.textContent = 'Err'; elements.pendingWithdrawalCountBadge.style.display = 'inline-block'; if (results[4].reason?.message?.includes("index")) showStatus(elements.dashboardStatus, "CRITICAL: Pending withdrawal query fail. Add '.indexOn': 'status' to '/withdrawals' rules.", "danger", false); else showStatus(elements.dashboardStatus, `Err Pending Withdrawals: ${results[4].reason?.message}`, "warning"); } if (results[5].status === 'fulfilled') elements.statCompletedWithdrawals.textContent = results[5].value.exists() ? results[5].value.size : 0; else { console.error("Err Completed Withdrawals:", results[5].reason); setError(elements.statCompletedWithdrawals); if (results[5].reason?.message?.includes("index")) showStatus(elements.dashboardStatus, "WARNING: Completed withdrawal query fail. Add '.indexOn': 'status' to '/withdrawals' rules.", "warning", false); } if (results[6].status === 'fulfilled') elements.statRejectedWithdrawals.textContent = results[6].value.exists() ? results[6].value.size : 0; else { console.error("Err Rejected Withdrawals:", results[6].reason); setError(elements.statRejectedWithdrawals); if (results[6].reason?.message?.includes("index")) showStatus(elements.dashboardStatus, "WARNING: Rejected withdrawal query fail. Add '.indexOn': 'status' to '/withdrawals' rules.", "warning", false); } console.log("Dashboard stats loading complete.", errorsFound ? "Errors occurred." : "");}
        async function loadGames() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; const gamesRef = ref(db, 'games'); elements.gamesTableBody.innerHTML = tableLoadingPlaceholderHtml(4); gameDataCache = {}; clearStatus(elements.gamesStatus); try { const snapshot = await get(gamesRef); let tableHtml = ''; if (snapshot.exists()) { snapshot.forEach(childSnapshot => { const gameId = childSnapshot.key; const game = childSnapshot.val(); if (game && game.name) { gameDataCache[gameId] = game.name; tableHtml += `<tr><td><img src="${sanitizeHTML(game.imageUrl || 'https://via.placeholder.com/60x40/1E293B/94A3B8?text=N/A')}" alt="${sanitizeHTML(game.name)}" class="preview-img"></td><td>${sanitizeHTML(game.name)}</td><td><small class="text-muted">${sanitizeHTML(gameId)}</small> <i class="bi bi-clipboard copy-btn ms-1" data-target="td:nth-child(3) > small" title="Copy Game ID"></i></td><td class="action-buttons"><button class="btn btn-sm btn-info btn-edit-game" data-id="${sanitizeHTML(gameId)}" title="Edit Game"><i class="bi bi-pencil-square"></i></button><button class="btn btn-sm btn-danger btn-delete-game" data-id="${sanitizeHTML(gameId)}" title="Delete Game"><i class="bi bi-trash"></i></button></td></tr>`; } else { console.warn("Skipping invalid game data:", gameId, game); } }); } elements.gamesTableBody.innerHTML = tableHtml || `<tr><td colspan="4" class="text-center p-3 text-muted">No games found. Add one using the button above.</td></tr>`; if (elements.dashboardSection?.classList.contains('active')) { elements.statTotalGames.textContent = Object.keys(gameDataCache).length; } } catch (error) { console.error("Error loading games:", error); elements.gamesTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-3 text-danger">Error loading games: ${error.message}. Check console & Rules.</td></tr>`; showStatus(elements.gamesStatus, `Error loading games: ${error.message}. Check Rules.`, 'danger', false); if (elements.dashboardSection?.classList.contains('active')) elements.statTotalGames.textContent = 'Error'; } }
        async function loadPromotions() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; const promotionsRef = ref(db, 'promotions'); elements.promotionsTableBody.innerHTML = tableLoadingPlaceholderHtml(3); clearStatus(elements.promotionsStatus); let promoCount = 0; try { const snapshot = await get(promotionsRef); let tableHtml = ''; if (snapshot.exists()) { promoCount = snapshot.size; snapshot.forEach(childSnapshot => { const promoId = childSnapshot.key; const promo = childSnapshot.val(); if (promo && promo.imageUrl) { const displayLink = promo.link ? sanitizeHTML(promo.link) : ''; const shortLink = displayLink.length > 50 ? displayLink.substring(0, 50) + '...' : displayLink; tableHtml += `<tr><td><img src="${sanitizeHTML(promo.imageUrl)}" alt="Promotion" class="preview-img"></td><td>${promo.link ? `<a href="${displayLink}" target="_blank" class="text-info" title="${displayLink}">${shortLink}</a>` : '<span class="text-muted">No Link</span>'}</td><td class="action-buttons"><button class="btn btn-sm btn-info btn-edit-promo" data-id="${sanitizeHTML(promoId)}" title="Edit Promotion"><i class="bi bi-pencil-square"></i></button><button class="btn btn-sm btn-danger btn-delete-promo" data-id="${sanitizeHTML(promoId)}" title="Delete Promotion"><i class="bi bi-trash"></i></button></td></tr>`; } else { console.warn("Skipping invalid promotion data:", promoId, promo); } }); } elements.promotionsTableBody.innerHTML = tableHtml || `<tr><td colspan="3" class="text-center p-3 text-muted">No promotions found.</td></tr>`; if (elements.dashboardSection?.classList.contains('active')) { elements.statTotalPromotions.textContent = promoCount; } } catch (error) { console.error("Error loading promotions:", error); elements.promotionsTableBody.innerHTML = `<tr><td colspan="3" class="text-center p-3 text-danger">Error loading promotions: ${error.message}. Check console & Rules.</td></tr>`; showStatus(elements.promotionsStatus, `Error loading promotions: ${error.message}. Check Rules.`, 'danger', false); if (elements.dashboardSection?.classList.contains('active')) elements.statTotalPromotions.textContent = 'Error'; } }
        async function loadTournaments() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; const tournamentsRef = ref(db, 'tournaments'); if (Object.keys(gameDataCache).length === 0) await loadGames(); elements.tournamentsTableBody.innerHTML = tableLoadingPlaceholderHtml(8); clearStatus(elements.tournamentsStatus); try { const snapshot = await get(tournamentsRef); let activeCount = 0; let finishedCount = 0; let tableHtml = ''; if (snapshot.exists()) { snapshot.forEach(childSnapshot => { const tournamentId = childSnapshot.key; const t = childSnapshot.val(); if (t && t.name && t.gameId && t.status) { const gameName = gameDataCache[t.gameId] || `<small class="text-warning" title="ID: ${t.gameId}">Unknown</small>`; let statusClass = 'secondary'; if (t.status === 'ongoing') { statusClass = 'success'; activeCount++; } else if (t.status === 'upcoming') { statusClass = 'info'; activeCount++; } else if (t.status === 'result') { statusClass = 'primary'; finishedCount++; } else if (t.status === 'completed') { statusClass = 'secondary'; finishedCount++; } else if (t.status === 'cancelled') { statusClass = 'danger'; finishedCount++; } const statusBadge = `<span class="status-badge text-bg-${statusClass}">${t.status}</span>`; const registeredCount = t.registeredPlayers ? Object.keys(t.registeredPlayers).length : 0; const maxPlayers = t.maxPlayers > 0 ? `/${t.maxPlayers}` : ''; const playersDisplay = `${registeredCount}${maxPlayers}`; tableHtml += `<tr><td>${sanitizeHTML(t.name)}</td><td>${gameName}</td><td>${formatCurrency(t.entryFee)}</td><td>${formatCurrency(t.prizePool)}</td><td>${formatDate(t.startTime)}</td><td>${statusBadge}</td><td>${playersDisplay}</td><td class="action-buttons"><button class="btn btn-sm btn-info btn-edit-tournament" data-id="${sanitizeHTML(tournamentId)}" title="Edit"><i class="bi bi-pencil-square"></i></button><button class="btn btn-sm btn-secondary btn-view-registered" data-id="${sanitizeHTML(tournamentId)}" data-name="${sanitizeHTML(t.name)}" title="View Players"><i class="bi bi-people"></i></button><button class="btn btn-sm btn-danger btn-delete-tournament" data-id="${sanitizeHTML(tournamentId)}" title="Delete"><i class="bi bi-trash"></i></button></td></tr>`; } else { console.warn("Skipping invalid tournament data:", tournamentId, t); } }); } elements.tournamentsTableBody.innerHTML = tableHtml || `<tr><td colspan="8" class="text-center p-3 text-muted">No tournaments found.</td></tr>`; if (elements.dashboardSection?.classList.contains('active')) { elements.statActiveTournaments.textContent = activeCount; elements.statFinishedTournaments.textContent = finishedCount; } } catch (error) { console.error("Error loading tournaments:", error); elements.tournamentsTableBody.innerHTML = `<tr><td colspan="8" class="text-center p-3 text-danger">Error: ${error.message}. Check Rules.</td></tr>`; showStatus(elements.tournamentsStatus, `Error loading tournaments: ${error.message}. Check Rules.`, 'danger', false); if (elements.dashboardSection?.classList.contains('active')) { elements.statActiveTournaments.textContent = 'Error'; elements.statFinishedTournaments.textContent = 'Error'; } } }
        
        // MODIFIED: This function now calculates Total Balance correctly.
        function renderUsersTable(usersArray) {
            let tableHtml = '';
            if (usersArray?.length > 0) {
                usersArray.sort((a, b) => (a.displayName || '').localeCompare(b.displayName || '', undefined, { sensitivity: 'base' }));
                usersArray.forEach(user => {
                    if (user?.email && user.uid) {
                        const status = user.status || 'active';
                        const statusBadge = `<span class="status-badge text-bg-${status === 'active' ? 'success' : 'danger'}">${status}</span>`;
                        
                        // MODIFICATION: Calculate total balance from components instead of using the 'balance' field.
                        // EXPLANATION: This ensures the displayed value is always correct, as per your formula: Win cash + Bonus cash.
                        const totalBalance = (Number(user.winningCash) || 0) + (Number(user.bonusCash) || 0);

                        tableHtml += `<tr>
                            <td><small class="text-muted">${sanitizeHTML(user.uid)}</small> <i class="bi bi-clipboard copy-btn ms-1" data-target="td:first-child > small" title="Copy UID"></i></td>
                            <td>${sanitizeHTML(user.displayName || 'N/A')}</td>
                            <td>${sanitizeHTML(user.email)}</td>
                            <td>${formatCurrency(totalBalance)}</td>
                            <td>${statusBadge}</td>
                            <td class="action-buttons">
                                <button class="btn btn-sm btn-info btn-view-user" data-id="${sanitizeHTML(user.uid)}" title="View/Edit"><i class="bi bi-eye"></i></button>
                                <button class="btn btn-sm btn-danger btn-delete-user" data-id="${sanitizeHTML(user.uid)}" title="Delete (DB Only)"><i class="bi bi-trash"></i></button>
                            </td>
                        </tr>`;
                    }
                });
            }
            elements.usersTableBody.innerHTML = tableHtml || `<tr><td colspan="6" class="text-center p-3 text-muted">No users found matching criteria.</td></tr>`;
        }

        async function loadUsers() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; const usersRef = ref(db, 'users'); elements.usersTableBody.innerHTML = tableLoadingPlaceholderHtml(6); userDataCache = {}; fullUserDataCache = {}; clearStatus(elements.usersStatus); elements.userSearchInput.value = ''; const listenerKey = 'users'; if (dbListeners[listenerKey]) try { off(usersRef, 'value', dbListeners[listenerKey]); delete dbListeners[listenerKey]; console.log("Detached previous users listener."); } catch(e) { console.warn("Could not detach users listener", e); } dbListeners[listenerKey] = onValue(usersRef, (snapshot) => { console.log("Users data received via listener."); let userCount = 0; const usersArray = []; fullUserDataCache = {}; userDataCache = {}; if (snapshot.exists()) { snapshot.forEach(childSnapshot => { userCount++; const userId = childSnapshot.key; const user = childSnapshot.val(); if (user && user.email) { user.uid = userId; fullUserDataCache[userId] = user; userDataCache[userId] = { displayName: user.displayName || 'N/A', email: user.email, status: user.status || 'active', balance: user.balance || 0, winningCash: user.winningCash || 0 }; usersArray.push(user); } else { console.warn("Skipping invalid user data:", userId, user); } }); } renderUsersTable(usersArray); if (elements.dashboardSection?.classList.contains('active')) { elements.statTotalUsers.textContent = userCount; } console.log("Users table updated. Count:", userCount); }, (error) => { console.error("Error listening to users:", error); elements.usersTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-3 text-danger">Error: ${error.message}. Check Rules.</td></tr>`; showStatus(elements.usersStatus, `Error listening to users: ${error.message}. Check Rules.`, 'danger', false); fullUserDataCache = {}; userDataCache = {}; if (elements.dashboardSection?.classList.contains('active')) elements.statTotalUsers.textContent = 'Error'; try { if (dbListeners[listenerKey]) { off(usersRef, 'value', dbListeners[listenerKey]); delete dbListeners[listenerKey]; console.log("Detached failed users listener."); } } catch(e) { console.warn("Could not detach failed users listener.", e); } }); console.log("Attached new users listener."); }
        async function loadWithdrawals(status = 'pending') { if (!db || !isDesignatedAdmin(currentAdminUser)) return; const targetTableBody = getElement(`${status}WithdrawalsTableBody`); if (!targetTableBody) { console.error(`Table body not found: ${status}`); return; } const q = query(ref(db, 'withdrawals'), orderByChild('status'), equalTo(status)); targetTableBody.innerHTML = tableLoadingPlaceholderHtml(status === 'pending' ? 5 : 6); if (status === 'pending') clearStatus(elements.withdrawalsStatus); const listenerKey = `withdrawals-${status}`; if (dbListeners[listenerKey]) try { off(q, 'value', dbListeners[listenerKey]); delete dbListeners[listenerKey]; console.log(`Detached previous ${status} withdrawals listener.`); } catch (e) { console.warn(`Could not detach ${listenerKey}`, e); } dbListeners[listenerKey] = onValue(q, async (snapshot) => { console.log(`${status} withdrawals data received.`); let tableHtml = ''; let count = 0; targetTableBody.innerHTML = ''; if (snapshot.exists()) { count = snapshot.size; const userIds = new Set(); snapshot.forEach(child => { if (child.val()?.userId && !userDataCache[child.val().userId]) userIds.add(child.val().userId); }); if (userIds.size > 0) { console.log(`Fetching ${userIds.size} missing basic user details for ${status} withdrawals...`); const promises = Array.from(userIds).map(uid => get(ref(db, `users/${uid}`)).then(us => { if (us.exists()) { const u = us.val(); userDataCache[uid] = { displayName: u.displayName || 'N/A', email: u.email || uid, status: u.status || 'unknown' }; } else { userDataCache[uid] = { displayName: 'Unknown User', email: uid, status: 'deleted' }; } }).catch(err => { console.warn(`Failed fetch user ${uid}`, err); userDataCache[uid] = { displayName: 'Error Fetching', email: uid, status: 'error' }; })); await Promise.allSettled(promises); console.log("Missing user details fetch complete."); } const withdrawals = []; snapshot.forEach(child => withdrawals.push({ id: child.key, ...child.val() })); withdrawals.sort((a, b) => (b.requestTimestamp || 0) - (a.requestTimestamp || 0)); withdrawals.forEach(w => { if (w && w.userId && w.amount != null && w.requestTimestamp) { const user = userDataCache[w.userId] || { displayName: 'Loading...', email: w.userId, status: 'unknown' }; const userDisplay = `${sanitizeHTML(user.displayName)} (<small class="text-muted" title="${w.userId}">${sanitizeHTML(user.email)}</small>)`; let methodDisplay = sanitizeHTML(w.methodDetails?.methodName || w.method || 'N/A'); if (w.methodDetails?.accountInfo) { methodDisplay += `<small class="text-muted d-block" title="${sanitizeHTML(w.methodDetails.accountInfo)}">${sanitizeHTML(String(w.methodDetails.accountInfo)).substring(0, 40)}${String(w.methodDetails.accountInfo).length > 40 ? '...' : ''}</small>`; } const requestTime = formatDate(w.requestTimestamp); const processedTime = formatDate(w.processedAt); let rowHtml = `<tr><td>${requestTime}</td>`; if (status !== 'pending') rowHtml += `<td>${processedTime}</td>`; rowHtml += `<td>${userDisplay}</td><td>${formatCurrency(w.amount)}</td><td>${methodDisplay}</td>`; if (status === 'pending') { rowHtml += `<td class="action-buttons"><button class="btn btn-sm btn-success btn-approve-withdrawal" data-id="${sanitizeHTML(w.id)}" data-userid="${sanitizeHTML(w.userId)}" title="Approve"><i class="bi bi-check-circle"></i></button> <button class="btn btn-sm btn-danger btn-reject-withdrawal" data-id="${sanitizeHTML(w.id)}" data-userid="${sanitizeHTML(w.userId)}" title="Reject"><i class="bi bi-x-circle"></i></button></td>`; } else if (status === 'completed') { const note = sanitizeHTML(w.adminNote || ''); rowHtml += `<td><small title="${note}">${note.substring(0, 30)}${ note.length > 30 ? '...' : ''}</small></td>`; } else if (status === 'rejected') { const reason = sanitizeHTML(w.rejectReason || ''); rowHtml += `<td><small title="${reason}">${reason.substring(0, 30)}${ reason.length > 30 ? '...' : ''}</small></td>`; } rowHtml += `</tr>`; tableHtml += rowHtml; } else { console.warn(`Skipping invalid ${status} withdrawal:`, w.id, w); } }); } const emptyColspan = status === 'pending' ? 5 : 6; targetTableBody.innerHTML = tableHtml || `<tr><td colspan="${emptyColspan}" class="text-center p-3 text-muted">No ${status} withdrawals found.</td></tr>`; if (status === 'pending') { if (elements.pendingWithdrawalCountBadge) { elements.pendingWithdrawalCountBadge.textContent = count; elements.pendingWithdrawalCountBadge.style.display = count > 0 ? 'inline-block' : 'none'; } if (elements.dashboardSection?.classList.contains('active') && elements.statPendingWithdrawals) elements.statPendingWithdrawals.textContent = count; } else if (status === 'completed' && elements.dashboardSection?.classList.contains('active') && elements.statCompletedWithdrawals) { elements.statCompletedWithdrawals.textContent = count; } else if (status === 'rejected' && elements.dashboardSection?.classList.contains('active') && elements.statRejectedWithdrawals) { elements.statRejectedWithdrawals.textContent = count; } console.log(`${status} withdrawals table updated. Count:`, count); }, (error) => { console.error(`Error listening to ${status} withdrawals:`, error); const errorColspan = status === 'pending' ? 5 : 6; targetTableBody.innerHTML = `<tr><td colspan="${errorColspan}" class="text-center p-3 text-danger">Error loading: ${error.message}. Check Rules/Index.</td></tr>`; showStatus(elements.withdrawalsStatus, `Error loading ${status} withdrawals: ${error.message}. Check Rules/Index.`, 'danger', false); if (status === 'pending') { if (error?.message?.includes("index")) showStatus(elements.withdrawalsStatus, "CRITICAL: Pending query fail. Add '.indexOn': 'status' to '/withdrawals' rules.", "danger", false); if(elements.pendingWithdrawalCountBadge){ elements.pendingWithdrawalCountBadge.textContent = 'Err'; elements.pendingWithdrawalCountBadge.style.display = 'inline-block';} if (elements.dashboardSection?.classList.contains('active')) elements.statPendingWithdrawals.textContent = 'Error'; } else if (status === 'completed' && elements.dashboardSection?.classList.contains('active')) elements.statCompletedWithdrawals.textContent = 'Error'; else if (status === 'rejected' && elements.dashboardSection?.classList.contains('active')) elements.statRejectedWithdrawals.textContent = 'Error'; try { if (dbListeners[listenerKey]) { off(q, 'value', dbListeners[listenerKey]); delete dbListeners[listenerKey]; console.log(`Detached failed ${status} listener.`); } } catch(e) { console.warn(`Could not detach failed ${status} listener.`, e); } }); console.log(`Attached new listener for ${status} withdrawals.`); }
        async function loadSettings() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; console.log("Loading settings..."); elements.appSettingsForm?.querySelectorAll('input, textarea, button').forEach(el => el.disabled = true); clearStatus(elements.settingsStatus); try { const snapshot = await get(ref(db, 'settings')); if (snapshot.exists()) { appSettings = snapshot.val() || {}; elements.settingLogoUrlInput.value = appSettings.logoUrl || ''; elements.settingAppNameInput.value = appSettings.appName || ''; elements.settingMinWithdrawInput.value = appSettings.minWithdraw || 0; elements.settingReferralBonusInput.value = appSettings.referralBonus || 0; elements.settingSupportContactInput.value = appSettings.supportContact || ''; elements.settingUpiDetailsInput.value = appSettings.upiDetails || ''; elements.settingPolicyPrivacyInput.value = appSettings.policyPrivacy || ''; elements.settingPolicyTermsInput.value = appSettings.policyTerms || ''; elements.settingPolicyRefundInput.value = appSettings.policyRefund || ''; elements.settingPolicyFairPlayInput.value = appSettings.policyFairPlay || ''; if(elements.adminHeaderLogo) { const logoUrl = appSettings.logoUrl; elements.adminHeaderLogo.src = logoUrl || 'https://via.placeholder.com/35/1E293B/94A3B8?text=L'; elements.adminHeaderLogo.style.display = logoUrl ? 'inline-block' : 'none'; elements.adminHeaderLogo.alt = appSettings.appName ? `${appSettings.appName} Logo` : 'Logo'; } document.title = `${appSettings.appName || 'Gaming Tournament'} - Admin Panel`; console.log("Settings loaded and applied."); } else { console.log("No settings found."); showStatus(elements.settingsStatus, "No settings found. Please configure.", "info", false); elements.appSettingsForm.reset(); appSettings = {}; if(elements.adminHeaderLogo) elements.adminHeaderLogo.style.display = 'none'; document.title = 'Admin Panel'; } } catch (error) { console.error("Error loading settings:", error); showStatus(elements.settingsStatus, `Error loading settings: ${error.message}. Check Rules.`, "danger", false); appSettings = {}; if(elements.adminHeaderLogo) elements.adminHeaderLogo.style.display = 'none'; document.title = 'Admin Panel'; } finally { elements.appSettingsForm?.querySelectorAll('input, textarea, button').forEach(el => el.disabled = false); } }
        
        const IMGBB_API_KEY = '1579b196953465c653d3639ab091448c';
        async function uploadToImgBB(file, statusElement) { if (!file) throw new Error("File not selected."); if (!IMGBB_API_KEY || IMGBB_API_KEY === 'YOUR_IMGBB_API_KEY') { console.error("ImgBB API Key missing or is a placeholder!"); throw new Error("ImgBB API Key not set."); } const formData = new FormData(); formData.append('image', file); if (statusElement) { statusElement.textContent = 'Uploading...'; statusElement.style.color = 'var(--text-secondary)'; statusElement.style.display = 'block'; } try { const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData }); if (!response.ok) { let errorMsg = `ImgBB upload failed: HTTP ${response.status}`; try { const errorData = await response.json(); errorMsg += ` - ${errorData?.error?.message || response.statusText}`; } catch (e) {} throw new Error(errorMsg); } const data = await response.json(); if (data.success) { console.log('ImgBB upload successful. URL:', data.data.url); if (statusElement) statusElement.textContent = 'Upload complete!'; return data.data.url; } else { console.error('ImgBB upload failed:', data); throw new Error(`ImgBB upload failed: ${data.error?.message || 'Unknown error'}`); } } catch (error) { console.error('ImgBB Fetch error:', error); if (statusElement) { statusElement.textContent = `Upload Error: ${error.message}`; statusElement.style.color = 'var(--danger-color)'; } throw error; } }
        async function saveGame() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; const gameId = elements.gameEditId.value; const isEditing = !!gameId; const name = elements.gameNameInput.value.trim(); const imageUrlInput = elements.gameImageUrlInput.value.trim(); const imageFile = elements.gameImageFileInput.files[0]; const statusEl = elements.gameStatus; const imgbbStatusEl = elements.gameForm?.querySelector('.imgbb-upload-status'); clearStatus(statusEl); if (imgbbStatusEl) { imgbbStatusEl.textContent = ''; imgbbStatusEl.style.display = 'none'; } if (!name) { showStatus(statusEl, "Game Name is required.", "warning"); return; } if (!imageUrlInput && !imageFile && !isEditing) { showStatus(statusEl, "Image URL or File Upload required for new game.", "warning"); return; } if (!imageUrlInput && !imageFile && isEditing) { showStatus(statusEl, "Image URL cannot be empty when editing.", "warning"); return; } showLoader(true); elements.saveGameBtn.disabled = true; let finalImageUrl = imageUrlInput; try { if (imageFile) { finalImageUrl = await uploadToImgBB(imageFile, imgbbStatusEl); } if (!finalImageUrl) { throw new Error("Image URL is missing after potential upload."); } const gameData = { name: name, imageUrl: finalImageUrl }; if (isEditing) { gameData.updatedAt = serverTimestamp(); const gameRef = ref(db, `games/${gameId}`); await update(gameRef, gameData); console.log("Game updated successfully:", gameId); showStatus(elements.gamesStatus, "Game updated successfully!", "success", 3000); } else { gameData.createdAt = serverTimestamp(); const newGameRef = push(ref(db, 'games')); await set(newGameRef, gameData); console.log("Game added successfully, key:", newGameRef.key); showStatus(elements.gamesStatus, "Game added successfully!", "success", 3000); } elements.gameForm.reset(); elements.gameEditId.value = ''; if (imgbbStatusEl) { imgbbStatusEl.textContent = ''; imgbbStatusEl.style.display = 'none'; } getModalInstance(elements.gameModalEl)?.hide(); loadGames(); } catch (error) { console.error("Error saving game:", error); showStatus(statusEl, `Error saving game: ${error.message}. Check console & Rules.`, "danger", false); if (imgbbStatusEl && !imgbbStatusEl.textContent.includes('Error')) { imgbbStatusEl.style.display = 'none'; } } finally { showLoader(false); elements.saveGameBtn.disabled = false; } }
        async function savePromotion() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; const promoId = elements.promotionEditId.value; const isEditing = !!promoId; const promoLink = elements.promoLinkInput.value.trim(); const imageUrlInput = elements.promoImageUrlInput.value.trim(); const imageFile = elements.promoImageFileInput.files[0]; const statusEl = elements.promotionStatus; const imgbbStatusEl = elements.promotionForm?.querySelector('.imgbb-upload-status'); clearStatus(statusEl); if (imgbbStatusEl) { imgbbStatusEl.textContent = ''; imgbbStatusEl.style.display = 'none'; } if (!imageUrlInput && !imageFile && !isEditing) { showStatus(statusEl, "Image URL or File Upload required for new promotion.", "warning"); return; } if (!imageUrlInput && !imageFile && isEditing) { showStatus(statusEl, "Image URL cannot be empty when editing.", "warning"); return; } showLoader(true); elements.savePromotionBtn.disabled = true; let finalImageUrl = imageUrlInput; try { if (imageFile) { finalImageUrl = await uploadToImgBB(imageFile, imgbbStatusEl); } if (!finalImageUrl) { throw new Error("Image URL is missing after potential upload."); } const promoData = { imageUrl: finalImageUrl, link: promoLink || null }; if (isEditing) { promoData.updatedAt = serverTimestamp(); const promoRef = ref(db, `promotions/${promoId}`); await update(promoRef, promoData); console.log("Promotion updated successfully:", promoId); showStatus(elements.promotionsStatus, "Promotion updated successfully!", "success", 3000); } else { promoData.createdAt = serverTimestamp(); const newPromoRef = push(ref(db, 'promotions')); await set(newPromoRef, promoData); console.log("Promotion added successfully, key:", newPromoRef.key); showStatus(elements.promotionsStatus, "Promotion added successfully!", "success", 3000); } elements.promotionForm.reset(); elements.promotionEditId.value = ''; if (imgbbStatusEl) { imgbbStatusEl.textContent = ''; imgbbStatusEl.style.display = 'none'; } getModalInstance(elements.promotionModalEl)?.hide(); loadPromotions(); } catch (error) { console.error("Error saving promotion:", error); showStatus(statusEl, `Error saving promotion: ${error.message}. Check console & Rules.`, "danger", false); if (imgbbStatusEl && !imgbbStatusEl.textContent.includes('Error')) { imgbbStatusEl.style.display = 'none'; } } finally { showLoader(false); elements.savePromotionBtn.disabled = false; } }
        
        async function saveTournament(event) {
            event.preventDefault();
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            const statusEl = elements.addTournamentStatus;
            clearStatus(statusEl);
            
            const gameId = elements.tournamentGameSelect.value;
            const name = elements.tournamentNameInput.value.trim();
            const startTimeStr = elements.tournamentStartTimeInput.value;
            
            if (!gameId || !name || !startTimeStr) {
                showStatus(statusEl, "Game, Name, and Start Time are required.", "warning");
                return;
            }
        
            let startTimeTimestamp;
            try {
                startTimeTimestamp = new Date(startTimeStr).getTime();
                if (isNaN(startTimeTimestamp)) throw new Error('Invalid Date');
            } catch (e) {
                showStatus(statusEl, "Invalid Start Date & Time format.", "warning");
                return;
            }
        
            const entryFee = parseFloat(elements.tournamentEntryFeeInput.value) || 0;
            const prizePool = parseFloat(elements.tournamentPrizePoolInput.value) || 0;
            const perKillPrize = parseFloat(elements.tournamentPerKillInput.value) || 0;
            const maxPlayers = parseInt(elements.tournamentMaxPlayersInput.value) || 0;
        
            const tournamentData = {
                gameId: gameId,
                name: name,
                startTime: startTimeTimestamp,
                status: elements.tournamentStatusSelect.value,
                entryFee: entryFee,
                prizePool: prizePool,
                perKillPrize: perKillPrize,
                maxPlayers: maxPlayers,
                tags: elements.tournamentTagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag),
                mode: elements.tournamentModeInput.value.trim(),
                map: elements.tournamentMapInput.value.trim(),
                description: elements.tournamentDescriptionInput.value.trim(),
                roomId: elements.tournamentRoomIdInput.value.trim() || null,
                roomPassword: elements.tournamentRoomPasswordInput.value.trim() || null,
                showIdPass: elements.tournamentShowIdPassCheckbox.checked,
                updatedAt: serverTimestamp()
            };
        
            showLoader(true);
            elements.saveTournamentBtn.disabled = true;
        
            try {
                if (currentEditingTournamentId) {
                    const tRef = ref(db, `tournaments/${currentEditingTournamentId}`);
                    await update(tRef, tournamentData);
                    console.log("Tournament updated:", currentEditingTournamentId);
                    showStatus(elements.tournamentsStatus, "Tournament updated successfully!", "success", 3000);
                } else {
                    tournamentData.createdAt = serverTimestamp();
                    const newRef = push(ref(db, 'tournaments'));
                    await set(newRef, tournamentData);
                    console.log("Tournament added:", newRef.key);
                    showStatus(elements.tournamentsStatus, "Tournament added successfully!", "success", 3000);
                }
                elements.tournamentForm.reset();
                currentEditingTournamentId = null;
                getModalInstance(elements.addTournamentModalEl)?.hide();
                loadTournaments();
                loadDashboardStats();
            } catch (error) {
                console.error("Error saving tournament:", error);
                showStatus(statusEl, `Error: ${error.message}. Check Rules.`, "danger", false);
            } finally {
                showLoader(false);
                elements.saveTournamentBtn.disabled = false;
            }
        }

        async function deleteGame(gameId) { if (!db || !gameId || !isDesignatedAdmin(currentAdminUser)) return; if (!confirm(`DELETE Game ID: ${gameId}? Removes DB entry. Image on ImgBB NOT deleted. OK?`)) return; showLoader(true); const statusEl = elements.gamesStatus; clearStatus(statusEl); try { await remove(ref(db, `games/${gameId}`)); console.log("Game deleted from DB:", gameId); delete gameDataCache[gameId]; showStatus(statusEl, "Game data deleted.", "success", 3000); loadGames(); loadDashboardStats(); } catch (error) { console.error("Error deleting game:", error); showStatus(statusEl, `Error deleting game: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); } }
        async function deletePromotion(promoId) { if (!db || !promoId || !isDesignatedAdmin(currentAdminUser)) return; if (!confirm(`DELETE Promotion ID: ${promoId}? Removes DB entry. Image on ImgBB NOT deleted. OK?`)) return; showLoader(true); const statusEl = elements.promotionsStatus; clearStatus(statusEl); try { await remove(ref(db, `promotions/${promoId}`)); console.log("Promotion deleted from DB:", promoId); showStatus(statusEl, "Promotion data deleted.", "success", 3000); loadPromotions(); loadDashboardStats(); } catch (error) { console.error("Error deleting promotion:", error); showStatus(statusEl, `Error deleting promotion: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); } }
        async function deleteTournament(tournamentId) { if (!db || !tournamentId || !isDesignatedAdmin(currentAdminUser)) return; if (!confirm(`DELETE Tournament ID: ${tournamentId}? Cannot be undone.`)) return; showLoader(true); const statusEl = elements.tournamentsStatus; clearStatus(statusEl); try { await remove(ref(db, `tournaments/${tournamentId}`)); console.log("Tournament deleted:", tournamentId); showStatus(statusEl, "Tournament deleted.", "success", 3000); loadTournaments(); loadDashboardStats(); } catch (error) { console.error("Error deleting tournament:", error); showStatus(statusEl, `Error: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); } }
        async function saveNewUser() { if (!auth || !db || !isDesignatedAdmin(currentAdminUser)) return; const statusEl = elements.addUserStatus; clearStatus(statusEl); const name = elements.newUserNameInput.value.trim(); const email = elements.newUserEmailInput.value.trim(); const password = elements.newUserPasswordInput.value; const initialBalanceStr = elements.newUserInitialBalanceInput.value; if (!name || !email || !password) { showStatus(statusEl, "Name, Email, Password required.", "warning"); return; } if (password.length < 6) { showStatus(statusEl, "Password min 6 chars.", "warning"); return; } const initialBalance = parseFloat(initialBalanceStr) || 0; if (initialBalance < 0) { showStatus(statusEl, "Initial Balance cannot be negative.", "warning"); return; } if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showStatus(statusEl, "Invalid Email format.", "warning"); return; } showLoader(true); elements.saveNewUserBtn.disabled = true; try { const referralCode = Math.random().toString(36).substring(2, 10).toUpperCase(); const cred = await createUserWithEmailAndPassword(auth, email, password); const uid = cred.user.uid; console.log("User created in Auth:", uid, email); const userData = { uid: uid, email: email, displayName: name, balance: initialBalance, winningCash: 0, bonusCash: 0, status: 'active', createdAt: serverTimestamp(), referralCode: referralCode, isAdmin: false, referralEarnings: 0, totalEarnings: 0, totalMatches: 0, wonMatches: 0 }; await set(ref(db, `users/${uid}`), userData); console.log("User data created in DB:", uid); showStatus(statusEl, `User ${name} created!`, "success", 4000); elements.addUserForm.reset(); getModalInstance(elements.addUserModalEl)?.hide(); loadDashboardStats(); } catch (error) { console.error("Error creating user:", error); let msg = `Error: ${error.message}`; if (error.code === 'auth/email-already-in-use') msg = "Email already registered."; else if (error.code === 'auth/weak-password') msg = "Password too weak."; else if (error.code === 'auth/invalid-email') msg = "Invalid email format."; else if (error.code === 'permission-denied') msg = "Permission denied creating user/DB entry. Check Rules."; showStatus(statusEl, msg, "danger", false); } finally { showLoader(false); elements.saveNewUserBtn.disabled = false; } }
        async function updateUserBalance(event) { event.preventDefault(); if (!db || !isDesignatedAdmin(currentAdminUser)) return; const statusEl = elements.balanceUpdateStatus; clearStatus(statusEl); const userId = elements.editUserUid.value; const amountStr = elements.balanceUpdateAmountInput.value; const type = elements.balanceUpdateTypeSelect.value; const reason = elements.balanceUpdateReasonInput.value.trim(); if (!userId || !amountStr || !type || !reason) { showStatus(statusEl, "All fields required.", "warning"); return; } const amount = parseFloat(amountStr); if (isNaN(amount) || amount === 0) { showStatus(statusEl, "Invalid or zero amount.", "warning"); return; } showLoader(true); const userRefPath = `users/${userId}`; const updates = {}; try { const userSnapshot = await get(ref(db, userRefPath)); if (!userSnapshot.exists()) throw new Error(`User ${userId} not found.`); const user = userSnapshot.val(); const currentBalance = Number(user.balance || 0); const currentWinning = Number(user.winningCash || 0); const currentBonus = Number(user.bonusCash || 0); let newBalance = currentBalance; let newWinning = currentWinning; let newBonus = currentBonus; let logType = ''; switch (type) { case 'balance': newBalance += amount; updates[`${userRefPath}/balance`] = newBalance; logType = amount > 0 ? 'admin_deposit' : 'admin_deduction'; break; case 'winningCash': newWinning += amount; newBalance += amount; if (newWinning < 0) throw new Error("Winning cash cannot be negative."); updates[`${userRefPath}/winningCash`] = newWinning; updates[`${userRefPath}/balance`] = newBalance; logType = amount > 0 ? 'admin_winning_add' : 'admin_winning_deduct'; break; case 'bonusCash': newBonus += amount; newBalance += amount; if (newBonus < 0) throw new Error("Bonus cash cannot be negative."); updates[`${userRefPath}/bonusCash`] = newBonus; updates[`${userRefPath}/balance`] = newBalance; logType = amount > 0 ? 'admin_bonus_add' : 'admin_bonus_deduct'; break; default: throw new Error("Invalid balance type."); } if (newBalance < 0 && !confirm(`Warning: Negative total balance (${formatCurrency(newBalance)}). Proceed?`)) { showLoader(false); showStatus(statusEl, "Update cancelled.", "info"); return; } const txKey = push(ref(db, `transactions/${userId}`)).key; const txData = { type: logType, amount: amount, timestamp: serverTimestamp(), description: `Admin Update: ${reason}`, status: 'completed', balanceAfter: newBalance, adminUid: currentAdminUser.uid }; updates[`transactions/${userId}/${txKey}`] = txData; await update(ref(db), updates); console.log(`Balance updated for ${userId}. New Bal: ${newBalance}, Win: ${newWinning}, Bonus: ${newBonus}`); elements.userDetailWinning.textContent = newWinning.toFixed(2); elements.userDetailBonus.textContent = newBonus.toFixed(2); const updatedTotalBalance = newWinning + newBonus; elements.userDetailBalance.textContent = updatedTotalBalance.toFixed(2); if (fullUserDataCache[userId]) { fullUserDataCache[userId].balance = newBalance; fullUserDataCache[userId].winningCash = newWinning; fullUserDataCache[userId].bonusCash = newBonus; } if (userDataCache[userId]) { userDataCache[userId].balance = newBalance; userDataCache[userId].winningCash = newWinning; } showStatus(statusEl, "Balance updated!", "success", 3000); elements.updateBalanceForm.reset(); } catch (error) { console.error("Error updating balance:", error); showStatus(statusEl, `Error: ${error.message}`, "danger", false); } finally { showLoader(false); } }
        async function toggleUserBlock(event) { const button = event.target.closest('button'); if (!button || !db || !isDesignatedAdmin(currentAdminUser)) return; const userId = button.dataset.id; const currentAction = button.dataset.action; if (!userId || !currentAction) return; const newStatus = currentAction === 'block' ? 'blocked' : 'active'; if (!confirm(`Confirm ${currentAction} user ${userId}?`)) return; showLoader(true); button.disabled = true; const modalVisible = getModalInstance(elements.userModalEl)?._isShown; const statusEl = modalVisible && elements.editUserUid.value === userId ? elements.balanceUpdateStatus : elements.usersStatus; clearStatus(statusEl); try { await set(ref(db, `users/${userId}/status`), newStatus); console.log(`User ${userId} status set to ${newStatus}`); if (fullUserDataCache[userId]) fullUserDataCache[userId].status = newStatus; if (userDataCache[userId]) userDataCache[userId].status = newStatus; showStatus(statusEl, `User ${newStatus} successfully!`, "success", 3000); if (modalVisible && elements.editUserUid.value === userId) { elements.userDetailStatus.textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1); elements.userDetailStatus.className = `fw-bold text-${newStatus === 'active' ? 'success' : 'danger'}`; button.textContent = newStatus === 'active' ? 'Block User' : 'Unblock User'; button.className = `btn btn-sm ${newStatus === 'active' ? 'btn-danger' : 'btn-success'}`; button.dataset.action = newStatus === 'active' ? 'block' : 'unblock'; } filterUsers(); } catch (error) { console.error(`Error ${currentAction}ing user:`, error); showStatus(statusEl, `Error ${currentAction}ing user: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); button.disabled = false; } }
        async function deleteUser(userId) { if (!db || !userId || !isDesignatedAdmin(currentAdminUser)) return; const userName = fullUserDataCache[userId]?.displayName || fullUserDataCache[userId]?.email || userId; if (!confirm(`DELETE USER: ${userName} (UID: ${userId})?\n\nWARNING:\n- Removes user data from Realtime Database ONLY.\n- DOES NOT delete from Firebase Auth.\n- Associated data (transactions, etc.) may be orphaned.\n\nCannot be undone. Proceed?`)) return; showLoader(true); const statusEl = elements.usersStatus; clearStatus(statusEl); const modal = getModalInstance(elements.userModalEl); if (modal?._isShown) modal.hide(); try { await remove(ref(db, `users/${userId}`)); console.log("User deleted from DB:", userId); delete fullUserDataCache[userId]; delete userDataCache[userId]; showStatus(statusEl, `User ${userName} deleted from Database.`, "success", 5000); filterUsers(); loadDashboardStats(); } catch (error) { console.error("Error deleting user from DB:", error); showStatus(statusEl, `Error deleting user data: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); } }
        async function openWithdrawalActionModal(withdrawalId, type) { if (!db || !withdrawalId || !type || !isDesignatedAdmin(currentAdminUser)) return; console.log(`Opening withdrawal modal: ${withdrawalId}, Action: ${type}`); showLoader(true); currentWithdrawalAction = { id: withdrawalId, type: type, userId: null }; elements.withdrawalRejectReasonInput.value = ''; elements.withdrawalApproveNoteInput.value = ''; elements.withdrawalRejectReasonDiv.style.display = 'none'; elements.withdrawalApproveNoteDiv.style.display = 'none'; elements.withdrawalRejectReasonInput.required = false; elements.withdrawalApproveNoteInput.required = false; clearStatus(elements.withdrawalActionStatus); elements.approveWithdrawalBtn.style.display = 'inline-block'; elements.rejectWithdrawalBtn.style.display = 'inline-block'; elements.approveWithdrawalBtn.disabled = false; elements.rejectWithdrawalBtn.disabled = false; const withdrawalRef = ref(db, `withdrawals/${withdrawalId}`); try { const snapshot = await get(withdrawalRef); if (!snapshot.exists()) throw new Error(`Withdrawal ${withdrawalId} not found.`); const w = snapshot.val(); currentWithdrawalAction.userId = w.userId; if (w.status !== 'pending') { alert(`Request already processed (Status: ${w.status}).`); showLoader(false); return; } let userDisplay = `UID: ${w.userId}`; const userId = w.userId; if (userId && userDataCache[userId]) { const u = userDataCache[userId]; userDisplay = `${sanitizeHTML(u.displayName)} (<small class="text-muted" title="${userId}">${sanitizeHTML(u.email)}</small>)`; } else if (userId) { try { const userSnap = await get(ref(db, `users/${userId}`)); if (userSnap.exists()) { const u = userSnap.val(); userDataCache[userId] = { displayName: u.displayName || 'N/A', email: u.email || userId, status: u.status || 'unknown' }; userDisplay = `${sanitizeHTML(u.displayName)} (<small class="text-muted" title="${userId}">${sanitizeHTML(u.email)}</small>)`; } else { userDataCache[userId] = { displayName: 'Unknown User', email: userId, status: 'deleted' }; userDisplay = `Unknown User (<small class="text-muted" title="${userId}">${userId}</small>)`; } } catch (err) { console.warn(`Could not fetch user ${userId}`, err); userDataCache[userId] = { displayName: 'Error Fetching', email: userId, status: 'error' }; userDisplay = `Error Fetching (<small class="text-muted" title="${userId}">${userId}</small>)`; } } let methodDisplay = sanitizeHTML(w.methodDetails?.methodName || w.method || 'N/A'); if (w.methodDetails?.accountInfo) methodDisplay += ` - ${sanitizeHTML(w.methodDetails.accountInfo)}`; elements.withdrawalDetailId.textContent = withdrawalId; elements.withdrawalDetailUser.innerHTML = userDisplay; elements.withdrawalDetailUserUid.textContent = userId || 'N/A'; elements.withdrawalDetailAmount.textContent = (w.amount || 0).toFixed(2); elements.withdrawalDetailMethod.textContent = methodDisplay; if (type === 'reject') { elements.withdrawalRejectReasonDiv.style.display = 'block'; elements.withdrawalRejectReasonInput.required = true; elements.approveWithdrawalBtn.style.display = 'none'; } else { elements.withdrawalApproveNoteDiv.style.display = 'block'; elements.rejectWithdrawalBtn.style.display = 'none'; } getModalInstance(elements.withdrawalActionModalEl)?.show(); } catch (error) { console.error("Error opening withdrawal modal:", error); alert(`Error fetching details: ${error.message}`); showStatus(elements.withdrawalsStatus, `Error fetching details: ${error.message}`, 'danger', false); } finally { showLoader(false); } }
        async function processWithdrawalAction() { if (!db || !currentWithdrawalAction.id || !currentWithdrawalAction.type || !currentWithdrawalAction.userId || !isDesignatedAdmin(currentAdminUser)) { console.error("Withdrawal details missing or unauthorized."); showStatus(elements.withdrawalActionStatus, "Internal error/unauthorized.", "danger", false); return; } const statusEl = elements.withdrawalActionStatus; clearStatus(statusEl); const withdrawalId = currentWithdrawalAction.id; const actionType = currentWithdrawalAction.type; const userId = currentWithdrawalAction.userId; const updates = {}; const withdrawalRefPath = `withdrawals/${withdrawalId}`; let reason = ''; let adminNote = ''; let logType = ''; let logStatus = 'failed'; let refundRequired = false; showLoader(true); elements.approveWithdrawalBtn.disabled = true; elements.rejectWithdrawalBtn.disabled = true; try { const wSnapshot = await get(ref(db, withdrawalRefPath)); if (!wSnapshot.exists()) throw new Error("Withdrawal request not found."); const wData = wSnapshot.val(); const amount = Number(wData.amount || 0); if (wData.status !== 'pending') throw new Error(`Request already processed (Status: ${wData.status}).`); if (amount <= 0) throw new Error("Invalid amount."); if (actionType === 'reject') { reason = elements.withdrawalRejectReasonInput.value.trim(); if (!reason) { elements.rejectWithdrawalBtn.disabled = false; throw new Error("Rejection reason required."); } updates[`${withdrawalRefPath}/status`] = 'rejected'; updates[`${withdrawalRefPath}/rejectReason`] = reason; updates[`${withdrawalRefPath}/processedAt`] = serverTimestamp(); updates[`${withdrawalRefPath}/processedBy`] = currentAdminUser.uid; refundRequired = true; logType = 'withdrawal_rejected'; logStatus = 'completed'; } else { adminNote = elements.withdrawalApproveNoteInput.value.trim(); updates[`${withdrawalRefPath}/status`] = 'completed'; updates[`${withdrawalRefPath}/adminNote`] = adminNote || 'Approved'; updates[`${withdrawalRefPath}/processedAt`] = serverTimestamp(); updates[`${withdrawalRefPath}/processedBy`] = currentAdminUser.uid; refundRequired = false; logType = 'withdrawal_approved'; logStatus = 'completed'; } if (refundRequired) { const uSnapshot = await get(ref(db, `users/${userId}`)); if (!uSnapshot.exists()) throw new Error(`User ${userId} not found for refund.`); const user = uSnapshot.val(); const currentWinning = Number(user.winningCash || 0); const currentBalance = Number(user.balance || 0); const newWinning = currentWinning + amount; const newBalance = currentBalance + amount; updates[`users/${userId}/winningCash`] = newWinning; updates[`users/${userId}/balance`] = newBalance; const refundTxKey = push(ref(db, `transactions/${userId}`)).key; updates[`transactions/${userId}/${refundTxKey}`] = { type: 'withdrawal_refund', amount: amount, timestamp: serverTimestamp(), description: `Refund rejected withdrawal: ${withdrawalId}. Reason: ${reason}`, status: 'completed', balanceAfter: newBalance, adminUid: currentAdminUser.uid }; console.log(`Prepared refund for ${userId}. New Bal: ${newBalance}`); if (fullUserDataCache[userId]) { fullUserDataCache[userId].balance = newBalance; fullUserDataCache[userId].winningCash = newWinning; } if (userDataCache[userId]) { userDataCache[userId].balance = newBalance; userDataCache[userId].winningCash = newWinning; } } const mainTxKey = push(ref(db, `transactions/${userId}`)).key; updates[`transactions/${userId}/${mainTxKey}`] = { type: logType, amount: 0, timestamp: serverTimestamp(), description: `Withdrawal ${actionType} by admin. ID: ${withdrawalId}. ${actionType === 'reject' ? `Reason: ${reason}` : `Note: ${adminNote}`}`, status: logStatus, withdrawalId: withdrawalId, adminUid: currentAdminUser.uid }; await update(ref(db), updates); console.log(`Withdrawal ${withdrawalId} ${actionType} processed.`); showStatus(elements.withdrawalsStatus, `Withdrawal ${actionType} successfully!`, "success", 4000); getModalInstance(elements.withdrawalActionModalEl)?.hide(); loadDashboardStats(); } catch (error) { console.error("Error processing withdrawal:", error); showStatus(statusEl, `Error: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); if (getModalInstance(elements.withdrawalActionModalEl)?._isShown) { elements.approveWithdrawalBtn.disabled = false; elements.rejectWithdrawalBtn.disabled = false; } } }
        async function saveSettings(event) { event.preventDefault(); if (!db || !isDesignatedAdmin(currentAdminUser)) return; const statusEl = elements.settingsStatus; clearStatus(statusEl); const minW = parseFloat(elements.settingMinWithdrawInput.value) || 0; const refB = parseFloat(elements.settingReferralBonusInput.value) || 0; if (minW < 0 || refB < 0) { showStatus(statusEl, "Numeric values cannot be negative.", "warning"); return; } const settingsData = { logoUrl: elements.settingLogoUrlInput.value.trim(), appName: elements.settingAppNameInput.value.trim(), minWithdraw: minW, referralBonus: refB, supportContact: elements.settingSupportContactInput.value.trim(), upiDetails: elements.settingUpiDetailsInput.value.trim(), policyPrivacy: elements.settingPolicyPrivacyInput.value.trim(), policyTerms: elements.settingPolicyTermsInput.value.trim(), policyRefund: elements.settingPolicyRefundInput.value.trim(), policyFairPlay: elements.settingPolicyFairPlayInput.value.trim(), lastUpdated: serverTimestamp() }; showLoader(true); elements.appSettingsForm?.querySelectorAll('input, textarea, button').forEach(el => el.disabled = true); try { await set(ref(db, 'settings'), settingsData); appSettings = settingsData; console.log("Settings saved:", appSettings); showStatus(statusEl, "Settings saved!", "success", 3000); if(elements.adminHeaderLogo) { const logoUrl = appSettings.logoUrl; elements.adminHeaderLogo.src = logoUrl || 'https://via.placeholder.com/35/1E293B/94A3B8?text=L'; elements.adminHeaderLogo.style.display = logoUrl ? 'inline-block' : 'none'; elements.adminHeaderLogo.alt = appSettings.appName ? `${appSettings.appName} Logo` : 'Logo'; } document.title = `${appSettings.appName || 'Gaming Tournament'} - Admin Panel`; } catch (error) { console.error("Error saving settings:", error); showStatus(statusEl, `Error: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); elements.appSettingsForm?.querySelectorAll('input, textarea, button').forEach(el => el.disabled = false); } }
        async function loadThemeSettings() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; console.log("Loading theme settings..."); const statusEl = elements.themeStatus; clearStatus(statusEl); try { const settingsSnap = await get(ref(db, 'settings')); const currentTheme = settingsSnap.exists() ? settingsSnap.val().theme : null; if (currentTheme) { console.log("Found custom theme in DB:", currentTheme); populateThemePickers(currentTheme); } else { console.log("No custom theme in DB, loading default."); populateThemePickers(defaultTheme); showStatus(statusEl, "Currently using the default theme. Customize and save to change it.", "info", 10000); } } catch (error) { console.error("Error loading theme settings:", error); showStatus(statusEl, `Error loading theme: ${error.message}`, "danger", false); populateThemePickers(defaultTheme); } }
        function populateThemePickers(theme) { elements.themeColorPickers.forEach(picker => { const cssVar = picker.dataset.var; const colorValue = theme[cssVar] || '#000000'; picker.value = colorValue; const textInput = picker.parentElement.querySelector(`input[type="text"][data-target="${picker.id}"]`); if (textInput) { textInput.value = colorValue; } }); }
        async function saveTheme() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; const statusEl = elements.themeStatus; clearStatus(statusEl); const themeData = {}; elements.themeColorPickers.forEach(picker => { const cssVar = picker.dataset.var; if (cssVar && /^#[0-9A-F]{6}$/i.test(picker.value)) { themeData[cssVar] = picker.value; } else { console.warn(`Skipping invalid color for ${cssVar}: ${picker.value}`); } }); if(themeData['--accent-color']) { themeData['--accent-gradient'] = `linear-gradient(to right, ${themeData['--accent-color']}, #FBBF24)`; } if (Object.keys(themeData).length < elements.themeColorPickers.length) { showStatus(statusEl, "One or more colors are invalid. Please check the values.", "warning"); return; } showLoader(true); elements.saveThemeBtn.disabled = true; try { await update(ref(db, 'settings'), { theme: themeData }); console.log("Theme saved successfully:", themeData); showStatus(statusEl, "Theme saved successfully! Changes will appear for users in real-time.", "success", 5000); } catch (error) { console.error("Error saving theme:", error); showStatus(statusEl, `Error saving theme: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); elements.saveThemeBtn.disabled = false; } }
        async function resetTheme() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; if (!confirm("Are you sure you want to reset to the default theme? This will remove your custom theme settings.")) { return; } const statusEl = elements.themeStatus; clearStatus(statusEl); showLoader(true); elements.resetThemeBtn.disabled = true; try { await remove(ref(db, 'settings/theme')); console.log("Theme reset successfully."); showStatus(statusEl, "Theme has been reset to default.", "success", 5000); populateThemePickers(defaultTheme); } catch (error) { console.error("Error resetting theme:", error); showStatus(statusEl, `Error resetting theme: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); elements.resetThemeBtn.disabled = false; } }
        async function addDemoData() { if (!db || !isDesignatedAdmin(currentAdminUser) || !confirm("Add sample demo data? Only adds if sections are empty.")) return; showLoader(true); elements.addDemoDataBtn.disabled = true; const sectionEl = querySel('#adminMainContent .section.active'); const statusEl = sectionEl?.querySelector('div[id$="Status"]') || elements.dashboardStatus; clearStatus(statusEl); let added = []; const now = Date.now(); try { const gamesRef = ref(db, 'games'); const gamesSnap = await get(gamesRef); let demoGameId = null; if (!gamesSnap.exists() || gamesSnap.size === 0) { const newRef = push(gamesRef); demoGameId = newRef.key; await set(newRef, { name: "Demo Game (BGMI)", imageUrl: "https://i.ibb.co/4Z5hPVzp/20250418-150058.jpg", createdAt: serverTimestamp() }); added.push("Game"); gameDataCache[demoGameId] = "Demo Game (BGMI)"; } else { const games = gamesSnap.val(); demoGameId = Object.keys(games)[0]; gameDataCache = Object.entries(games).reduce((acc, [id, data]) => { acc[id] = data.name; return acc; }, {}); } const promoRef = ref(db, 'promotions'); const promoSnap = await get(promoRef); if (!promoSnap.exists() || promoSnap.size === 0) { await set(push(promoRef), { imageUrl: "https://i.ibb.co/RGmQ420n/20250418-150709.jpg", link: "#", createdAt: serverTimestamp() }); added.push("Promotion"); } if (demoGameId) { const tRef = ref(db, 'tournaments'); const tSnap = await get(tRef); if (!tSnap.exists() || tSnap.size === 0) { await set(push(tRef), { gameId: demoGameId, name: "Weekend Demo Clash", startTime: now + 86400000, status: "upcoming", entryFee: 10, prizePool: 100, perKillPrize: 2, maxPlayers: 50, tags: ["Demo", "Squad"], description: "Sample tournament details.", roomId: null, roomPassword: null, showIdPass: false, createdAt: serverTimestamp(), updatedAt: serverTimestamp() }); added.push("Tournament"); } } const usersRef = ref(db, 'users'); const usersSnap = await get(usersRef); let demoUserNeeded = true; if(usersSnap.exists()){ usersSnap.forEach(uSnap => { if(uSnap.key !== designatedAdminUid) demoUserNeeded = false; }); } if(demoUserNeeded && auth) { try { const demoEmail = `demo${Date.now().toString().slice(-5)}@example.com`, demoPass = "password", cred = await createUserWithEmailAndPassword(auth, demoEmail, demoPass), uid = cred.user.uid, code = Math.random().toString(36).substring(2, 10).toUpperCase(); await set(ref(db, `users/${uid}`), { uid: uid, email: demoEmail, displayName: "Demo User", balance: 50, winningCash: 10, bonusCash: 5, status: 'active', createdAt: serverTimestamp(), referralCode: code, isAdmin: false, referralEarnings: 0, totalEarnings: 0, totalMatches: 0, wonMatches: 0 }); added.push("User (Demo)"); console.log("Created demo user:", demoEmail); } catch (userErr) { console.error("Failed demo user creation:", userErr); } } const settingsRef = ref(db, 'settings'); const settingsSnap = await get(settingsRef); if (!settingsSnap.exists()) { const demoSettings = { appName: "Demo Gaming App", logoUrl: "https://i.ibb.co/BvH3m14/Chat-GPT-Image-Apr-18-2025-05-54-04-PM.png", minWithdraw: 50, referralBonus: 5, supportContact: "support@demo.com", upiDetails: "demo@upi", policyPrivacy: "Demo Privacy Policy.", policyTerms: "Demo Terms.", policyRefund: "Demo Refund Policy.", policyFairPlay: "Demo Fair Play Policy.", lastUpdated: serverTimestamp() }; await set(settingsRef, demoSettings); added.push("Settings"); appSettings = demoSettings; } if (added.length > 0) { showStatus(statusEl, `Demo data added for: ${added.join(', ')}. Refreshing...`, "success", 5000); if (added.includes("Game")) await loadGames(); if (added.includes("Promotion")) await loadPromotions(); if (added.includes("Tournament")) await loadTournaments(); if (added.includes("Settings")) await loadSettings(); if (added.includes("User (Demo)")) await loadUsers(); loadDashboardStats(); } else { showStatus(statusEl, "No demo data added (already exists?).", "info", 5000); } } catch (error) { console.error("Error adding demo data:", error); showStatus(statusEl, `Error adding demo data: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); elements.addDemoDataBtn.disabled = false; } }
        
        async function loadUpdates() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            const updatesRef = ref(db, 'updates');
            elements.updatesTableBody.innerHTML = tableLoadingPlaceholderHtml(3);
            clearStatus(elements.updatesStatus);
            try {
                const snapshot = await get(updatesRef);
                let tableHtml = '';
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const updateId = childSnapshot.key;
                        const update = childSnapshot.val();
                        if (update && update.imageUrl && update.title) {
                            tableHtml += `<tr>
                                <td><img src="${sanitizeHTML(update.imageUrl)}" alt="Update Image" class="preview-img"></td>
                                <td>${sanitizeHTML(update.title)}</td>
                                <td class="action-buttons">
                                    <button class="btn btn-sm btn-info btn-edit-update" data-id="${sanitizeHTML(updateId)}" title="Edit Update"><i class="bi bi-pencil-square"></i></button>
                                    <button class="btn btn-sm btn-danger btn-delete-update" data-id="${sanitizeHTML(updateId)}" title="Delete Update"><i class="bi bi-trash"></i></button>
                                </td>
                            </tr>`;
                        }
                    });
                }
                elements.updatesTableBody.innerHTML = tableHtml || `<tr><td colspan="3" class="text-center p-3 text-muted">No updates found.</td></tr>`;
            } catch (error) {
                console.error("Error loading updates:", error);
                elements.updatesTableBody.innerHTML = `<tr><td colspan="3" class="text-center p-3 text-danger">Error loading updates: ${error.message}.</td></tr>`;
                showStatus(elements.updatesStatus, `Error loading updates: ${error.message}.`, 'danger', false);
            }
        }

        async function saveUpdate() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            const updateId = elements.updateEditId.value;
            const isEditing = !!updateId;
            const title = elements.updateTitleInput.value.trim();
            const imageUrl = elements.updateImageUrlInput.value.trim();
            const statusEl = elements.updateStatus;
            clearStatus(statusEl);

            if (!title || !imageUrl) {
                showStatus(statusEl, "Title and Image URL are required.", "warning");
                return;
            }

            showLoader(true);
            elements.saveUpdateBtn.disabled = true;
            
            try {
                const updateData = { title, imageUrl };
                if (isEditing) {
                    updateData.updatedAt = serverTimestamp();
                    await update(ref(db, `updates/${updateId}`), updateData);
                    showStatus(elements.updatesStatus, "Update saved successfully!", "success");
                } else {
                    updateData.createdAt = serverTimestamp();
                    await push(ref(db, 'updates'), updateData);
                    showStatus(elements.updatesStatus, "Update posted successfully!", "success");
                }
                getModalInstance(elements.updateModalEl)?.hide();
                loadUpdates();
            } catch (error) {
                console.error("Error saving update:", error);
                showStatus(statusEl, `Error: ${error.message}.`, "danger", false);
            } finally {
                showLoader(false);
                elements.saveUpdateBtn.disabled = false;
            }
        }
        
        async function openEditUpdateModal(updateId) {
            if (!db || !updateId || !isDesignatedAdmin(currentAdminUser)) return;
            showLoader(true);
            elements.updateForm.reset();
            clearStatus(elements.updateStatus);
            try {
                const snapshot = await get(ref(db, `updates/${updateId}`));
                if (!snapshot.exists()) throw new Error(`Update ${updateId} not found.`);
                const update = snapshot.val();
                elements.updateModalTitle.textContent = "Edit Update";
                elements.updateEditId.value = updateId;
                elements.updateTitleInput.value = update.title || '';
                elements.updateImageUrlInput.value = update.imageUrl || '';
                getModalInstance(elements.updateModalEl)?.show();
            } catch (error) {
                console.error("Error opening edit update modal:", error);
                showStatus(elements.updatesStatus, `Error loading update for edit: ${error.message}`, "danger");
            } finally {
                showLoader(false);
            }
        }
        
        async function deleteUpdate(updateId) {
            if (!db || !updateId || !isDesignatedAdmin(currentAdminUser)) return;
            if (!confirm(`Are you sure you want to delete this update?`)) return;
            showLoader(true);
            try {
                await remove(ref(db, `updates/${updateId}`));
                showStatus(elements.updatesStatus, "Update deleted successfully.", "success");
                loadUpdates();
            } catch (error) {
                console.error("Error deleting update:", error);
                showStatus(elements.updatesStatus, `Error: ${error.message}`, "danger");
            } finally {
                showLoader(false);
            }
        }

        async function loadDeposits(status = 'pending') {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            const targetTableBody = getElement(`${status}DepositsTableBody`);
            if (!targetTableBody) { console.error(`Table body not found for deposits: ${status}`); return; }
            
            const q = query(ref(db, 'rechargeRequests'), orderByChild('status'), equalTo(status));
            targetTableBody.innerHTML = tableLoadingPlaceholderHtml(status === 'pending' ? 5 : 6);
            if (status === 'pending') clearStatus(elements.depositsStatus);

            const listenerKey = `deposits-${status}`;
            if (dbListeners[listenerKey]) try { off(q, 'value', dbListeners[listenerKey]); } catch (e) { console.warn(`Could not detach ${listenerKey}`, e); }

            dbListeners[listenerKey] = onValue(q, async (snapshot) => {
                console.log(`${status} deposit data received.`);
                let tableHtml = '';
                let count = 0;

                if (snapshot.exists()) {
                    count = snapshot.size;
                    const userIds = new Set();
                    snapshot.forEach(child => { if (child.val()?.userId && !userDataCache[child.val().userId]) userIds.add(child.val().userId); });
                    if (userIds.size > 0) await Promise.allSettled(Array.from(userIds).map(uid => get(ref(db, `users/${uid}`)).then(us => { if (us.exists()) { const u = us.val(); userDataCache[uid] = { displayName: u.displayName || 'N/A', email: u.email || uid }; } })));

                    const deposits = [];
                    snapshot.forEach(child => deposits.push({ id: child.key, ...child.val() }));
                    deposits.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                    deposits.forEach(d => {
                        const user = userDataCache[d.userId] || { displayName: 'Unknown', email: d.userId };
                        const userDisplay = `${sanitizeHTML(user.displayName)} (<small class="text-muted">${sanitizeHTML(user.email)}</small>)`;
                        const detailsHtml = `
                            <small class="d-block">Method: <strong>${sanitizeHTML(d.method)}</strong></small>
                            <small class="d-block" title="${sanitizeHTML(d.transactionId)}">Txn ID: ${sanitizeHTML(String(d.transactionId).substring(0, 15))}...</small>
                            <small class="d-block">Phone Number: ${sanitizeHTML(d.playerGameId)}</small>`;
                        
                        const requestTime = formatDate(d.timestamp);
                        const processedTime = formatDate(d.processedAt);

                        let rowHtml = `<tr><td>${requestTime}</td>`;
                        if (status !== 'pending') rowHtml += `<td>${processedTime}</td>`;
                        rowHtml += `<td>${userDisplay}</td><td>${formatCurrency(d.amount)}</td><td>${detailsHtml}</td>`;

                        if (status === 'pending') {
                            rowHtml += `<td class="action-buttons"><button class="btn btn-sm btn-success btn-approve-deposit" data-id="${d.id}"><i class="bi bi-check-circle"></i></button> <button class="btn btn-sm btn-danger btn-reject-deposit" data-id="${d.id}"><i class="bi bi-x-circle"></i></button></td>`;
                        } else if (status === 'approved') {
                            rowHtml += `<td><small>${sanitizeHTML(d.adminNote || 'N/A')}</small></td>`;
                        } else if (status === 'rejected') {
                            rowHtml += `<td><small>${sanitizeHTML(d.rejectReason || 'N/A')}</small></td>`;
                        }
                        rowHtml += `</tr>`;
                        tableHtml += rowHtml;
                    });
                }
                const emptyColspan = status === 'pending' ? 5 : 6;
                targetTableBody.innerHTML = tableHtml || `<tr><td colspan="${emptyColspan}" class="text-center p-3 text-muted">No ${status} deposits found.</td></tr>`;
                
                if (status === 'pending') {
                    elements.pendingDepositCountBadge.textContent = count;
                    elements.pendingDepositCountBadge.style.display = count > 0 ? 'inline-block' : 'none';
                }
            }, (error) => {
                console.error(`Error loading ${status} deposits:`, error);
                targetTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-3 text-danger">Error: ${error.message}. Check Rules/Index.</td></tr>`;
                if (error?.message?.includes("index")) showStatus(elements.depositsStatus, "CRITICAL: Deposit query fail. Add '.indexOn': 'status' to '/rechargeRequests' rules.", "danger", false);
            });
        }

        async function openDepositActionModal(requestId, type) {
            if (!db || !requestId || !type || !isDesignatedAdmin(currentAdminUser)) return;
            showLoader(true);
            currentDepositAction = { id: requestId, type: type, userId: null };
            
            elements.depositRejectReasonInput.value = '';
            elements.depositApproveNoteInput.value = '';
            elements.depositRejectReasonDiv.style.display = 'none';
            elements.depositApproveNoteDiv.style.display = 'none';
            elements.approveDepositBtn.style.display = 'inline-block';
            elements.rejectDepositBtn.style.display = 'inline-block';
            clearStatus(elements.depositActionStatus);

            try {
                const snapshot = await get(ref(db, `rechargeRequests/${requestId}`));
                if (!snapshot.exists()) throw new Error("Deposit request not found.");
                const d = snapshot.val();
                currentDepositAction.userId = d.userId;

                if (d.status !== 'pending') {
                    alert(`Request already processed (Status: ${d.status}).`);
                    return;
                }
                
                const user = userDataCache[d.userId] || { displayName: 'Loading...', email: d.userId };
                elements.depositDetailId.textContent = requestId;
                elements.depositDetailUser.textContent = `${user.displayName} (${user.email})`;
                elements.depositDetailAmount.textContent = formatCurrency(d.amount);
                elements.depositDetailMethod.textContent = d.method || 'N/A';
                elements.depositDetailGameId.textContent = d.playerGameId || 'N/A';
                elements.depositDetailTxnId.textContent = d.transactionId || 'N/A';

                if (type === 'reject') {
                    elements.depositRejectReasonDiv.style.display = 'block';
                    elements.approveDepositBtn.style.display = 'none';
                } else {
                    elements.depositApproveNoteDiv.style.display = 'block';
                    elements.rejectDepositBtn.style.display = 'none';
                }
                getModalInstance(elements.depositActionModalEl)?.show();
            } catch (error) {
                console.error("Error opening deposit modal:", error);
                showStatus(elements.depositsStatus, `Error: ${error.message}`, 'danger');
            } finally {
                showLoader(false);
            }
        }

        async function processDepositAction() {
            const { id, type, userId } = currentDepositAction;
            if (!id || !type || !userId || !isDesignatedAdmin(currentAdminUser)) return;

            const statusEl = elements.depositActionStatus;
            clearStatus(statusEl);
            showLoader(true);
            elements.approveDepositBtn.disabled = true;
            elements.rejectDepositBtn.disabled = true;
            
            const updates = {};
            const depositRefPath = `rechargeRequests/${id}`;

            try {
                const depositSnap = await get(ref(db, depositRefPath));
                if (!depositSnap.exists() || depositSnap.val().status !== 'pending') throw new Error("Request not found or already processed.");
                const depositData = depositSnap.val();
                const amount = Number(depositData.amount);

                if (type === 'approve') {
                    const userSnap = await get(ref(db, `users/${userId}`));
                    if (!userSnap.exists()) throw new Error("User to credit not found.");
                    
                    const newBalance = (userSnap.val().balance || 0) + amount;
                    updates[`users/${userId}/balance`] = newBalance;
                    
                    const txKey = push(ref(db, `transactions/${userId}`)).key;
                    updates[`transactions/${userId}/${txKey}`] = {
                        type: 'deposit_approved',
                        amount: amount,
                        description: `Deposit via ${depositData.method}`,
                        timestamp: serverTimestamp(),
                        balanceAfter: newBalance,
                        adminUid: currentAdminUser.uid
                    };
                    
                    updates[`${depositRefPath}/status`] = 'approved';
                    updates[`${depositRefPath}/processedAt`] = serverTimestamp();
                    updates[`${depositRefPath}/adminNote`] = elements.depositApproveNoteInput.value.trim() || 'Approved';
                    
                    await update(ref(db), updates);
                    await sendNotification(userId, "Deposit Approved", `Your deposit request for ${formatCurrency(amount)} has been approved.`);
                    showStatus(elements.depositsStatus, "Deposit approved and balance updated.", "success");

                } else { // Reject
                    const reason = elements.depositRejectReasonInput.value.trim();
                    if (!reason) throw new Error("Rejection reason is required.");
                    
                    updates[`${depositRefPath}/status`] = 'rejected';
                    updates[`${depositRefPath}/processedAt`] = serverTimestamp();
                    updates[`${depositRefPath}/rejectReason`] = reason;

                    await update(ref(db), updates);
                    await sendNotification(userId, "Deposit Rejected", `Your deposit request was rejected. Reason: ${reason}`);
                    showStatus(elements.depositsStatus, "Deposit request rejected.", "success");
                }

                getModalInstance(elements.depositActionModalEl)?.hide();
                loadDashboardStats();

            } catch (error) {
                console.error("Error processing deposit:", error);
                showStatus(statusEl, `Error: ${error.message}`, "danger", false);
            } finally {
                showLoader(false);
                elements.approveDepositBtn.disabled = false;
                elements.rejectDepositBtn.disabled = false;
            }
        }

        async function sendNotification(userId, title, message) {
            if (!userId || !title || !message) {
                throw new Error("User ID, title, and message are required to send a notification.");
            }
            const notification = {
                title: title,
                message: message,
                isRead: false,
                timestamp: serverTimestamp()
            };
            await push(ref(db, `notifications/${userId}`), notification);
            console.log(`Notification sent to ${userId}`);
        }

        async function sendBroadcastNotification(event) {
            event.preventDefault();
            const title = elements.broadcastNotificationTitle.value.trim();
            const message = elements.broadcastNotificationMessage.value.trim();
            if (!title || !message) {
                showStatus(elements.notificationStatus, "Title and Message are required.", "warning");
                return;
            }

            if (!confirm(`Are you sure you want to send this notification to ALL users? This action cannot be undone.`)) {
                return;
            }

            showLoader(true);
            try {
                const usersSnap = await get(ref(db, 'users'));
                if (!usersSnap.exists()) throw new Error("No users found to broadcast to.");
                
                const updates = {};
                const notification = { title, message, isRead: false, timestamp: serverTimestamp() };
                let userCount = 0;
                
                usersSnap.forEach(userSnapshot => {
                    const userId = userSnapshot.key;
                    const newNotifKey = push(ref(db, `notifications/${userId}`)).key;
                    updates[`notifications/${userId}/${newNotifKey}`] = notification;
                    userCount++;
                });

                await update(ref(db), updates);
                showStatus(elements.notificationStatus, `Broadcast sent successfully to ${userCount} users.`, "success");
                elements.sendBroadcastNotificationForm.reset();

            } catch (error) {
                console.error("Error sending broadcast:", error);
                showStatus(elements.notificationStatus, `Error: ${error.message}`, "danger");
            } finally {
                showLoader(false);
            }
        }

        function setupRealtimeAdminListeners() {
            if (!db || !currentAdminUser || !isDesignatedAdmin(currentAdminUser)) return;
            console.log("Setting up realtime count listeners...");
            detachAllAdminListeners();

            const pendingWithdrawalQuery = query(ref(db, 'withdrawals'), orderByChild('status'), equalTo('pending'));
            dbListeners['pendingWithdrawalsCount'] = onValue(pendingWithdrawalQuery, (snapshot) => {
                 const count = snapshot.exists() ? snapshot.size : 0;
                 if (elements.pendingWithdrawalCountBadge) { elements.pendingWithdrawalCountBadge.textContent = count; elements.pendingWithdrawalCountBadge.style.display = count > 0 ? 'inline-block' : 'none'; }
                 if (elements.statPendingWithdrawals && elements.dashboardSection.classList.contains('active')) elements.statPendingWithdrawals.textContent = count;
            }, error => console.error("Listener error (pending withdrawals):", error));
            
            const pendingDepositQuery = query(ref(db, 'rechargeRequests'), orderByChild('status'), equalTo('pending'));
            dbListeners['pendingDepositsCount'] = onValue(pendingDepositQuery, (snapshot) => {
                const count = snapshot.exists() ? snapshot.size : 0;
                console.log("Realtime pending deposit count:", count);
                if (elements.pendingDepositCountBadge) {
                    elements.pendingDepositCountBadge.textContent = count;
                    elements.pendingDepositCountBadge.style.display = count > 0 ? 'inline-block' : 'none';
                }
            }, error => {
                console.error("Listener error (pending deposits):", error);
                if (elements.pendingDepositCountBadge) { elements.pendingDepositCountBadge.textContent = 'Err'; elements.pendingDepositCountBadge.style.display = 'inline-block';}
                if (error?.message?.includes("index")) showStatus(elements.dashboardStatus, `Deposit count error. Add index '.indexOn': 'status' to '/rechargeRequests'.`, "danger", false);
            });
        }
        
        function detachAllAdminListeners() {
             if (!db || Object.keys(dbListeners).length === 0) return;
             Object.keys(dbListeners).forEach(key => {
                 try {
                      if (key === 'pendingWithdrawalsCount') off(query(ref(db, 'withdrawals'), orderByChild('status'), equalTo('pending')), 'value', dbListeners[key]);
                      else if (key === 'pendingDepositsCount') off(query(ref(db, 'rechargeRequests'), orderByChild('status'), equalTo('pending')), 'value', dbListeners[key]);
                      else if (key === 'users') off(ref(db, 'users'), 'value', dbListeners[key]);
                      else if (key.startsWith('withdrawals-')) off(query(ref(db, 'withdrawals'), orderByChild('status'), equalTo(key.split('-')[1])), 'value', dbListeners[key]);
                      else if (key.startsWith('deposits-')) off(query(ref(db, 'rechargeRequests'), orderByChild('status'), equalTo(key.split('-')[1])), 'value', dbListeners[key]);
                      else console.warn("Unknown listener key, cannot detach automatically:", key);
                 } catch (e) { console.warn(`Could not detach listener ${key}`, e); }
             });
             dbListeners = {};
             console.log("Finished detaching listeners.");
        }
        
        async function openEditGameModal(gameId) { if (!db || !gameId || !isDesignatedAdmin(currentAdminUser)) return; showLoader(true); elements.gameForm.reset(); clearStatus(elements.gameStatus); const imgbbStatusEl = elements.gameForm.querySelector('.imgbb-upload-status'); if (imgbbStatusEl) { imgbbStatusEl.textContent = ''; imgbbStatusEl.style.display = 'none'; } try { const snapshot = await get(ref(db, `games/${gameId}`)); if (!snapshot.exists()) throw new Error(`Game ${gameId} not found.`); const game = snapshot.val(); elements.gameModalTitle.textContent = "Edit Game"; elements.gameEditId.value = gameId; elements.gameNameInput.value = game.name || ''; elements.gameImageUrlInput.value = game.imageUrl || ''; elements.gameImageFileInput.value = ''; getModalInstance(elements.gameModalEl)?.show(); } catch (error) { console.error("Error opening edit game modal:", error); showStatus(elements.gamesStatus, `Error loading game for edit: ${error.message}`, "danger", false); } finally { showLoader(false); } }
        async function openEditPromotionModal(promoId) { if (!db || !promoId || !isDesignatedAdmin(currentAdminUser)) return; showLoader(true); elements.promotionForm.reset(); clearStatus(elements.promotionStatus); const imgbbStatusEl = elements.promotionForm.querySelector('.imgbb-upload-status'); if (imgbbStatusEl) { imgbbStatusEl.textContent = ''; imgbbStatusEl.style.display = 'none'; } try { const snapshot = await get(ref(db, `promotions/${promoId}`)); if (!snapshot.exists()) throw new Error(`Promotion ${promoId} not found.`); const promo = snapshot.val(); elements.promotionModalTitle.textContent = "Edit Promotion"; elements.promotionEditId.value = promoId; elements.promoImageUrlInput.value = promo.imageUrl || ''; elements.promoLinkInput.value = promo.link || ''; elements.promoImageFileInput.value = ''; getModalInstance(elements.promotionModalEl)?.show(); } catch (error) { console.error("Error opening edit promotion modal:", error); showStatus(elements.promotionsStatus, `Error loading promotion for edit: ${error.message}`, "danger", false); } finally { showLoader(false); } }
        async function populateGameSelect(selectedValue = null) { if (!elements.tournamentGameSelect) return; const select = elements.tournamentGameSelect; select.innerHTML = '<option value="">Loading...</option>'; select.disabled = true; try { if (Object.keys(gameDataCache).length === 0) await loadGames(); if (Object.keys(gameDataCache).length > 0) { select.innerHTML = '<option value="">-- Select Game --</option>'; const sorted = Object.entries(gameDataCache).sort(([, a], [, b]) => a.localeCompare(b)); sorted.forEach(([id, name]) => { const opt = document.createElement('option'); opt.value = id; opt.textContent = sanitizeHTML(name); select.appendChild(opt); }); if (selectedValue) select.value = selectedValue; } else { select.innerHTML = '<option value="">No Games Available</option>'; } } catch (error) { console.error("Error populating game select:", error); select.innerHTML = '<option value="">Error Loading</option>'; } finally { select.disabled = false; } }
        
        async function openEditTournamentModal(tournamentId) {
            if (!db || !tournamentId || !isDesignatedAdmin(currentAdminUser)) return;
            showLoader(true);
            clearStatus(elements.addTournamentStatus);
            elements.tournamentForm.reset();
            currentEditingTournamentId = tournamentId;
        
            try {
                const snapshot = await get(ref(db, `tournaments/${tournamentId}`));
                if (!snapshot.exists()) throw new Error(`Tournament ${tournamentId} not found.`);
                const t = snapshot.val();
        
                await populateGameSelect(t.gameId);
                elements.tournamentModalTitle.textContent = "Edit Tournament";
                elements.tournamentEditId.value = tournamentId;
                elements.tournamentNameInput.value = t.name || '';
                
                if (t.startTime) {
                    try {
                        const d = new Date(t.startTime);
                        if (!isNaN(d)) {
                            const offset = d.getTimezoneOffset() * 60000;
                            elements.tournamentStartTimeInput.value = new Date(d - offset).toISOString().slice(0, 16);
                        }
                    } catch (e) { console.warn("Err fmt date", e); }
                }
                
                elements.tournamentStatusSelect.value = t.status || 'upcoming';
                elements.tournamentEntryFeeInput.value = t.entryFee ?? 0;
                elements.tournamentPrizePoolInput.value = t.prizePool ?? 0;
                elements.tournamentPerKillInput.value = t.perKillPrize ?? 0;
                elements.tournamentMaxPlayersInput.value = t.maxPlayers ?? 0;
                elements.tournamentTagsInput.value = (t.tags || []).join(', ');
                elements.tournamentModeInput.value = t.mode || '';
                elements.tournamentMapInput.value = t.map || '';
                elements.tournamentDescriptionInput.value = t.description || '';
                
                elements.tournamentRoomIdInput.value = t.roomId || '';
                elements.tournamentRoomPasswordInput.value = t.roomPassword || '';
                elements.tournamentShowIdPassCheckbox.checked = t.showIdPass || false;
        
                getModalInstance(elements.addTournamentModalEl)?.show();
            } catch (error) {
                console.error("Error opening edit tournament modal:", error);
                showStatus(elements.tournamentsStatus, `Error loading tournament: ${error.message}`, "danger", false);
                currentEditingTournamentId = null;
            } finally {
                showLoader(false);
            }
        }
        
        // MODIFIED: This function now calculates and displays Total Balance correctly.
        async function openUserModal(userId) {
            if (!db || !userId || !isDesignatedAdmin(currentAdminUser)) return;
            showLoader(true);
            clearStatus(elements.balanceUpdateStatus);
            elements.updateBalanceForm.reset();
            elements.userDetailReferredBy.textContent = "N/A";
            elements.userDetailReferredCount.textContent = "N/A";
            try {
                let user;
                if (fullUserDataCache[userId] && fullUserDataCache[userId].status !== 'error' && fullUserDataCache[userId].status !== 'deleted') {
                    user = fullUserDataCache[userId];
                } else {
                    const snapshot = await get(ref(db, `users/${userId}`));
                    if (!snapshot.exists()) throw new Error(`User ${userId} not found.`);
                    user = snapshot.val();
                    user.uid = userId;
                    fullUserDataCache[userId] = user;
                }
                elements.userModalTitle.textContent = `User: ${sanitizeHTML(user.displayName || 'N/A')}`;
                elements.userDetailUid.textContent = userId;
                elements.userDetailEmail.textContent = sanitizeHTML(user.email || 'N/A');
                elements.userDetailName.textContent = sanitizeHTML(user.displayName || 'N/A');
                elements.userDetailCreatedAt.textContent = formatDate(user.createdAt);

                // MODIFICATION: Calculate total balance from components.
                // EXPLANATION: This ensures the modal always shows the correct sum of winning and bonus cash.
                const totalBalance = (Number(user.winningCash) || 0) + (Number(user.bonusCash) || 0);
                elements.userDetailBalance.textContent = formatCurrency(totalBalance).substring(1); // remove ₹ symbol for consistency with other fields

                elements.userDetailWinning.textContent = (Number(user.winningCash) || 0).toFixed(2);
                elements.userDetailBonus.textContent = (Number(user.bonusCash) || 0).toFixed(2);

                elements.editUserUid.value = userId;
                elements.userDetailReferralCode.textContent = user.referralCode || 'N/A';
                const status = user.status || 'active';
                elements.userDetailStatus.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                elements.userDetailStatus.className = `fw-bold text-${status === 'active' ? 'success' : 'danger'}`;
                elements.userBlockBtn.textContent = status === 'active' ? 'Block User' : 'Unblock User';
                elements.userBlockBtn.className = `btn btn-sm ${status === 'active' ? 'btn-danger' : 'btn-success'}`;
                elements.userBlockBtn.dataset.id = userId;
                elements.userBlockBtn.dataset.action = status === 'active' ? 'block' : 'unblock';
                elements.userDeleteBtn.dataset.id = userId;
                getModalInstance(elements.userModalEl)?.show();
            } catch (error) {
                console.error("Error opening user modal:", error);
                showStatus(elements.usersStatus, `Error loading user: ${error.message}`, "danger", false);
            } finally {
                showLoader(false);
            }
        }
        
        async function openRegisteredPlayersModal(tournamentId, tournamentName) {
            if (!db || !tournamentId || !isDesignatedAdmin(currentAdminUser)) return;
            elements.registeredPlayersModalTitle.textContent = "Registered Players";
            elements.registeredPlayersTournamentName.textContent = tournamentName || "N/A";
            elements.registeredPlayersTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-3"><div class="spinner-border spinner-border-sm"></div></td></tr>`;
            clearStatus(elements.registeredPlayersStatus);
            getModalInstance(elements.registeredPlayersModalEl)?.show();
            
            try {
                const playersRef = ref(db, `tournaments/${tournamentId}/registeredPlayers`);
                const snapshot = await get(playersRef);
                
                if (!snapshot.exists()) {
                    elements.registeredPlayersTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-3 text-muted">No players registered.</td></tr>`;
                    return;
                }
                
                const registeredData = snapshot.val();
                const userIds = Object.keys(registeredData);
                let tableHtml = '';
                
                const promises = userIds.map(async (uid) => {
                    let user = fullUserDataCache[uid];
                    if (!user) {
                        const uSnap = await get(ref(db, `users/${uid}`));
                        user = uSnap.exists() ? { uid, ...uSnap.val() } : { uid, displayName: 'User Not Found', email: 'N/A' };
                        fullUserDataCache[uid] = user;
                    }
                    return { user, playerData: registeredData[uid] };
                });
                
                const results = await Promise.all(promises);
                
                results.forEach(({ user, playerData }) => {
                    tableHtml += `<tr>
                        <td><small class="text-muted">${sanitizeHTML(user.uid)}</small></td>
                        <td>${sanitizeHTML(user.displayName)}</td>
                        <td>${sanitizeHTML(playerData.inGameName || 'N/A')}</td>
                        <td>${sanitizeHTML(playerData.inGameId || 'N/A')}</td>
                        <td>${formatDate(playerData.joinedAt)}</td>
                    </tr>`;
                });

                elements.registeredPlayersTableBody.innerHTML = tableHtml || `<tr><td colspan="5" class="text-center p-3 text-muted">Could not load player details.</td></tr>`;
                elements.registeredPlayersModalTitle.textContent = `Registered Players (${results.length})`;

            } catch (error) {
                console.error("Error loading registered players:", error);
                elements.registeredPlayersTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-3 text-danger">Error: ${error.message}.</td></tr>`;
                showStatus(elements.registeredPlayersStatus, `Error: ${error.message}`, 'danger');
            }
        }
        
        function initializeAdminEventListeners() {
            console.log("Initializing Admin Event Listeners...");
            if (!auth || !db) { console.error("Cannot init listeners: Firebase not ready."); return; }
            elements.adminSetupForm?.addEventListener('submit', setupAdmin);
            elements.adminLoginForm?.addEventListener('submit', loginAdmin);
            elements.adminLogoutBtn?.addEventListener('click', logoutAdminUser);
            elements.sidebarLinks?.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); const sectionId = link.dataset.section; if (sectionId && !link.classList.contains('active')) { showAdminSection(sectionId); } else { getOffcanvasInstance(elements.sidebar)?.hide(); } }); });
            elements.saveGameBtn?.addEventListener('click', saveGame);
            elements.savePromotionBtn?.addEventListener('click', savePromotion);
            elements.saveTournamentBtn?.addEventListener('click', saveTournament);
            elements.saveNewUserBtn?.addEventListener('click', saveNewUser);
            elements.appSettingsForm?.addEventListener('submit', saveSettings);
            elements.updateBalanceForm?.addEventListener('submit', updateUserBalance);
            elements.addNewGameBtn?.addEventListener('click', () => { elements.gameForm?.reset(); elements.gameEditId.value = ''; elements.gameModalTitle.textContent = "Add New Game"; clearStatus(elements.gameStatus); const imgbbEl = elements.gameForm?.querySelector('.imgbb-upload-status'); if(imgbbEl){ imgbbEl.textContent=''; imgbbEl.style.display='none';} });
            elements.addNewPromotionBtn?.addEventListener('click', () => { elements.promotionForm?.reset(); elements.promotionEditId.value = ''; elements.promotionModalTitle.textContent = "Add New Promotion"; clearStatus(elements.promotionStatus); const imgbbEl = elements.promotionForm?.querySelector('.imgbb-upload-status'); if(imgbbEl){ imgbbEl.textContent=''; imgbbEl.style.display='none';} });
            elements.addNewTournamentBtn?.addEventListener('click', () => { currentEditingTournamentId = null; elements.tournamentForm?.reset(); if(elements.tournamentModalTitle) elements.tournamentModalTitle.textContent = "Add New Tournament"; clearStatus(elements.addTournamentStatus); populateGameSelect(); });
            elements.userBlockBtn?.addEventListener('click', toggleUserBlock);
            elements.userDeleteBtn?.addEventListener('click', (e) => { const userId = e.target.closest('button')?.dataset.id; if (userId) deleteUser(userId); });
            elements.approveWithdrawalBtn?.addEventListener('click', processWithdrawalAction);
            elements.rejectWithdrawalBtn?.addEventListener('click', processWithdrawalAction);
            elements.addDemoDataBtn?.addEventListener('click', addDemoData);
            elements.userSearchInput?.addEventListener('input', filterUsers);
            elements.saveThemeBtn?.addEventListener('click', saveTheme);
            elements.resetThemeBtn?.addEventListener('click', resetTheme);
            elements.previewDefaultThemeBtn?.addEventListener('click', () => populateThemePickers(defaultTheme));
            elements.previewCrimsonThemeBtn?.addEventListener('click', () => populateThemePickers(crimsonTheme));
            elements.previewOceanicThemeBtn?.addEventListener('click', () => populateThemePickers(oceanicTheme));
            elements.customThemeForm?.addEventListener('input', (e) => { if (e.target.matches('input[type="color"]')) { const textInput = e.target.parentElement.querySelector(`input[type="text"][data-target="${e.target.id}"]`); if(textInput) textInput.value = e.target.value; } else if (e.target.matches('input[type="text"]')) { const colorInput = getElement(e.target.dataset.target); if(colorInput && /^#[0-9A-F]{6}$/i.test(e.target.value)) { colorInput.value = e.target.value; } } });

            elements.saveUpdateBtn?.addEventListener('click', saveUpdate);
            elements.addNewUpdateBtn?.addEventListener('click', () => {
                elements.updateForm?.reset();
                elements.updateEditId.value = '';
                elements.updateModalTitle.textContent = "Add New Update";
                clearStatus(elements.updateStatus);
            });
            elements.approveDepositBtn?.addEventListener('click', processDepositAction);
            elements.rejectDepositBtn?.addEventListener('click', processDepositAction);
            elements.sendSingleNotificationForm?.addEventListener('submit', (e) => {
                e.preventDefault();
                const uid = elements.singleNotificationUid.value;
                const title = elements.singleNotificationTitle.value;
                const message = elements.singleNotificationMessage.value;
                sendNotification(uid, title, message)
                    .then(() => {
                        showStatus(elements.notificationStatus, `Notification sent to ${uid}`, "success");
                        elements.sendSingleNotificationForm.reset();
                    })
                    .catch(err => showStatus(elements.notificationStatus, `Error: ${err.message}`, "danger"));
            });
            elements.sendBroadcastNotificationForm?.addEventListener('submit', sendBroadcastNotification);
            
            document.body.addEventListener('click', (event) => {
                 const target = event.target; const actionButton = target.closest('button[data-id]'); const copyIcon = target.closest('.copy-btn[data-target]');
                 if (actionButton) {
                     const targetId = actionButton.dataset.id; if (!targetId) return;
                     if (actionButton.classList.contains('btn-delete-game')) deleteGame(targetId);
                     else if (actionButton.classList.contains('btn-edit-game')) openEditGameModal(targetId);
                     else if (actionButton.classList.contains('btn-delete-promo')) deletePromotion(targetId);
                     else if (actionButton.classList.contains('btn-edit-promo')) openEditPromotionModal(targetId);
                     else if (actionButton.classList.contains('btn-delete-update')) deleteUpdate(targetId);
                     else if (actionButton.classList.contains('btn-edit-update')) openEditUpdateModal(targetId);
                     else if (actionButton.classList.contains('btn-delete-tournament')) deleteTournament(targetId);
                     else if (actionButton.classList.contains('btn-edit-tournament')) openEditTournamentModal(targetId);
                     else if (actionButton.classList.contains('btn-view-user')) openUserModal(targetId);
                     else if (actionButton.classList.contains('btn-approve-withdrawal')) openWithdrawalActionModal(targetId, 'approve');
                     else if (actionButton.classList.contains('btn-reject-withdrawal')) openWithdrawalActionModal(targetId, 'reject');
                     else if (actionButton.classList.contains('btn-approve-deposit')) openDepositActionModal(targetId, 'approve');
                     else if (actionButton.classList.contains('btn-reject-deposit')) openDepositActionModal(targetId, 'reject');
                     else if (actionButton.classList.contains('btn-delete-user')) deleteUser(targetId);
                     else if (actionButton.classList.contains('btn-view-registered')) openRegisteredPlayersModal(targetId, actionButton.dataset.name);
                     return;
                 }
                 if (copyIcon) { copyToClipboard(copyIcon.dataset.target); return; }
            });
            
            const resetModal = (modalEl, formEl, statusEl, idField = null, titleEl = null, defaultTitle = 'Add New Item', imgbbSel = '.imgbb-upload-status') => { modalEl?.addEventListener('hidden.bs.modal', () => { formEl?.reset(); if(statusEl) clearStatus(statusEl); const imgbbStat = formEl?.querySelector(imgbbSel); if(imgbbStat) { imgbbStat.textContent=''; imgbbStat.style.display='none'; } if (idField) idField.value = ''; if (titleEl) titleEl.textContent = defaultTitle; if (modalEl === elements.addTournamentModalEl) currentEditingTournamentId = null; if (modalEl === elements.userModalEl) elements.editUserUid.value = ''; if (modalEl === elements.withdrawalActionModalEl) currentWithdrawalAction = { id: null, type: null, userId: null }; if (modalEl === elements.depositActionModalEl) currentDepositAction = { id: null, type: null, userId: null }; currentEditingItemId = null; }); };
            resetModal(elements.gameModalEl, elements.gameForm, elements.gameStatus, elements.gameEditId, elements.gameModalTitle, 'Add New Game');
            resetModal(elements.promotionModalEl, elements.promotionForm, elements.promotionStatus, elements.promotionEditId, elements.promotionModalTitle, 'Add New Promotion');
            resetModal(elements.updateModalEl, elements.updateForm, elements.updateStatus, elements.updateEditId, elements.updateModalTitle, 'Add New Update');
            resetModal(elements.addTournamentModalEl, elements.tournamentForm, elements.addTournamentStatus, elements.tournamentEditId, elements.tournamentModalTitle, 'Add New Tournament', null);
            resetModal(elements.addUserModalEl, elements.addUserForm, elements.addUserStatus, null, null, '', null);
            resetModal(elements.userModalEl, elements.updateBalanceForm, elements.balanceUpdateStatus, elements.editUserUid, null, '', null);
            resetModal(elements.withdrawalActionModalEl, null, elements.withdrawalActionStatus, null, null, '', null);
            resetModal(elements.depositActionModalEl, null, elements.depositActionStatus, null, null, '', null);
            resetModal(elements.registeredPlayersModalEl, null, elements.registeredPlayersStatus, null, null, '', null);
             console.log("Admin Event Listeners Initialized.");
        }

        function filterUsers() { const searchTerm = elements.userSearchInput.value.toLowerCase().trim(); const filteredUsers = Object.values(fullUserDataCache).filter(user => user.displayName?.toLowerCase().includes(searchTerm) || user.email?.toLowerCase().includes(searchTerm)); renderUsersTable(filteredUsers); }

        document.addEventListener('DOMContentLoaded', () => {
            console.log("Admin Panel DOM Loaded.");
            if (!app || !auth || !db) return;
            initializeAdminEventListeners();
            onAuthStateChanged(auth, handleAdminAuthStateChange);
        });

    </script>

</body>
</html>    <!-- Login / Setup Area -->
    <div id="auth-container">
        <div id="admin-setup-section" style="display: none;">
            <div class="container login-container"> <div class="card shadow"> <div class="card-body p-4"> <h2 class="card-title text-center mb-4">Admin Account Setup</h2> <p class="text-muted text-center small mb-3">Create the primary admin account.</p> <form id="adminSetupForm"> <div class="mb-3"> <label for="setupEmail" class="form-label">Admin Email</label> <input type="email" class="form-control" id="setupEmail" required> </div> <div class="mb-3"> <label for="setupPassword" class="form-label">Admin Password (min 6 chars)</label> <input type="password" class="form-control" id="setupPassword" required minlength="6"> </div> <div id="adminSetupStatus" class="mt-3"></div> <div class="d-grid"> <button type="submit" class="btn btn-success">Create Admin Account</button> </div> </form> </div> </div> </div>
        </div>
        <div id="admin-login-section" style="display: none;">
            <div class="container login-container"> <div class="card shadow"> <div class="card-body p-4"> <h2 class="card-title text-center mb-4">Admin Login</h2> <form id="adminLoginForm"> <div class="mb-3"> <label for="adminEmail" class="form-label">Email</label> <input type="email" class="form-control" id="adminEmail" required> </div> <div class="mb-3"> <label for="adminPassword" class="form-label">Password</label> <input type="password" class="form-control" id="adminPassword" required> </div> <div id="adminLoginStatus" class="mt-3"></div> <div class="d-grid"> <button type="submit" class="btn btn-primary">Login</button> </div> </form> </div> </div> </div>
        </div>
    </div>

    <!-- Main Admin Panel Area -->
    <div id="admin-main-area" style="display: none;">
        <header class="app-header">
            <div class="header-left">
                <button class="menu-toggle-btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#adminSidebar" aria-controls="adminSidebar">
                    <i class="bi bi-list"></i>
                </button>
                <img src="https://via.placeholder.com/35/1E293B/94A3B8?text=L" alt="Logo" class="header-logo" id="adminHeaderLogo" style="display:none;">
                <h1 class="header-title ms-1" id="adminPageTitle">Dashboard</h1>
            </div>
            <div class="header-right">
                <span class="admin-email-header" id="adminUserEmailShort"></span>
                <button class="btn btn-sm btn-outline-danger" id="adminLogoutBtnHeader"><i class="bi bi-box-arrow-right"></i> Logout</button>
            </div>
        </header>

        <div class="offcanvas offcanvas-start" tabindex="-1" id="adminSidebar" aria-labelledby="adminSidebarLabel">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="adminSidebarLabel">Admin Menu</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
                <ul class="nav flex-column">
                    <li class="nav-item"> <a class="nav-link active" href="#" data-section="dashboard-section"><i class="bi bi-speedometer2"></i> Dashboard</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="games-section"><i class="bi bi-controller"></i> Games</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="promotions-section"><i class="bi bi-images"></i> Promotions</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="update-section"><i class="bi bi-newspaper"></i> Updates</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="tournaments-section"><i class="bi bi-trophy"></i> Tournaments</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="users-section"><i class="bi bi-people"></i> Users</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="transactions-section"><i class="bi bi-receipt"></i> Transactions</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="withdrawals-section"><i class="bi bi-cash-coin"></i> Withdrawals <span class="badge bg-danger ms-1" id="pendingWithdrawalCountBadge" style="display: none;">0</span></a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="deposits-section"><i class="bi bi-wallet2"></i> Deposit <span class="badge bg-warning ms-1" id="pendingDepositCountBadge" style="display: none;">0</span></a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="notifications-section"><i class="bi bi-bell-fill"></i> Notifications</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="settings-section"><i class="bi bi-gear"></i> Settings</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="theme-section"><i class="bi bi-palette-fill"></i> Theme</a> </li>
                </ul>
                <div class="mt-auto p-3 border-top border-secondary">
                     <button class="btn btn-warning btn-sm w-100 mb-2" id="addDemoDataBtn"><i class="bi bi-database-add"></i> Add Demo Data</button>
                     <small class="text-muted d-block text-center">Adds sample data if DB is empty.</small>
                </div>
            </div>
        </div>

        <main class="main-content" id="adminMainContent">
            <!-- Dashboard Section -->
            <section id="dashboard-section" class="section active">
                <h2>Dashboard Overview</h2>
                <div class="row">
                    <!-- Row 1 -->
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-primary shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Total Users</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statTotalUsers">--</p>
                                <i class="bi bi-people-fill dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-info shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Active/Upcoming Tournaments</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statActiveTournaments">--</p>
                                <i class="bi bi-trophy-fill dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-warning shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Pending Withdrawals</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statPendingWithdrawals">--</p>
                                <i class="bi bi-hourglass-split dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                     <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-success shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Completed Withdrawals</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statCompletedWithdrawals">--</p>
                                <i class="bi bi-check-circle-fill dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                    <!-- Row 2 -->
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-dark shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Rejected Withdrawals</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statRejectedWithdrawals">--</p>
                                <i class="bi bi-x-octagon-fill dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                     <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-secondary shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Total Games</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statTotalGames">--</p>
                                <i class="bi bi-controller dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-secondary shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Total Promotions</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statTotalPromotions">--</p>
                                <i class="bi bi-images dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                     <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-secondary shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Finished Tournaments</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statFinishedTournaments">--</p>
                                <i class="bi bi-flag-fill dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="dashboardStatus"></div>
            </section>

            <!-- Games Section -->
            <section id="games-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <h2>Manage Games</h2>
                    <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#gameModal" id="addNewGameBtn"><i class="bi bi-plus-circle"></i> Add Game</button>
                </div>
                 <div id="gamesStatus" class="mb-3"></div>
                <div class="table-responsive card">
                    <table class="table table-dark table-hover mb-0">
                        <thead> <tr><th>Image</th><th>Name</th><th>Game ID</th><th>Actions</th></tr> </thead>
                        <tbody id="gamesTableBody">
                            <tr class="loading-placeholder"><td colspan="4"><div class="placeholder w-100 py-3"></div></td></tr>
                            <tr class="loading-placeholder"><td colspan="4"><div class="placeholder w-100 py-3"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Promotions Section -->
            <section id="promotions-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                     <h2>Manage Promotions</h2>
                     <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#promotionModal" id="addNewPromotionBtn"><i class="bi bi-plus-circle"></i> Add Promotion</button>
                </div>
                <div id="promotionsStatus" class="mb-3"></div>
                <div class="table-responsive card">
                    <table class="table table-dark table-hover mb-0">
                         <thead> <tr><th>Image</th><th>Link</th><th>Actions</th></tr> </thead>
                         <tbody id="promotionsTableBody">
                            <tr class="loading-placeholder"><td colspan="3"><div class="placeholder w-100 py-3"></div></td></tr>
                         </tbody>
                    </table>
                </div>
             </section>
             
            <!-- UPDATE SECTION -->
            <section id="update-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                     <h2>Manage Updates</h2>
                     <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#updateModal" id="addNewUpdateBtn"><i class="bi bi-plus-circle"></i> Add Update</button>
                </div>
                <div id="updatesStatus" class="mb-3"></div>
                <div class="table-responsive card">
                    <table class="table table-dark table-hover mb-0">
                         <thead> <tr><th>Image</th><th>Title</th><th>Actions</th></tr> </thead>
                         <tbody id="updatesTableBody">
                            <tr class="loading-placeholder"><td colspan="3"><div class="placeholder w-100 py-3"></div></td></tr>
                         </tbody>
                    </table>
                </div>
            </section>

            <!-- Tournaments Section -->
            <section id="tournaments-section" class="section">
                 <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                     <h2>Manage Tournaments</h2>
                     <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addTournamentModal" id="addNewTournamentBtn"><i class="bi bi-plus-circle"></i> Add Tournament</button>
                 </div>
                 <div id="tournamentsStatus" class="mb-3"></div>
                 <div class="table-responsive card">
                     <table class="table table-dark table-hover mb-0">
                         <thead> <tr><th>Name</th><th>Game</th><th>Fee</th><th>Prize</th><th>Start Time</th><th>Status</th><th>Players</th><th>Actions</th></tr> </thead>
                         <tbody id="tournamentsTableBody">
                            <tr class="loading-placeholder"><td colspan="8"><div class="placeholder w-100 py-3"></div></td></tr>
                            <tr class="loading-placeholder"><td colspan="8"><div class="placeholder w-100 py-3"></div></td></tr>
                         </tbody>
                    </table>
                 </div>
            </section>

            <!-- Users Section -->
            <section id="users-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <h2>Manage Users</h2>
                    <div class="d-flex gap-2">
                        <input type="search" class="form-control form-control-sm" id="userSearchInput" placeholder="Search by name or email...">
                        <button class="btn btn-success btn-sm flex-shrink-0" data-bs-toggle="modal" data-bs-target="#addUserModal">
                            <i class="bi bi-person-plus-fill"></i> Add User
                        </button>
                    </div>
                </div>
                 <div id="usersStatus" class="mb-3"></div>
                <div class="table-responsive card">
                    <table class="table table-dark table-hover mb-0">
                        <thead>
                            <tr><th>UID</th><th>Display Name</th><th>Email</th><th>Balance</th><th>Status</th><th>Actions</th></tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr class="loading-placeholder"><td colspan="6"><div class="placeholder w-100 py-3"></div></td></tr>
                            <tr class="loading-placeholder"><td colspan="6"><div class="placeholder w-100 py-3"></div></td></tr>
                            <tr class="loading-placeholder"><td colspan="6"><div class="placeholder w-100 py-3"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Transactions Section -->
            <section id="transactions-section" class="section card"> <div class="card-body"> <h2 class="card-title">User Transactions</h2> <p class="text-muted">Section under development.</p></div> </section>

            <!-- Withdrawals Section -->
            <section id="withdrawals-section" class="section">
                <h2>Manage Withdrawals</h2>
                 <div id="withdrawalsStatus" class="mb-3"></div>
                <div class="card">
                    <div class="card-header bg-secondary border-bottom border-dark"> <ul class="nav nav-tabs card-header-tabs" id="withdrawalTabs" role="tablist"> <li class="nav-item" role="presentation"><button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pendingWithdrawalsTab" type="button" role="tab">Pending</button></li> <li class="nav-item" role="presentation"><button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completedWithdrawalsTab" type="button" role="tab">Completed</button></li> <li class="nav-item" role="presentation"><button class="nav-link" id="rejected-tab" data-bs-toggle="tab" data-bs-target="#rejectedWithdrawalsTab" type="button" role="tab">Rejected</button></li> </ul> </div>
                    <div class="card-body tab-content p-0">
                        <div class="tab-pane fade show active" id="pendingWithdrawalsTab" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover mb-0">
                                    <thead><tr><th>Requested At</th><th>User</th><th>Amount</th><th>Method</th><th>Actions</th></tr></thead>
                                    <tbody id="pendingWithdrawalsTableBody"> <tr class="loading-placeholder"><td colspan="5"><div class="placeholder w-100 py-3"></div></td></tr> <tr class="loading-placeholder"><td colspan="5"><div class="placeholder w-100 py-3"></div></td></tr> </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="completedWithdrawalsTab" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover mb-0">
                                    <thead><tr><th>Requested At</th><th>Processed At</th><th>User</th><th>Amount</th><th>Method</th><th>Admin Note</th></tr></thead>
                                    <tbody id="completedWithdrawalsTableBody"> <tr class="loading-placeholder"><td colspan="6"><div class="placeholder w-100 py-3"></div></td></tr> </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="rejectedWithdrawalsTab" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover mb-0">
                                    <thead><tr><th>Requested At</th><th>Processed At</th><th>User</th><th>Amount</th><th>Method</th><th>Reason</th></tr></thead>
                                    <tbody id="rejectedWithdrawalsTableBody"> <tr class="loading-placeholder"><td colspan="6"><div class="placeholder w-100 py-3"></div></td></tr></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                 </div>
            </section>
            
            <!-- DEPOSIT SECTION    -->
            <section id="deposits-section" class="section">
                <h2>Manage Deposits (Recharge)</h2>
                <div id="depositsStatus" class="mb-3"></div>
                <div class="card">
                    <div class="card-header bg-secondary border-bottom border-dark">
                        <ul class="nav nav-tabs card-header-tabs" id="depositTabs" role="tablist">
                            <li class="nav-item" role="presentation"><button class="nav-link active" id="pending-deposit-tab" data-bs-toggle="tab" data-bs-target="#pendingDepositsTab" type="button" role="tab">Pending</button></li>
                            <li class="nav-item" role="presentation"><button class="nav-link" id="approved-deposit-tab" data-bs-toggle="tab" data-bs-target="#approvedDepositsTab" type="button" role="tab">Approved</button></li>
                            <li class="nav-item" role="presentation"><button class="nav-link" id="rejected-deposit-tab" data-bs-toggle="tab" data-bs-target="#rejectedDepositsTab" type="button" role="tab">Rejected</button></li>
                        </ul>
                    </div>
                    <div class="card-body tab-content p-0">
                        <!-- Pending Deposits -->
                        <div class="tab-pane fade show active" id="pendingDepositsTab" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover mb-0">
                                    <thead><tr><th>Requested At</th><th>User</th><th>Amount</th><th>Details</th><th>Actions</th></tr></thead>
                                    <tbody id="pendingDepositsTableBody">
                                        <tr class="loading-placeholder"><td colspan="5"><div class="placeholder w-100 py-3"></div></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- Approved Deposits -->
                        <div class="tab-pane fade" id="approvedDepositsTab" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover mb-0">
                                    <thead><tr><th>Requested At</th><th>Processed At</th><th>User</th><th>Amount</th><th>Details</th><th>Admin Note</th></tr></thead>
                                    <tbody id="approvedDepositsTableBody">
                                        <tr class="loading-placeholder"><td colspan="6"><div class="placeholder w-100 py-3"></div></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- Rejected Deposits -->
                        <div class="tab-pane fade" id="rejectedDepositsTab" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover mb-0">
                                    <thead><tr><th>Requested At</th><th>Processed At</th><th>User</th><th>Amount</th><th>Details</th><th>Reason</th></tr></thead>
                                    <tbody id="rejectedDepositsTableBody">
                                        <tr class="loading-placeholder"><td colspan="6"><div class="placeholder w-100 py-3"></div></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- NOTIFICATIONS SECTION -->
            <section id="notifications-section" class="section">
                <h2>Send Notifications</h2>
                <div id="notificationStatus" class="mb-3"></div>
                <div class="row">
                    <!-- Send to Single User -->
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header"><h5 class="mb-0"><i class="bi bi-person-fill me-2"></i> Send to Single User</h5></div>
                            <div class="card-body">
                                <form id="sendSingleNotificationForm">
                                    <div class="mb-3">
                                        <label for="singleNotificationUid" class="form-label">User ID (UID)</label>
                                        <input type="text" id="singleNotificationUid" class="form-control" placeholder="Enter user's Firebase UID" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="singleNotificationTitle" class="form-label">Title</label>
                                        <input type="text" id="singleNotificationTitle" class="form-control" placeholder="e.g., Recharge Approved" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="singleNotificationMessage" class="form-label">Message</label>
                                        <textarea id="singleNotificationMessage" class="form-control" rows="3" placeholder="e.g., Your recharge of ₹50 is complete." required></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Send Notification</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <!-- Broadcast to All Users -->
                    <div class="col-lg-6">
                        <div class="card border-danger">
                            <div class="card-header bg-danger text-white"><h5 class="mb-0"><i class="bi bi-broadcast me-2"></i> Broadcast to All Users</h5></div>
                            <div class="card-body">
                                <form id="sendBroadcastNotificationForm">
                                    <div class="mb-3">
                                        <label for="broadcastNotificationTitle" class="form-label">Title</label>
                                        <input type="text" id="broadcastNotificationTitle" class="form-control" placeholder="e.g., Maintenance Alert" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="broadcastNotificationMessage" class="form-label">Message</label>
                                        <textarea id="broadcastNotificationMessage" class="form-control" rows="3" placeholder="e.g., The app will be down for maintenance..." required></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-danger">Send to ALL Users</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settings-section" class="section card"> <div class="card-body"> <h2 class="card-title">App Settings</h2> <form id="appSettingsForm"> <div class="row"> <div class="col-md-6 mb-3"> <label for="settingLogoUrl" class="form-label">Logo URL</label> <input type="url" class="form-control" id="settingLogoUrl"> </div> <div class="col-md-6 mb-3"> <label for="settingAppName" class="form-label">App Name</label> <input type="text" class="form-control" id="settingAppName"> </div> <div class="col-md-6 mb-3"> <label for="settingMinWithdraw" class="form-label">Min Withdraw (₹)</label> <input type="number" class="form-control" id="settingMinWithdraw" min="0" step="any"> </div> <div class="col-md-6 mb-3"> <label for="settingReferralBonus" class="form-label">Referral Bonus (₹)</label> <input type="number" class="form-control" id="settingReferralBonus" min="0" step="any"> </div> <div class="col-12 mb-3"> <label for="settingSupportContact" class="form-label">Admin Support Contact</label> <input type="text" class="form-control" id="settingSupportContact"> </div> <div class="col-12 mb-3"> <label for="settingUpiDetails" class="form-label">UPI Details for Payment</label> <input type="text" class="form-control" id="settingUpiDetails"> </div> <div class="col-12 mb-3"> <label for="settingPolicyPrivacy" class="form-label">Privacy Policy</label> <textarea class="form-control" id="settingPolicyPrivacy" rows="5"></textarea> </div> <div class="col-12 mb-3"> <label for="settingPolicyTerms" class="form-label">Terms & Conditions</label> <textarea class="form-control" id="settingPolicyTerms" rows="5"></textarea> </div> <div class="col-12 mb-3"> <label for="settingPolicyRefund" class="form-label">Refund Policy</label> <textarea class="form-control" id="settingPolicyRefund" rows="5"></textarea> </div> <div class="col-12 mb-3"> <label for="settingPolicyFairPlay" class="form-label">Fair Play Policy</label> <textarea class="form-control" id="settingPolicyFairPlay" rows="5"></textarea> </div> </div> <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Save Settings</button> <div id="settingsStatus" class="mt-3"></div> </form> </div> </section>
            
            <!-- Theme Section -->
            <section id="theme-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="section-title mb-0">Theme Customization</h2>
                    <button class="btn btn-danger btn-sm" id="resetThemeBtn"><i class="bi bi-arrow-counterclockwise"></i> Reset to Default Theme</button>
                </div>
                <div id="themeStatus" class="mb-3"></div>
                <div class="row">
                    <div class="col-lg-4 mb-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">Predefined Themes</h5>
                                <p class="card-text text-secondary small">Select a theme to preview the colors in the form below, then click "Save Theme" to apply it.</p>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-secondary" id="previewDefaultThemeBtn">Default Dark</button>
                                    <button class="btn btn-outline-danger" id="previewCrimsonThemeBtn">Crimson Dark</button>
                                    <button class="btn btn-outline-info" id="previewOceanicThemeBtn">Oceanic Blue</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-8 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Custom Theme Colors</h5>
                                <form id="customThemeForm">
                                    <div class="row g-3">
                                        <div class="col-md-6"><div class="color-picker-group mb-2"><label for="theme-primary-bg" class="form-label">Primary BG</label><input type="color" class="form-control form-control-color" id="theme-primary-bg" data-var="--primary-bg"><input type="text" class="form-control form-control-sm" data-target="theme-primary-bg"></div></div>
                                        <div class="col-md-6"><div class="color-picker-group mb-2"><label for="theme-accent-color" class="form-label">Accent Color</label><input type="color" class="form-control form-control-color" id="theme-accent-color" data-var="--accent-color"><input type="text" class="form-control form-control-sm" data-target="theme-accent-color"></div></div>
                                        <div class="col-md-6"><div class="color-picker-group mb-2"><label for="theme-text-primary" class="form-label">Primary Text</label><input type="color" class="form-control form-control-color" id="theme-text-primary" data-var="--text-primary"><input type="text" class="form-control form-control-sm" data-target="theme-text-primary"></div></div>
                                        <div class="col-md-6"><div class="color-picker-group mb-2"><label for="theme-primary-button-bg" class="form-label">Primary Button</label><input type="color" class="form-control form-control-color" id="theme-primary-button-bg" data-var="--primary-button-bg"><input type="text" class="form-control form-control-sm" data-target="theme-primary-button-bg"></div></div>
                                        <div class="col-12"><hr class="my-2"></div>
                                        <div class="col-md-6"><div class="color-picker-group mb-2"><label for="theme-secondary-bg" class="form-label">Secondary BG</label><input type="color" class="form-control form-control-color" id="theme-secondary-bg" data-var="--secondary-bg"><input type="text" class="form-control form-control-sm" data-target="theme-secondary-bg"></div></div>
                                        <div class="col-md-6"><div class="color-picker-group mb-2"><label for="theme-card-bg" class="form-label">Card BG</label><input type="color" class="form-control form-control-color" id="theme-card-bg" data-var="--card-bg"><input type="text" class="form-control form-control-sm" data-target="theme-card-bg"></div></div>
                                        <div class="col-md-6"><div class="color-picker-group mb-2"><label for="theme-text-secondary" class="form-label">Secondary Text</label><input type="color" class="form-control form-control-color" id="theme-text-secondary" data-var="--text-secondary"><input type="text" class="form-control form-control-sm" data-target="theme-text-secondary"></div></div>
                                         <div class="col-md-6"><div class="color-picker-group mb-2"><label for="theme-border-color" class="form-label">Border Color</label><input type="color" class="form-control form-control-color" id="theme-border-color" data-var="--border-color"><input type="text" class="form-control form-control-sm" data-target="theme-border-color"></div></div>
                                    </div>
                                    <div class="d-flex justify-content-end mt-4">
                                         <button type="button" class="btn btn-primary" id="saveThemeBtn"><i class="bi bi-save"></i> Save Theme</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="gameModal" tabindex="-1"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="gameModalTitle">Add New Game</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <form id="gameForm"> <input type="hidden" id="gameEditId"> <div class="mb-3"> <label for="gameName" class="form-label">Game Name</label> <input type="text" class="form-control" id="gameName" required> </div> <div class="mb-3"> <label for="gameImageUrl" class="form-label">Image URL</label> <input type="url" class="form-control" id="gameImageUrl" required> <small class="text-muted">Direct image URL (e.g., from ImgBB).</small> </div> <div class="mb-3"> <label for="gameImageFile" class="form-label">Upload New Image (Optional - Overwrites URL)</label> <input class="form-control" type="file" id="gameImageFile" accept="image/*"> <div class="imgbb-upload-status mt-2"></div> </div> <div id="gameStatus" class="mt-2"></div></form> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> <button type="button" class="btn btn-primary" id="saveGameBtn">Save Game</button> </div> </div> </div> </div>
    <div class="modal fade" id="promotionModal" tabindex="-1"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="promotionModalTitle">Add New Promotion</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <form id="promotionForm"> <input type="hidden" id="promotionEditId"> <div class="mb-3"> <label for="promoImageUrl" class="form-label">Image URL</label> <input type="url" class="form-control" id="promoImageUrl" required> <small class="text-muted">Direct image URL (e.g., from ImgBB).</small> </div> <div class="mb-3"> <label for="promoImageFile" class="form-label">Upload New Image (Optional - Overwrites URL)</label> <input class="form-control" type="file" id="promoImageFile" accept="image/*"> <div class="imgbb-upload-status mt-2"></div> </div> <div class="mb-3"> <label for="promoLink" class="form-label">Link (Optional)</label> <input type="url" class="form-control" id="promoLink"> </div> <div id="promotionStatus" class="mt-2"></div></form> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> <button type="button" class="btn btn-primary" id="savePromotionBtn">Save Promotion</button> </div> </div> </div> </div>
    <!-- UPDATE MODAL -->
    <div class="modal fade" id="updateModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="updateModalTitle">Add New Update</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="updateForm">
                        <input type="hidden" id="updateEditId">
                        <div class="mb-3">
                            <label for="updateTitle" class="form-label">Title</label>
                            <input type="text" class="form-control" id="updateTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="updateImageUrl" class="form-label">Image URL</label>
                            <input type="url" class="form-control" id="updateImageUrl" required>
                            <small class="text-muted">Direct image URL (e.g., from ImgBB).</small>
                        </div>
                        <div id="updateStatus" class="mt-2"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveUpdateBtn">Post Update</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="addTournamentModal" tabindex="-1"> <div class="modal-dialog modal-lg"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="tournamentModalTitle">Add New Tournament</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <form id="tournamentForm"> <input type="hidden" id="tournamentEditId"> <div class="row"> <div class="col-md-6 mb-3"> <label for="tournamentGame" class="form-label">Game</label> <select class="form-select" id="tournamentGame" required></select> </div> <div class="col-md-6 mb-3"> <label for="tournamentName" class="form-label">Tournament Name</label> <input type="text" class="form-control" id="tournamentName" required> </div> <div class="col-md-6 mb-3"> <label for="tournamentStartTime" class="form-label">Start Date & Time</label> <input type="datetime-local" class="form-control" id="tournamentStartTime" required> </div> <div class="col-md-6 mb-3"> <label for="tournamentStatus" class="form-label">Status</label> <select class="form-select" id="tournamentStatus" required> <option value="upcoming">Upcoming</option> <option value="ongoing">Ongoing</option> <option value="completed">Completed</option> <option value="result">Result</option> <option value="cancelled">Cancelled</option> </select> </div> <div class="col-md-4 mb-3"> <label for="tournamentEntryFee" class="form-label">Entry Fee (₹)</label> <input type="number" class="form-control" id="tournamentEntryFee" min="0" value="0" required step="any"> </div> <div class="col-md-4 mb-3"> <label for="tournamentPrizePool" class="form-label">Total Prize Pool (₹)</label> <input type="number" class="form-control" id="tournamentPrizePool" min="0" value="0" step="any"> </div> <div class="col-md-4 mb-3"> <label for="tournamentPerKill" class="form-label">Per Kill Prize (₹)</label> <input type="number" class="form-control" id="tournamentPerKill" min="0" value="0" step="any"> </div> <div class="col-md-6 mb-3"> <label for="tournamentMaxPlayers" class="form-label">Max Players (0 for Unlimited)</label> <input type="number" class="form-control" id="tournamentMaxPlayers" min="0" value="0" required> </div> <div class="col-md-6 mb-3"> <label for="tournamentTags" class="form-label">Tags (comma-separated)</label> <input type="text" class="form-control" id="tournamentTags" placeholder="e.g., TPP, FPP"> </div> <div class="col-md-6 mb-3"> <label for="tournamentMode" class="form-label">Mode</label> <input type="text" class="form-control" id="tournamentMode" placeholder="e.g., Squad, Solo, Duo"> </div> <div class="col-md-6 mb-3"> <label for="tournamentMap" class="form-label">Map</label> <input type="text" class="form-control" id="tournamentMap" placeholder="e.g., Erangel, Livik, Miramar"> </div> <div class="col-12 mb-3"> <label for="tournamentDescription" class="form-label">Description / Rules</label> <textarea class="form-control" id="tournamentDescription" rows="4"></textarea> </div> <div class="col-md-6 mb-3"> <label for="tournamentRoomId" class="form-label">Room ID</label> <input type="text" class="form-control" id="tournamentRoomId"> </div> <div class="col-md-6 mb-3"> <label for="tournamentRoomPassword" class="form-label">Room Password</label> <input type="text" class="form-control" id="tournamentRoomPassword"> </div> <div class="form-check mb-3 ms-2"> <input class="form-check-input" type="checkbox" id="tournamentShowIdPass"> <label class="form-check-label" for="tournamentShowIdPass"> Show ID/Pass?</label> </div> </div> <div id="addTournamentStatus" class="mt-2"></div></form> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> <button type="button" class="btn btn-primary" id="saveTournamentBtn">Save Tournament</button> </div> </div> </div> </div>
    <div class="modal fade" id="userModal" tabindex="-1"> <div class="modal-dialog modal-lg"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="userModalTitle">User Details</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <div class="row"> <div class="col-md-6"> <h5>User Info</h5> <p><strong>UID:</strong> <small id="userDetailUid" class="text-muted user-uid-copy"></small> <i class="bi bi-clipboard copy-btn ms-1" data-target="#userDetailUid" title="Copy UID"></i></p> <p><strong>Email:</strong> <span id="userDetailEmail"></span></p> <p><strong>Name:</strong> <span id="userDetailName"></span></p> <p><strong>Created At:</strong> <span id="userDetailCreatedAt">N/A</span></p> <hr> <h5>Wallet</h5> <p>Total Balance: ₹<span id="userDetailBalance">0.00</span></p> <p>Winning Cash: ₹<span id="userDetailWinning">0.00</span></p> <p>Bonus Cash: ₹<span id="userDetailBonus">0.00</span></p> <hr> <h5>Referral Info</h5> <p><strong>Referral Code:</strong> <span id="userDetailReferralCode" class="text-info">N/A</span> <i class="bi bi-clipboard copy-btn ms-1" data-target="#userDetailReferralCode" title="Copy Code"></i></p> <p><strong>Referred By:</strong> <span id="userDetailReferredBy">N/A</span></p> <p><strong>Users Referred:</strong> <span id="userDetailReferredCount">N/A</span></p> </div> <div class="col-md-6"> <h5>Update Balance (Caution!)</h5> <form id="updateBalanceForm"> <input type="hidden" id="editUserUid"> <div class="row"> <div class="col-md-6 mb-3"> <label for="balanceUpdateAmount" class="form-label">Amount (+/-)</label> <input type="number" step="any" class="form-control" id="balanceUpdateAmount" placeholder="e.g., 50 or -20" required> </div> <div class="col-md-6 mb-3"> <label for="balanceUpdateType" class="form-label">Balance Type</label> <select id="balanceUpdateType" class="form-select" required> <option value="">--Select--</option> <option value="balance">Total Balance</option> <option value="winningCash">Winning Cash</option> <option value="bonusCash">Bonus Cash</option> </select> </div> </div> <div class="mb-3"> <label for="balanceUpdateReason" class="form-label">Reason</label> <input type="text" class="form-control" id="balanceUpdateReason" placeholder="Manual Deposit, Correction etc." required> </div> <button type="submit" class="btn btn-warning">Update Balance</button> <div id="balanceUpdateStatus" class="mt-2"></div> </form> <hr> <h5>Status & Actions</h5> <p>Current Status: <span id="userDetailStatus" class="fw-bold"></span></p> <button class="btn btn-sm mb-2" id="userBlockBtn"></button> <button class="btn btn-sm btn-danger mb-2" id="userDeleteBtn"><i class="bi bi-trash"></i> Delete User (DB Only)</button> </div> </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> </div> </div> </div> </div>
    <div class="modal fade" id="withdrawalActionModal" tabindex="-1"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title">Withdrawal Action</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <p><strong>Request ID:</strong> <small id="withdrawalDetailId" class="text-muted withdrawal-id-copy"></small> <i class="bi bi-clipboard copy-btn ms-1" data-target="#withdrawalDetailId" title="Copy Request ID"></i></p> <p><strong>User:</strong> <span id="withdrawalDetailUser"></span> (<small id="withdrawalDetailUserUid" class="text-muted withdrawal-user-uid-copy"></small> <i class="bi bi-clipboard copy-btn ms-1" data-target="#withdrawalDetailUserUid" title="Copy User UID"></i>)</p> <p><strong>Amount:</strong> ₹<span id="withdrawalDetailAmount"></span></p> <p><strong>Method:</strong> <span id="withdrawalDetailMethod"></span></p> <hr> <div id="withdrawalRejectReasonDiv" style="display: none;" class="mb-3"> <label for="withdrawalRejectReason" class="form-label">Reason for Rejection</label> <textarea class="form-control" id="withdrawalRejectReason" rows="3" required></textarea> </div> <div id="withdrawalApproveNoteDiv" style="display: none;" class="mb-3"> <label for="withdrawalApproveNote" class="form-label">Admin Note / Txn ID (Optional)</label> <input type="text" class="form-control" id="withdrawalApproveNote" placeholder="e.g., Transaction ID"> </div> <div id="withdrawalActionStatus" class="mt-2"></div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button> <button type="button" class="btn btn-danger" id="rejectWithdrawalBtn">Reject</button> <button type="button" class="btn btn-success" id="approveWithdrawalBtn">Approve</button> </div> </div> </div> </div>
    <div class="modal fade" id="addUserModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Add New User</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="addUserForm"><div class="mb-3"><label for="newUserName" class="form-label">Display Name</label><input type="text" class="form-control" id="newUserName" required></div><div class="mb-3"><label for="newUserEmail" class="form-label">Email Address</label><input type="email" class="form-control" id="newUserEmail" required></div><div class="mb-3"><label for="newUserPassword" class="form-label">Password (min 6 chars)</label><input type="password" class="form-control" id="newUserPassword" required minlength="6"></div><div class="mb-3"><label for="newUserInitialBalance" class="form-label">Initial Balance (₹)</label><input type="number" step="any" class="form-control" id="newUserInitialBalance" value="0" min="0"><small class="text-muted">This will be added to Total Balance.</small></div><div id="addUserStatus" class="mt-2"></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button type="button" class="btn btn-primary" id="saveNewUserBtn">Create User</button></div></div></div></div>
    
    <!-- MODIFIED: Added columns for In-Game Name & ID -->
    <div class="modal fade" id="registeredPlayersModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="registeredPlayersModalTitle">Registered Players</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Tournament: <strong id="registeredPlayersTournamentName"></strong></p><div id="registeredPlayersStatus" class="mb-2"></div><div class="table-responsive"><table class="table table-dark table-sm table-hover"><thead><tr><th>User UID</th><th>Display Name</th><th>In-Game Name</th><th>In-Game ID</th><th>Joined At</th></tr></thead><tbody id="registeredPlayersTableBody"><tr><td colspan="5" class="text-center p-3"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div></td></tr></tbody></table></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div></div></div></div>

    <!-- DEPOSIT ACTION MODAL -->
    <div class="modal fade" id="depositActionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Deposit Action</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Request ID:</strong> <small id="depositDetailId" class="text-muted"></small></p>
                    <p><strong>User:</strong> <span id="depositDetailUser"></span></p>
                    <p><strong>Amount:</strong> <span id="depositDetailAmount" class="fw-bold text-success"></span></p>
                    <hr>
                    <p><strong>Method:</strong> <span id="depositDetailMethod"></span></p>
                    <p><strong>Game ID:</strong> <span id="depositDetailGameId"></span></p>
                    <p><strong>Transaction ID:</strong> <span id="depositDetailTxnId"></span></p>
                    <hr>
                    <div id="depositRejectReasonDiv" style="display: none;" class="mb-3">
                        <label for="depositRejectReason" class="form-label">Reason for Rejection</label>
                        <textarea class="form-control" id="depositRejectReason" rows="3" required></textarea>
                    </div>
                    <div id="depositApproveNoteDiv" style="display: none;" class="mb-3">
                        <label for="depositApproveNote" class="form-label">Admin Note (Optional)</label>
                        <input type="text" class="form-control" id="depositApproveNote" placeholder="e.g., Verified">
                    </div>
                    <div id="depositActionStatus" class="mt-2"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="rejectDepositBtn">Reject</button>
                    <button type="button" class="btn btn-success" id="approveDepositBtn">Approve</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, get, set, update, push, query, orderByChild, equalTo, onValue, off, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        // Firebase Config (Unchanged)
        const firebaseConfig = {
            apiKey: "AIzaSyBhE8HNbhHcL_DlGWDW4zu3AvE8VSeA8zE",
            authDomain: "l-tournament-10594.firebaseapp.com",
            databaseURL: "https://l-tournament-10594-default-rtdb.firebaseio.com",
            projectId: "l-tournament-10594",
            storageBucket: "l-tournament-10594.firebasestorage.app",
            messagingSenderId: "517389311136",
            appId: "1:517389311136:web:c05c333a3a15465fd37dc5"
        };

        // Firebase Initialization (Unchanged)
        let app, db, auth;
        try {
             if (firebaseConfig.apiKey.includes("YOUR_")) console.warn("Admin Panel: Using placeholder Firebase config.");
             app = initializeApp(firebaseConfig);
             db = getDatabase(app);
             auth = getAuth(app);
             console.log("Admin Panel: Firebase Initialized");
        } catch (error) {
             console.error("Admin Panel: Firebase initialization failed:", error);
             document.body.innerHTML = `<div class="alert alert-danger m-5"><strong>Critical Error:</strong> Could not connect. Check console & config.</div>`;
        }
        
        const getElement = (id) => document.getElementById(id);
        const querySel = (selector) => document.querySelector(selector);
        const querySelAll = (selector) => document.querySelectorAll(selector);
        
        const elements = {
             adminLoader: getElement('adminLoader'),
             authContainer: getElement('auth-container'),
             loginSection: getElement('admin-login-section'),
             setupSection: getElement('admin-setup-section'),
             mainArea: getElement('admin-main-area'),
             adminLoginForm: getElement('adminLoginForm'),
             adminEmailInput: getElement('adminEmail'),
             adminPasswordInput: getElement('adminPassword'),
             adminLoginStatus: getElement('adminLoginStatus'),
             adminSetupForm: getElement('adminSetupForm'),
             setupEmailInput: getElement('setupEmail'),
             setupPasswordInput: getElement('setupPassword'),
             setupStatus: getElement('adminSetupStatus'),
             adminUserEmailDisplay: getElement('adminUserEmailShort'),
             adminLogoutBtn: getElement('adminLogoutBtnHeader'),
             sidebar: getElement('adminSidebar'),
             sidebarLinks: querySelAll('#adminSidebar .nav-link'),
             sections: querySelAll('#adminMainContent .section'),
             adminPageTitle: getElement('adminPageTitle'),
             adminHeaderLogo: getElement('adminHeaderLogo'),
             dashboardSection: getElement('dashboard-section'),
             statTotalUsers: getElement('statTotalUsers'),
             statActiveTournaments: getElement('statActiveTournaments'),
             statPendingWithdrawals: getElement('statPendingWithdrawals'),
             statCompletedWithdrawals: getElement('statCompletedWithdrawals'),
             statRejectedWithdrawals: getElement('statRejectedWithdrawals'),
             statTotalGames: getElement('statTotalGames'),
             statTotalPromotions: getElement('statTotalPromotions'),
             statFinishedTournaments: getElement('statFinishedTournaments'),
             dashboardStatus: getElement('dashboardStatus'),
             pendingWithdrawalCountBadge: getElement('pendingWithdrawalCountBadge'),
             gamesTableBody: getElement('gamesTableBody'),
             gameModalEl: getElement('gameModal'),
             gameModalTitle: getElement('gameModalTitle'),
             gameForm: getElement('gameForm'),
             gameEditId: getElement('gameEditId'),
             gameNameInput: getElement('gameName'),
             gameImageFileInput: getElement('gameImageFile'),
             gameImageUrlInput: getElement('gameImageUrl'),
             saveGameBtn: getElement('saveGameBtn'),
             gameStatus: getElement('gameStatus'),
             gamesStatus: getElement('gamesStatus'),
             addNewGameBtn: getElement('addNewGameBtn'),
             promotionsTableBody: getElement('promotionsTableBody'),
             promotionModalEl: getElement('promotionModal'),
             promotionModalTitle: getElement('promotionModalTitle'),
             promotionForm: getElement('promotionForm'),
             promotionEditId: getElement('promotionEditId'),
             promoImageFileInput: getElement('promoImageFile'),
             promoImageUrlInput: getElement('promoImageUrl'),
             promoLinkInput: getElement('promoLink'),
             savePromotionBtn: getElement('savePromotionBtn'),
             promotionStatus: getElement('promotionStatus'),
             promotionsStatus: getElement('promotionsStatus'),
             addNewPromotionBtn: getElement('addNewPromotionBtn'),
             tournamentsTableBody: getElement('tournamentsTableBody'),
             addTournamentModalEl: getElement('addTournamentModal'),
             tournamentForm: getElement('tournamentForm'),
             tournamentModalTitle: getElement('tournamentModalTitle'),
             tournamentEditId: getElement('tournamentEditId'),
             tournamentGameSelect: getElement('tournamentGame'),
             tournamentNameInput: getElement('tournamentName'),
             tournamentStartTimeInput: getElement('tournamentStartTime'),
             tournamentStatusSelect: getElement('tournamentStatus'),
             tournamentEntryFeeInput: getElement('tournamentEntryFee'),
             tournamentPrizePoolInput: getElement('tournamentPrizePool'),
             tournamentPerKillInput: getElement('tournamentPerKill'),
             tournamentMaxPlayersInput: getElement('tournamentMaxPlayers'),
             tournamentTagsInput: getElement('tournamentTags'),
             tournamentModeInput: getElement('tournamentMode'),
             tournamentMapInput: getElement('tournamentMap'),
             tournamentDescriptionInput: getElement('tournamentDescription'),
             tournamentRoomIdInput: getElement('tournamentRoomId'),
             tournamentRoomPasswordInput: getElement('tournamentRoomPassword'),
             tournamentShowIdPassCheckbox: getElement('tournamentShowIdPass'),
             saveTournamentBtn: getElement('saveTournamentBtn'),
             addNewTournamentBtn: getElement('addNewTournamentBtn'),
             addTournamentStatus: getElement('addTournamentStatus'),
             tournamentsStatus: getElement('tournamentsStatus'),
             usersSection: getElement('users-section'),
             usersTableBody: getElement('usersTableBody'),
             userSearchInput: getElement('userSearchInput'),
             userModalEl: getElement('userModal'),
             userModalTitle: getElement('userModalTitle'),
             userDetailUid: getElement('userDetailUid'),
             userDetailEmail: getElement('userDetailEmail'),
             userDetailName: getElement('userDetailName'),
             userDetailCreatedAt: getElement('userDetailCreatedAt'),
             userDetailBalance: getElement('userDetailBalance'),
             userDetailWinning: getElement('userDetailWinning'),
             userDetailBonus: getElement('userDetailBonus'),
             userDetailReferralCode: getElement('userDetailReferralCode'),
             userDetailReferredBy: getElement('userDetailReferredBy'),
             userDetailReferredCount: getElement('userDetailReferredCount'),
             userDetailStatus: getElement('userDetailStatus'),
             updateBalanceForm: getElement('updateBalanceForm'),
             editUserUid: getElement('editUserUid'),
             balanceUpdateAmountInput: getElement('balanceUpdateAmount'),
             balanceUpdateTypeSelect: getElement('balanceUpdateType'),
             balanceUpdateReasonInput: getElement('balanceUpdateReason'),
             balanceUpdateStatus: getElement('balanceUpdateStatus'),
             userBlockBtn: getElement('userBlockBtn'),
             userDeleteBtn: getElement('userDeleteBtn'),
             addUserModalEl: getElement('addUserModal'),
             addUserForm: getElement('addUserForm'),
             newUserNameInput: getElement('newUserName'),
             newUserEmailInput: getElement('newUserEmail'),
             newUserPasswordInput: getElement('newUserPassword'),
             newUserInitialBalanceInput: getElement('newUserInitialBalance'),
             saveNewUserBtn: getElement('saveNewUserBtn'),
             addUserStatus: getElement('addUserStatus'),
             usersStatus: getElement('usersStatus'),
             pendingWithdrawalsTableBody: getElement('pendingWithdrawalsTableBody'),
             completedWithdrawalsTableBody: getElement('completedWithdrawalsTableBody'),
             rejectedWithdrawalsTableBody: getElement('rejectedWithdrawalsTableBody'),
             withdrawalActionModalEl: getElement('withdrawalActionModal'),
             withdrawalDetailId: getElement('withdrawalDetailId'),
             withdrawalDetailUser: getElement('withdrawalDetailUser'),
             withdrawalDetailUserUid: getElement('withdrawalDetailUserUid'),
             withdrawalDetailAmount: getElement('withdrawalDetailAmount'),
             withdrawalDetailMethod: getElement('withdrawalDetailMethod'),
             withdrawalRejectReasonDiv: getElement('withdrawalRejectReasonDiv'),
             withdrawalRejectReasonInput: getElement('withdrawalRejectReason'),
             withdrawalApproveNoteDiv: getElement('withdrawalApproveNoteDiv'),
             withdrawalApproveNoteInput: getElement('withdrawalApproveNote'),
             withdrawalActionStatus: getElement('withdrawalActionStatus'),
             rejectWithdrawalBtn: getElement('rejectWithdrawalBtn'),
             approveWithdrawalBtn: getElement('approveWithdrawalBtn'),
             withdrawalsStatus: getElement('withdrawalsStatus'),
             registeredPlayersModalEl: getElement('registeredPlayersModal'),
             registeredPlayersModalTitle: getElement('registeredPlayersModalTitle'),
             registeredPlayersTournamentName: getElement('registeredPlayersTournamentName'),
             registeredPlayersTableBody: getElement('registeredPlayersTableBody'),
             registeredPlayersStatus: getElement('registeredPlayersStatus'),
             settingsSection: getElement('settings-section'),
             appSettingsForm: getElement('appSettingsForm'),
             settingLogoUrlInput: getElement('settingLogoUrl'),
             settingAppNameInput: getElement('settingAppName'),
             settingMinWithdrawInput: getElement('settingMinWithdraw'),
             settingReferralBonusInput: getElement('settingReferralBonus'),
             settingSupportContactInput: getElement('settingSupportContact'),
             settingUpiDetailsInput: getElement('settingUpiDetails'),
             settingPolicyPrivacyInput: getElement('settingPolicyPrivacy'),
             settingPolicyTermsInput: getElement('settingPolicyTerms'),
             settingPolicyRefundInput: getElement('settingPolicyRefund'),
             settingPolicyFairPlayInput: getElement('settingPolicyFairPlay'),
             settingsStatus: getElement('settingsStatus'),
             themeSection: getElement('theme-section'),
             themeStatus: getElement('themeStatus'),
             customThemeForm: getElement('customThemeForm'),
             themeColorPickers: querySelAll('#customThemeForm input[type="color"]'),
             saveThemeBtn: getElement('saveThemeBtn'),
             resetThemeBtn: getElement('resetThemeBtn'),
             previewDefaultThemeBtn: getElement('previewDefaultThemeBtn'),
             previewCrimsonThemeBtn: getElement('previewCrimsonThemeBtn'),
             previewOceanicThemeBtn: getElement('previewOceanicThemeBtn'),
             addDemoDataBtn: getElement('addDemoDataBtn'),
             transactionsSection: getElement('transactions-section'),
             depositsStatus: getElement('depositsStatus'),
             pendingDepositCountBadge: getElement('pendingDepositCountBadge'),
             pendingDepositsTableBody: getElement('pendingDepositsTableBody'),
             approvedDepositsTableBody: getElement('approvedDepositsTableBody'),
             rejectedDepositsTableBody: getElement('rejectedDepositsTableBody'),
             depositActionModalEl: getElement('depositActionModal'),
             depositDetailId: getElement('depositDetailId'),
             depositDetailUser: getElement('depositDetailUser'),
             depositDetailAmount: getElement('depositDetailAmount'),
             depositDetailMethod: getElement('depositDetailMethod'),
             depositDetailGameId: getElement('depositDetailGameId'),
             depositDetailTxnId: getElement('depositDetailTxnId'),
             depositRejectReasonDiv: getElement('depositRejectReasonDiv'),
             depositRejectReasonInput: getElement('depositRejectReason'),
             depositApproveNoteDiv: getElement('depositApproveNoteDiv'),
             depositApproveNoteInput: getElement('depositApproveNote'),
             depositActionStatus: getElement('depositActionStatus'),
             rejectDepositBtn: getElement('rejectDepositBtn'),
             approveDepositBtn: getElement('approveDepositBtn'),
             notificationsSection: getElement('notifications-section'),
             notificationStatus: getElement('notificationStatus'),
             sendSingleNotificationForm: getElement('sendSingleNotificationForm'),
             singleNotificationUid: getElement('singleNotificationUid'),
             singleNotificationTitle: getElement('singleNotificationTitle'),
             singleNotificationMessage: getElement('singleNotificationMessage'),
             sendBroadcastNotificationForm: getElement('sendBroadcastNotificationForm'),
             broadcastNotificationTitle: getElement('broadcastNotificationTitle'),
             broadcastNotificationMessage: getElement('broadcastNotificationMessage'),
             updatesStatus: getElement('updatesStatus'),
             updatesTableBody: getElement('updatesTableBody'),
             addNewUpdateBtn: getElement('addNewUpdateBtn'),
             updateModalEl: getElement('updateModal'),
             updateModalTitle: getElement('updateModalTitle'),
             updateForm: getElement('updateForm'),
             updateEditId: getElement('updateEditId'),
             updateTitleInput: getElement('updateTitle'),
             updateImageUrlInput: getElement('updateImageUrl'),
             saveUpdateBtn: getElement('saveUpdateBtn'),
             updateStatus: getElement('updateStatus')
        };
        
        let componentInstances = {};
        const getComponentInstance = (element, componentType = 'Modal') => { if (!element) return null; const instanceKey = `${componentType}-${element.id}`; if (!componentInstances[instanceKey]) { try { if (componentType === 'Modal') componentInstances[instanceKey] = new bootstrap.Modal(element); else if (componentType === 'Offcanvas') componentInstances[instanceKey] = new bootstrap.Offcanvas(element); else if (componentType === 'Tab') componentInstances[instanceKey] = new bootstrap.Tab(element); else if (componentType === 'Alert') componentInstances[instanceKey] = new bootstrap.Alert(element); else if (componentType === 'Toast') componentInstances[instanceKey] = new bootstrap.Toast(element); else { console.warn("Unknown Bootstrap component type:", componentType); return null; } } catch (e) { console.error(`Error creating Bootstrap ${componentType} instance for #${element.id}:`, e); return null; } } return componentInstances[instanceKey]; }
        const getModalInstance = (element) => getComponentInstance(element, 'Modal');
        const getOffcanvasInstance = (element) => getComponentInstance(element, 'Offcanvas');
        let currentAdminUser = null;
        let currentWithdrawalAction = { id: null, type: null, userId: null };
        let currentDepositAction = { id: null, type: null, userId: null }; 
        let currentEditingItemId = null;
        let currentEditingTournamentId = null;
        let gameDataCache = {};
        let userDataCache = {};
        let fullUserDataCache = {};
        let dbListeners = {};
        let isAdminSetupComplete = false;
        let designatedAdminUid = null;
        let appSettings = {};
        const defaultTheme = {'--primary-bg':'#0F172A','--secondary-bg':'#1E293B','--card-bg':'#1E293B','--text-primary':'#E2E8F0','--text-secondary':'#94A3B8','--accent-color':'#FACC15','--primary-button-bg':'#3B82F6','--border-color':'#334155',};
        const crimsonTheme = {'--primary-bg':'#1a0005','--secondary-bg':'#2e0009','--card-bg':'#2e0009','--text-primary':'#fce7f3','--text-secondary':'#e9a8d9','--accent-color':'#f43f5e','--primary-button-bg':'#be185d','--border-color':'#500724',};
        const oceanicTheme = {'--primary-bg':'#0c1445','--secondary-bg':'#182157','--card-bg':'#182157','--text-primary':'#e0e7ff','--text-secondary':'#a5b4fc','--accent-color':'#38bdf8','--primary-button-bg':'#4338ca','--border-color':'#312e81',};
        
        function isDesignatedAdmin(user) { if (!user) return false; if (!designatedAdminUid) { console.warn("Designated Admin UID check failed: UID not loaded yet."); return false; } return user.uid === designatedAdminUid; }
        
        const showLoader = (show) => { if (elements.adminLoader) elements.adminLoader.style.display = show ? 'flex' : 'none'; };
        function showStatus(element, message, type = 'danger', autohide = 5000) { if (!element) { console.warn("showStatus called with null element for message:", message); return; } const alertId = `status-alert-${element.id || Math.random().toString(36).substring(2)}`; element.style.display = 'block'; element.innerHTML = `<div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">${sanitizeHTML(message)}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`; if (autohide && typeof autohide === 'number' && autohide > 0) { setTimeout(() => { const currentAlert = getElement(alertId); if (currentAlert) { try { const bsAlert = getComponentInstance(currentAlert, 'Alert'); if (bsAlert) bsAlert.close(); else currentAlert.remove(); } catch (e) { console.warn("Error closing alert:", e); currentAlert.remove(); } } }, autohide); } }
        function clearStatus(element) { if (!element) return; element.innerHTML = ''; }
        const formatDate = (timestamp) => { if (!timestamp) return 'N/A'; if (typeof timestamp === 'object' && timestamp.hasOwnProperty('.sv')) { return 'Pending...'; } const tsNumber = Number(timestamp); if (isNaN(tsNumber) || tsNumber <= 0) return 'Invalid Date'; try { const date = new Date(tsNumber); if (isNaN(date.getTime())) return 'Invalid Date'; return date.toLocaleString([], { dateStyle: 'short', timeStyle: 'short'}); } catch (e) { console.warn("Error formatting date:", timestamp, e); return 'Invalid Date'; } };
        const formatCurrency = (amount) => { const num = Number(amount); return isNaN(num) ? '₹--' : `₹${num.toFixed(2)}`; }
        function sanitizeHTML(str) { if (str == null) return ''; str = String(str); const temp = document.createElement('div'); temp.textContent = str; return temp.innerHTML; }
        function copyToClipboard(targetSelector) { const copyIcon = event?.target.closest('.copy-btn'); const context = copyIcon?.closest('.modal-body, tr'); const element = context?.querySelector(targetSelector); const textToCopy = element?.textContent?.trim(); if (!textToCopy) { console.warn("Copy target empty or not found:", targetSelector); return; } if (navigator.clipboard && window.isSecureContext) { navigator.clipboard.writeText(textToCopy).then(() => { const toastEl = document.createElement('div'); toastEl.className = 'toast position-fixed bottom-0 end-0 p-3 m-3 text-bg-success border-0'; toastEl.setAttribute('role', 'alert'); toastEl.setAttribute('aria-live', 'assertive'); toastEl.setAttribute('aria-atomic', 'true'); toastEl.innerHTML = '<div class="toast-body">Copied!</div>'; document.body.appendChild(toastEl); const toast = getComponentInstance(toastEl, 'Toast'); if(toast) toast.show(); toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove()); }).catch(err => { console.warn('Clipboard writeText failed: ', err); alert('Could not copy.'); }); } else { const textArea = document.createElement("textarea"); textArea.value = textToCopy; textArea.style.position = "fixed"; textArea.style.left = "-9999px"; textArea.style.top = "0"; document.body.appendChild(textArea); textArea.focus(); textArea.select(); try { document.execCommand('copy'); alert('Copied! (fallback)'); } catch (err) { console.warn('Fallback copy failed: ', err); alert('Copy failed.'); } document.body.removeChild(textArea); } }
        const tableLoadingPlaceholderHtml = (cols) => `<tr class="loading-placeholder"><td colspan="${cols}"><div class="placeholder w-100 py-3"></div></td></tr>`.repeat(3);

        function showAdminSection(sectionId) {
             elements.sections.forEach(sec => sec.classList.remove('active'));
             const targetSection = getElement(sectionId);
             if (targetSection) {
                 targetSection.classList.add('active');
                 const linkElement = querySel(`#adminSidebar .nav-link[data-section="${sectionId}"]`);
                 let title = 'Admin Panel';
                 if (linkElement) {
                     const linkText = linkElement.textContent.trim() || sectionId.replace('-section', '').replace('-', ' ');
                     title = linkText.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                     const badge = linkElement.querySelector('.badge');
                     if (badge) { title = title.replace(badge.textContent, '').trim(); }
                 }
                 if(elements.adminPageTitle) elements.adminPageTitle.textContent = title;
                 elements.sidebarLinks?.forEach(link => { link.classList.toggle('active', link.dataset.section === sectionId); });
                 loadDataForSection(sectionId);
                 const sidebar = getOffcanvasInstance(elements.sidebar);
                 if (sidebar?._isShown) sidebar.hide();
             } else {
                 console.error("Section element not found:", sectionId);
                 showAdminSection('dashboard-section');
             }
        }
        
        function loadDataForSection(sectionId) {
             if (!currentAdminUser || !isDesignatedAdmin(currentAdminUser)) {
                 console.warn("Attempted to load data without proper admin authorization.");
                 showStatus(elements.dashboardStatus, "Admin not authorized.", "danger", false);
                 return;
             }
             console.log(`Loading data for section: ${sectionId}`);
             clearStatus(elements.dashboardStatus); clearStatus(elements.gamesStatus); clearStatus(elements.promotionsStatus);
             clearStatus(elements.tournamentsStatus); clearStatus(elements.usersStatus); clearStatus(elements.withdrawalsStatus);
             clearStatus(elements.settingsStatus); clearStatus(elements.themeStatus);
             clearStatus(elements.depositsStatus); clearStatus(elements.notificationStatus); clearStatus(elements.updatesStatus);

             switch(sectionId) {
                 case 'dashboard-section': loadDashboardStats(); break;
                 case 'games-section': loadGames(); break;
                 case 'promotions-section': loadPromotions(); break;
                 case 'update-section': loadUpdates(); break;
                 case 'tournaments-section': loadTournaments(); break;
                 case 'users-section': loadUsers(); break;
                 case 'withdrawals-section':
                    loadWithdrawals('pending'); loadWithdrawals('completed'); loadWithdrawals('rejected');
                     const activeWithdrawalTab = querySel('#withdrawalTabs .nav-link.active') || getElement('pending-tab');
                     if (activeWithdrawalTab) getComponentInstance(activeWithdrawalTab, 'Tab')?.show();
                    break;
                 case 'deposits-section':
                    loadDeposits('pending'); loadDeposits('approved'); loadDeposits('rejected');
                    const activeDepositTab = querySel('#depositTabs .nav-link.active') || getElement('pending-deposit-tab');
                    if (activeDepositTab) getComponentInstance(activeDepositTab, 'Tab')?.show();
                    break;
                 case 'notifications-section': 
                    elements.sendSingleNotificationForm.reset();
                    elements.sendBroadcastNotificationForm.reset();
                    break; 
                 case 'settings-section': loadSettings(); break;
                 case 'theme-section': loadThemeSettings(); break;
                 case 'transactions-section':
                     if (elements.transactionsSection) elements.transactionsSection.innerHTML = '<div class="card-body"><h2 class="card-title">User Transactions</h2><p class="text-muted">Section under development.</p></div>';
                     break;
                 default: console.warn("Unknown section requested:", sectionId); showStatus(elements.dashboardStatus, `Unknown section requested: ${sectionId}`, "warning");
             }
         }

        async function loginAdmin(event) { event.preventDefault(); if (!auth) return; const email = elements.adminEmailInput.value; const password = elements.adminPasswordInput.value; clearStatus(elements.adminLoginStatus); showLoader(true); try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { console.error("Admin Login Error:", error); let message = `Login Failed: ${error.code}`; if (error.code === 'auth/network-request-failed') { message = "Login Failed: Network error."; } else if (['auth/invalid-credential', 'auth/wrong-password', 'auth/user-not-found', 'auth/invalid-email'].includes(error.code)) { message = "Login Failed: Invalid email or password."; } else if (error.code === 'auth/too-many-requests') { message = "Login Failed: Too many attempts."; } showStatus(elements.adminLoginStatus, message, 'danger', false); } finally { showLoader(false); } }
        async function logoutAdminUser() { if (!auth) return; showLoader(true); try { await signOut(auth); } catch (error) { console.error("Admin Logout Error:", error); alert("Logout failed: " + error.message); } }
        async function checkAdminSetup() { if (!db) return false; const adminConfigRef = ref(db, 'adminConfig'); try { console.log("Checking admin setup..."); const snapshot = await get(adminConfigRef); if (snapshot.exists()) { const d = snapshot.val(); isAdminSetupComplete = d.setupComplete === true; designatedAdminUid = d.adminUid || null; } else { isAdminSetupComplete = false; designatedAdminUid = null; } console.log("Admin setup check:", isAdminSetupComplete, "| UID:", designatedAdminUid); return isAdminSetupComplete; } catch (error) { console.error("Error checking admin setup:", error); const el = elements.loginSection?.style.display === 'block' ? elements.adminLoginStatus : elements.setupStatus; if (el) showStatus(el, `Config check error: ${error.message}. Check Rules.`, "danger", false); isAdminSetupComplete = false; designatedAdminUid = null; return false; } }
        async function setupAdmin(event) { event.preventDefault(); if (!auth || !db || isAdminSetupComplete) return; const email = elements.setupEmailInput.value.trim(); const password = elements.setupPasswordInput.value; clearStatus(elements.setupStatus); if (password.length < 6) { showStatus(elements.setupStatus, "Password min 6 chars.", "warning"); return; } showLoader(true); try { const cred = await createUserWithEmailAndPassword(auth, email, password); const uid = cred.user.uid; console.log("Admin user created in Auth:", uid); await set(ref(db, 'adminConfig'), { setupComplete: true, adminUid: uid }); console.log("Admin setup complete in DB."); isAdminSetupComplete = true; designatedAdminUid = uid; await signOut(auth); alert("Admin account created! Please login now."); await handleInitialLoad(); } catch (error) { console.error("Admin Setup Error:", error); let message = `Setup failed: ${error.message}`; if (error.code === 'auth/email-already-in-use') message = "Email already in use."; else if (error.code === 'auth/weak-password') message = "Password is too weak."; else if (error.code === 'auth/invalid-email') message = "Invalid email format."; else if (error.code === 'permission-denied') message = "Setup failed: Permission denied writing config. Check Firebase Rules for '/adminConfig'."; showStatus(elements.setupStatus, message, "danger", false); isAdminSetupComplete = false; designatedAdminUid = null; } finally { showLoader(false); } }
        async function handleInitialLoad() { if (!auth || !db) return; showLoader(true); await checkAdminSetup(); elements.setupSection.style.display = 'none'; elements.loginSection.style.display = 'none'; elements.mainArea.style.display = 'none'; elements.authContainer.style.display = 'block'; if (!isAdminSetupComplete) { elements.setupSection.style.display = 'block'; console.log("Showing Setup Form"); } else { elements.loginSection.style.display = 'block'; console.log("Showing Login Form"); } showLoader(false); }
        async function handleAdminAuthStateChange(user) { if (!auth || !db) return; console.log("Auth State Changed. User:", user ? user.uid : 'null'); showLoader(true); currentAdminUser = user; detachAllAdminListeners(); if (user) { if (!designatedAdminUid) await checkAdminSetup(); if (isDesignatedAdmin(user)) { console.log("Admin Authenticated & Authorized:", user.email); if (elements.adminUserEmailDisplay) elements.adminUserEmailDisplay.textContent = user.email; elements.authContainer.style.display = 'none'; elements.mainArea.style.display = 'block'; await loadSettings(); showAdminSection('dashboard-section'); setupRealtimeAdminListeners(); } else { console.warn("Unauthorized user login attempt:", user.email, "| UID:", user.uid, "| Expected:", designatedAdminUid); alert(`Access Denied. ${user.email} is not the designated admin.`); await logoutAdminUser(); return; } } else { console.log("Auth State: Logged Out"); currentAdminUser = null; designatedAdminUid = null; isAdminSetupComplete = false; elements.mainArea.style.display = 'none'; elements.authContainer.style.display = 'block'; gameDataCache = {}; userDataCache = {}; fullUserDataCache = {}; appSettings = {}; if(elements.adminHeaderLogo) { elements.adminHeaderLogo.src='https://via.placeholder.com/35/1E293B/94A3B8?text=L'; elements.adminHeaderLogo.style.display='none'; } if(elements.adminPageTitle) elements.adminPageTitle.textContent='Admin Panel'; document.title='Admin Panel'; if(elements.adminUserEmailDisplay) elements.adminUserEmailDisplay.textContent=''; Object.values(elements).filter(el => el.id?.startsWith('stat')).forEach(el => el.textContent = '--'); if(elements.pendingWithdrawalCountBadge) { elements.pendingWithdrawalCountBadge.textContent='0'; elements.pendingWithdrawalCountBadge.style.display='none';} if(elements.userSearchInput) elements.userSearchInput.value = ''; await handleInitialLoad(); } setTimeout(() => showLoader(false), 150); }
        
        async function loadDashboardStats() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; console.log("Loading dashboard stats..."); clearStatus(elements.dashboardStatus); Object.values(elements).filter(el => el.id?.startsWith('stat')).forEach(el => el.textContent = '...'); const usersRef = ref(db, 'users'); const gamesRef = ref(db, 'games'); const promotionsRef = ref(db, 'promotions'); const tournamentsRef = ref(db, 'tournaments'); const withdrawalsRef = ref(db, 'withdrawals'); const activeTournamentsQuery = query(tournamentsRef, orderByChild('status')); const pendingWithdrawalsQuery = query(withdrawalsRef, orderByChild('status'), equalTo('pending')); const completedWithdrawalsQuery = query(withdrawalsRef, orderByChild('status'), equalTo('completed')); const rejectedWithdrawalsQuery = query(withdrawalsRef, orderByChild('status'), equalTo('rejected')); const results = await Promise.allSettled([get(usersRef), get(gamesRef), get(promotionsRef), get(activeTournamentsQuery), get(pendingWithdrawalsQuery), get(completedWithdrawalsQuery), get(rejectedWithdrawalsQuery)]); let errorsFound = false; const setError = (element) => { element.textContent = 'Error'; errorsFound = true; }; if (results[0].status === 'fulfilled') elements.statTotalUsers.textContent = results[0].value.exists() ? results[0].value.size : 0; else { console.error("Err Users:", results[0].reason); setError(elements.statTotalUsers); showStatus(elements.dashboardStatus, `Err Users: ${results[0].reason?.message}`, "warning"); } if (results[1].status === 'fulfilled') elements.statTotalGames.textContent = results[1].value.exists() ? results[1].value.size : 0; else { console.error("Err Games:", results[1].reason); setError(elements.statTotalGames); } if (results[2].status === 'fulfilled') elements.statTotalPromotions.textContent = results[2].value.exists() ? results[2].value.size : 0; else { console.error("Err Promos:", results[2].reason); setError(elements.statTotalPromotions); } if (results[3].status === 'fulfilled') { let activeCount = 0; let finishedCount = 0; if (results[3].value.exists()) { results[3].value.forEach(child => { const status = child.val()?.status; if (status === 'ongoing' || status === 'upcoming') activeCount++; else if (status === 'completed' || status === 'result' || status === 'cancelled') finishedCount++; }); } elements.statActiveTournaments.textContent = activeCount; elements.statFinishedTournaments.textContent = finishedCount; } else { console.error("Err Tournaments:", results[3].reason); setError(elements.statActiveTournaments); setError(elements.statFinishedTournaments); if (results[3].reason?.message?.includes("index")) showStatus(elements.dashboardStatus, "WARNING: Tournament query fail. Add '.indexOn': 'status' to '/tournaments' rules.", "warning", false); else showStatus(elements.dashboardStatus, `Err Tournaments: ${results[3].reason?.message}`, "warning"); } if (results[4].status === 'fulfilled') { const count = results[4].value.exists() ? results[4].value.size : 0; elements.statPendingWithdrawals.textContent = count; elements.pendingWithdrawalCountBadge.textContent = count; elements.pendingWithdrawalCountBadge.style.display = count > 0 ? 'inline-block' : 'none'; } else { console.error("Err Pending Withdrawals:", results[4].reason); setError(elements.statPendingWithdrawals); elements.pendingWithdrawalCountBadge.textContent = 'Err'; elements.pendingWithdrawalCountBadge.style.display = 'inline-block'; if (results[4].reason?.message?.includes("index")) showStatus(elements.dashboardStatus, "CRITICAL: Pending withdrawal query fail. Add '.indexOn': 'status' to '/withdrawals' rules.", "danger", false); else showStatus(elements.dashboardStatus, `Err Pending Withdrawals: ${results[4].reason?.message}`, "warning"); } if (results[5].status === 'fulfilled') elements.statCompletedWithdrawals.textContent = results[5].value.exists() ? results[5].value.size : 0; else { console.error("Err Completed Withdrawals:", results[5].reason); setError(elements.statCompletedWithdrawals); if (results[5].reason?.message?.includes("index")) showStatus(elements.dashboardStatus, "WARNING: Completed withdrawal query fail. Add '.indexOn': 'status' to '/withdrawals' rules.", "warning", false); } if (results[6].status === 'fulfilled') elements.statRejectedWithdrawals.textContent = results[6].value.exists() ? results[6].value.size : 0; else { console.error("Err Rejected Withdrawals:", results[6].reason); setError(elements.statRejectedWithdrawals); if (results[6].reason?.message?.includes("index")) showStatus(elements.dashboardStatus, "WARNING: Rejected withdrawal query fail. Add '.indexOn': 'status' to '/withdrawals' rules.", "warning", false); } console.log("Dashboard stats loading complete.", errorsFound ? "Errors occurred." : "");}
        async function loadGames() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; const gamesRef = ref(db, 'games'); elements.gamesTableBody.innerHTML = tableLoadingPlaceholderHtml(4); gameDataCache = {}; clearStatus(elements.gamesStatus); try { const snapshot = await get(gamesRef); let tableHtml = ''; if (snapshot.exists()) { snapshot.forEach(childSnapshot => { const gameId = childSnapshot.key; const game = childSnapshot.val(); if (game && game.name) { gameDataCache[gameId] = game.name; tableHtml += `<tr><td><img src="${sanitizeHTML(game.imageUrl || 'https://via.placeholder.com/60x40/1E293B/94A3B8?text=N/A')}" alt="${sanitizeHTML(game.name)}" class="preview-img"></td><td>${sanitizeHTML(game.name)}</td><td><small class="text-muted">${sanitizeHTML(gameId)}</small> <i class="bi bi-clipboard copy-btn ms-1" data-target="td:nth-child(3) > small" title="Copy Game ID"></i></td><td class="action-buttons"><button class="btn btn-sm btn-info btn-edit-game" data-id="${sanitizeHTML(gameId)}" title="Edit Game"><i class="bi bi-pencil-square"></i></button><button class="btn btn-sm btn-danger btn-delete-game" data-id="${sanitizeHTML(gameId)}" title="Delete Game"><i class="bi bi-trash"></i></button></td></tr>`; } else { console.warn("Skipping invalid game data:", gameId, game); } }); } elements.gamesTableBody.innerHTML = tableHtml || `<tr><td colspan="4" class="text-center p-3 text-muted">No games found. Add one using the button above.</td></tr>`; if (elements.dashboardSection?.classList.contains('active')) { elements.statTotalGames.textContent = Object.keys(gameDataCache).length; } } catch (error) { console.error("Error loading games:", error); elements.gamesTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-3 text-danger">Error loading games: ${error.message}. Check console & Rules.</td></tr>`; showStatus(elements.gamesStatus, `Error loading games: ${error.message}. Check Rules.`, 'danger', false); if (elements.dashboardSection?.classList.contains('active')) elements.statTotalGames.textContent = 'Error'; } }
        async function loadPromotions() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; const promotionsRef = ref(db, 'promotions'); elements.promotionsTableBody.innerHTML = tableLoadingPlaceholderHtml(3); clearStatus(elements.promotionsStatus); let promoCount = 0; try { const snapshot = await get(promotionsRef); let tableHtml = ''; if (snapshot.exists()) { promoCount = snapshot.size; snapshot.forEach(childSnapshot => { const promoId = childSnapshot.key; const promo = childSnapshot.val(); if (promo && promo.imageUrl) { const displayLink = promo.link ? sanitizeHTML(promo.link) : ''; const shortLink = displayLink.length > 50 ? displayLink.substring(0, 50) + '...' : displayLink; tableHtml += `<tr><td><img src="${sanitizeHTML(promo.imageUrl)}" alt="Promotion" class="preview-img"></td><td>${promo.link ? `<a href="${displayLink}" target="_blank" class="text-info" title="${displayLink}">${shortLink}</a>` : '<span class="text-muted">No Link</span>'}</td><td class="action-buttons"><button class="btn btn-sm btn-info btn-edit-promo" data-id="${sanitizeHTML(promoId)}" title="Edit Promotion"><i class="bi bi-pencil-square"></i></button><button class="btn btn-sm btn-danger btn-delete-promo" data-id="${sanitizeHTML(promoId)}" title="Delete Promotion"><i class="bi bi-trash"></i></button></td></tr>`; } else { console.warn("Skipping invalid promotion data:", promoId, promo); } }); } elements.promotionsTableBody.innerHTML = tableHtml || `<tr><td colspan="3" class="text-center p-3 text-muted">No promotions found.</td></tr>`; if (elements.dashboardSection?.classList.contains('active')) { elements.statTotalPromotions.textContent = promoCount; } } catch (error) { console.error("Error loading promotions:", error); elements.promotionsTableBody.innerHTML = `<tr><td colspan="3" class="text-center p-3 text-danger">Error loading promotions: ${error.message}. Check console & Rules.</td></tr>`; showStatus(elements.promotionsStatus, `Error loading promotions: ${error.message}. Check Rules.`, 'danger', false); if (elements.dashboardSection?.classList.contains('active')) elements.statTotalPromotions.textContent = 'Error'; } }
        async function loadTournaments() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; const tournamentsRef = ref(db, 'tournaments'); if (Object.keys(gameDataCache).length === 0) await loadGames(); elements.tournamentsTableBody.innerHTML = tableLoadingPlaceholderHtml(8); clearStatus(elements.tournamentsStatus); try { const snapshot = await get(tournamentsRef); let activeCount = 0; let finishedCount = 0; let tableHtml = ''; if (snapshot.exists()) { snapshot.forEach(childSnapshot => { const tournamentId = childSnapshot.key; const t = childSnapshot.val(); if (t && t.name && t.gameId && t.status) { const gameName = gameDataCache[t.gameId] || `<small class="text-warning" title="ID: ${t.gameId}">Unknown</small>`; let statusClass = 'secondary'; if (t.status === 'ongoing') { statusClass = 'success'; activeCount++; } else if (t.status === 'upcoming') { statusClass = 'info'; activeCount++; } else if (t.status === 'result') { statusClass = 'primary'; finishedCount++; } else if (t.status === 'completed') { statusClass = 'secondary'; finishedCount++; } else if (t.status === 'cancelled') { statusClass = 'danger'; finishedCount++; } const statusBadge = `<span class="status-badge text-bg-${statusClass}">${t.status}</span>`; const registeredCount = t.registeredPlayers ? Object.keys(t.registeredPlayers).length : 0; const maxPlayers = t.maxPlayers > 0 ? `/${t.maxPlayers}` : ''; const playersDisplay = `${registeredCount}${maxPlayers}`; tableHtml += `<tr><td>${sanitizeHTML(t.name)}</td><td>${gameName}</td><td>${formatCurrency(t.entryFee)}</td><td>${formatCurrency(t.prizePool)}</td><td>${formatDate(t.startTime)}</td><td>${statusBadge}</td><td>${playersDisplay}</td><td class="action-buttons"><button class="btn btn-sm btn-info btn-edit-tournament" data-id="${sanitizeHTML(tournamentId)}" title="Edit"><i class="bi bi-pencil-square"></i></button><button class="btn btn-sm btn-secondary btn-view-registered" data-id="${sanitizeHTML(tournamentId)}" data-name="${sanitizeHTML(t.name)}" title="View Players"><i class="bi bi-people"></i></button><button class="btn btn-sm btn-danger btn-delete-tournament" data-id="${sanitizeHTML(tournamentId)}" title="Delete"><i class="bi bi-trash"></i></button></td></tr>`; } else { console.warn("Skipping invalid tournament data:", tournamentId, t); } }); } elements.tournamentsTableBody.innerHTML = tableHtml || `<tr><td colspan="8" class="text-center p-3 text-muted">No tournaments found.</td></tr>`; if (elements.dashboardSection?.classList.contains('active')) { elements.statActiveTournaments.textContent = activeCount; elements.statFinishedTournaments.textContent = finishedCount; } } catch (error) { console.error("Error loading tournaments:", error); elements.tournamentsTableBody.innerHTML = `<tr><td colspan="8" class="text-center p-3 text-danger">Error: ${error.message}. Check Rules.</td></tr>`; showStatus(elements.tournamentsStatus, `Error loading tournaments: ${error.message}. Check Rules.`, 'danger', false); if (elements.dashboardSection?.classList.contains('active')) { elements.statActiveTournaments.textContent = 'Error'; elements.statFinishedTournaments.textContent = 'Error'; } } }
        function renderUsersTable(usersArray) { let tableHtml = ''; if (usersArray?.length > 0) { usersArray.sort((a, b) => (a.displayName || '').localeCompare(b.displayName || '', undefined, { sensitivity: 'base' })); usersArray.forEach(user => { if (user?.email && user.uid) { const status = user.status || 'active'; const statusBadge = `<span class="status-badge text-bg-${status === 'active' ? 'success' : 'danger'}">${status}</span>`; tableHtml += `<tr><td><small class="text-muted">${sanitizeHTML(user.uid)}</small> <i class="bi bi-clipboard copy-btn ms-1" data-target="td:first-child > small" title="Copy UID"></i></td><td>${sanitizeHTML(user.displayName || 'N/A')}</td><td>${sanitizeHTML(user.email)}</td><td>${formatCurrency(user.balance)}</td><td>${statusBadge}</td><td class="action-buttons"><button class="btn btn-sm btn-info btn-view-user" data-id="${sanitizeHTML(user.uid)}" title="View/Edit"><i class="bi bi-eye"></i></button><button class="btn btn-sm btn-danger btn-delete-user" data-id="${sanitizeHTML(user.uid)}" title="Delete (DB Only)"><i class="bi bi-trash"></i></button></td></tr>`; } }); } elements.usersTableBody.innerHTML = tableHtml || `<tr><td colspan="6" class="text-center p-3 text-muted">No users found matching criteria.</td></tr>`; }
        async function loadUsers() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; const usersRef = ref(db, 'users'); elements.usersTableBody.innerHTML = tableLoadingPlaceholderHtml(6); userDataCache = {}; fullUserDataCache = {}; clearStatus(elements.usersStatus); elements.userSearchInput.value = ''; const listenerKey = 'users'; if (dbListeners[listenerKey]) try { off(usersRef, 'value', dbListeners[listenerKey]); delete dbListeners[listenerKey]; console.log("Detached previous users listener."); } catch(e) { console.warn("Could not detach users listener", e); } dbListeners[listenerKey] = onValue(usersRef, (snapshot) => { console.log("Users data received via listener."); let userCount = 0; const usersArray = []; fullUserDataCache = {}; userDataCache = {}; if (snapshot.exists()) { snapshot.forEach(childSnapshot => { userCount++; const userId = childSnapshot.key; const user = childSnapshot.val(); if (user && user.email) { user.uid = userId; fullUserDataCache[userId] = user; userDataCache[userId] = { displayName: user.displayName || 'N/A', email: user.email, status: user.status || 'active', balance: user.balance || 0, winningCash: user.winningCash || 0 }; usersArray.push(user); } else { console.warn("Skipping invalid user data:", userId, user); } }); } renderUsersTable(usersArray); if (elements.dashboardSection?.classList.contains('active')) { elements.statTotalUsers.textContent = userCount; } console.log("Users table updated. Count:", userCount); }, (error) => { console.error("Error listening to users:", error); elements.usersTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-3 text-danger">Error: ${error.message}. Check Rules.</td></tr>`; showStatus(elements.usersStatus, `Error listening to users: ${error.message}. Check Rules.`, 'danger', false); fullUserDataCache = {}; userDataCache = {}; if (elements.dashboardSection?.classList.contains('active')) elements.statTotalUsers.textContent = 'Error'; try { if (dbListeners[listenerKey]) { off(usersRef, 'value', dbListeners[listenerKey]); delete dbListeners[listenerKey]; console.log("Detached failed users listener."); } } catch(e) { console.warn("Could not detach failed users listener.", e); } }); console.log("Attached new users listener."); }
        async function loadWithdrawals(status = 'pending') { if (!db || !isDesignatedAdmin(currentAdminUser)) return; const targetTableBody = getElement(`${status}WithdrawalsTableBody`); if (!targetTableBody) { console.error(`Table body not found: ${status}`); return; } const q = query(ref(db, 'withdrawals'), orderByChild('status'), equalTo(status)); targetTableBody.innerHTML = tableLoadingPlaceholderHtml(status === 'pending' ? 5 : 6); if (status === 'pending') clearStatus(elements.withdrawalsStatus); const listenerKey = `withdrawals-${status}`; if (dbListeners[listenerKey]) try { off(q, 'value', dbListeners[listenerKey]); delete dbListeners[listenerKey]; console.log(`Detached previous ${status} withdrawals listener.`); } catch (e) { console.warn(`Could not detach ${listenerKey}`, e); } dbListeners[listenerKey] = onValue(q, async (snapshot) => { console.log(`${status} withdrawals data received.`); let tableHtml = ''; let count = 0; targetTableBody.innerHTML = ''; if (snapshot.exists()) { count = snapshot.size; const userIds = new Set(); snapshot.forEach(child => { if (child.val()?.userId && !userDataCache[child.val().userId]) userIds.add(child.val().userId); }); if (userIds.size > 0) { console.log(`Fetching ${userIds.size} missing basic user details for ${status} withdrawals...`); const promises = Array.from(userIds).map(uid => get(ref(db, `users/${uid}`)).then(us => { if (us.exists()) { const u = us.val(); userDataCache[uid] = { displayName: u.displayName || 'N/A', email: u.email || uid, status: u.status || 'unknown' }; } else { userDataCache[uid] = { displayName: 'Unknown User', email: uid, status: 'deleted' }; } }).catch(err => { console.warn(`Failed fetch user ${uid}`, err); userDataCache[uid] = { displayName: 'Error Fetching', email: uid, status: 'error' }; })); await Promise.allSettled(promises); console.log("Missing user details fetch complete."); } const withdrawals = []; snapshot.forEach(child => withdrawals.push({ id: child.key, ...child.val() })); withdrawals.sort((a, b) => (b.requestTimestamp || 0) - (a.requestTimestamp || 0)); withdrawals.forEach(w => { if (w && w.userId && w.amount != null && w.requestTimestamp) { const user = userDataCache[w.userId] || { displayName: 'Loading...', email: w.userId, status: 'unknown' }; const userDisplay = `${sanitizeHTML(user.displayName)} (<small class="text-muted" title="${w.userId}">${sanitizeHTML(user.email)}</small>)`; let methodDisplay = sanitizeHTML(w.methodDetails?.methodName || w.method || 'N/A'); if (w.methodDetails?.accountInfo) { methodDisplay += `<small class="text-muted d-block" title="${sanitizeHTML(w.methodDetails.accountInfo)}">${sanitizeHTML(String(w.methodDetails.accountInfo)).substring(0, 40)}${String(w.methodDetails.accountInfo).length > 40 ? '...' : ''}</small>`; } const requestTime = formatDate(w.requestTimestamp); const processedTime = formatDate(w.processedAt); let rowHtml = `<tr><td>${requestTime}</td>`; if (status !== 'pending') rowHtml += `<td>${processedTime}</td>`; rowHtml += `<td>${userDisplay}</td><td>${formatCurrency(w.amount)}</td><td>${methodDisplay}</td>`; if (status === 'pending') { rowHtml += `<td class="action-buttons"><button class="btn btn-sm btn-success btn-approve-withdrawal" data-id="${sanitizeHTML(w.id)}" data-userid="${sanitizeHTML(w.userId)}" title="Approve"><i class="bi bi-check-circle"></i></button> <button class="btn btn-sm btn-danger btn-reject-withdrawal" data-id="${sanitizeHTML(w.id)}" data-userid="${sanitizeHTML(w.userId)}" title="Reject"><i class="bi bi-x-circle"></i></button></td>`; } else if (status === 'completed') { const note = sanitizeHTML(w.adminNote || ''); rowHtml += `<td><small title="${note}">${note.substring(0, 30)}${ note.length > 30 ? '...' : ''}</small></td>`; } else if (status === 'rejected') { const reason = sanitizeHTML(w.rejectReason || ''); rowHtml += `<td><small title="${reason}">${reason.substring(0, 30)}${ reason.length > 30 ? '...' : ''}</small></td>`; } rowHtml += `</tr>`; tableHtml += rowHtml; } else { console.warn(`Skipping invalid ${status} withdrawal:`, w.id, w); } }); } const emptyColspan = status === 'pending' ? 5 : 6; targetTableBody.innerHTML = tableHtml || `<tr><td colspan="${emptyColspan}" class="text-center p-3 text-muted">No ${status} withdrawals found.</td></tr>`; if (status === 'pending') { if (elements.pendingWithdrawalCountBadge) { elements.pendingWithdrawalCountBadge.textContent = count; elements.pendingWithdrawalCountBadge.style.display = count > 0 ? 'inline-block' : 'none'; } if (elements.dashboardSection?.classList.contains('active') && elements.statPendingWithdrawals) elements.statPendingWithdrawals.textContent = count; } else if (status === 'completed' && elements.dashboardSection?.classList.contains('active') && elements.statCompletedWithdrawals) { elements.statCompletedWithdrawals.textContent = count; } else if (status === 'rejected' && elements.dashboardSection?.classList.contains('active') && elements.statRejectedWithdrawals) { elements.statRejectedWithdrawals.textContent = count; } console.log(`${status} withdrawals table updated. Count:`, count); }, (error) => { console.error(`Error listening to ${status} withdrawals:`, error); const errorColspan = status === 'pending' ? 5 : 6; targetTableBody.innerHTML = `<tr><td colspan="${errorColspan}" class="text-center p-3 text-danger">Error loading: ${error.message}. Check Rules/Index.</td></tr>`; showStatus(elements.withdrawalsStatus, `Error loading ${status} withdrawals: ${error.message}. Check Rules/Index.`, 'danger', false); if (status === 'pending') { if (error?.message?.includes("index")) showStatus(elements.withdrawalsStatus, "CRITICAL: Pending query fail. Add '.indexOn': 'status' to '/withdrawals' rules.", "danger", false); if(elements.pendingWithdrawalCountBadge){ elements.pendingWithdrawalCountBadge.textContent = 'Err'; elements.pendingWithdrawalCountBadge.style.display = 'inline-block';} if (elements.dashboardSection?.classList.contains('active')) elements.statPendingWithdrawals.textContent = 'Error'; } else if (status === 'completed' && elements.dashboardSection?.classList.contains('active')) elements.statCompletedWithdrawals.textContent = 'Error'; else if (status === 'rejected' && elements.dashboardSection?.classList.contains('active')) elements.statRejectedWithdrawals.textContent = 'Error'; try { if (dbListeners[listenerKey]) { off(q, 'value', dbListeners[listenerKey]); delete dbListeners[listenerKey]; console.log(`Detached failed ${status} listener.`); } } catch(e) { console.warn(`Could not detach failed ${status} listener.`, e); } }); console.log(`Attached new listener for ${status} withdrawals.`); }
        async function loadSettings() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; console.log("Loading settings..."); elements.appSettingsForm?.querySelectorAll('input, textarea, button').forEach(el => el.disabled = true); clearStatus(elements.settingsStatus); try { const snapshot = await get(ref(db, 'settings')); if (snapshot.exists()) { appSettings = snapshot.val() || {}; elements.settingLogoUrlInput.value = appSettings.logoUrl || ''; elements.settingAppNameInput.value = appSettings.appName || ''; elements.settingMinWithdrawInput.value = appSettings.minWithdraw || 0; elements.settingReferralBonusInput.value = appSettings.referralBonus || 0; elements.settingSupportContactInput.value = appSettings.supportContact || ''; elements.settingUpiDetailsInput.value = appSettings.upiDetails || ''; elements.settingPolicyPrivacyInput.value = appSettings.policyPrivacy || ''; elements.settingPolicyTermsInput.value = appSettings.policyTerms || ''; elements.settingPolicyRefundInput.value = appSettings.policyRefund || ''; elements.settingPolicyFairPlayInput.value = appSettings.policyFairPlay || ''; if(elements.adminHeaderLogo) { const logoUrl = appSettings.logoUrl; elements.adminHeaderLogo.src = logoUrl || 'https://via.placeholder.com/35/1E293B/94A3B8?text=L'; elements.adminHeaderLogo.style.display = logoUrl ? 'inline-block' : 'none'; elements.adminHeaderLogo.alt = appSettings.appName ? `${appSettings.appName} Logo` : 'Logo'; } document.title = `${appSettings.appName || 'Gaming Tournament'} - Admin Panel`; console.log("Settings loaded and applied."); } else { console.log("No settings found."); showStatus(elements.settingsStatus, "No settings found. Please configure.", "info", false); elements.appSettingsForm.reset(); appSettings = {}; if(elements.adminHeaderLogo) elements.adminHeaderLogo.style.display = 'none'; document.title = 'Admin Panel'; } } catch (error) { console.error("Error loading settings:", error); showStatus(elements.settingsStatus, `Error loading settings: ${error.message}. Check Rules.`, "danger", false); appSettings = {}; if(elements.adminHeaderLogo) elements.adminHeaderLogo.style.display = 'none'; document.title = 'Admin Panel'; } finally { elements.appSettingsForm?.querySelectorAll('input, textarea, button').forEach(el => el.disabled = false); } }
        
        const IMGBB_API_KEY = '1579b196953465c653d3639ab091448c';
        async function uploadToImgBB(file, statusElement) { if (!file) throw new Error("File not selected."); if (!IMGBB_API_KEY || IMGBB_API_KEY === 'YOUR_IMGBB_API_KEY') { console.error("ImgBB API Key missing or is a placeholder!"); throw new Error("ImgBB API Key not set."); } const formData = new FormData(); formData.append('image', file); if (statusElement) { statusElement.textContent = 'Uploading...'; statusElement.style.color = 'var(--text-secondary)'; statusElement.style.display = 'block'; } try { const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData }); if (!response.ok) { let errorMsg = `ImgBB upload failed: HTTP ${response.status}`; try { const errorData = await response.json(); errorMsg += ` - ${errorData?.error?.message || response.statusText}`; } catch (e) {} throw new Error(errorMsg); } const data = await response.json(); if (data.success) { console.log('ImgBB upload successful. URL:', data.data.url); if (statusElement) statusElement.textContent = 'Upload complete!'; return data.data.url; } else { console.error('ImgBB upload failed:', data); throw new Error(`ImgBB upload failed: ${data.error?.message || 'Unknown error'}`); } } catch (error) { console.error('ImgBB Fetch error:', error); if (statusElement) { statusElement.textContent = `Upload Error: ${error.message}`; statusElement.style.color = 'var(--danger-color)'; } throw error; } }
        async function saveGame() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; const gameId = elements.gameEditId.value; const isEditing = !!gameId; const name = elements.gameNameInput.value.trim(); const imageUrlInput = elements.gameImageUrlInput.value.trim(); const imageFile = elements.gameImageFileInput.files[0]; const statusEl = elements.gameStatus; const imgbbStatusEl = elements.gameForm?.querySelector('.imgbb-upload-status'); clearStatus(statusEl); if (imgbbStatusEl) { imgbbStatusEl.textContent = ''; imgbbStatusEl.style.display = 'none'; } if (!name) { showStatus(statusEl, "Game Name is required.", "warning"); return; } if (!imageUrlInput && !imageFile && !isEditing) { showStatus(statusEl, "Image URL or File Upload required for new game.", "warning"); return; } if (!imageUrlInput && !imageFile && isEditing) { showStatus(statusEl, "Image URL cannot be empty when editing.", "warning"); return; } showLoader(true); elements.saveGameBtn.disabled = true; let finalImageUrl = imageUrlInput; try { if (imageFile) { finalImageUrl = await uploadToImgBB(imageFile, imgbbStatusEl); } if (!finalImageUrl) { throw new Error("Image URL is missing after potential upload."); } const gameData = { name: name, imageUrl: finalImageUrl }; if (isEditing) { gameData.updatedAt = serverTimestamp(); const gameRef = ref(db, `games/${gameId}`); await update(gameRef, gameData); console.log("Game updated successfully:", gameId); showStatus(elements.gamesStatus, "Game updated successfully!", "success", 3000); } else { gameData.createdAt = serverTimestamp(); const newGameRef = push(ref(db, 'games')); await set(newGameRef, gameData); console.log("Game added successfully, key:", newGameRef.key); showStatus(elements.gamesStatus, "Game added successfully!", "success", 3000); } elements.gameForm.reset(); elements.gameEditId.value = ''; if (imgbbStatusEl) { imgbbStatusEl.textContent = ''; imgbbStatusEl.style.display = 'none'; } getModalInstance(elements.gameModalEl)?.hide(); loadGames(); } catch (error) { console.error("Error saving game:", error); showStatus(statusEl, `Error saving game: ${error.message}. Check console & Rules.`, "danger", false); if (imgbbStatusEl && !imgbbStatusEl.textContent.includes('Error')) { imgbbStatusEl.style.display = 'none'; } } finally { showLoader(false); elements.saveGameBtn.disabled = false; } }
        async function savePromotion() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; const promoId = elements.promotionEditId.value; const isEditing = !!promoId; const promoLink = elements.promoLinkInput.value.trim(); const imageUrlInput = elements.promoImageUrlInput.value.trim(); const imageFile = elements.promoImageFileInput.files[0]; const statusEl = elements.promotionStatus; const imgbbStatusEl = elements.promotionForm?.querySelector('.imgbb-upload-status'); clearStatus(statusEl); if (imgbbStatusEl) { imgbbStatusEl.textContent = ''; imgbbStatusEl.style.display = 'none'; } if (!imageUrlInput && !imageFile && !isEditing) { showStatus(statusEl, "Image URL or File Upload required for new promotion.", "warning"); return; } if (!imageUrlInput && !imageFile && isEditing) { showStatus(statusEl, "Image URL cannot be empty when editing.", "warning"); return; } showLoader(true); elements.savePromotionBtn.disabled = true; let finalImageUrl = imageUrlInput; try { if (imageFile) { finalImageUrl = await uploadToImgBB(imageFile, imgbbStatusEl); } if (!finalImageUrl) { throw new Error("Image URL is missing after potential upload."); } const promoData = { imageUrl: finalImageUrl, link: promoLink || null }; if (isEditing) { promoData.updatedAt = serverTimestamp(); const promoRef = ref(db, `promotions/${promoId}`); await update(promoRef, promoData); console.log("Promotion updated successfully:", promoId); showStatus(elements.promotionsStatus, "Promotion updated successfully!", "success", 3000); } else { promoData.createdAt = serverTimestamp(); const newPromoRef = push(ref(db, 'promotions')); await set(newPromoRef, promoData); console.log("Promotion added successfully, key:", newPromoRef.key); showStatus(elements.promotionsStatus, "Promotion added successfully!", "success", 3000); } elements.promotionForm.reset(); elements.promotionEditId.value = ''; if (imgbbStatusEl) { imgbbStatusEl.textContent = ''; imgbbStatusEl.style.display = 'none'; } getModalInstance(elements.promotionModalEl)?.hide(); loadPromotions(); } catch (error) { console.error("Error saving promotion:", error); showStatus(statusEl, `Error saving promotion: ${error.message}. Check console & Rules.`, "danger", false); if (imgbbStatusEl && !imgbbStatusEl.textContent.includes('Error')) { imgbbStatusEl.style.display = 'none'; } } finally { showLoader(false); elements.savePromotionBtn.disabled = false; } }
        
        // MODIFIED: This function now correctly saves room ID and password.
        async function saveTournament(event) {
            event.preventDefault();
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            const statusEl = elements.addTournamentStatus;
            clearStatus(statusEl);
            
            const gameId = elements.tournamentGameSelect.value;
            const name = elements.tournamentNameInput.value.trim();
            const startTimeStr = elements.tournamentStartTimeInput.value;
            
            if (!gameId || !name || !startTimeStr) {
                showStatus(statusEl, "Game, Name, and Start Time are required.", "warning");
                return;
            }
        
            let startTimeTimestamp;
            try {
                startTimeTimestamp = new Date(startTimeStr).getTime();
                if (isNaN(startTimeTimestamp)) throw new Error('Invalid Date');
            } catch (e) {
                showStatus(statusEl, "Invalid Start Date & Time format.", "warning");
                return;
            }
        
            const entryFee = parseFloat(elements.tournamentEntryFeeInput.value) || 0;
            const prizePool = parseFloat(elements.tournamentPrizePoolInput.value) || 0;
            const perKillPrize = parseFloat(elements.tournamentPerKillInput.value) || 0;
            const maxPlayers = parseInt(elements.tournamentMaxPlayersInput.value) || 0;
        
            const tournamentData = {
                gameId: gameId,
                name: name,
                startTime: startTimeTimestamp,
                status: elements.tournamentStatusSelect.value,
                entryFee: entryFee,
                prizePool: prizePool,
                perKillPrize: perKillPrize,
                maxPlayers: maxPlayers,
                tags: elements.tournamentTagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag),
                mode: elements.tournamentModeInput.value.trim(),
                map: elements.tournamentMapInput.value.trim(),
                description: elements.tournamentDescriptionInput.value.trim(),
                // MODIFIED: Added Room ID and Password to the data object
                roomId: elements.tournamentRoomIdInput.value.trim() || null,
                roomPassword: elements.tournamentRoomPasswordInput.value.trim() || null,
                showIdPass: elements.tournamentShowIdPassCheckbox.checked,
                updatedAt: serverTimestamp()
            };
        
            showLoader(true);
            elements.saveTournamentBtn.disabled = true;
        
            try {
                if (currentEditingTournamentId) {
                    const tRef = ref(db, `tournaments/${currentEditingTournamentId}`);
                    await update(tRef, tournamentData);
                    console.log("Tournament updated:", currentEditingTournamentId);
                    showStatus(elements.tournamentsStatus, "Tournament updated successfully!", "success", 3000);
                } else {
                    tournamentData.createdAt = serverTimestamp();
                    const newRef = push(ref(db, 'tournaments'));
                    await set(newRef, tournamentData);
                    console.log("Tournament added:", newRef.key);
                    showStatus(elements.tournamentsStatus, "Tournament added successfully!", "success", 3000);
                }
                elements.tournamentForm.reset();
                currentEditingTournamentId = null;
                getModalInstance(elements.addTournamentModalEl)?.hide();
                loadTournaments();
                loadDashboardStats();
            } catch (error) {
                console.error("Error saving tournament:", error);
                showStatus(statusEl, `Error: ${error.message}. Check Rules.`, "danger", false);
            } finally {
                showLoader(false);
                elements.saveTournamentBtn.disabled = false;
            }
        }

        async function deleteGame(gameId) { if (!db || !gameId || !isDesignatedAdmin(currentAdminUser)) return; if (!confirm(`DELETE Game ID: ${gameId}? Removes DB entry. Image on ImgBB NOT deleted. OK?`)) return; showLoader(true); const statusEl = elements.gamesStatus; clearStatus(statusEl); try { await remove(ref(db, `games/${gameId}`)); console.log("Game deleted from DB:", gameId); delete gameDataCache[gameId]; showStatus(statusEl, "Game data deleted.", "success", 3000); loadGames(); loadDashboardStats(); } catch (error) { console.error("Error deleting game:", error); showStatus(statusEl, `Error deleting game: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); } }
        async function deletePromotion(promoId) { if (!db || !promoId || !isDesignatedAdmin(currentAdminUser)) return; if (!confirm(`DELETE Promotion ID: ${promoId}? Removes DB entry. Image on ImgBB NOT deleted. OK?`)) return; showLoader(true); const statusEl = elements.promotionsStatus; clearStatus(statusEl); try { await remove(ref(db, `promotions/${promoId}`)); console.log("Promotion deleted from DB:", promoId); showStatus(statusEl, "Promotion data deleted.", "success", 3000); loadPromotions(); loadDashboardStats(); } catch (error) { console.error("Error deleting promotion:", error); showStatus(statusEl, `Error deleting promotion: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); } }
        async function deleteTournament(tournamentId) { if (!db || !tournamentId || !isDesignatedAdmin(currentAdminUser)) return; if (!confirm(`DELETE Tournament ID: ${tournamentId}? Cannot be undone.`)) return; showLoader(true); const statusEl = elements.tournamentsStatus; clearStatus(statusEl); try { await remove(ref(db, `tournaments/${tournamentId}`)); console.log("Tournament deleted:", tournamentId); showStatus(statusEl, "Tournament deleted.", "success", 3000); loadTournaments(); loadDashboardStats(); } catch (error) { console.error("Error deleting tournament:", error); showStatus(statusEl, `Error: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); } }
        async function saveNewUser() { if (!auth || !db || !isDesignatedAdmin(currentAdminUser)) return; const statusEl = elements.addUserStatus; clearStatus(statusEl); const name = elements.newUserNameInput.value.trim(); const email = elements.newUserEmailInput.value.trim(); const password = elements.newUserPasswordInput.value; const initialBalanceStr = elements.newUserInitialBalanceInput.value; if (!name || !email || !password) { showStatus(statusEl, "Name, Email, Password required.", "warning"); return; } if (password.length < 6) { showStatus(statusEl, "Password min 6 chars.", "warning"); return; } const initialBalance = parseFloat(initialBalanceStr) || 0; if (initialBalance < 0) { showStatus(statusEl, "Initial Balance cannot be negative.", "warning"); return; } if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showStatus(statusEl, "Invalid Email format.", "warning"); return; } showLoader(true); elements.saveNewUserBtn.disabled = true; try { const referralCode = Math.random().toString(36).substring(2, 10).toUpperCase(); const cred = await createUserWithEmailAndPassword(auth, email, password); const uid = cred.user.uid; console.log("User created in Auth:", uid, email); const userData = { uid: uid, email: email, displayName: name, balance: initialBalance, winningCash: 0, bonusCash: 0, status: 'active', createdAt: serverTimestamp(), referralCode: referralCode, isAdmin: false, referralEarnings: 0, totalEarnings: 0, totalMatches: 0, wonMatches: 0 }; await set(ref(db, `users/${uid}`), userData); console.log("User data created in DB:", uid); showStatus(statusEl, `User ${name} created!`, "success", 4000); elements.addUserForm.reset(); getModalInstance(elements.addUserModalEl)?.hide(); loadDashboardStats(); } catch (error) { console.error("Error creating user:", error); let msg = `Error: ${error.message}`; if (error.code === 'auth/email-already-in-use') msg = "Email already registered."; else if (error.code === 'auth/weak-password') msg = "Password too weak."; else if (error.code === 'auth/invalid-email') msg = "Invalid email format."; else if (error.code === 'permission-denied') msg = "Permission denied creating user/DB entry. Check Rules."; showStatus(statusEl, msg, "danger", false); } finally { showLoader(false); elements.saveNewUserBtn.disabled = false; } }
        async function updateUserBalance(event) { event.preventDefault(); if (!db || !isDesignatedAdmin(currentAdminUser)) return; const statusEl = elements.balanceUpdateStatus; clearStatus(statusEl); const userId = elements.editUserUid.value; const amountStr = elements.balanceUpdateAmountInput.value; const type = elements.balanceUpdateTypeSelect.value; const reason = elements.balanceUpdateReasonInput.value.trim(); if (!userId || !amountStr || !type || !reason) { showStatus(statusEl, "All fields required.", "warning"); return; } const amount = parseFloat(amountStr); if (isNaN(amount) || amount === 0) { showStatus(statusEl, "Invalid or zero amount.", "warning"); return; } showLoader(true); const userRefPath = `users/${userId}`; const updates = {}; try { const userSnapshot = await get(ref(db, userRefPath)); if (!userSnapshot.exists()) throw new Error(`User ${userId} not found.`); const user = userSnapshot.val(); const currentBalance = Number(user.balance || 0); const currentWinning = Number(user.winningCash || 0); const currentBonus = Number(user.bonusCash || 0); let newBalance = currentBalance; let newWinning = currentWinning; let newBonus = currentBonus; let logType = ''; switch (type) { case 'balance': newBalance += amount; updates[`${userRefPath}/balance`] = newBalance; logType = amount > 0 ? 'admin_deposit' : 'admin_deduction'; break; case 'winningCash': newWinning += amount; newBalance += amount; if (newWinning < 0) throw new Error("Winning cash cannot be negative."); updates[`${userRefPath}/winningCash`] = newWinning; updates[`${userRefPath}/balance`] = newBalance; logType = amount > 0 ? 'admin_winning_add' : 'admin_winning_deduct'; break; case 'bonusCash': newBonus += amount; newBalance += amount; if (newBonus < 0) throw new Error("Bonus cash cannot be negative."); updates[`${userRefPath}/bonusCash`] = newBonus; updates[`${userRefPath}/balance`] = newBalance; logType = amount > 0 ? 'admin_bonus_add' : 'admin_bonus_deduct'; break; default: throw new Error("Invalid balance type."); } if (newBalance < 0 && !confirm(`Warning: Negative total balance (${formatCurrency(newBalance)}). Proceed?`)) { showLoader(false); showStatus(statusEl, "Update cancelled.", "info"); return; } const txKey = push(ref(db, `transactions/${userId}`)).key; const txData = { type: logType, amount: amount, timestamp: serverTimestamp(), description: `Admin Update: ${reason}`, status: 'completed', balanceAfter: newBalance, adminUid: currentAdminUser.uid }; updates[`transactions/${userId}/${txKey}`] = txData; await update(ref(db), updates); console.log(`Balance updated for ${userId}. New Bal: ${newBalance}, Win: ${newWinning}, Bonus: ${newBonus}`); elements.userDetailBalance.textContent = newBalance.toFixed(2); elements.userDetailWinning.textContent = newWinning.toFixed(2); elements.userDetailBonus.textContent = newBonus.toFixed(2); if (fullUserDataCache[userId]) { fullUserDataCache[userId].balance = newBalance; fullUserDataCache[userId].winningCash = newWinning; fullUserDataCache[userId].bonusCash = newBonus; } if (userDataCache[userId]) { userDataCache[userId].balance = newBalance; userDataCache[userId].winningCash = newWinning; } showStatus(statusEl, "Balance updated!", "success", 3000); elements.updateBalanceForm.reset(); } catch (error) { console.error("Error updating balance:", error); showStatus(statusEl, `Error: ${error.message}`, "danger", false); } finally { showLoader(false); } }
        async function toggleUserBlock(event) { const button = event.target.closest('button'); if (!button || !db || !isDesignatedAdmin(currentAdminUser)) return; const userId = button.dataset.id; const currentAction = button.dataset.action; if (!userId || !currentAction) return; const newStatus = currentAction === 'block' ? 'blocked' : 'active'; if (!confirm(`Confirm ${currentAction} user ${userId}?`)) return; showLoader(true); button.disabled = true; const modalVisible = getModalInstance(elements.userModalEl)?._isShown; const statusEl = modalVisible && elements.editUserUid.value === userId ? elements.balanceUpdateStatus : elements.usersStatus; clearStatus(statusEl); try { await set(ref(db, `users/${userId}/status`), newStatus); console.log(`User ${userId} status set to ${newStatus}`); if (fullUserDataCache[userId]) fullUserDataCache[userId].status = newStatus; if (userDataCache[userId]) userDataCache[userId].status = newStatus; showStatus(statusEl, `User ${newStatus} successfully!`, "success", 3000); if (modalVisible && elements.editUserUid.value === userId) { elements.userDetailStatus.textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1); elements.userDetailStatus.className = `fw-bold text-${newStatus === 'active' ? 'success' : 'danger'}`; button.textContent = newStatus === 'active' ? 'Block User' : 'Unblock User'; button.className = `btn btn-sm ${newStatus === 'active' ? 'btn-danger' : 'btn-success'}`; button.dataset.action = newStatus === 'active' ? 'block' : 'unblock'; } filterUsers(); } catch (error) { console.error(`Error ${currentAction}ing user:`, error); showStatus(statusEl, `Error ${currentAction}ing user: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); button.disabled = false; } }
        async function deleteUser(userId) { if (!db || !userId || !isDesignatedAdmin(currentAdminUser)) return; const userName = fullUserDataCache[userId]?.displayName || fullUserDataCache[userId]?.email || userId; if (!confirm(`DELETE USER: ${userName} (UID: ${userId})?\n\nWARNING:\n- Removes user data from Realtime Database ONLY.\n- DOES NOT delete from Firebase Auth.\n- Associated data (transactions, etc.) may be orphaned.\n\nCannot be undone. Proceed?`)) return; showLoader(true); const statusEl = elements.usersStatus; clearStatus(statusEl); const modal = getModalInstance(elements.userModalEl); if (modal?._isShown) modal.hide(); try { await remove(ref(db, `users/${userId}`)); console.log("User deleted from DB:", userId); delete fullUserDataCache[userId]; delete userDataCache[userId]; showStatus(statusEl, `User ${userName} deleted from Database.`, "success", 5000); filterUsers(); loadDashboardStats(); } catch (error) { console.error("Error deleting user from DB:", error); showStatus(statusEl, `Error deleting user data: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); } }
        async function openWithdrawalActionModal(withdrawalId, type) { if (!db || !withdrawalId || !type || !isDesignatedAdmin(currentAdminUser)) return; console.log(`Opening withdrawal modal: ${withdrawalId}, Action: ${type}`); showLoader(true); currentWithdrawalAction = { id: withdrawalId, type: type, userId: null }; elements.withdrawalRejectReasonInput.value = ''; elements.withdrawalApproveNoteInput.value = ''; elements.withdrawalRejectReasonDiv.style.display = 'none'; elements.withdrawalApproveNoteDiv.style.display = 'none'; elements.withdrawalRejectReasonInput.required = false; elements.withdrawalApproveNoteInput.required = false; clearStatus(elements.withdrawalActionStatus); elements.approveWithdrawalBtn.style.display = 'inline-block'; elements.rejectWithdrawalBtn.style.display = 'inline-block'; elements.approveWithdrawalBtn.disabled = false; elements.rejectWithdrawalBtn.disabled = false; const withdrawalRef = ref(db, `withdrawals/${withdrawalId}`); try { const snapshot = await get(withdrawalRef); if (!snapshot.exists()) throw new Error(`Withdrawal ${withdrawalId} not found.`); const w = snapshot.val(); currentWithdrawalAction.userId = w.userId; if (w.status !== 'pending') { alert(`Request already processed (Status: ${w.status}).`); showLoader(false); return; } let userDisplay = `UID: ${w.userId}`; const userId = w.userId; if (userId && userDataCache[userId]) { const u = userDataCache[userId]; userDisplay = `${sanitizeHTML(u.displayName)} (<small class="text-muted" title="${userId}">${sanitizeHTML(u.email)}</small>)`; } else if (userId) { try { const userSnap = await get(ref(db, `users/${userId}`)); if (userSnap.exists()) { const u = userSnap.val(); userDataCache[userId] = { displayName: u.displayName || 'N/A', email: u.email || userId, status: u.status || 'unknown' }; userDisplay = `${sanitizeHTML(u.displayName)} (<small class="text-muted" title="${userId}">${sanitizeHTML(u.email)}</small>)`; } else { userDataCache[userId] = { displayName: 'Unknown User', email: userId, status: 'deleted' }; userDisplay = `Unknown User (<small class="text-muted" title="${userId}">${userId}</small>)`; } } catch (err) { console.warn(`Could not fetch user ${userId}`, err); userDataCache[userId] = { displayName: 'Error Fetching', email: userId, status: 'error' }; userDisplay = `Error Fetching (<small class="text-muted" title="${userId}">${userId}</small>)`; } } let methodDisplay = sanitizeHTML(w.methodDetails?.methodName || w.method || 'N/A'); if (w.methodDetails?.accountInfo) methodDisplay += ` - ${sanitizeHTML(w.methodDetails.accountInfo)}`; elements.withdrawalDetailId.textContent = withdrawalId; elements.withdrawalDetailUser.innerHTML = userDisplay; elements.withdrawalDetailUserUid.textContent = userId || 'N/A'; elements.withdrawalDetailAmount.textContent = (w.amount || 0).toFixed(2); elements.withdrawalDetailMethod.textContent = methodDisplay; if (type === 'reject') { elements.withdrawalRejectReasonDiv.style.display = 'block'; elements.withdrawalRejectReasonInput.required = true; elements.approveWithdrawalBtn.style.display = 'none'; } else { elements.withdrawalApproveNoteDiv.style.display = 'block'; elements.rejectWithdrawalBtn.style.display = 'none'; } getModalInstance(elements.withdrawalActionModalEl)?.show(); } catch (error) { console.error("Error opening withdrawal modal:", error); alert(`Error fetching details: ${error.message}`); showStatus(elements.withdrawalsStatus, `Error fetching details: ${error.message}`, 'danger', false); } finally { showLoader(false); } }
        async function processWithdrawalAction() { if (!db || !currentWithdrawalAction.id || !currentWithdrawalAction.type || !currentWithdrawalAction.userId || !isDesignatedAdmin(currentAdminUser)) { console.error("Withdrawal details missing or unauthorized."); showStatus(elements.withdrawalActionStatus, "Internal error/unauthorized.", "danger", false); return; } const statusEl = elements.withdrawalActionStatus; clearStatus(statusEl); const withdrawalId = currentWithdrawalAction.id; const actionType = currentWithdrawalAction.type; const userId = currentWithdrawalAction.userId; const updates = {}; const withdrawalRefPath = `withdrawals/${withdrawalId}`; let reason = ''; let adminNote = ''; let logType = ''; let logStatus = 'failed'; let refundRequired = false; showLoader(true); elements.approveWithdrawalBtn.disabled = true; elements.rejectWithdrawalBtn.disabled = true; try { const wSnapshot = await get(ref(db, withdrawalRefPath)); if (!wSnapshot.exists()) throw new Error("Withdrawal request not found."); const wData = wSnapshot.val(); const amount = Number(wData.amount || 0); if (wData.status !== 'pending') throw new Error(`Request already processed (Status: ${wData.status}).`); if (amount <= 0) throw new Error("Invalid amount."); if (actionType === 'reject') { reason = elements.withdrawalRejectReasonInput.value.trim(); if (!reason) { elements.rejectWithdrawalBtn.disabled = false; throw new Error("Rejection reason required."); } updates[`${withdrawalRefPath}/status`] = 'rejected'; updates[`${withdrawalRefPath}/rejectReason`] = reason; updates[`${withdrawalRefPath}/processedAt`] = serverTimestamp(); updates[`${withdrawalRefPath}/processedBy`] = currentAdminUser.uid; refundRequired = true; logType = 'withdrawal_rejected'; logStatus = 'completed'; } else { adminNote = elements.withdrawalApproveNoteInput.value.trim(); updates[`${withdrawalRefPath}/status`] = 'completed'; updates[`${withdrawalRefPath}/adminNote`] = adminNote || 'Approved'; updates[`${withdrawalRefPath}/processedAt`] = serverTimestamp(); updates[`${withdrawalRefPath}/processedBy`] = currentAdminUser.uid; refundRequired = false; logType = 'withdrawal_approved'; logStatus = 'completed'; } if (refundRequired) { const uSnapshot = await get(ref(db, `users/${userId}`)); if (!uSnapshot.exists()) throw new Error(`User ${userId} not found for refund.`); const user = uSnapshot.val(); const currentWinning = Number(user.winningCash || 0); const currentBalance = Number(user.balance || 0); const newWinning = currentWinning + amount; const newBalance = currentBalance + amount; updates[`users/${userId}/winningCash`] = newWinning; updates[`users/${userId}/balance`] = newBalance; const refundTxKey = push(ref(db, `transactions/${userId}`)).key; updates[`transactions/${userId}/${refundTxKey}`] = { type: 'withdrawal_refund', amount: amount, timestamp: serverTimestamp(), description: `Refund rejected withdrawal: ${withdrawalId}. Reason: ${reason}`, status: 'completed', balanceAfter: newBalance, adminUid: currentAdminUser.uid }; console.log(`Prepared refund for ${userId}. New Bal: ${newBalance}`); if (fullUserDataCache[userId]) { fullUserDataCache[userId].balance = newBalance; fullUserDataCache[userId].winningCash = newWinning; } if (userDataCache[userId]) { userDataCache[userId].balance = newBalance; userDataCache[userId].winningCash = newWinning; } } const mainTxKey = push(ref(db, `transactions/${userId}`)).key; updates[`transactions/${userId}/${mainTxKey}`] = { type: logType, amount: 0, timestamp: serverTimestamp(), description: `Withdrawal ${actionType} by admin. ID: ${withdrawalId}. ${actionType === 'reject' ? `Reason: ${reason}` : `Note: ${adminNote}`}`, status: logStatus, withdrawalId: withdrawalId, adminUid: currentAdminUser.uid }; await update(ref(db), updates); console.log(`Withdrawal ${withdrawalId} ${actionType} processed.`); showStatus(elements.withdrawalsStatus, `Withdrawal ${actionType} successfully!`, "success", 4000); getModalInstance(elements.withdrawalActionModalEl)?.hide(); loadDashboardStats(); } catch (error) { console.error("Error processing withdrawal:", error); showStatus(statusEl, `Error: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); if (getModalInstance(elements.withdrawalActionModalEl)?._isShown) { elements.approveWithdrawalBtn.disabled = false; elements.rejectWithdrawalBtn.disabled = false; } } }
        async function saveSettings(event) { event.preventDefault(); if (!db || !isDesignatedAdmin(currentAdminUser)) return; const statusEl = elements.settingsStatus; clearStatus(statusEl); const minW = parseFloat(elements.settingMinWithdrawInput.value) || 0; const refB = parseFloat(elements.settingReferralBonusInput.value) || 0; if (minW < 0 || refB < 0) { showStatus(statusEl, "Numeric values cannot be negative.", "warning"); return; } const settingsData = { logoUrl: elements.settingLogoUrlInput.value.trim(), appName: elements.settingAppNameInput.value.trim(), minWithdraw: minW, referralBonus: refB, supportContact: elements.settingSupportContactInput.value.trim(), upiDetails: elements.settingUpiDetailsInput.value.trim(), policyPrivacy: elements.settingPolicyPrivacyInput.value.trim(), policyTerms: elements.settingPolicyTermsInput.value.trim(), policyRefund: elements.settingPolicyRefundInput.value.trim(), policyFairPlay: elements.settingPolicyFairPlayInput.value.trim(), lastUpdated: serverTimestamp() }; showLoader(true); elements.appSettingsForm?.querySelectorAll('input, textarea, button').forEach(el => el.disabled = true); try { await set(ref(db, 'settings'), settingsData); appSettings = settingsData; console.log("Settings saved:", appSettings); showStatus(statusEl, "Settings saved!", "success", 3000); if(elements.adminHeaderLogo) { const logoUrl = appSettings.logoUrl; elements.adminHeaderLogo.src = logoUrl || 'https://via.placeholder.com/35/1E293B/94A3B8?text=L'; elements.adminHeaderLogo.style.display = logoUrl ? 'inline-block' : 'none'; elements.adminHeaderLogo.alt = appSettings.appName ? `${appSettings.appName} Logo` : 'Logo'; } document.title = `${appSettings.appName || 'Gaming Tournament'} - Admin Panel`; } catch (error) { console.error("Error saving settings:", error); showStatus(statusEl, `Error: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); elements.appSettingsForm?.querySelectorAll('input, textarea, button').forEach(el => el.disabled = false); } }
        async function loadThemeSettings() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; console.log("Loading theme settings..."); const statusEl = elements.themeStatus; clearStatus(statusEl); try { const settingsSnap = await get(ref(db, 'settings')); const currentTheme = settingsSnap.exists() ? settingsSnap.val().theme : null; if (currentTheme) { console.log("Found custom theme in DB:", currentTheme); populateThemePickers(currentTheme); } else { console.log("No custom theme in DB, loading default."); populateThemePickers(defaultTheme); showStatus(statusEl, "Currently using the default theme. Customize and save to change it.", "info", 10000); } } catch (error) { console.error("Error loading theme settings:", error); showStatus(statusEl, `Error loading theme: ${error.message}`, "danger", false); populateThemePickers(defaultTheme); } }
        function populateThemePickers(theme) { elements.themeColorPickers.forEach(picker => { const cssVar = picker.dataset.var; const colorValue = theme[cssVar] || '#000000'; picker.value = colorValue; const textInput = picker.parentElement.querySelector(`input[type="text"][data-target="${picker.id}"]`); if (textInput) { textInput.value = colorValue; } }); }
        async function saveTheme() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; const statusEl = elements.themeStatus; clearStatus(statusEl); const themeData = {}; elements.themeColorPickers.forEach(picker => { const cssVar = picker.dataset.var; if (cssVar && /^#[0-9A-F]{6}$/i.test(picker.value)) { themeData[cssVar] = picker.value; } else { console.warn(`Skipping invalid color for ${cssVar}: ${picker.value}`); } }); if(themeData['--accent-color']) { themeData['--accent-gradient'] = `linear-gradient(to right, ${themeData['--accent-color']}, #FBBF24)`; } if (Object.keys(themeData).length < elements.themeColorPickers.length) { showStatus(statusEl, "One or more colors are invalid. Please check the values.", "warning"); return; } showLoader(true); elements.saveThemeBtn.disabled = true; try { await update(ref(db, 'settings'), { theme: themeData }); console.log("Theme saved successfully:", themeData); showStatus(statusEl, "Theme saved successfully! Changes will appear for users in real-time.", "success", 5000); } catch (error) { console.error("Error saving theme:", error); showStatus(statusEl, `Error saving theme: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); elements.saveThemeBtn.disabled = false; } }
        async function resetTheme() { if (!db || !isDesignatedAdmin(currentAdminUser)) return; if (!confirm("Are you sure you want to reset to the default theme? This will remove your custom theme settings.")) { return; } const statusEl = elements.themeStatus; clearStatus(statusEl); showLoader(true); elements.resetThemeBtn.disabled = true; try { await remove(ref(db, 'settings/theme')); console.log("Theme reset successfully."); showStatus(statusEl, "Theme has been reset to default.", "success", 5000); populateThemePickers(defaultTheme); } catch (error) { console.error("Error resetting theme:", error); showStatus(statusEl, `Error resetting theme: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); elements.resetThemeBtn.disabled = false; } }
        async function addDemoData() { if (!db || !isDesignatedAdmin(currentAdminUser) || !confirm("Add sample demo data? Only adds if sections are empty.")) return; showLoader(true); elements.addDemoDataBtn.disabled = true; const sectionEl = querySel('#adminMainContent .section.active'); const statusEl = sectionEl?.querySelector('div[id$="Status"]') || elements.dashboardStatus; clearStatus(statusEl); let added = []; const now = Date.now(); try { const gamesRef = ref(db, 'games'); const gamesSnap = await get(gamesRef); let demoGameId = null; if (!gamesSnap.exists() || gamesSnap.size === 0) { const newRef = push(gamesRef); demoGameId = newRef.key; await set(newRef, { name: "Demo Game (BGMI)", imageUrl: "https://i.ibb.co/4Z5hPVzp/20250418-150058.jpg", createdAt: serverTimestamp() }); added.push("Game"); gameDataCache[demoGameId] = "Demo Game (BGMI)"; } else { const games = gamesSnap.val(); demoGameId = Object.keys(games)[0]; gameDataCache = Object.entries(games).reduce((acc, [id, data]) => { acc[id] = data.name; return acc; }, {}); } const promoRef = ref(db, 'promotions'); const promoSnap = await get(promoRef); if (!promoSnap.exists() || promoSnap.size === 0) { await set(push(promoRef), { imageUrl: "https://i.ibb.co/RGmQ420n/20250418-150709.jpg", link: "#", createdAt: serverTimestamp() }); added.push("Promotion"); } if (demoGameId) { const tRef = ref(db, 'tournaments'); const tSnap = await get(tRef); if (!tSnap.exists() || tSnap.size === 0) { await set(push(tRef), { gameId: demoGameId, name: "Weekend Demo Clash", startTime: now + 86400000, status: "upcoming", entryFee: 10, prizePool: 100, perKillPrize: 2, maxPlayers: 50, tags: ["Demo", "Squad"], description: "Sample tournament details.", roomId: null, roomPassword: null, showIdPass: false, createdAt: serverTimestamp(), updatedAt: serverTimestamp() }); added.push("Tournament"); } } const usersRef = ref(db, 'users'); const usersSnap = await get(usersRef); let demoUserNeeded = true; if(usersSnap.exists()){ usersSnap.forEach(uSnap => { if(uSnap.key !== designatedAdminUid) demoUserNeeded = false; }); } if(demoUserNeeded && auth) { try { const demoEmail = `demo${Date.now().toString().slice(-5)}@example.com`, demoPass = "password", cred = await createUserWithEmailAndPassword(auth, demoEmail, demoPass), uid = cred.user.uid, code = Math.random().toString(36).substring(2, 10).toUpperCase(); await set(ref(db, `users/${uid}`), { uid: uid, email: demoEmail, displayName: "Demo User", balance: 50, winningCash: 10, bonusCash: 5, status: 'active', createdAt: serverTimestamp(), referralCode: code, isAdmin: false, referralEarnings: 0, totalEarnings: 0, totalMatches: 0, wonMatches: 0 }); added.push("User (Demo)"); console.log("Created demo user:", demoEmail); } catch (userErr) { console.error("Failed demo user creation:", userErr); } } const settingsRef = ref(db, 'settings'); const settingsSnap = await get(settingsRef); if (!settingsSnap.exists()) { const demoSettings = { appName: "Demo Gaming App", logoUrl: "https://i.ibb.co/BvH3m14/Chat-GPT-Image-Apr-18-2025-05-54-04-PM.png", minWithdraw: 50, referralBonus: 5, supportContact: "support@demo.com", upiDetails: "demo@upi", policyPrivacy: "Demo Privacy Policy.", policyTerms: "Demo Terms.", policyRefund: "Demo Refund Policy.", policyFairPlay: "Demo Fair Play Policy.", lastUpdated: serverTimestamp() }; await set(settingsRef, demoSettings); added.push("Settings"); appSettings = demoSettings; } if (added.length > 0) { showStatus(statusEl, `Demo data added for: ${added.join(', ')}. Refreshing...`, "success", 5000); if (added.includes("Game")) await loadGames(); if (added.includes("Promotion")) await loadPromotions(); if (added.includes("Tournament")) await loadTournaments(); if (added.includes("Settings")) await loadSettings(); if (added.includes("User (Demo)")) await loadUsers(); loadDashboardStats(); } else { showStatus(statusEl, "No demo data added (already exists?).", "info", 5000); } } catch (error) { console.error("Error adding demo data:", error); showStatus(statusEl, `Error adding demo data: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); elements.addDemoDataBtn.disabled = false; } }
        
        async function loadUpdates() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            const updatesRef = ref(db, 'updates');
            elements.updatesTableBody.innerHTML = tableLoadingPlaceholderHtml(3);
            clearStatus(elements.updatesStatus);
            try {
                const snapshot = await get(updatesRef);
                let tableHtml = '';
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const updateId = childSnapshot.key;
                        const update = childSnapshot.val();
                        if (update && update.imageUrl && update.title) {
                            tableHtml += `<tr>
                                <td><img src="${sanitizeHTML(update.imageUrl)}" alt="Update Image" class="preview-img"></td>
                                <td>${sanitizeHTML(update.title)}</td>
                                <td class="action-buttons">
                                    <button class="btn btn-sm btn-info btn-edit-update" data-id="${sanitizeHTML(updateId)}" title="Edit Update"><i class="bi bi-pencil-square"></i></button>
                                    <button class="btn btn-sm btn-danger btn-delete-update" data-id="${sanitizeHTML(updateId)}" title="Delete Update"><i class="bi bi-trash"></i></button>
                                </td>
                            </tr>`;
                        }
                    });
                }
                elements.updatesTableBody.innerHTML = tableHtml || `<tr><td colspan="3" class="text-center p-3 text-muted">No updates found.</td></tr>`;
            } catch (error) {
                console.error("Error loading updates:", error);
                elements.updatesTableBody.innerHTML = `<tr><td colspan="3" class="text-center p-3 text-danger">Error loading updates: ${error.message}.</td></tr>`;
                showStatus(elements.updatesStatus, `Error loading updates: ${error.message}.`, 'danger', false);
            }
        }

        async function saveUpdate() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            const updateId = elements.updateEditId.value;
            const isEditing = !!updateId;
            const title = elements.updateTitleInput.value.trim();
            const imageUrl = elements.updateImageUrlInput.value.trim();
            const statusEl = elements.updateStatus;
            clearStatus(statusEl);

            if (!title || !imageUrl) {
                showStatus(statusEl, "Title and Image URL are required.", "warning");
                return;
            }

            showLoader(true);
            elements.saveUpdateBtn.disabled = true;
            
            try {
                const updateData = { title, imageUrl };
                if (isEditing) {
                    updateData.updatedAt = serverTimestamp();
                    await update(ref(db, `updates/${updateId}`), updateData);
                    showStatus(elements.updatesStatus, "Update saved successfully!", "success");
                } else {
                    updateData.createdAt = serverTimestamp();
                    await push(ref(db, 'updates'), updateData);
                    showStatus(elements.updatesStatus, "Update posted successfully!", "success");
                }
                getModalInstance(elements.updateModalEl)?.hide();
                loadUpdates();
            } catch (error) {
                console.error("Error saving update:", error);
                showStatus(statusEl, `Error: ${error.message}.`, "danger", false);
            } finally {
                showLoader(false);
                elements.saveUpdateBtn.disabled = false;
            }
        }
        
        async function openEditUpdateModal(updateId) {
            if (!db || !updateId || !isDesignatedAdmin(currentAdminUser)) return;
            showLoader(true);
            elements.updateForm.reset();
            clearStatus(elements.updateStatus);
            try {
                const snapshot = await get(ref(db, `updates/${updateId}`));
                if (!snapshot.exists()) throw new Error(`Update ${updateId} not found.`);
                const update = snapshot.val();
                elements.updateModalTitle.textContent = "Edit Update";
                elements.updateEditId.value = updateId;
                elements.updateTitleInput.value = update.title || '';
                elements.updateImageUrlInput.value = update.imageUrl || '';
                getModalInstance(elements.updateModalEl)?.show();
            } catch (error) {
                console.error("Error opening edit update modal:", error);
                showStatus(elements.updatesStatus, `Error loading update for edit: ${error.message}`, "danger");
            } finally {
                showLoader(false);
            }
        }
        
        async function deleteUpdate(updateId) {
            if (!db || !updateId || !isDesignatedAdmin(currentAdminUser)) return;
            if (!confirm(`Are you sure you want to delete this update?`)) return;
            showLoader(true);
            try {
                await remove(ref(db, `updates/${updateId}`));
                showStatus(elements.updatesStatus, "Update deleted successfully.", "success");
                loadUpdates();
            } catch (error) {
                console.error("Error deleting update:", error);
                showStatus(elements.updatesStatus, `Error: ${error.message}`, "danger");
            } finally {
                showLoader(false);
            }
        }

        async function loadDeposits(status = 'pending') {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            const targetTableBody = getElement(`${status}DepositsTableBody`);
            if (!targetTableBody) { console.error(`Table body not found for deposits: ${status}`); return; }
            
            const q = query(ref(db, 'rechargeRequests'), orderByChild('status'), equalTo(status));
            targetTableBody.innerHTML = tableLoadingPlaceholderHtml(status === 'pending' ? 5 : 6);
            if (status === 'pending') clearStatus(elements.depositsStatus);

            const listenerKey = `deposits-${status}`;
            if (dbListeners[listenerKey]) try { off(q, 'value', dbListeners[listenerKey]); } catch (e) { console.warn(`Could not detach ${listenerKey}`, e); }

            dbListeners[listenerKey] = onValue(q, async (snapshot) => {
                console.log(`${status} deposit data received.`);
                let tableHtml = '';
                let count = 0;

                if (snapshot.exists()) {
                    count = snapshot.size;
                    const userIds = new Set();
                    snapshot.forEach(child => { if (child.val()?.userId && !userDataCache[child.val().userId]) userIds.add(child.val().userId); });
                    if (userIds.size > 0) await Promise.allSettled(Array.from(userIds).map(uid => get(ref(db, `users/${uid}`)).then(us => { if (us.exists()) { const u = us.val(); userDataCache[uid] = { displayName: u.displayName || 'N/A', email: u.email || uid }; } })));

                    const deposits = [];
                    snapshot.forEach(child => deposits.push({ id: child.key, ...child.val() }));
                    deposits.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                    deposits.forEach(d => {
                        const user = userDataCache[d.userId] || { displayName: 'Unknown', email: d.userId };
                        const userDisplay = `${sanitizeHTML(user.displayName)} (<small class="text-muted">${sanitizeHTML(user.email)}</small>)`;
                        const detailsHtml = `
                            <small class="d-block">Method: <strong>${sanitizeHTML(d.method)}</strong></small>
                            <small class="d-block" title="${sanitizeHTML(d.transactionId)}">Txn ID: ${sanitizeHTML(String(d.transactionId).substring(0, 15))}...</small>
                            <small class="d-block">Phone Number: ${sanitizeHTML(d.playerGameId)}</small>`;
                        
                        const requestTime = formatDate(d.timestamp);
                        const processedTime = formatDate(d.processedAt);

                        let rowHtml = `<tr><td>${requestTime}</td>`;
                        if (status !== 'pending') rowHtml += `<td>${processedTime}</td>`;
                        rowHtml += `<td>${userDisplay}</td><td>${formatCurrency(d.amount)}</td><td>${detailsHtml}</td>`;

                        if (status === 'pending') {
                            rowHtml += `<td class="action-buttons"><button class="btn btn-sm btn-success btn-approve-deposit" data-id="${d.id}"><i class="bi bi-check-circle"></i></button> <button class="btn btn-sm btn-danger btn-reject-deposit" data-id="${d.id}"><i class="bi bi-x-circle"></i></button></td>`;
                        } else if (status === 'approved') {
                            rowHtml += `<td><small>${sanitizeHTML(d.adminNote || 'N/A')}</small></td>`;
                        } else if (status === 'rejected') {
                            rowHtml += `<td><small>${sanitizeHTML(d.rejectReason || 'N/A')}</small></td>`;
                        }
                        rowHtml += `</tr>`;
                        tableHtml += rowHtml;
                    });
                }
                const emptyColspan = status === 'pending' ? 5 : 6;
                targetTableBody.innerHTML = tableHtml || `<tr><td colspan="${emptyColspan}" class="text-center p-3 text-muted">No ${status} deposits found.</td></tr>`;
                
                if (status === 'pending') {
                    elements.pendingDepositCountBadge.textContent = count;
                    elements.pendingDepositCountBadge.style.display = count > 0 ? 'inline-block' : 'none';
                }
            }, (error) => {
                console.error(`Error loading ${status} deposits:`, error);
                targetTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-3 text-danger">Error: ${error.message}. Check Rules/Index.</td></tr>`;
                if (error?.message?.includes("index")) showStatus(elements.depositsStatus, "CRITICAL: Deposit query fail. Add '.indexOn': 'status' to '/rechargeRequests' rules.", "danger", false);
            });
        }

        async function openDepositActionModal(requestId, type) {
            if (!db || !requestId || !type || !isDesignatedAdmin(currentAdminUser)) return;
            showLoader(true);
            currentDepositAction = { id: requestId, type: type, userId: null };
            
            elements.depositRejectReasonInput.value = '';
            elements.depositApproveNoteInput.value = '';
            elements.depositRejectReasonDiv.style.display = 'none';
            elements.depositApproveNoteDiv.style.display = 'none';
            elements.approveDepositBtn.style.display = 'inline-block';
            elements.rejectDepositBtn.style.display = 'inline-block';
            clearStatus(elements.depositActionStatus);

            try {
                const snapshot = await get(ref(db, `rechargeRequests/${requestId}`));
                if (!snapshot.exists()) throw new Error("Deposit request not found.");
                const d = snapshot.val();
                currentDepositAction.userId = d.userId;

                if (d.status !== 'pending') {
                    alert(`Request already processed (Status: ${d.status}).`);
                    return;
                }
                
                const user = userDataCache[d.userId] || { displayName: 'Loading...', email: d.userId };
                elements.depositDetailId.textContent = requestId;
                elements.depositDetailUser.textContent = `${user.displayName} (${user.email})`;
                elements.depositDetailAmount.textContent = formatCurrency(d.amount);
                elements.depositDetailMethod.textContent = d.method || 'N/A';
                elements.depositDetailGameId.textContent = d.playerGameId || 'N/A';
                elements.depositDetailTxnId.textContent = d.transactionId || 'N/A';

                if (type === 'reject') {
                    elements.depositRejectReasonDiv.style.display = 'block';
                    elements.approveDepositBtn.style.display = 'none';
                } else {
                    elements.depositApproveNoteDiv.style.display = 'block';
                    elements.rejectDepositBtn.style.display = 'none';
                }
                getModalInstance(elements.depositActionModalEl)?.show();
            } catch (error) {
                console.error("Error opening deposit modal:", error);
                showStatus(elements.depositsStatus, `Error: ${error.message}`, 'danger');
            } finally {
                showLoader(false);
            }
        }

        async function processDepositAction() {
            const { id, type, userId } = currentDepositAction;
            if (!id || !type || !userId || !isDesignatedAdmin(currentAdminUser)) return;

            const statusEl = elements.depositActionStatus;
            clearStatus(statusEl);
            showLoader(true);
            elements.approveDepositBtn.disabled = true;
            elements.rejectDepositBtn.disabled = true;
            
            const updates = {};
            const depositRefPath = `rechargeRequests/${id}`;

            try {
                const depositSnap = await get(ref(db, depositRefPath));
                if (!depositSnap.exists() || depositSnap.val().status !== 'pending') throw new Error("Request not found or already processed.");
                const depositData = depositSnap.val();
                const amount = Number(depositData.amount);

                if (type === 'approve') {
                    const userSnap = await get(ref(db, `users/${userId}`));
                    if (!userSnap.exists()) throw new Error("User to credit not found.");
                    
                    const newBalance = (userSnap.val().balance || 0) + amount;
                    updates[`users/${userId}/balance`] = newBalance;
                    
                    const txKey = push(ref(db, `transactions/${userId}`)).key;
                    updates[`transactions/${userId}/${txKey}`] = {
                        type: 'deposit_approved',
                        amount: amount,
                        description: `Deposit via ${depositData.method}`,
                        timestamp: serverTimestamp(),
                        balanceAfter: newBalance,
                        adminUid: currentAdminUser.uid
                    };
                    
                    updates[`${depositRefPath}/status`] = 'approved';
                    updates[`${depositRefPath}/processedAt`] = serverTimestamp();
                    updates[`${depositRefPath}/adminNote`] = elements.depositApproveNoteInput.value.trim() || 'Approved';
                    
                    await update(ref(db), updates);
                    await sendNotification(userId, "Deposit Approved", `Your deposit request for ${formatCurrency(amount)} has been approved.`);
                    showStatus(elements.depositsStatus, "Deposit approved and balance updated.", "success");

                } else { // Reject
                    const reason = elements.depositRejectReasonInput.value.trim();
                    if (!reason) throw new Error("Rejection reason is required.");
                    
                    updates[`${depositRefPath}/status`] = 'rejected';
                    updates[`${depositRefPath}/processedAt`] = serverTimestamp();
                    updates[`${depositRefPath}/rejectReason`] = reason;

                    await update(ref(db), updates);
                    await sendNotification(userId, "Deposit Rejected", `Your deposit request was rejected. Reason: ${reason}`);
                    showStatus(elements.depositsStatus, "Deposit request rejected.", "success");
                }

                getModalInstance(elements.depositActionModalEl)?.hide();
                loadDashboardStats();

            } catch (error) {
                console.error("Error processing deposit:", error);
                showStatus(statusEl, `Error: ${error.message}`, "danger", false);
            } finally {
                showLoader(false);
                elements.approveDepositBtn.disabled = false;
                elements.rejectDepositBtn.disabled = false;
            }
        }

        async function sendNotification(userId, title, message) {
            if (!userId || !title || !message) {
                throw new Error("User ID, title, and message are required to send a notification.");
            }
            const notification = {
                title: title,
                message: message,
                isRead: false,
                timestamp: serverTimestamp()
            };
            await push(ref(db, `notifications/${userId}`), notification);
            console.log(`Notification sent to ${userId}`);
        }

        async function sendBroadcastNotification(event) {
            event.preventDefault();
            const title = elements.broadcastNotificationTitle.value.trim();
            const message = elements.broadcastNotificationMessage.value.trim();
            if (!title || !message) {
                showStatus(elements.notificationStatus, "Title and Message are required.", "warning");
                return;
            }

            if (!confirm(`Are you sure you want to send this notification to ALL users? This action cannot be undone.`)) {
                return;
            }

            showLoader(true);
            try {
                const usersSnap = await get(ref(db, 'users'));
                if (!usersSnap.exists()) throw new Error("No users found to broadcast to.");
                
                const updates = {};
                const notification = { title, message, isRead: false, timestamp: serverTimestamp() };
                let userCount = 0;
                
                usersSnap.forEach(userSnapshot => {
                    const userId = userSnapshot.key;
                    const newNotifKey = push(ref(db, `notifications/${userId}`)).key;
                    updates[`notifications/${userId}/${newNotifKey}`] = notification;
                    userCount++;
                });

                await update(ref(db), updates);
                showStatus(elements.notificationStatus, `Broadcast sent successfully to ${userCount} users.`, "success");
                elements.sendBroadcastNotificationForm.reset();

            } catch (error) {
                console.error("Error sending broadcast:", error);
                showStatus(elements.notificationStatus, `Error: ${error.message}`, "danger");
            } finally {
                showLoader(false);
            }
        }

        function setupRealtimeAdminListeners() {
            if (!db || !currentAdminUser || !isDesignatedAdmin(currentAdminUser)) return;
            console.log("Setting up realtime count listeners...");
            detachAllAdminListeners();

            const pendingWithdrawalQuery = query(ref(db, 'withdrawals'), orderByChild('status'), equalTo('pending'));
            dbListeners['pendingWithdrawalsCount'] = onValue(pendingWithdrawalQuery, (snapshot) => {
                 const count = snapshot.exists() ? snapshot.size : 0;
                 if (elements.pendingWithdrawalCountBadge) { elements.pendingWithdrawalCountBadge.textContent = count; elements.pendingWithdrawalCountBadge.style.display = count > 0 ? 'inline-block' : 'none'; }
                 if (elements.statPendingWithdrawals && elements.dashboardSection.classList.contains('active')) elements.statPendingWithdrawals.textContent = count;
            }, error => console.error("Listener error (pending withdrawals):", error));
            
            const pendingDepositQuery = query(ref(db, 'rechargeRequests'), orderByChild('status'), equalTo('pending'));
            dbListeners['pendingDepositsCount'] = onValue(pendingDepositQuery, (snapshot) => {
                const count = snapshot.exists() ? snapshot.size : 0;
                console.log("Realtime pending deposit count:", count);
                if (elements.pendingDepositCountBadge) {
                    elements.pendingDepositCountBadge.textContent = count;
                    elements.pendingDepositCountBadge.style.display = count > 0 ? 'inline-block' : 'none';
                }
            }, error => {
                console.error("Listener error (pending deposits):", error);
                if (elements.pendingDepositCountBadge) { elements.pendingDepositCountBadge.textContent = 'Err'; elements.pendingDepositCountBadge.style.display = 'inline-block';}
                if (error?.message?.includes("index")) showStatus(elements.dashboardStatus, `Deposit count error. Add index '.indexOn': 'status' to '/rechargeRequests'.`, "danger", false);
            });
        }
        
        function detachAllAdminListeners() {
             if (!db || Object.keys(dbListeners).length === 0) return;
             Object.keys(dbListeners).forEach(key => {
                 try {
                      if (key === 'pendingWithdrawalsCount') off(query(ref(db, 'withdrawals'), orderByChild('status'), equalTo('pending')), 'value', dbListeners[key]);
                      else if (key === 'pendingDepositsCount') off(query(ref(db, 'rechargeRequests'), orderByChild('status'), equalTo('pending')), 'value', dbListeners[key]);
                      else if (key === 'users') off(ref(db, 'users'), 'value', dbListeners[key]);
                      else if (key.startsWith('withdrawals-')) off(query(ref(db, 'withdrawals'), orderByChild('status'), equalTo(key.split('-')[1])), 'value', dbListeners[key]);
                      else if (key.startsWith('deposits-')) off(query(ref(db, 'rechargeRequests'), orderByChild('status'), equalTo(key.split('-')[1])), 'value', dbListeners[key]);
                      else console.warn("Unknown listener key, cannot detach automatically:", key);
                 } catch (e) { console.warn(`Could not detach listener ${key}`, e); }
             });
             dbListeners = {};
             console.log("Finished detaching listeners.");
        }
        
        async function openEditGameModal(gameId) { if (!db || !gameId || !isDesignatedAdmin(currentAdminUser)) return; showLoader(true); elements.gameForm.reset(); clearStatus(elements.gameStatus); const imgbbStatusEl = elements.gameForm.querySelector('.imgbb-upload-status'); if (imgbbStatusEl) { imgbbStatusEl.textContent = ''; imgbbStatusEl.style.display = 'none'; } try { const snapshot = await get(ref(db, `games/${gameId}`)); if (!snapshot.exists()) throw new Error(`Game ${gameId} not found.`); const game = snapshot.val(); elements.gameModalTitle.textContent = "Edit Game"; elements.gameEditId.value = gameId; elements.gameNameInput.value = game.name || ''; elements.gameImageUrlInput.value = game.imageUrl || ''; elements.gameImageFileInput.value = ''; getModalInstance(elements.gameModalEl)?.show(); } catch (error) { console.error("Error opening edit game modal:", error); showStatus(elements.gamesStatus, `Error loading game for edit: ${error.message}`, "danger", false); } finally { showLoader(false); } }
        async function openEditPromotionModal(promoId) { if (!db || !promoId || !isDesignatedAdmin(currentAdminUser)) return; showLoader(true); elements.promotionForm.reset(); clearStatus(elements.promotionStatus); const imgbbStatusEl = elements.promotionForm.querySelector('.imgbb-upload-status'); if (imgbbStatusEl) { imgbbStatusEl.textContent = ''; imgbbStatusEl.style.display = 'none'; } try { const snapshot = await get(ref(db, `promotions/${promoId}`)); if (!snapshot.exists()) throw new Error(`Promotion ${promoId} not found.`); const promo = snapshot.val(); elements.promotionModalTitle.textContent = "Edit Promotion"; elements.promotionEditId.value = promoId; elements.promoImageUrlInput.value = promo.imageUrl || ''; elements.promoLinkInput.value = promo.link || ''; elements.promoImageFileInput.value = ''; getModalInstance(elements.promotionModalEl)?.show(); } catch (error) { console.error("Error opening edit promotion modal:", error); showStatus(elements.promotionsStatus, `Error loading promotion for edit: ${error.message}`, "danger", false); } finally { showLoader(false); } }
        async function populateGameSelect(selectedValue = null) { if (!elements.tournamentGameSelect) return; const select = elements.tournamentGameSelect; select.innerHTML = '<option value="">Loading...</option>'; select.disabled = true; try { if (Object.keys(gameDataCache).length === 0) await loadGames(); if (Object.keys(gameDataCache).length > 0) { select.innerHTML = '<option value="">-- Select Game --</option>'; const sorted = Object.entries(gameDataCache).sort(([, a], [, b]) => a.localeCompare(b)); sorted.forEach(([id, name]) => { const opt = document.createElement('option'); opt.value = id; opt.textContent = sanitizeHTML(name); select.appendChild(opt); }); if (selectedValue) select.value = selectedValue; } else { select.innerHTML = '<option value="">No Games Available</option>'; } } catch (error) { console.error("Error populating game select:", error); select.innerHTML = '<option value="">Error Loading</option>'; } finally { select.disabled = false; } }
        
        // MODIFIED: This function now populates room ID and password when editing.
        async function openEditTournamentModal(tournamentId) {
            if (!db || !tournamentId || !isDesignatedAdmin(currentAdminUser)) return;
            showLoader(true);
            clearStatus(elements.addTournamentStatus);
            elements.tournamentForm.reset();
            currentEditingTournamentId = tournamentId;
        
            try {
                const snapshot = await get(ref(db, `tournaments/${tournamentId}`));
                if (!snapshot.exists()) throw new Error(`Tournament ${tournamentId} not found.`);
                const t = snapshot.val();
        
                await populateGameSelect(t.gameId);
                elements.tournamentModalTitle.textContent = "Edit Tournament";
                elements.tournamentEditId.value = tournamentId;
                elements.tournamentNameInput.value = t.name || '';
                
                if (t.startTime) {
                    try {
                        const d = new Date(t.startTime);
                        if (!isNaN(d)) {
                            const offset = d.getTimezoneOffset() * 60000;
                            elements.tournamentStartTimeInput.value = new Date(d - offset).toISOString().slice(0, 16);
                        }
                    } catch (e) { console.warn("Err fmt date", e); }
                }
                
                elements.tournamentStatusSelect.value = t.status || 'upcoming';
                elements.tournamentEntryFeeInput.value = t.entryFee ?? 0;
                elements.tournamentPrizePoolInput.value = t.prizePool ?? 0;
                elements.tournamentPerKillInput.value = t.perKillPrize ?? 0;
                elements.tournamentMaxPlayersInput.value = t.maxPlayers ?? 0;
                elements.tournamentTagsInput.value = (t.tags || []).join(', ');
                elements.tournamentModeInput.value = t.mode || '';
                elements.tournamentMapInput.value = t.map || '';
                elements.tournamentDescriptionInput.value = t.description || '';
                
                // MODIFIED: Populating Room ID and Password fields
                elements.tournamentRoomIdInput.value = t.roomId || '';
                elements.tournamentRoomPasswordInput.value = t.roomPassword || '';
                elements.tournamentShowIdPassCheckbox.checked = t.showIdPass || false;
        
                getModalInstance(elements.addTournamentModalEl)?.show();
            } catch (error) {
                console.error("Error opening edit tournament modal:", error);
                showStatus(elements.tournamentsStatus, `Error loading tournament: ${error.message}`, "danger", false);
                currentEditingTournamentId = null;
            } finally {
                showLoader(false);
            }
        }
        
        async function openUserModal(userId) { if (!db || !userId || !isDesignatedAdmin(currentAdminUser)) return; showLoader(true); clearStatus(elements.balanceUpdateStatus); elements.updateBalanceForm.reset(); elements.userDetailReferredBy.textContent = "N/A"; elements.userDetailReferredCount.textContent = "N/A"; try { let user; if (fullUserDataCache[userId] && fullUserDataCache[userId].status !== 'error' && fullUserDataCache[userId].status !== 'deleted') { user = fullUserDataCache[userId]; } else { const snapshot = await get(ref(db, `users/${userId}`)); if (!snapshot.exists()) throw new Error(`User ${userId} not found.`); user = snapshot.val(); user.uid = userId; fullUserDataCache[userId] = user; } elements.userModalTitle.textContent = `User: ${sanitizeHTML(user.displayName || 'N/A')}`; elements.userDetailUid.textContent = userId; elements.userDetailEmail.textContent = sanitizeHTML(user.email || 'N/A'); elements.userDetailName.textContent = sanitizeHTML(user.displayName || 'N/A'); elements.userDetailCreatedAt.textContent = formatDate(user.createdAt); elements.userDetailBalance.textContent = formatCurrency(user.balance); elements.userDetailWinning.textContent = formatCurrency(user.winningCash); elements.userDetailBonus.textContent = formatCurrency(user.bonusCash); elements.editUserUid.value = userId; elements.userDetailReferralCode.textContent = user.referralCode || 'N/A'; const status = user.status || 'active'; elements.userDetailStatus.textContent = status.charAt(0).toUpperCase() + status.slice(1); elements.userDetailStatus.className = `fw-bold text-${status === 'active' ? 'success' : 'danger'}`; elements.userBlockBtn.textContent = status === 'active' ? 'Block User' : 'Unblock User'; elements.userBlockBtn.className = `btn btn-sm ${status === 'active' ? 'btn-danger' : 'btn-success'}`; elements.userBlockBtn.dataset.id = userId; elements.userBlockBtn.dataset.action = status === 'active' ? 'block' : 'unblock'; elements.userDeleteBtn.dataset.id = userId; getModalInstance(elements.userModalEl)?.show(); } catch (error) { console.error("Error opening user modal:", error); showStatus(elements.usersStatus, `Error loading user: ${error.message}`, "danger", false); } finally { showLoader(false); } }
        
        // MODIFIED: This function now reads and displays the player's in-game name and ID.
        async function openRegisteredPlayersModal(tournamentId, tournamentName) {
            if (!db || !tournamentId || !isDesignatedAdmin(currentAdminUser)) return;
            elements.registeredPlayersModalTitle.textContent = "Registered Players";
            elements.registeredPlayersTournamentName.textContent = tournamentName || "N/A";
            elements.registeredPlayersTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-3"><div class="spinner-border spinner-border-sm"></div></td></tr>`;
            clearStatus(elements.registeredPlayersStatus);
            getModalInstance(elements.registeredPlayersModalEl)?.show();
            
            try {
                const playersRef = ref(db, `tournaments/${tournamentId}/registeredPlayers`);
                const snapshot = await get(playersRef);
                
                if (!snapshot.exists()) {
                    elements.registeredPlayersTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-3 text-muted">No players registered.</td></tr>`;
                    return;
                }
                
                const registeredData = snapshot.val();
                const userIds = Object.keys(registeredData);
                let tableHtml = '';
                
                const promises = userIds.map(async (uid) => {
                    let user = fullUserDataCache[uid];
                    if (!user) {
                        const uSnap = await get(ref(db, `users/${uid}`));
                        user = uSnap.exists() ? { uid, ...uSnap.val() } : { uid, displayName: 'User Not Found', email: 'N/A' };
                        fullUserDataCache[uid] = user;
                    }
                    return { user, playerData: registeredData[uid] };
                });
                
                const results = await Promise.all(promises);
                
                results.forEach(({ user, playerData }) => {
                    tableHtml += `<tr>
                        <td><small class="text-muted">${sanitizeHTML(user.uid)}</small></td>
                        <td>${sanitizeHTML(user.displayName)}</td>
                        <td>${sanitizeHTML(playerData.inGameName || 'N/A')}</td>
                        <td>${sanitizeHTML(playerData.inGameId || 'N/A')}</td>
                        <td>${formatDate(playerData.joinedAt)}</td>
                    </tr>`;
                });

                elements.registeredPlayersTableBody.innerHTML = tableHtml || `<tr><td colspan="5" class="text-center p-3 text-muted">Could not load player details.</td></tr>`;
                elements.registeredPlayersModalTitle.textContent = `Registered Players (${results.length})`;

            } catch (error) {
                console.error("Error loading registered players:", error);
                elements.registeredPlayersTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-3 text-danger">Error: ${error.message}.</td></tr>`;
                showStatus(elements.registeredPlayersStatus, `Error: ${error.message}`, 'danger');
            }
        }
        
        function initializeAdminEventListeners() {
            console.log("Initializing Admin Event Listeners...");
            if (!auth || !db) { console.error("Cannot init listeners: Firebase not ready."); return; }
            elements.adminSetupForm?.addEventListener('submit', setupAdmin);
            elements.adminLoginForm?.addEventListener('submit', loginAdmin);
            elements.adminLogoutBtn?.addEventListener('click', logoutAdminUser);
            elements.sidebarLinks?.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); const sectionId = link.dataset.section; if (sectionId && !link.classList.contains('active')) { showAdminSection(sectionId); } else { getOffcanvasInstance(elements.sidebar)?.hide(); } }); });
            elements.saveGameBtn?.addEventListener('click', saveGame);
            elements.savePromotionBtn?.addEventListener('click', savePromotion);
            elements.saveTournamentBtn?.addEventListener('click', saveTournament);
            elements.saveNewUserBtn?.addEventListener('click', saveNewUser);
            elements.appSettingsForm?.addEventListener('submit', saveSettings);
            elements.updateBalanceForm?.addEventListener('submit', updateUserBalance);
            elements.addNewGameBtn?.addEventListener('click', () => { elements.gameForm?.reset(); elements.gameEditId.value = ''; elements.gameModalTitle.textContent = "Add New Game"; clearStatus(elements.gameStatus); const imgbbEl = elements.gameForm?.querySelector('.imgbb-upload-status'); if(imgbbEl){ imgbbEl.textContent=''; imgbbEl.style.display='none';} });
            elements.addNewPromotionBtn?.addEventListener('click', () => { elements.promotionForm?.reset(); elements.promotionEditId.value = ''; elements.promotionModalTitle.textContent = "Add New Promotion"; clearStatus(elements.promotionStatus); const imgbbEl = elements.promotionForm?.querySelector('.imgbb-upload-status'); if(imgbbEl){ imgbbEl.textContent=''; imgbbEl.style.display='none';} });
            elements.addNewTournamentBtn?.addEventListener('click', () => { currentEditingTournamentId = null; elements.tournamentForm?.reset(); if(elements.tournamentModalTitle) elements.tournamentModalTitle.textContent = "Add New Tournament"; clearStatus(elements.addTournamentStatus); populateGameSelect(); });
            elements.userBlockBtn?.addEventListener('click', toggleUserBlock);
            elements.userDeleteBtn?.addEventListener('click', (e) => { const userId = e.target.closest('button')?.dataset.id; if (userId) deleteUser(userId); });
            elements.approveWithdrawalBtn?.addEventListener('click', processWithdrawalAction);
            elements.rejectWithdrawalBtn?.addEventListener('click', processWithdrawalAction);
            elements.addDemoDataBtn?.addEventListener('click', addDemoData);
            elements.userSearchInput?.addEventListener('input', filterUsers);
            elements.saveThemeBtn?.addEventListener('click', saveTheme);
            elements.resetThemeBtn?.addEventListener('click', resetTheme);
            elements.previewDefaultThemeBtn?.addEventListener('click', () => populateThemePickers(defaultTheme));
            elements.previewCrimsonThemeBtn?.addEventListener('click', () => populateThemePickers(crimsonTheme));
            elements.previewOceanicThemeBtn?.addEventListener('click', () => populateThemePickers(oceanicTheme));
            elements.customThemeForm?.addEventListener('input', (e) => { if (e.target.matches('input[type="color"]')) { const textInput = e.target.parentElement.querySelector(`input[type="text"][data-target="${e.target.id}"]`); if(textInput) textInput.value = e.target.value; } else if (e.target.matches('input[type="text"]')) { const colorInput = getElement(e.target.dataset.target); if(colorInput && /^#[0-9A-F]{6}$/i.test(e.target.value)) { colorInput.value = e.target.value; } } });

            elements.saveUpdateBtn?.addEventListener('click', saveUpdate);
            elements.addNewUpdateBtn?.addEventListener('click', () => {
                elements.updateForm?.reset();
                elements.updateEditId.value = '';
                elements.updateModalTitle.textContent = "Add New Update";
                clearStatus(elements.updateStatus);
            });
            elements.approveDepositBtn?.addEventListener('click', processDepositAction);
            elements.rejectDepositBtn?.addEventListener('click', processDepositAction);
            elements.sendSingleNotificationForm?.addEventListener('submit', (e) => {
                e.preventDefault();
                const uid = elements.singleNotificationUid.value;
                const title = elements.singleNotificationTitle.value;
                const message = elements.singleNotificationMessage.value;
                sendNotification(uid, title, message)
                    .then(() => {
                        showStatus(elements.notificationStatus, `Notification sent to ${uid}`, "success");
                        elements.sendSingleNotificationForm.reset();
                    })
                    .catch(err => showStatus(elements.notificationStatus, `Error: ${err.message}`, "danger"));
            });
            elements.sendBroadcastNotificationForm?.addEventListener('submit', sendBroadcastNotification);
            
            document.body.addEventListener('click', (event) => {
                 const target = event.target; const actionButton = target.closest('button[data-id]'); const copyIcon = target.closest('.copy-btn[data-target]');
                 if (actionButton) {
                     const targetId = actionButton.dataset.id; if (!targetId) return;
                     if (actionButton.classList.contains('btn-delete-game')) deleteGame(targetId);
                     else if (actionButton.classList.contains('btn-edit-game')) openEditGameModal(targetId);
                     else if (actionButton.classList.contains('btn-delete-promo')) deletePromotion(targetId);
                     else if (actionButton.classList.contains('btn-edit-promo')) openEditPromotionModal(targetId);
                     else if (actionButton.classList.contains('btn-delete-update')) deleteUpdate(targetId);
                     else if (actionButton.classList.contains('btn-edit-update')) openEditUpdateModal(targetId);
                     else if (actionButton.classList.contains('btn-delete-tournament')) deleteTournament(targetId);
                     else if (actionButton.classList.contains('btn-edit-tournament')) openEditTournamentModal(targetId);
                     else if (actionButton.classList.contains('btn-view-user')) openUserModal(targetId);
                     else if (actionButton.classList.contains('btn-approve-withdrawal')) openWithdrawalActionModal(targetId, 'approve');
                     else if (actionButton.classList.contains('btn-reject-withdrawal')) openWithdrawalActionModal(targetId, 'reject');
                     else if (actionButton.classList.contains('btn-approve-deposit')) openDepositActionModal(targetId, 'approve');
                     else if (actionButton.classList.contains('btn-reject-deposit')) openDepositActionModal(targetId, 'reject');
                     else if (actionButton.classList.contains('btn-delete-user')) deleteUser(targetId);
                     else if (actionButton.classList.contains('btn-view-registered')) openRegisteredPlayersModal(targetId, actionButton.dataset.name);
                     return;
                 }
                 if (copyIcon) { copyToClipboard(copyIcon.dataset.target); return; }
            });
            
            const resetModal = (modalEl, formEl, statusEl, idField = null, titleEl = null, defaultTitle = 'Add New Item', imgbbSel = '.imgbb-upload-status') => { modalEl?.addEventListener('hidden.bs.modal', () => { formEl?.reset(); if(statusEl) clearStatus(statusEl); const imgbbStat = formEl?.querySelector(imgbbSel); if(imgbbStat) { imgbbStat.textContent=''; imgbbStat.style.display='none'; } if (idField) idField.value = ''; if (titleEl) titleEl.textContent = defaultTitle; if (modalEl === elements.addTournamentModalEl) currentEditingTournamentId = null; if (modalEl === elements.userModalEl) elements.editUserUid.value = ''; if (modalEl === elements.withdrawalActionModalEl) currentWithdrawalAction = { id: null, type: null, userId: null }; if (modalEl === elements.depositActionModalEl) currentDepositAction = { id: null, type: null, userId: null }; currentEditingItemId = null; }); };
            resetModal(elements.gameModalEl, elements.gameForm, elements.gameStatus, elements.gameEditId, elements.gameModalTitle, 'Add New Game');
            resetModal(elements.promotionModalEl, elements.promotionForm, elements.promotionStatus, elements.promotionEditId, elements.promotionModalTitle, 'Add New Promotion');
            resetModal(elements.updateModalEl, elements.updateForm, elements.updateStatus, elements.updateEditId, elements.updateModalTitle, 'Add New Update');
            resetModal(elements.addTournamentModalEl, elements.tournamentForm, elements.addTournamentStatus, elements.tournamentEditId, elements.tournamentModalTitle, 'Add New Tournament', null);
            resetModal(elements.addUserModalEl, elements.addUserForm, elements.addUserStatus, null, null, '', null);
            resetModal(elements.userModalEl, elements.updateBalanceForm, elements.balanceUpdateStatus, elements.editUserUid, null, '', null);
            resetModal(elements.withdrawalActionModalEl, null, elements.withdrawalActionStatus, null, null, '', null);
            resetModal(elements.depositActionModalEl, null, elements.depositActionStatus, null, null, '', null);
            resetModal(elements.registeredPlayersModalEl, null, elements.registeredPlayersStatus, null, null, '', null);
             console.log("Admin Event Listeners Initialized.");
        }

        function filterUsers() { const searchTerm = elements.userSearchInput.value.toLowerCase().trim(); const filteredUsers = Object.values(fullUserDataCache).filter(user => user.displayName?.toLowerCase().includes(searchTerm) || user.email?.toLowerCase().includes(searchTerm)); renderUsersTable(filteredUsers); }

        document.addEventListener('DOMContentLoaded', () => {
            console.log("Admin Panel DOM Loaded.");
            if (!app || !auth || !db) return;
            initializeAdminEventListeners();
            onAuthStateChanged(auth, handleAdminAuthStateChange);
        });

    </script>

</body>
</html>
